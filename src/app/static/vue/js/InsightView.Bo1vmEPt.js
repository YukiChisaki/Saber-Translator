import{r as y,c as G,d as Ss,a as te,e as g,l as X,k as v,w as ue,f as e,h as E,g as fe,n as H,t as _,i as Pt,D as K,v as O,z as N,o as ke,F as Q,j as W,u as se,p as ie,K as Ue,B as Ne,m as je,x as de,L as gt,M as It,N as Fe,O as Ps,b as Is,C as Ms,y as Rs}from"./vue-vendor.BAHshaBR.js";import{apiClient as q}from"./client.Bht704G-.js";import{u as Mt,_ as Ts}from"./bookshelfStore.Dj-iTrX1.js";import{_ as he}from"./CustomSelect.vue_vue_type_style_index_0_lang.CQaT8Lug.js";import{_ as oe,s as Us}from"./index.hqaqi8h8.js";import{B as As}from"./BaseModal.B5VqfWE9.js";import{fetchModels as Oe}from"./config.CwRcCkM9.js";import"./utils-vendor.B9ygI19o.js";import"./bookshelf.B4ums9uK.js";async function Bs(n,t){return q.post(`/api/manga-insight/${n}/analyze/start`,t,{timeout:0})}async function Es(n,t){return q.post(`/api/manga-insight/${n}/analyze/pause`,{task_id:t})}async function Ls(n,t){return q.post(`/api/manga-insight/${n}/analyze/resume`,{task_id:t})}async function Ds(n,t){return q.post(`/api/manga-insight/${n}/analyze/cancel`,{task_id:t})}async function Rt(n){return q.get(`/api/manga-insight/${n}/analyze/status`)}async function zs(n,t){return q.post(`/api/manga-insight/${n}/reanalyze/page/${t}`,{},{timeout:0})}async function Os(n,t){return q.get(`/api/manga-insight/${n}/pages/${t}`)}function Gs(n,t){return`/api/manga-insight/${n}/page-image/${t}`}function nt(n,t){return`/api/manga-insight/${n}/thumbnail/${t}`}async function Vs(n){return q.get(`/api/manga-insight/${n}/chapters`)}async function qs(n,t){return t?q.get(`/api/manga-insight/${n}/overview/${t}`):q.get(`/api/manga-insight/${n}/overview`)}async function Fs(n,t,l=!1){return q.post(`/api/manga-insight/${n}/overview/generate`,{template:t,force:l},{timeout:0})}async function Ks(n){return q.get(`/api/manga-insight/${n}/overview/templates`)}async function Ns(n){return q.get(`/api/manga-insight/${n}/timeline`)}async function js(n){return q.post(`/api/manga-insight/${n}/regenerate/timeline`,{},{timeout:0})}async function Hs(n,t,l){return q.post(`/api/manga-insight/${n}/chat`,{question:t,...l},{timeout:0})}async function Qs(n){return q.post(`/api/manga-insight/${n}/rebuild-embeddings`,{},{timeout:0})}async function Js(n,t){return q.get(`/api/manga-insight/${n}/notes`,{params:void 0})}async function Zs(n,t){return q.post(`/api/manga-insight/${n}/notes`,t)}async function Ws(n,t,l){return q.put(`/api/manga-insight/${n}/notes/${t}`,l)}async function Xs(n,t){return q.delete(`/api/manga-insight/${n}/notes/${t}`)}async function Ys(){return q.get("/api/manga-insight/config")}async function en(n){return q.post("/api/manga-insight/config",n)}async function tn(n){return q.post("/api/manga-insight/config/test/vlm",n)}async function sn(n){return q.post("/api/manga-insight/config/test/embedding",n)}async function nn(n){return q.post("/api/manga-insight/config/test/reranker",n)}async function an(n){return q.post("/api/manga-insight/config/test/llm",n)}const ft={batch_analysis:{label:"ðŸ“„ æ‰¹é‡åˆ†æžæç¤ºè¯",hint:"ç”¨äºŽæ‰¹é‡åˆ†æžå¤šä¸ªé¡µé¢ã€‚æ”¯æŒå˜é‡ï¼š{page_count}, {start_page}, {end_page}"},segment_summary:{label:"ðŸ“‘ æ®µè½æ€»ç»“æç¤ºè¯",hint:"ç”¨äºŽæ±‡æ€»å¤šä¸ªæ‰¹æ¬¡çš„åˆ†æžç»“æžœç”Ÿæˆæ®µè½æ€»ç»“ã€‚"},chapter_summary:{label:"ðŸ“– ç« èŠ‚æ€»ç»“æç¤ºè¯",hint:"ç”¨äºŽç”Ÿæˆç« èŠ‚çº§åˆ«çš„å®Œæ•´æ€»ç»“ã€‚"},qa_response:{label:"ðŸ’¬ é—®ç­”å“åº”æç¤ºè¯",hint:"ç”¨äºŽå›žç­”ç”¨æˆ·å…³äºŽæ¼«ç”»å†…å®¹çš„é—®é¢˜ã€‚"}};async function ln(){return q.get("/api/manga-insight/prompts/defaults")}async function on(){return q.get("/api/manga-insight/prompts/library")}async function rn(n){return q.post("/api/manga-insight/prompts/library",n)}async function un(n){return q.delete(`/api/manga-insight/prompts/library/${n}`)}async function cn(n){return q.post("/api/manga-insight/prompts/library/import",{library:n})}async function Tt(n){return q.get(`/api/manga-insight/${n}/export`)}function De(n){if(n==null)return n;if(Array.isArray(n))return n.map(l=>typeof l=="object"&&l!==null?De(l):l);if(typeof n!="object")return n;const t={};for(const[l,a]of Object.entries(n)){const s=dn(l);a!==null&&typeof a=="object"?Array.isArray(a)?t[s]=a.map(o=>typeof o=="object"&&o!==null?De(o):o):t[s]=De(a):t[s]=a}return t}function dn(n){return n.replace(/_([a-z])/g,(t,l)=>l.toUpperCase())}function pn(n){const{currentBookId:t}=n,l=y([]),a=y("all"),s=y(!1),o=y(null),i=G(()=>a.value==="all"?l.value:l.value.filter(w=>w.type===a.value));async function u(){if(!t.value){l.value=[];return}s.value=!0,o.value=null;try{const w=await Js(t.value);w.success&&w.notes&&(l.value=w.notes.map(x=>De(x)))}catch(w){console.error("åŠ è½½ç¬”è®°å¤±è´¥:",w),o.value=w instanceof Error?w.message:"åŠ è½½ç¬”è®°å¤±è´¥"}finally{s.value=!1}}async function r(w){if(!t.value)return null;try{const x=await Zs(t.value,{type:w.type,content:w.content,page_num:w.pageNum,title:w.title,tags:w.tags,question:w.question,answer:w.answer,citations:w.citations,comment:w.comment});if(x.success&&x.note){const S=De(x.note);return l.value.unshift(S),S}}catch(x){console.error("æ·»åŠ ç¬”è®°å¤±è´¥:",x),o.value=x instanceof Error?x.message:"æ·»åŠ ç¬”è®°å¤±è´¥"}return null}async function d(w,x){if(!t.value)return!1;try{if((await Ws(t.value,w,{content:x.content,page_num:x.pageNum,title:x.title,tags:x.tags,question:x.question,answer:x.answer,citations:x.citations,comment:x.comment})).success){const U=l.value.findIndex(R=>R.id===w);return U!==-1&&(l.value[U]={...l.value[U],...x,updatedAt:new Date().toISOString()}),!0}}catch(S){console.error("æ›´æ–°ç¬”è®°å¤±è´¥:",S),o.value=S instanceof Error?S.message:"æ›´æ–°ç¬”è®°å¤±è´¥"}return!1}async function m(w){if(!t.value)return!1;try{if((await Xs(t.value,w)).success)return l.value=l.value.filter(S=>S.id!==w),!0}catch(x){console.error("åˆ é™¤ç¬”è®°å¤±è´¥:",x),o.value=x instanceof Error?x.message:"åˆ é™¤ç¬”è®°å¤±è´¥"}return!1}function k(w){a.value=w}function $(){l.value=[]}return{notes:l,noteTypeFilter:a,filteredNotes:i,isLoading:s,error:o,loadNotes:u,addNote:r,updateNote:d,deleteNote:m,setNoteTypeFilter:k,clearNotes:$}}function vn(n){const t=y([]),l=y(!1);function a(k){const $={id:`user_${Date.now()}`,role:"user",content:k,timestamp:new Date().toISOString()};return t.value.push($),$}function s(k){const $={id:`assistant_${Date.now()}`,role:"assistant",content:"",timestamp:new Date().toISOString(),isLoading:!0,mode:k};return t.value.push($),$}function o(k,$){const w=t.value.findIndex(x=>x.id===k);w!==-1&&(t.value[w]={...t.value[w],...$})}function i(k,$){const w=t.value.findIndex(x=>x.id===k);if(w!==-1){const x=t.value[w];x&&(x.content+=$)}}function u(k){const $=t.value.findIndex(w=>w.id===k);if($!==-1){const w=t.value[$];w&&(w.saved=!0)}}function r(){t.value=[]}function d(){t.value.length>0&&t.value.pop()}function m(k){l.value=k}return{qaHistory:t,isStreaming:l,addUserMessage:a,addAssistantMessage:s,updateAssistantMessage:o,appendToAssistantMessage:i,markAsSaved:u,clearHistory:r,removeLastMessage:d,setStreaming:m}}const ht="insight_provider_configs";function mn(n){function t(){localStorage.setItem(ht,JSON.stringify(n.value))}function l(){const r=localStorage.getItem(ht);if(r)try{const d=JSON.parse(r);n.value={vlm:d.vlm||{},llm:d.llm||{},embedding:d.embedding||{},reranker:d.reranker||{}}}catch(d){console.error("[Insight] åŠ è½½æœåŠ¡å•†é…ç½®ç¼“å­˜å¤±è´¥:",d)}}function a(r,d,m,k){return{save($,w){if(!$)return;const x=n.value[r];x[$]=d(w),t()},restore($,w){if(!$)return;const S=n.value[r][$];S?m(w,S):m(w,k)},switch($,w,x){$!==w&&(this.save($,x),this.restore(w,x))}}}const s=a("vlm",r=>({apiKey:r.apiKey,model:r.model,baseUrl:r.baseUrl,rpmLimit:r.rpmLimit,temperature:r.temperature,forceJson:r.forceJson,useStream:r.useStream,imageMaxSize:r.imageMaxSize}),(r,d)=>{d.apiKey!==void 0&&(r.apiKey=d.apiKey),d.model!==void 0&&(r.model=d.model),d.baseUrl!==void 0&&(r.baseUrl=d.baseUrl),d.rpmLimit!==void 0&&(r.rpmLimit=d.rpmLimit),d.temperature!==void 0&&(r.temperature=d.temperature),d.forceJson!==void 0&&(r.forceJson=d.forceJson),d.useStream!==void 0&&(r.useStream=d.useStream),d.imageMaxSize!==void 0&&(r.imageMaxSize=d.imageMaxSize)},{apiKey:"",model:"",baseUrl:""}),o=a("llm",r=>({apiKey:r.apiKey,model:r.model,baseUrl:r.baseUrl,useStream:r.useStream}),(r,d)=>{d.apiKey!==void 0&&(r.apiKey=d.apiKey),d.model!==void 0&&(r.model=d.model),d.baseUrl!==void 0&&(r.baseUrl=d.baseUrl),d.useStream!==void 0&&(r.useStream=d.useStream)},{apiKey:"",model:"",baseUrl:""}),i=a("embedding",r=>({apiKey:r.apiKey,model:r.model,baseUrl:r.baseUrl,rpmLimit:r.rpmLimit}),(r,d)=>{d.apiKey!==void 0&&(r.apiKey=d.apiKey),d.model!==void 0&&(r.model=d.model),d.baseUrl!==void 0&&(r.baseUrl=d.baseUrl),d.rpmLimit!==void 0&&(r.rpmLimit=d.rpmLimit)},{apiKey:"",model:"",baseUrl:""}),u=a("reranker",r=>({apiKey:r.apiKey,model:r.model,baseUrl:r.baseUrl,topK:r.topK}),(r,d)=>{d.apiKey!==void 0&&(r.apiKey=d.apiKey),d.model!==void 0&&(r.model=d.model),d.baseUrl!==void 0&&(r.baseUrl=d.baseUrl),d.topK!==void 0&&(r.topK=d.topK)},{apiKey:"",model:"",baseUrl:""});return{saveToStorage:t,loadFromStorage:l,vlmManager:s,llmManager:o,embeddingManager:i,rerankerManager:u}}const ce=Ss("insight",()=>{const n=y(null),t=y(null),l=y("idle"),a=y({current:0,total:0,status:"idle"}),s=y(0),o=y(0),i=y("full"),u=y(!0),r=y([]),d=y(new Map),m=y(null),k=y([]),$=y([]),w=y(null),x=y(!1),S=y(null),U=y(0),R=pn({currentBookId:n}),D=vn(),f=y({vlm:{provider:"gemini",apiKey:"",model:"gemini-2.0-flash",baseUrl:"",rpmLimit:10,temperature:.3,forceJson:!1,useStream:!0,imageMaxSize:0},llm:{useSameAsVlm:!0,provider:"gemini",apiKey:"",model:"gemini-2.0-flash",baseUrl:"",useStream:!0},embedding:{provider:"openai",apiKey:"",model:"text-embedding-3-small",baseUrl:"",rpmLimit:0},reranker:{provider:"jina",apiKey:"",model:"jina-reranker-v2-base-multilingual",baseUrl:"",topK:5},imageGen:{provider:"siliconflow",apiKey:"",model:"stabilityai/stable-diffusion-3-5-large",baseUrl:"",maxRetries:3},batch:{pagesPerBatch:5,contextBatchCount:1,architecturePreset:"standard",customLayers:[]},prompts:{}}),b=y({vlm:{},llm:{},embedding:{},reranker:{}}),p=mn(b),c=G(()=>a.value.total===0?0:Math.round(a.value.current/a.value.total*100)),h=G(()=>l.value==="running"),P=G(()=>l.value==="completed"),T=G(()=>{if(o.value>0)return o.value;let B=0;return d.value.forEach(V=>{V.analyzed&&B++}),B}),M=G(()=>s.value||d.value.size),z=G(()=>w.value===null?null:d.value.get(w.value)||null);function Y(B){n.value=B,B?R.loadNotes():R.clearNotes()}function j(B){l.value=B,a.value.status=B}function A(B){t.value=B}function C(B,V,ge){a.value={current:B,total:V,status:l.value,message:ge}}function I(B){i.value=B}function L(B){u.value=B}function F(B){s.value=B}function re(B){o.value=B}function ve(B){r.value=B}function J(B,V){d.value.set(B,V)}function Z(B){d.value.clear(),B.forEach(V=>d.value.set(V.pageNum,V))}function le(B){w.value=B}function Pe(B){m.value=B,B&&!k.value.includes(B.type)&&k.value.push(B.type)}function xe(B){k.value=B}function Qt(B){$.value=B}function Jt(){U.value=Date.now()}function Zt(B){D.qaHistory.value.push(B)}function Wt(B){const V=D.qaHistory.value,ge=V[V.length-1];ge?.role==="assistant"&&(ge.content=B)}function Xt(){D.clearHistory()}function Yt(){D.qaHistory.value=D.qaHistory.value.filter(B=>!B.isLoading)}function es(B){D.setStreaming(B)}function ts(B){w.value=B}async function ss(B){if(!await R.addNote({type:B.type,content:B.content,pageNum:B.pageNum,title:B.title,tags:B.tags,question:B.question,answer:B.answer,citations:B.citations,comment:B.comment}))throw new Error("ä¿å­˜ç¬”è®°å¤±è´¥")}async function ns(B,V){await R.updateNote(B,V)}async function as(B){await R.deleteNote(B)}function ls(B){R.setNoteTypeFilter(B)}async function os(){await R.loadNotes()}function rs(B){x.value=B}function is(B){S.value=B}function us(B){f.value.vlm={...f.value.vlm,...B},p.vlmManager.save(f.value.vlm.provider,f.value.vlm),me()}function cs(B){f.value.llm={...f.value.llm,...B},p.llmManager.save(f.value.llm.provider,f.value.llm),me()}function ds(B){f.value.embedding={...f.value.embedding,...B},p.embeddingManager.save(f.value.embedding.provider,f.value.embedding),me()}function ps(B){f.value.reranker={...f.value.reranker,...B},p.rerankerManager.save(f.value.reranker.provider,f.value.reranker),me()}function vs(B){f.value.imageGen={...f.value.imageGen,...B},me()}function ms(B){f.value.batch={...f.value.batch,...B},me()}function gs(B){f.value.prompts={...f.value.prompts,...B},me()}function fs(B){f.value.vlm.provider!==B&&(p.vlmManager.switch(f.value.vlm.provider,B,f.value.vlm),f.value.vlm.provider=B,me())}function hs(B){f.value.llm.provider!==B&&(p.llmManager.switch(f.value.llm.provider,B,f.value.llm),f.value.llm.provider=B,me())}function bs(B){f.value.embedding.provider!==B&&(p.embeddingManager.switch(f.value.embedding.provider,B,f.value.embedding),f.value.embedding.provider=B,me())}function ys(B){f.value.reranker.provider!==B&&(p.rerankerManager.switch(f.value.reranker.provider,B,f.value.reranker),f.value.reranker.provider=B,me())}function ks(B){f.value=B,me()}function me(){localStorage.setItem("manga_insight_config",JSON.stringify(f.value))}function _s(){p.loadFromStorage();const B=localStorage.getItem("manga_insight_config");if(B)try{const V=JSON.parse(B);f.value={vlm:{...f.value.vlm,...V.vlm},llm:{...f.value.llm,...V.llm},embedding:{...f.value.embedding,...V.embedding},reranker:{...f.value.reranker,...V.reranker},imageGen:{...f.value.imageGen,...V.imageGen},batch:{...f.value.batch,...V.batch},prompts:V.prompts||{}}}catch(V){console.error("åŠ è½½é…ç½®å¤±è´¥:",V)}}function $s(){const B=(V,ge)=>Object.fromEntries(Object.entries(V).map(([Ce,Se])=>[Ce,ge(Se)]));return{vlm:{provider:f.value.vlm.provider,api_key:f.value.vlm.apiKey,model:f.value.vlm.model,base_url:f.value.vlm.baseUrl||null,rpm_limit:f.value.vlm.rpmLimit,temperature:f.value.vlm.temperature,force_json:f.value.vlm.forceJson,use_stream:f.value.vlm.useStream,image_max_size:f.value.vlm.imageMaxSize},chat_llm:{use_same_as_vlm:f.value.llm.useSameAsVlm,provider:f.value.llm.provider,api_key:f.value.llm.apiKey,model:f.value.llm.model,base_url:f.value.llm.baseUrl||null,use_stream:f.value.llm.useStream},embedding:{provider:f.value.embedding.provider,api_key:f.value.embedding.apiKey,model:f.value.embedding.model,base_url:f.value.embedding.baseUrl||null,rpm_limit:f.value.embedding.rpmLimit},reranker:{provider:f.value.reranker.provider,api_key:f.value.reranker.apiKey,model:f.value.reranker.model,base_url:f.value.reranker.baseUrl||null,top_k:f.value.reranker.topK},image_gen:{provider:f.value.imageGen.provider,api_key:f.value.imageGen.apiKey,model:f.value.imageGen.model,base_url:f.value.imageGen.baseUrl||null,max_retries:f.value.imageGen.maxRetries},analysis:{batch:{pages_per_batch:f.value.batch.pagesPerBatch,context_batch_count:f.value.batch.contextBatchCount,architecture_preset:f.value.batch.architecturePreset,custom_layers:f.value.batch.customLayers.map(V=>({name:V.name,units_per_group:V.units,align_to_chapter:V.align}))}},prompts:f.value.prompts,providerSettings:{vlmProvider:B(b.value.vlm,V=>({api_key:V.apiKey||"",model:V.model||"",base_url:V.baseUrl||"",rpm_limit:V.rpmLimit??10,temperature:V.temperature??.3,force_json:V.forceJson??!1,use_stream:V.useStream??!0,image_max_size:V.imageMaxSize??0})),llmProvider:B(b.value.llm,V=>({api_key:V.apiKey||"",model:V.model||"",base_url:V.baseUrl||"",use_stream:V.useStream??!0})),embeddingProvider:B(b.value.embedding,V=>({api_key:V.apiKey||"",model:V.model||"",base_url:V.baseUrl||"",rpm_limit:V.rpmLimit??0})),rerankerProvider:B(b.value.reranker,V=>({api_key:V.apiKey||"",model:V.model||"",base_url:V.baseUrl||"",top_k:V.topK??5}))}}}function ws(B){const V=B.vlm,ge=B.chat_llm,Ce=B.embedding,Se=B.reranker,Ae=B.analysis?.batch,Te=B.image_gen;if(V&&(f.value.vlm={provider:V.provider||"gemini",apiKey:V.api_key||"",model:V.model||"",baseUrl:V.base_url||"",rpmLimit:V.rpm_limit||10,temperature:V.temperature||.3,forceJson:V.force_json||!1,useStream:V.use_stream!==!1,imageMaxSize:V.image_max_size||0}),ge&&(f.value.llm={useSameAsVlm:ge.use_same_as_vlm!==!1,provider:ge.provider||f.value.vlm.provider,apiKey:ge.api_key||f.value.vlm.apiKey,model:ge.model||f.value.vlm.model,baseUrl:ge.base_url||f.value.vlm.baseUrl,useStream:ge.use_stream!==!1}),Ce&&(f.value.embedding={provider:Ce.provider||"openai",apiKey:Ce.api_key||"",model:Ce.model||"",baseUrl:Ce.base_url||"",rpmLimit:Ce.rpm_limit??0}),Se&&(f.value.reranker={provider:Se.provider||"jina",apiKey:Se.api_key||"",model:Se.model||"",baseUrl:Se.base_url||"",topK:Se.top_k||5}),Ae){const $e=Ae.custom_layers;f.value.batch={pagesPerBatch:Ae.pages_per_batch||5,contextBatchCount:Ae.context_batch_count??1,architecturePreset:Ae.architecture_preset||"standard",customLayers:$e?.map(ae=>({name:ae.name||"",units:ae.units_per_group||1,align:ae.align_to_chapter||!1}))||[]}}Te&&(f.value.imageGen={provider:Te.provider||"siliconflow",apiKey:Te.api_key||"",model:Te.model||"stabilityai/stable-diffusion-3-5-large",baseUrl:Te.base_url||"",maxRetries:Te.max_retries||3});const _e=B.providerSettings;if(_e){if(_e.vlmProvider)for(const[$e,ae]of Object.entries(_e.vlmProvider))b.value.vlm[$e]={apiKey:ae.api_key||"",model:ae.model||"",baseUrl:ae.base_url||"",rpmLimit:ae.rpm_limit??10,temperature:ae.temperature??.3,forceJson:ae.force_json??!1,useStream:ae.use_stream??!0,imageMaxSize:ae.image_max_size??0};if(_e.llmProvider)for(const[$e,ae]of Object.entries(_e.llmProvider))b.value.llm[$e]={apiKey:ae.api_key||"",model:ae.model||"",baseUrl:ae.base_url||"",useStream:ae.use_stream??!0};if(_e.embeddingProvider)for(const[$e,ae]of Object.entries(_e.embeddingProvider))b.value.embedding[$e]={apiKey:ae.api_key||"",model:ae.model||"",baseUrl:ae.base_url||"",rpmLimit:ae.rpm_limit??0};if(_e.rerankerProvider)for(const[$e,ae]of Object.entries(_e.rerankerProvider))b.value.reranker[$e]={apiKey:ae.api_key||"",model:ae.model||"",baseUrl:ae.base_url||"",topK:ae.top_k??5};p.saveToStorage()}B.prompts&&(f.value.prompts=B.prompts),me(),p.vlmManager.save(f.value.vlm.provider,f.value.vlm),p.llmManager.save(f.value.llm.provider,f.value.llm),p.embeddingManager.save(f.value.embedding.provider,f.value.embedding),p.rerankerManager.save(f.value.reranker.provider,f.value.reranker)}function xs(){l.value="idle",a.value={current:0,total:0,status:"idle"},d.value.clear(),m.value=null,$.value=[]}function Cs(){n.value=null,l.value="idle",a.value={current:0,total:0,status:"idle"},i.value="full",u.value=!0,r.value=[],d.value.clear(),m.value=null,k.value=[],$.value=[],D.clearHistory(),R.clearNotes(),w.value=null,R.setNoteTypeFilter("all"),x.value=!1,D.setStreaming(!1),S.value=null}return{currentBookId:n,currentTaskId:t,analysisStatus:l,progress:a,analysisMode:i,incrementalAnalysis:u,chapters:r,pages:d,overview:m,generatedTemplates:k,timeline:$,qaHistory:D.qaHistory,notes:R.notes,selectedPageNum:w,noteTypeFilter:R.noteTypeFilter,isLoading:x,isStreaming:D.isStreaming,error:S,config:f,progressPercent:c,isAnalyzing:h,isAnalysisCompleted:P,analyzedPageCount:T,totalPageCount:M,filteredNotes:R.filteredNotes,selectedPage:z,setCurrentBook:Y,setCurrentTaskId:A,setAnalysisStatus:j,updateProgress:C,setAnalysisMode:I,setIncrementalAnalysis:L,setBookTotalPages:F,setAnalyzedPagesCount:re,setChapters:ve,setPageData:J,setPages:Z,selectPage:le,setOverview:Pe,setGeneratedTemplates:xe,setTimeline:Qt,dataRefreshKey:U,triggerDataRefresh:Jt,addQAMessage:Zt,updateLastAssistantMessage:Wt,clearQAHistory:Xt,removeLoadingMessages:Yt,setStreaming:es,setCurrentPage:ts,addNote:ss,updateNote:ns,deleteNote:as,setNoteTypeFilter:ls,loadNotesFromAPI:os,setLoading:rs,setError:is,updateVlmConfig:us,updateLlmConfig:cs,updateEmbeddingConfig:ds,updateRerankerConfig:ps,updateImageGenConfig:vs,updateBatchConfig:ms,updatePrompts:gs,setConfig:ks,saveConfigToStorage:me,loadConfigFromStorage:_s,getConfigForApi:$s,setConfigFromApi:ws,setVlmProvider:fs,setLlmProvider:hs,setEmbeddingProvider:bs,setRerankerProvider:ys,resetAnalysis:xs,reset:Cs}}),gn={class:"book-selector"},fn=te({__name:"BookSelector",emits:["select"],setup(n,{emit:t}){const l=t,a=Mt(),s=G(()=>a.books),o=G(()=>{const r=[{label:"-- é€‰æ‹©ä¹¦ç± --",value:""}];return s.value.forEach(d=>{r.push({label:d.title||d.id,value:d.id})}),r}),i=y("");function u(r){const d=String(r);i.value=d,d&&l("select",d)}return(r,d)=>(v(),g("div",gn,[X(he,{modelValue:i.value,"onUpdate:modelValue":d[0]||(d[0]=m=>i.value=m),options:o.value,onChange:u},null,8,["modelValue","options"])]))}}),hn=oe(fn,[["__scopeId","data-v-d6052909"]]),bn={class:"sidebar-section analysis-control-compact"},yn={class:"analysis-status-bar"},kn={class:"status-left"},_n={class:"status-label"},$n={class:"status-right"},wn={class:"status-progress"},xn={key:1,class:"progress-message"},Cn={class:"analysis-btn-group"},Sn={key:0,class:"btn-group-idle"},Pn=["disabled"],In={key:0,width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor"},Mn={key:1,class:"loading-spinner"},Rn={key:1,class:"btn-group-running"},Tn={key:2,class:"btn-group-paused"},Un={key:4,class:"page-input-wrapper"},An=["max"],Bn={class:"page-hint"},En={key:5,class:"mode-description"},Ln={key:6,class:"estimated-time"},Dn={class:"analysis-options-row"},zn={class:"checkbox-compact",title:"ä»…åˆ†æžæœªåˆ†æžçš„é¡µé¢ï¼Œè·³è¿‡å·²åˆ†æžçš„é¡µé¢"},On=["checked"],Gn=["disabled"],Vn=te({__name:"AnalysisProgress",emits:["start-polling","stop-polling"],setup(n,{emit:t}){const l=[{label:"å…¨ä¹¦",value:"full"},{label:"ç« èŠ‚",value:"chapter"},{label:"å•é¡µ",value:"page"}],a=G(()=>{const A=[{label:"é€‰æ‹©ç« èŠ‚...",value:""}];return o.chapters.forEach(C=>{A.push({label:`${C.title} (${C.startPage}-${C.endPage}é¡µ)`,value:C.id})}),A}),s=t,o=ce(),i=y("full"),u=y(""),r=y(null),d=y(!1),m=y(""),k=G(()=>{const A=o.analysisStatus;return{"status-dot":!0,running:A==="running",paused:A==="paused",completed:A==="completed",failed:A==="failed"}}),$=G(()=>{switch(o.analysisStatus){case"running":return"åˆ†æžä¸­";case"paused":return"å·²æš‚åœ";case"completed":return"å·²å®Œæˆ";case"failed":return"åˆ†æžå¤±è´¥";default:return"æœªåˆ†æž"}}),w=G(()=>{const{current:A,total:C}=o.progress;return C===0?"":`${A}/${C}`}),x=G(()=>o.analysisStatus==="idle"||o.analysisStatus==="completed"),S=G(()=>o.analysisStatus==="running"),U=G(()=>o.analysisStatus==="paused"),R=G(()=>o.analysisStatus==="completed"?"é‡æ–°åˆ†æž":"å¼€å§‹åˆ†æž"),D=G(()=>i.value==="chapter"),f=G(()=>i.value==="page"),b=G(()=>!(d.value||o.isAnalyzing||i.value==="chapter"&&!u.value||i.value==="page"&&!r.value)),p=G(()=>{switch(i.value){case"full":return"åˆ†æžæ•´æœ¬ä¹¦çš„æ‰€æœ‰é¡µé¢";case"chapter":return"ä»…åˆ†æžé€‰ä¸­ç« èŠ‚çš„é¡µé¢";case"page":return"ä»…åˆ†æžæŒ‡å®šçš„å•ä¸ªé¡µé¢";default:return""}}),c=G(()=>{const A=o.totalPageCount;if(A===0)return"";const C=o.config.batch.pagesPerBatch||5,L=Math.ceil(A/C)*10;return L<60?`çº¦ ${L} ç§’`:`çº¦ ${Math.ceil(L/60)} åˆ†é’Ÿ`});function h(){o.setAnalysisMode(i.value)}async function P(){if(o.currentBookId){if(o.isAnalyzing||d.value){console.warn("åˆ†æžæ­£åœ¨è¿›è¡Œä¸­æˆ–æ­£åœ¨å¯åŠ¨");return}if(i.value==="chapter"&&!u.value){m.value="è¯·é€‰æ‹©è¦åˆ†æžçš„ç« èŠ‚";return}if(i.value==="page"&&!r.value){m.value="è¯·è¾“å…¥è¦åˆ†æžçš„é¡µç ";return}d.value=!0,m.value="";try{const A={};i.value==="chapter"&&u.value?(A.mode="chapters",A.chapters=[u.value]):i.value==="page"&&r.value?(A.mode="pages",A.pages=[r.value]):A.mode=o.incrementalAnalysis?"incremental":"full";const C=await Bs(o.currentBookId,A);C.success?(C.task_id&&o.setCurrentTaskId(C.task_id),o.setAnalysisStatus("running"),s("start-polling")):(m.value=C.error||"å¯åŠ¨åˆ†æžå¤±è´¥",console.error("å¯åŠ¨åˆ†æžå¤±è´¥:",C.error))}catch(A){m.value=A instanceof Error?A.message:"å¯åŠ¨åˆ†æžå¤±è´¥",console.error("å¯åŠ¨åˆ†æžå¤±è´¥:",A)}finally{d.value=!1}}}async function T(){if(o.currentBookId)try{(await Es(o.currentBookId,o.currentTaskId||void 0)).success&&o.setAnalysisStatus("paused")}catch(A){console.error("æš‚åœåˆ†æžå¤±è´¥:",A)}}async function M(){if(o.currentBookId)try{(await Ls(o.currentBookId,o.currentTaskId||void 0)).success&&(o.setAnalysisStatus("running"),s("start-polling"))}catch(A){console.error("ç»§ç»­åˆ†æžå¤±è´¥:",A)}}async function z(){if(o.currentBookId&&confirm("ç¡®å®šè¦å–æ¶ˆåˆ†æžå—ï¼Ÿ"))try{(await Ds(o.currentBookId,o.currentTaskId||void 0)).success&&(o.setAnalysisStatus("idle"),o.setCurrentTaskId(null),s("stop-polling"))}catch(A){console.error("å–æ¶ˆåˆ†æžå¤±è´¥:",A)}}async function Y(){if(!o.currentBookId){m.value="è¯·å…ˆé€‰æ‹©ä¹¦ç±";return}try{const A=await Tt(o.currentBookId);if(A.success&&A.markdown){const C=new Blob([A.markdown],{type:"text/markdown"}),I=URL.createObjectURL(C),L=document.createElement("a");L.href=I,L.download=`${o.currentBookId}_analysis.md`,L.click(),URL.revokeObjectURL(I)}else m.value=A.error||"å¯¼å‡ºå¤±è´¥"}catch(A){m.value=A instanceof Error?A.message:"å¯¼å‡ºå¤±è´¥",console.error("å¯¼å‡ºå¤±è´¥:",A)}}function j(){m.value=""}return ue(i,()=>{j()}),(A,C)=>(v(),g("div",bn,[e("div",yn,[e("div",kn,[e("span",{class:H(k.value)},null,2),e("span",_n,_($.value),1)]),e("div",$n,[e("span",wn,_(w.value),1)])]),S.value||U.value?(v(),g("div",{key:0,class:H(["progress-bar-slim",{paused:U.value}])},[e("div",{class:"progress-fill-slim",style:Pt({width:K(o).progressPercent+"%"})},null,4)],2)):E("",!0),K(o).progress.message&&(S.value||U.value)?(v(),g("div",xn,_(K(o).progress.message),1)):E("",!0),m.value?(v(),g("div",{key:2,class:"error-message",onClick:j}," âš ï¸ "+_(m.value),1)):E("",!0),e("div",Cn,[x.value?(v(),g("div",Sn,[X(he,{modelValue:i.value,"onUpdate:modelValue":C[0]||(C[0]=I=>i.value=I),options:l,onChange:h},null,8,["modelValue"]),e("button",{class:H(["btn-analysis-start",{loading:d.value}]),disabled:!b.value,onClick:P},[d.value?E("",!0):(v(),g("svg",In,[...C[4]||(C[4]=[e("path",{d:"M8 5v14l11-7z"},null,-1)])])),d.value?(v(),g("span",Mn)):E("",!0),e("span",null,_(d.value?"å¯åŠ¨ä¸­...":R.value),1)],10,Pn)])):E("",!0),S.value?(v(),g("div",Rn,[e("button",{class:"btn-control btn-pause",title:"æš‚åœåˆ†æž",onClick:T},[...C[5]||(C[5]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"})],-1),e("span",{class:"btn-label"},"æš‚åœ",-1)])]),e("button",{class:"btn-control btn-cancel",title:"å–æ¶ˆåˆ†æž",onClick:z},[...C[6]||(C[6]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M6 6h12v12H6z"})],-1),e("span",{class:"btn-label"},"å–æ¶ˆ",-1)])])])):E("",!0),U.value?(v(),g("div",Tn,[e("button",{class:"btn-control btn-resume",title:"ç»§ç»­åˆ†æž",onClick:M},[...C[7]||(C[7]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M8 5v14l11-7z"})],-1),e("span",{class:"btn-label"},"ç»§ç»­",-1)])]),e("button",{class:"btn-control btn-cancel",title:"å–æ¶ˆåˆ†æž",onClick:z},[...C[8]||(C[8]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M6 6h12v12H6z"})],-1),e("span",{class:"btn-label"},"å–æ¶ˆ",-1)])])])):E("",!0)]),D.value?(v(),fe(he,{key:3,modelValue:u.value,"onUpdate:modelValue":C[1]||(C[1]=I=>u.value=I),options:a.value},null,8,["modelValue","options"])):E("",!0),f.value?(v(),g("div",Un,[O(e("input",{"onUpdate:modelValue":C[2]||(C[2]=I=>r.value=I),type:"number",class:"form-input-compact",placeholder:"è¾“å…¥é¡µç ",min:"1",max:K(o).totalPageCount||void 0},null,8,An),[[N,r.value,void 0,{number:!0}]]),e("span",Bn,"/ "+_(K(o).totalPageCount||"?"),1)])):E("",!0),x.value&&p.value?(v(),g("div",En,_(p.value),1)):E("",!0),x.value&&i.value==="full"&&c.value?(v(),g("div",Ln," â±ï¸ "+_(c.value),1)):E("",!0),e("div",Dn,[e("label",zn,[e("input",{type:"checkbox",checked:K(o).incrementalAnalysis,onChange:C[3]||(C[3]=I=>K(o).setIncrementalAnalysis(I.target.checked))},null,40,On),C[9]||(C[9]=e("span",null,"å¢žé‡æ¨¡å¼",-1))]),e("button",{class:"btn-icon-sm",title:"å¯¼å‡ºåˆ†æžæŠ¥å‘Š",disabled:K(o).analyzedPageCount===0,onClick:Y},[...C[10]||(C[10]=[e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e("polyline",{points:"7 10 12 15 17 10"}),e("line",{x1:"12",y1:"15",x2:"12",y2:"3"})],-1)])],8,Gn)])]))}}),qn=oe(Vn,[["__scopeId","data-v-1421f4fe"]]);function at(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var Re=at();function Ut(n){Re=n}var ze={exec:()=>null};function ee(n,t=""){let l=typeof n=="string"?n:n.source,a={replace:(s,o)=>{let i=typeof o=="string"?o:o.source;return i=i.replace(pe.caret,"$1"),l=l.replace(s,i),a},getRegex:()=>new RegExp(l,t)};return a}var Fn=(()=>{try{return!!new RegExp("(?<=1)(?<!1)")}catch{return!1}})(),pe={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] +\S/,listReplaceTask:/^\[[ xX]\] +/,listTaskCheckbox:/\[[ xX]\]/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:n=>new RegExp(`^( {0,3}${n})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}#`),htmlBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}<(?:[a-z].*>|!--)`,"i")},Kn=/^(?:[ \t]*(?:\n|$))+/,Nn=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,jn=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,Ge=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,Hn=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,lt=/(?:[*+-]|\d{1,9}[.)])/,At=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,Bt=ee(At).replace(/bull/g,lt).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),Qn=ee(At).replace(/bull/g,lt).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),ot=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,Jn=/^[^\n]+/,rt=/(?!\s*\])(?:\\[\s\S]|[^\[\]\\])+/,Zn=ee(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",rt).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),Wn=ee(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,lt).getRegex(),Ze="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",it=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,Xn=ee("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",it).replace("tag",Ze).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),Et=ee(ot).replace("hr",Ge).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Ze).getRegex(),Yn=ee(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",Et).getRegex(),ut={blockquote:Yn,code:Nn,def:Zn,fences:jn,heading:Hn,hr:Ge,html:Xn,lheading:Bt,list:Wn,newline:Kn,paragraph:Et,table:ze,text:Jn},bt=ee("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",Ge).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Ze).getRegex(),ea={...ut,lheading:Qn,table:bt,paragraph:ee(ot).replace("hr",Ge).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",bt).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Ze).getRegex()},ta={...ut,html:ee(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",it).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:ze,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:ee(ot).replace("hr",Ge).replace("heading",` *#{1,6} *[^
]`).replace("lheading",Bt).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},sa=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,na=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,Lt=/^( {2,}|\\)\n(?!\s*$)/,aa=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,We=/[\p{P}\p{S}]/u,ct=/[\s\p{P}\p{S}]/u,Dt=/[^\s\p{P}\p{S}]/u,la=ee(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,ct).getRegex(),zt=/(?!~)[\p{P}\p{S}]/u,oa=/(?!~)[\s\p{P}\p{S}]/u,ra=/(?:[^\s\p{P}\p{S}]|~)/u,ia=ee(/link|precode-code|html/,"g").replace("link",/\[(?:[^\[\]`]|(?<a>`+)[^`]+\k<a>(?!`))*?\]\((?:\\[\s\S]|[^\\\(\)]|\((?:\\[\s\S]|[^\\\(\)])*\))*\)/).replace("precode-",Fn?"(?<!`)()":"(^^|[^`])").replace("code",/(?<b>`+)[^`]+\k<b>(?!`)/).replace("html",/<(?! )[^<>]*?>/).getRegex(),Ot=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,ua=ee(Ot,"u").replace(/punct/g,We).getRegex(),ca=ee(Ot,"u").replace(/punct/g,zt).getRegex(),Gt="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",da=ee(Gt,"gu").replace(/notPunctSpace/g,Dt).replace(/punctSpace/g,ct).replace(/punct/g,We).getRegex(),pa=ee(Gt,"gu").replace(/notPunctSpace/g,ra).replace(/punctSpace/g,oa).replace(/punct/g,zt).getRegex(),va=ee("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,Dt).replace(/punctSpace/g,ct).replace(/punct/g,We).getRegex(),ma=ee(/\\(punct)/,"gu").replace(/punct/g,We).getRegex(),ga=ee(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),fa=ee(it).replace("(?:-->|$)","-->").getRegex(),ha=ee("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",fa).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),He=/(?:\[(?:\\[\s\S]|[^\[\]\\])*\]|\\[\s\S]|`+[^`]*?`+(?!`)|[^\[\]\\`])*?/,ba=ee(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",He).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),Vt=ee(/^!?\[(label)\]\[(ref)\]/).replace("label",He).replace("ref",rt).getRegex(),qt=ee(/^!?\[(ref)\](?:\[\])?/).replace("ref",rt).getRegex(),ya=ee("reflink|nolink(?!\\()","g").replace("reflink",Vt).replace("nolink",qt).getRegex(),yt=/[hH][tT][tT][pP][sS]?|[fF][tT][pP]/,dt={_backpedal:ze,anyPunctuation:ma,autolink:ga,blockSkip:ia,br:Lt,code:na,del:ze,emStrongLDelim:ua,emStrongRDelimAst:da,emStrongRDelimUnd:va,escape:sa,link:ba,nolink:qt,punctuation:la,reflink:Vt,reflinkSearch:ya,tag:ha,text:aa,url:ze},ka={...dt,link:ee(/^!?\[(label)\]\((.*?)\)/).replace("label",He).getRegex(),reflink:ee(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",He).getRegex()},et={...dt,emStrongRDelimAst:pa,emStrongLDelim:ca,url:ee(/^((?:protocol):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/).replace("protocol",yt).replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\[\s\S]|[^\\])*?(?:\\[\s\S]|[^\s~\\]))\1(?=[^~]|$)/,text:ee(/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|protocol:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/).replace("protocol",yt).getRegex()},_a={...et,br:ee(Lt).replace("{2,}","*").getRegex(),text:ee(et.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},Ke={normal:ut,gfm:ea,pedantic:ta},Be={normal:dt,gfm:et,breaks:_a,pedantic:ka},$a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},kt=n=>$a[n];function we(n,t){if(t){if(pe.escapeTest.test(n))return n.replace(pe.escapeReplace,kt)}else if(pe.escapeTestNoEncode.test(n))return n.replace(pe.escapeReplaceNoEncode,kt);return n}function _t(n){try{n=encodeURI(n).replace(pe.percentDecode,"%")}catch{return null}return n}function $t(n,t){let l=n.replace(pe.findPipe,(o,i,u)=>{let r=!1,d=i;for(;--d>=0&&u[d]==="\\";)r=!r;return r?"|":" |"}),a=l.split(pe.splitPipe),s=0;if(a[0].trim()||a.shift(),a.length>0&&!a.at(-1)?.trim()&&a.pop(),t)if(a.length>t)a.splice(t);else for(;a.length<t;)a.push("");for(;s<a.length;s++)a[s]=a[s].trim().replace(pe.slashPipe,"|");return a}function Ee(n,t,l){let a=n.length;if(a===0)return"";let s=0;for(;s<a&&n.charAt(a-s-1)===t;)s++;return n.slice(0,a-s)}function wa(n,t){if(n.indexOf(t[1])===-1)return-1;let l=0;for(let a=0;a<n.length;a++)if(n[a]==="\\")a++;else if(n[a]===t[0])l++;else if(n[a]===t[1]&&(l--,l<0))return a;return l>0?-2:-1}function wt(n,t,l,a,s){let o=t.href,i=t.title||null,u=n[1].replace(s.other.outputLinkReplace,"$1");a.state.inLink=!0;let r={type:n[0].charAt(0)==="!"?"image":"link",raw:l,href:o,title:i,text:u,tokens:a.inlineTokens(u)};return a.state.inLink=!1,r}function xa(n,t,l){let a=n.match(l.other.indentCodeCompensation);if(a===null)return t;let s=a[1];return t.split(`
`).map(o=>{let i=o.match(l.other.beginningSpace);if(i===null)return o;let[u]=i;return u.length>=s.length?o.slice(s.length):o}).join(`
`)}var Qe=class{options;rules;lexer;constructor(n){this.options=n||Re}space(n){let t=this.rules.block.newline.exec(n);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(n){let t=this.rules.block.code.exec(n);if(t){let l=t[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?l:Ee(l,`
`)}}}fences(n){let t=this.rules.block.fences.exec(n);if(t){let l=t[0],a=xa(l,t[3]||"",this.rules);return{type:"code",raw:l,lang:t[2]?t[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):t[2],text:a}}}heading(n){let t=this.rules.block.heading.exec(n);if(t){let l=t[2].trim();if(this.rules.other.endingHash.test(l)){let a=Ee(l,"#");(this.options.pedantic||!a||this.rules.other.endingSpaceChar.test(a))&&(l=a.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:l,tokens:this.lexer.inline(l)}}}hr(n){let t=this.rules.block.hr.exec(n);if(t)return{type:"hr",raw:Ee(t[0],`
`)}}blockquote(n){let t=this.rules.block.blockquote.exec(n);if(t){let l=Ee(t[0],`
`).split(`
`),a="",s="",o=[];for(;l.length>0;){let i=!1,u=[],r;for(r=0;r<l.length;r++)if(this.rules.other.blockquoteStart.test(l[r]))u.push(l[r]),i=!0;else if(!i)u.push(l[r]);else break;l=l.slice(r);let d=u.join(`
`),m=d.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");a=a?`${a}
${d}`:d,s=s?`${s}
${m}`:m;let k=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(m,o,!0),this.lexer.state.top=k,l.length===0)break;let $=o.at(-1);if($?.type==="code")break;if($?.type==="blockquote"){let w=$,x=w.raw+`
`+l.join(`
`),S=this.blockquote(x);o[o.length-1]=S,a=a.substring(0,a.length-w.raw.length)+S.raw,s=s.substring(0,s.length-w.text.length)+S.text;break}else if($?.type==="list"){let w=$,x=w.raw+`
`+l.join(`
`),S=this.list(x);o[o.length-1]=S,a=a.substring(0,a.length-$.raw.length)+S.raw,s=s.substring(0,s.length-w.raw.length)+S.raw,l=x.substring(o.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:a,tokens:o,text:s}}}list(n){let t=this.rules.block.list.exec(n);if(t){let l=t[1].trim(),a=l.length>1,s={type:"list",raw:"",ordered:a,start:a?+l.slice(0,-1):"",loose:!1,items:[]};l=a?`\\d{1,9}\\${l.slice(-1)}`:`\\${l}`,this.options.pedantic&&(l=a?l:"[*+-]");let o=this.rules.other.listItemRegex(l),i=!1;for(;n;){let r=!1,d="",m="";if(!(t=o.exec(n))||this.rules.block.hr.test(n))break;d=t[0],n=n.substring(d.length);let k=t[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,S=>" ".repeat(3*S.length)),$=n.split(`
`,1)[0],w=!k.trim(),x=0;if(this.options.pedantic?(x=2,m=k.trimStart()):w?x=t[1].length+1:(x=t[2].search(this.rules.other.nonSpaceChar),x=x>4?1:x,m=k.slice(x),x+=t[1].length),w&&this.rules.other.blankLine.test($)&&(d+=$+`
`,n=n.substring($.length+1),r=!0),!r){let S=this.rules.other.nextBulletRegex(x),U=this.rules.other.hrRegex(x),R=this.rules.other.fencesBeginRegex(x),D=this.rules.other.headingBeginRegex(x),f=this.rules.other.htmlBeginRegex(x);for(;n;){let b=n.split(`
`,1)[0],p;if($=b,this.options.pedantic?($=$.replace(this.rules.other.listReplaceNesting,"  "),p=$):p=$.replace(this.rules.other.tabCharGlobal,"    "),R.test($)||D.test($)||f.test($)||S.test($)||U.test($))break;if(p.search(this.rules.other.nonSpaceChar)>=x||!$.trim())m+=`
`+p.slice(x);else{if(w||k.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||R.test(k)||D.test(k)||U.test(k))break;m+=`
`+$}!w&&!$.trim()&&(w=!0),d+=b+`
`,n=n.substring(b.length+1),k=p.slice(x)}}s.loose||(i?s.loose=!0:this.rules.other.doubleBlankLine.test(d)&&(i=!0)),s.items.push({type:"list_item",raw:d,task:!!this.options.gfm&&this.rules.other.listIsTask.test(m),loose:!1,text:m,tokens:[]}),s.raw+=d}let u=s.items.at(-1);if(u)u.raw=u.raw.trimEnd(),u.text=u.text.trimEnd();else return;s.raw=s.raw.trimEnd();for(let r of s.items){if(this.lexer.state.top=!1,r.tokens=this.lexer.blockTokens(r.text,[]),r.task){if(r.text=r.text.replace(this.rules.other.listReplaceTask,""),r.tokens[0]?.type==="text"||r.tokens[0]?.type==="paragraph"){r.tokens[0].raw=r.tokens[0].raw.replace(this.rules.other.listReplaceTask,""),r.tokens[0].text=r.tokens[0].text.replace(this.rules.other.listReplaceTask,"");for(let m=this.lexer.inlineQueue.length-1;m>=0;m--)if(this.rules.other.listIsTask.test(this.lexer.inlineQueue[m].src)){this.lexer.inlineQueue[m].src=this.lexer.inlineQueue[m].src.replace(this.rules.other.listReplaceTask,"");break}}let d=this.rules.other.listTaskCheckbox.exec(r.raw);if(d){let m={type:"checkbox",raw:d[0]+" ",checked:d[0]!=="[ ]"};r.checked=m.checked,s.loose?r.tokens[0]&&["paragraph","text"].includes(r.tokens[0].type)&&"tokens"in r.tokens[0]&&r.tokens[0].tokens?(r.tokens[0].raw=m.raw+r.tokens[0].raw,r.tokens[0].text=m.raw+r.tokens[0].text,r.tokens[0].tokens.unshift(m)):r.tokens.unshift({type:"paragraph",raw:m.raw,text:m.raw,tokens:[m]}):r.tokens.unshift(m)}}if(!s.loose){let d=r.tokens.filter(k=>k.type==="space"),m=d.length>0&&d.some(k=>this.rules.other.anyLine.test(k.raw));s.loose=m}}if(s.loose)for(let r of s.items){r.loose=!0;for(let d of r.tokens)d.type==="text"&&(d.type="paragraph")}return s}}html(n){let t=this.rules.block.html.exec(n);if(t)return{type:"html",block:!0,raw:t[0],pre:t[1]==="pre"||t[1]==="script"||t[1]==="style",text:t[0]}}def(n){let t=this.rules.block.def.exec(n);if(t){let l=t[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),a=t[2]?t[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",s=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):t[3];return{type:"def",tag:l,raw:t[0],href:a,title:s}}}table(n){let t=this.rules.block.table.exec(n);if(!t||!this.rules.other.tableDelimiter.test(t[2]))return;let l=$t(t[1]),a=t[2].replace(this.rules.other.tableAlignChars,"").split("|"),s=t[3]?.trim()?t[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],o={type:"table",raw:t[0],header:[],align:[],rows:[]};if(l.length===a.length){for(let i of a)this.rules.other.tableAlignRight.test(i)?o.align.push("right"):this.rules.other.tableAlignCenter.test(i)?o.align.push("center"):this.rules.other.tableAlignLeft.test(i)?o.align.push("left"):o.align.push(null);for(let i=0;i<l.length;i++)o.header.push({text:l[i],tokens:this.lexer.inline(l[i]),header:!0,align:o.align[i]});for(let i of s)o.rows.push($t(i,o.header.length).map((u,r)=>({text:u,tokens:this.lexer.inline(u),header:!1,align:o.align[r]})));return o}}lheading(n){let t=this.rules.block.lheading.exec(n);if(t)return{type:"heading",raw:t[0],depth:t[2].charAt(0)==="="?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(n){let t=this.rules.block.paragraph.exec(n);if(t){let l=t[1].charAt(t[1].length-1)===`
`?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:l,tokens:this.lexer.inline(l)}}}text(n){let t=this.rules.block.text.exec(n);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(n){let t=this.rules.inline.escape.exec(n);if(t)return{type:"escape",raw:t[0],text:t[1]}}tag(n){let t=this.rules.inline.tag.exec(n);if(t)return!this.lexer.state.inLink&&this.rules.other.startATag.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:t[0]}}link(n){let t=this.rules.inline.link.exec(n);if(t){let l=t[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(l)){if(!this.rules.other.endAngleBracket.test(l))return;let o=Ee(l.slice(0,-1),"\\");if((l.length-o.length)%2===0)return}else{let o=wa(t[2],"()");if(o===-2)return;if(o>-1){let i=(t[0].indexOf("!")===0?5:4)+t[1].length+o;t[2]=t[2].substring(0,o),t[0]=t[0].substring(0,i).trim(),t[3]=""}}let a=t[2],s="";if(this.options.pedantic){let o=this.rules.other.pedanticHrefTitle.exec(a);o&&(a=o[1],s=o[3])}else s=t[3]?t[3].slice(1,-1):"";return a=a.trim(),this.rules.other.startAngleBracket.test(a)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(l)?a=a.slice(1):a=a.slice(1,-1)),wt(t,{href:a&&a.replace(this.rules.inline.anyPunctuation,"$1"),title:s&&s.replace(this.rules.inline.anyPunctuation,"$1")},t[0],this.lexer,this.rules)}}reflink(n,t){let l;if((l=this.rules.inline.reflink.exec(n))||(l=this.rules.inline.nolink.exec(n))){let a=(l[2]||l[1]).replace(this.rules.other.multipleSpaceGlobal," "),s=t[a.toLowerCase()];if(!s){let o=l[0].charAt(0);return{type:"text",raw:o,text:o}}return wt(l,s,l[0],this.lexer,this.rules)}}emStrong(n,t,l=""){let a=this.rules.inline.emStrongLDelim.exec(n);if(!(!a||a[3]&&l.match(this.rules.other.unicodeAlphaNumeric))&&(!(a[1]||a[2])||!l||this.rules.inline.punctuation.exec(l))){let s=[...a[0]].length-1,o,i,u=s,r=0,d=a[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(d.lastIndex=0,t=t.slice(-1*n.length+s);(a=d.exec(t))!=null;){if(o=a[1]||a[2]||a[3]||a[4]||a[5]||a[6],!o)continue;if(i=[...o].length,a[3]||a[4]){u+=i;continue}else if((a[5]||a[6])&&s%3&&!((s+i)%3)){r+=i;continue}if(u-=i,u>0)continue;i=Math.min(i,i+u+r);let m=[...a[0]][0].length,k=n.slice(0,s+a.index+m+i);if(Math.min(s,i)%2){let w=k.slice(1,-1);return{type:"em",raw:k,text:w,tokens:this.lexer.inlineTokens(w)}}let $=k.slice(2,-2);return{type:"strong",raw:k,text:$,tokens:this.lexer.inlineTokens($)}}}}codespan(n){let t=this.rules.inline.code.exec(n);if(t){let l=t[2].replace(this.rules.other.newLineCharGlobal," "),a=this.rules.other.nonSpaceChar.test(l),s=this.rules.other.startingSpaceChar.test(l)&&this.rules.other.endingSpaceChar.test(l);return a&&s&&(l=l.substring(1,l.length-1)),{type:"codespan",raw:t[0],text:l}}}br(n){let t=this.rules.inline.br.exec(n);if(t)return{type:"br",raw:t[0]}}del(n){let t=this.rules.inline.del.exec(n);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(n){let t=this.rules.inline.autolink.exec(n);if(t){let l,a;return t[2]==="@"?(l=t[1],a="mailto:"+l):(l=t[1],a=l),{type:"link",raw:t[0],text:l,href:a,tokens:[{type:"text",raw:l,text:l}]}}}url(n){let t;if(t=this.rules.inline.url.exec(n)){let l,a;if(t[2]==="@")l=t[0],a="mailto:"+l;else{let s;do s=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])?.[0]??"";while(s!==t[0]);l=t[0],t[1]==="www."?a="http://"+t[0]:a=t[0]}return{type:"link",raw:t[0],text:l,href:a,tokens:[{type:"text",raw:l,text:l}]}}}inlineText(n){let t=this.rules.inline.text.exec(n);if(t){let l=this.lexer.state.inRawBlock;return{type:"text",raw:t[0],text:t[0],escaped:l}}}},be=class tt{tokens;options;state;inlineQueue;tokenizer;constructor(t){this.tokens=[],this.tokens.links=Object.create(null),this.options=t||Re,this.options.tokenizer=this.options.tokenizer||new Qe,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let l={other:pe,block:Ke.normal,inline:Be.normal};this.options.pedantic?(l.block=Ke.pedantic,l.inline=Be.pedantic):this.options.gfm&&(l.block=Ke.gfm,this.options.breaks?l.inline=Be.breaks:l.inline=Be.gfm),this.tokenizer.rules=l}static get rules(){return{block:Ke,inline:Be}}static lex(t,l){return new tt(l).lex(t)}static lexInline(t,l){return new tt(l).inlineTokens(t)}lex(t){t=t.replace(pe.carriageReturn,`
`),this.blockTokens(t,this.tokens);for(let l=0;l<this.inlineQueue.length;l++){let a=this.inlineQueue[l];this.inlineTokens(a.src,a.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(t,l=[],a=!1){for(this.options.pedantic&&(t=t.replace(pe.tabCharGlobal,"    ").replace(pe.spaceLine,""));t;){let s;if(this.options.extensions?.block?.some(i=>(s=i.call({lexer:this},t,l))?(t=t.substring(s.raw.length),l.push(s),!0):!1))continue;if(s=this.tokenizer.space(t)){t=t.substring(s.raw.length);let i=l.at(-1);s.raw.length===1&&i!==void 0?i.raw+=`
`:l.push(s);continue}if(s=this.tokenizer.code(t)){t=t.substring(s.raw.length);let i=l.at(-1);i?.type==="paragraph"||i?.type==="text"?(i.raw+=(i.raw.endsWith(`
`)?"":`
`)+s.raw,i.text+=`
`+s.text,this.inlineQueue.at(-1).src=i.text):l.push(s);continue}if(s=this.tokenizer.fences(t)){t=t.substring(s.raw.length),l.push(s);continue}if(s=this.tokenizer.heading(t)){t=t.substring(s.raw.length),l.push(s);continue}if(s=this.tokenizer.hr(t)){t=t.substring(s.raw.length),l.push(s);continue}if(s=this.tokenizer.blockquote(t)){t=t.substring(s.raw.length),l.push(s);continue}if(s=this.tokenizer.list(t)){t=t.substring(s.raw.length),l.push(s);continue}if(s=this.tokenizer.html(t)){t=t.substring(s.raw.length),l.push(s);continue}if(s=this.tokenizer.def(t)){t=t.substring(s.raw.length);let i=l.at(-1);i?.type==="paragraph"||i?.type==="text"?(i.raw+=(i.raw.endsWith(`
`)?"":`
`)+s.raw,i.text+=`
`+s.raw,this.inlineQueue.at(-1).src=i.text):this.tokens.links[s.tag]||(this.tokens.links[s.tag]={href:s.href,title:s.title},l.push(s));continue}if(s=this.tokenizer.table(t)){t=t.substring(s.raw.length),l.push(s);continue}if(s=this.tokenizer.lheading(t)){t=t.substring(s.raw.length),l.push(s);continue}let o=t;if(this.options.extensions?.startBlock){let i=1/0,u=t.slice(1),r;this.options.extensions.startBlock.forEach(d=>{r=d.call({lexer:this},u),typeof r=="number"&&r>=0&&(i=Math.min(i,r))}),i<1/0&&i>=0&&(o=t.substring(0,i+1))}if(this.state.top&&(s=this.tokenizer.paragraph(o))){let i=l.at(-1);a&&i?.type==="paragraph"?(i.raw+=(i.raw.endsWith(`
`)?"":`
`)+s.raw,i.text+=`
`+s.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=i.text):l.push(s),a=o.length!==t.length,t=t.substring(s.raw.length);continue}if(s=this.tokenizer.text(t)){t=t.substring(s.raw.length);let i=l.at(-1);i?.type==="text"?(i.raw+=(i.raw.endsWith(`
`)?"":`
`)+s.raw,i.text+=`
`+s.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=i.text):l.push(s);continue}if(t){let i="Infinite loop on byte: "+t.charCodeAt(0);if(this.options.silent){console.error(i);break}else throw new Error(i)}}return this.state.top=!0,l}inline(t,l=[]){return this.inlineQueue.push({src:t,tokens:l}),l}inlineTokens(t,l=[]){let a=t,s=null;if(this.tokens.links){let r=Object.keys(this.tokens.links);if(r.length>0)for(;(s=this.tokenizer.rules.inline.reflinkSearch.exec(a))!=null;)r.includes(s[0].slice(s[0].lastIndexOf("[")+1,-1))&&(a=a.slice(0,s.index)+"["+"a".repeat(s[0].length-2)+"]"+a.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(s=this.tokenizer.rules.inline.anyPunctuation.exec(a))!=null;)a=a.slice(0,s.index)+"++"+a.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let o;for(;(s=this.tokenizer.rules.inline.blockSkip.exec(a))!=null;)o=s[2]?s[2].length:0,a=a.slice(0,s.index+o)+"["+"a".repeat(s[0].length-o-2)+"]"+a.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);a=this.options.hooks?.emStrongMask?.call({lexer:this},a)??a;let i=!1,u="";for(;t;){i||(u=""),i=!1;let r;if(this.options.extensions?.inline?.some(m=>(r=m.call({lexer:this},t,l))?(t=t.substring(r.raw.length),l.push(r),!0):!1))continue;if(r=this.tokenizer.escape(t)){t=t.substring(r.raw.length),l.push(r);continue}if(r=this.tokenizer.tag(t)){t=t.substring(r.raw.length),l.push(r);continue}if(r=this.tokenizer.link(t)){t=t.substring(r.raw.length),l.push(r);continue}if(r=this.tokenizer.reflink(t,this.tokens.links)){t=t.substring(r.raw.length);let m=l.at(-1);r.type==="text"&&m?.type==="text"?(m.raw+=r.raw,m.text+=r.text):l.push(r);continue}if(r=this.tokenizer.emStrong(t,a,u)){t=t.substring(r.raw.length),l.push(r);continue}if(r=this.tokenizer.codespan(t)){t=t.substring(r.raw.length),l.push(r);continue}if(r=this.tokenizer.br(t)){t=t.substring(r.raw.length),l.push(r);continue}if(r=this.tokenizer.del(t)){t=t.substring(r.raw.length),l.push(r);continue}if(r=this.tokenizer.autolink(t)){t=t.substring(r.raw.length),l.push(r);continue}if(!this.state.inLink&&(r=this.tokenizer.url(t))){t=t.substring(r.raw.length),l.push(r);continue}let d=t;if(this.options.extensions?.startInline){let m=1/0,k=t.slice(1),$;this.options.extensions.startInline.forEach(w=>{$=w.call({lexer:this},k),typeof $=="number"&&$>=0&&(m=Math.min(m,$))}),m<1/0&&m>=0&&(d=t.substring(0,m+1))}if(r=this.tokenizer.inlineText(d)){t=t.substring(r.raw.length),r.raw.slice(-1)!=="_"&&(u=r.raw.slice(-1)),i=!0;let m=l.at(-1);m?.type==="text"?(m.raw+=r.raw,m.text+=r.text):l.push(r);continue}if(t){let m="Infinite loop on byte: "+t.charCodeAt(0);if(this.options.silent){console.error(m);break}else throw new Error(m)}}return l}},Je=class{options;parser;constructor(n){this.options=n||Re}space(n){return""}code({text:n,lang:t,escaped:l}){let a=(t||"").match(pe.notSpaceStart)?.[0],s=n.replace(pe.endingNewline,"")+`
`;return a?'<pre><code class="language-'+we(a)+'">'+(l?s:we(s,!0))+`</code></pre>
`:"<pre><code>"+(l?s:we(s,!0))+`</code></pre>
`}blockquote({tokens:n}){return`<blockquote>
${this.parser.parse(n)}</blockquote>
`}html({text:n}){return n}def(n){return""}heading({tokens:n,depth:t}){return`<h${t}>${this.parser.parseInline(n)}</h${t}>
`}hr(n){return`<hr>
`}list(n){let t=n.ordered,l=n.start,a="";for(let i=0;i<n.items.length;i++){let u=n.items[i];a+=this.listitem(u)}let s=t?"ol":"ul",o=t&&l!==1?' start="'+l+'"':"";return"<"+s+o+`>
`+a+"</"+s+`>
`}listitem(n){return`<li>${this.parser.parse(n.tokens)}</li>
`}checkbox({checked:n}){return"<input "+(n?'checked="" ':"")+'disabled="" type="checkbox"> '}paragraph({tokens:n}){return`<p>${this.parser.parseInline(n)}</p>
`}table(n){let t="",l="";for(let s=0;s<n.header.length;s++)l+=this.tablecell(n.header[s]);t+=this.tablerow({text:l});let a="";for(let s=0;s<n.rows.length;s++){let o=n.rows[s];l="";for(let i=0;i<o.length;i++)l+=this.tablecell(o[i]);a+=this.tablerow({text:l})}return a&&(a=`<tbody>${a}</tbody>`),`<table>
<thead>
`+t+`</thead>
`+a+`</table>
`}tablerow({text:n}){return`<tr>
${n}</tr>
`}tablecell(n){let t=this.parser.parseInline(n.tokens),l=n.header?"th":"td";return(n.align?`<${l} align="${n.align}">`:`<${l}>`)+t+`</${l}>
`}strong({tokens:n}){return`<strong>${this.parser.parseInline(n)}</strong>`}em({tokens:n}){return`<em>${this.parser.parseInline(n)}</em>`}codespan({text:n}){return`<code>${we(n,!0)}</code>`}br(n){return"<br>"}del({tokens:n}){return`<del>${this.parser.parseInline(n)}</del>`}link({href:n,title:t,tokens:l}){let a=this.parser.parseInline(l),s=_t(n);if(s===null)return a;n=s;let o='<a href="'+n+'"';return t&&(o+=' title="'+we(t)+'"'),o+=">"+a+"</a>",o}image({href:n,title:t,text:l,tokens:a}){a&&(l=this.parser.parseInline(a,this.parser.textRenderer));let s=_t(n);if(s===null)return we(l);n=s;let o=`<img src="${n}" alt="${l}"`;return t&&(o+=` title="${we(t)}"`),o+=">",o}text(n){return"tokens"in n&&n.tokens?this.parser.parseInline(n.tokens):"escaped"in n&&n.escaped?n.text:we(n.text)}},pt=class{strong({text:n}){return n}em({text:n}){return n}codespan({text:n}){return n}del({text:n}){return n}html({text:n}){return n}text({text:n}){return n}link({text:n}){return""+n}image({text:n}){return""+n}br(){return""}checkbox({raw:n}){return n}},ye=class st{options;renderer;textRenderer;constructor(t){this.options=t||Re,this.options.renderer=this.options.renderer||new Je,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new pt}static parse(t,l){return new st(l).parse(t)}static parseInline(t,l){return new st(l).parseInline(t)}parse(t){let l="";for(let a=0;a<t.length;a++){let s=t[a];if(this.options.extensions?.renderers?.[s.type]){let i=s,u=this.options.extensions.renderers[i.type].call({parser:this},i);if(u!==!1||!["space","hr","heading","code","table","blockquote","list","html","def","paragraph","text"].includes(i.type)){l+=u||"";continue}}let o=s;switch(o.type){case"space":{l+=this.renderer.space(o);break}case"hr":{l+=this.renderer.hr(o);break}case"heading":{l+=this.renderer.heading(o);break}case"code":{l+=this.renderer.code(o);break}case"table":{l+=this.renderer.table(o);break}case"blockquote":{l+=this.renderer.blockquote(o);break}case"list":{l+=this.renderer.list(o);break}case"checkbox":{l+=this.renderer.checkbox(o);break}case"html":{l+=this.renderer.html(o);break}case"def":{l+=this.renderer.def(o);break}case"paragraph":{l+=this.renderer.paragraph(o);break}case"text":{l+=this.renderer.text(o);break}default:{let i='Token with "'+o.type+'" type was not found.';if(this.options.silent)return console.error(i),"";throw new Error(i)}}}return l}parseInline(t,l=this.renderer){let a="";for(let s=0;s<t.length;s++){let o=t[s];if(this.options.extensions?.renderers?.[o.type]){let u=this.options.extensions.renderers[o.type].call({parser:this},o);if(u!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(o.type)){a+=u||"";continue}}let i=o;switch(i.type){case"escape":{a+=l.text(i);break}case"html":{a+=l.html(i);break}case"link":{a+=l.link(i);break}case"image":{a+=l.image(i);break}case"checkbox":{a+=l.checkbox(i);break}case"strong":{a+=l.strong(i);break}case"em":{a+=l.em(i);break}case"codespan":{a+=l.codespan(i);break}case"br":{a+=l.br(i);break}case"del":{a+=l.del(i);break}case"text":{a+=l.text(i);break}default:{let u='Token with "'+i.type+'" type was not found.';if(this.options.silent)return console.error(u),"";throw new Error(u)}}}return a}},Le=class{options;block;constructor(n){this.options=n||Re}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens","emStrongMask"]);static passThroughHooksRespectAsync=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(n){return n}postprocess(n){return n}processAllTokens(n){return n}emStrongMask(n){return n}provideLexer(){return this.block?be.lex:be.lexInline}provideParser(){return this.block?ye.parse:ye.parseInline}},Ca=class{defaults=at();options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=ye;Renderer=Je;TextRenderer=pt;Lexer=be;Tokenizer=Qe;Hooks=Le;constructor(...n){this.use(...n)}walkTokens(n,t){let l=[];for(let a of n)switch(l=l.concat(t.call(this,a)),a.type){case"table":{let s=a;for(let o of s.header)l=l.concat(this.walkTokens(o.tokens,t));for(let o of s.rows)for(let i of o)l=l.concat(this.walkTokens(i.tokens,t));break}case"list":{let s=a;l=l.concat(this.walkTokens(s.items,t));break}default:{let s=a;this.defaults.extensions?.childTokens?.[s.type]?this.defaults.extensions.childTokens[s.type].forEach(o=>{let i=s[o].flat(1/0);l=l.concat(this.walkTokens(i,t))}):s.tokens&&(l=l.concat(this.walkTokens(s.tokens,t)))}}return l}use(...n){let t=this.defaults.extensions||{renderers:{},childTokens:{}};return n.forEach(l=>{let a={...l};if(a.async=this.defaults.async||a.async||!1,l.extensions&&(l.extensions.forEach(s=>{if(!s.name)throw new Error("extension name required");if("renderer"in s){let o=t.renderers[s.name];o?t.renderers[s.name]=function(...i){let u=s.renderer.apply(this,i);return u===!1&&(u=o.apply(this,i)),u}:t.renderers[s.name]=s.renderer}if("tokenizer"in s){if(!s.level||s.level!=="block"&&s.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let o=t[s.level];o?o.unshift(s.tokenizer):t[s.level]=[s.tokenizer],s.start&&(s.level==="block"?t.startBlock?t.startBlock.push(s.start):t.startBlock=[s.start]:s.level==="inline"&&(t.startInline?t.startInline.push(s.start):t.startInline=[s.start]))}"childTokens"in s&&s.childTokens&&(t.childTokens[s.name]=s.childTokens)}),a.extensions=t),l.renderer){let s=this.defaults.renderer||new Je(this.defaults);for(let o in l.renderer){if(!(o in s))throw new Error(`renderer '${o}' does not exist`);if(["options","parser"].includes(o))continue;let i=o,u=l.renderer[i],r=s[i];s[i]=(...d)=>{let m=u.apply(s,d);return m===!1&&(m=r.apply(s,d)),m||""}}a.renderer=s}if(l.tokenizer){let s=this.defaults.tokenizer||new Qe(this.defaults);for(let o in l.tokenizer){if(!(o in s))throw new Error(`tokenizer '${o}' does not exist`);if(["options","rules","lexer"].includes(o))continue;let i=o,u=l.tokenizer[i],r=s[i];s[i]=(...d)=>{let m=u.apply(s,d);return m===!1&&(m=r.apply(s,d)),m}}a.tokenizer=s}if(l.hooks){let s=this.defaults.hooks||new Le;for(let o in l.hooks){if(!(o in s))throw new Error(`hook '${o}' does not exist`);if(["options","block"].includes(o))continue;let i=o,u=l.hooks[i],r=s[i];Le.passThroughHooks.has(o)?s[i]=d=>{if(this.defaults.async&&Le.passThroughHooksRespectAsync.has(o))return(async()=>{let k=await u.call(s,d);return r.call(s,k)})();let m=u.call(s,d);return r.call(s,m)}:s[i]=(...d)=>{if(this.defaults.async)return(async()=>{let k=await u.apply(s,d);return k===!1&&(k=await r.apply(s,d)),k})();let m=u.apply(s,d);return m===!1&&(m=r.apply(s,d)),m}}a.hooks=s}if(l.walkTokens){let s=this.defaults.walkTokens,o=l.walkTokens;a.walkTokens=function(i){let u=[];return u.push(o.call(this,i)),s&&(u=u.concat(s.call(this,i))),u}}this.defaults={...this.defaults,...a}}),this}setOptions(n){return this.defaults={...this.defaults,...n},this}lexer(n,t){return be.lex(n,t??this.defaults)}parser(n,t){return ye.parse(n,t??this.defaults)}parseMarkdown(n){return(t,l)=>{let a={...l},s={...this.defaults,...a},o=this.onError(!!s.silent,!!s.async);if(this.defaults.async===!0&&a.async===!1)return o(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof t>"u"||t===null)return o(new Error("marked(): input parameter is undefined or null"));if(typeof t!="string")return o(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(t)+", string expected"));if(s.hooks&&(s.hooks.options=s,s.hooks.block=n),s.async)return(async()=>{let i=s.hooks?await s.hooks.preprocess(t):t,u=await(s.hooks?await s.hooks.provideLexer():n?be.lex:be.lexInline)(i,s),r=s.hooks?await s.hooks.processAllTokens(u):u;s.walkTokens&&await Promise.all(this.walkTokens(r,s.walkTokens));let d=await(s.hooks?await s.hooks.provideParser():n?ye.parse:ye.parseInline)(r,s);return s.hooks?await s.hooks.postprocess(d):d})().catch(o);try{s.hooks&&(t=s.hooks.preprocess(t));let i=(s.hooks?s.hooks.provideLexer():n?be.lex:be.lexInline)(t,s);s.hooks&&(i=s.hooks.processAllTokens(i)),s.walkTokens&&this.walkTokens(i,s.walkTokens);let u=(s.hooks?s.hooks.provideParser():n?ye.parse:ye.parseInline)(i,s);return s.hooks&&(u=s.hooks.postprocess(u)),u}catch(i){return o(i)}}}onError(n,t){return l=>{if(l.message+=`
Please report this to https://github.com/markedjs/marked.`,n){let a="<p>An error occurred:</p><pre>"+we(l.message+"",!0)+"</pre>";return t?Promise.resolve(a):a}if(t)return Promise.reject(l);throw l}}},Me=new Ca;function ne(n,t){return Me.parse(n,t)}ne.options=ne.setOptions=function(n){return Me.setOptions(n),ne.defaults=Me.defaults,Ut(ne.defaults),ne};ne.getDefaults=at;ne.defaults=Re;ne.use=function(...n){return Me.use(...n),ne.defaults=Me.defaults,Ut(ne.defaults),ne};ne.walkTokens=function(n,t){return Me.walkTokens(n,t)};ne.parseInline=Me.parseInline;ne.Parser=ye;ne.parser=ye.parse;ne.Renderer=Je;ne.TextRenderer=pt;ne.Lexer=be;ne.lexer=be.lex;ne.Tokenizer=Qe;ne.Hooks=Le;ne.parse=ne;ne.options;ne.setOptions;ne.use;ne.walkTokens;ne.parseInline;ye.parse;be.lex;const Sa={class:"overview-grid"},Pa={class:"overview-card summary-card"},Ia={class:"card-header"},Ma={class:"card-title-with-selector"},Ra={class:"card-title-icon"},Ta={class:"card-header-actions"},Ua={class:"template-status"},Aa={class:"template-description"},Ba={class:"card-content markdown-content"},Ea={key:0,class:"loading-text"},La=["innerHTML"],Da={key:2,class:"placeholder-text"},za={class:"overview-card stats-card"},Oa={class:"stats-grid"},Ga={class:"stat-item"},Va={class:"stat-value"},qa={class:"stat-item"},Fa={class:"stat-value"},Ka={class:"export-actions"},Na=["disabled"],ja=["disabled"],Ha={class:"overview-card recent-card"},Qa={class:"recent-pages"},Ja={key:0,class:"placeholder-text"},Za=["onClick"],Wa={class:"page-number"},Xa={key:0,class:"page-summary"},Ya=te({__name:"OverviewPanel",setup(n){const t=ce(),l=y("no_spoiler"),a=y(""),s=y(!1),o=y([]),i=y([]),u=[{value:"no_spoiler",label:"æ— å‰§é€ç®€ä»‹",icon:"ðŸŽ",description:"ä¸å«å‰§é€çš„ç®€çŸ­ä»‹ç»ï¼Œé€‚åˆæŽ¨èç»™ä»–äºº"},{value:"story_summary",label:"æ•…äº‹æ¦‚è¦",icon:"ðŸ“–",description:"å®Œæ•´çš„å‰§æƒ…å›žé¡¾ï¼ŒåŒ…å«æ‰€æœ‰å‰§é€"},{value:"recap",label:"å‰æƒ…å›žé¡¾",icon:"âª",description:"ä¹‹å‰å‘ç”Ÿçš„é‡è¦äº‹ä»¶å›žé¡¾"},{value:"character_guide",label:"è§’è‰²å›¾é‰´",icon:"ðŸ‘¥",description:"ä¸»è¦è§’è‰²ä»‹ç»å’Œå…³ç³»"},{value:"world_setting",label:"ä¸–ç•Œè§‚è®¾å®š",icon:"ðŸŒ",description:"æ•…äº‹èƒŒæ™¯å’Œä¸–ç•Œè§‚è®¾å®š"},{value:"highlights",label:"ååœºé¢ç›˜ç‚¹",icon:"âœ¨",description:"ç²¾å½©ç‰‡æ®µå’Œç»å…¸åœºæ™¯å›žé¡¾"},{value:"reading_notes",label:"é˜…è¯»ç¬”è®°",icon:"ðŸ“",description:"é˜…è¯»è¿‡ç¨‹ä¸­çš„é‡ç‚¹ç¬”è®°"}],r=u.map(c=>({label:`${c.icon} ${c.label}`,value:c.value})),d=G(()=>u.find(h=>h.value===l.value)?.icon||"ðŸ“Š"),m=G(()=>u.find(h=>h.value===l.value)?.description||""),k=G(()=>o.value.includes(l.value)?"å·²ç”Ÿæˆ":""),$=G(()=>a.value?ne.parse(a.value):"");async function w(){await x()}async function x(){if(t.currentBookId){s.value=!0,a.value="";try{const c=await qs(t.currentBookId,l.value);c.success&&c.content?(a.value=c.content,o.value.includes(l.value)||o.value.push(l.value)):a.value=""}catch(c){console.error("åŠ è½½æ¦‚è§ˆå¤±è´¥:",c),a.value="åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•"}finally{s.value=!1}}}async function S(c){if(t.currentBookId){s.value=!0,a.value="";try{const h=await Fs(t.currentBookId,l.value,c);h.success?h.content&&(a.value=h.content,o.value.includes(l.value)||o.value.push(l.value)):a.value=`ç”Ÿæˆå¤±è´¥: ${h.error||"æœªçŸ¥é”™è¯¯"}`}catch(h){console.error("ç”Ÿæˆæ¦‚è§ˆå¤±è´¥:",h),a.value="ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"}finally{s.value=!1}}}async function U(){if(t.currentBookId)try{const c=await Ks(t.currentBookId);if(c.success){let h=[];c.generated?h=c.generated:c.templates&&Array.isArray(c.templates)&&(h=c.templates),o.value=h}}catch(c){console.error("åŠ è½½æ¨¡æ¿åˆ—è¡¨å¤±è´¥:",c)}}const R=y(!1);async function D(){if(!t.currentBookId){alert("è¯·å…ˆé€‰æ‹©ä¹¦ç±");return}R.value=!0;try{const c=await Tt(t.currentBookId);if(c.success&&c.markdown){const h=new Blob([c.markdown],{type:"text/markdown"}),P=URL.createObjectURL(h),T=document.createElement("a");T.href=P,T.download=`${t.currentBookId}_analysis.md`,T.click(),URL.revokeObjectURL(P),alert("å¯¼å‡ºæˆåŠŸ")}else alert("å¯¼å‡ºå¤±è´¥: "+(c.error||"æœªçŸ¥é”™è¯¯"))}catch(c){console.error("å¯¼å‡ºå¤±è´¥:",c),alert("å¯¼å‡ºå¤±è´¥")}finally{R.value=!1}}function f(){if(!a.value){alert("æš‚æ— å†…å®¹å¯å¯¼å‡º");return}const c=u.find(Y=>Y.value===l.value),h=`${t.currentBookId}_${l.value}.md`,P=`# ${c?.label||l.value}

${a.value}`,T=new Blob([P],{type:"text/markdown"}),M=URL.createObjectURL(T),z=document.createElement("a");z.href=M,z.download=h,z.click(),URL.revokeObjectURL(M)}async function b(){if(t.currentBookId)try{if((await Rt(t.currentBookId)).success&&t.analyzedPageCount>0){const h=t.totalPageCount,P=t.analyzedPageCount,T=[],M=Math.max(1,P-4);for(let z=0;z<Math.min(5,P);z++){const Y=M+z;Y<=h&&T.push({page_num:Y,summary:`ç¬¬ ${Y} é¡µ`})}i.value=T.reverse()}}catch(c){console.error("åŠ è½½æœ€è¿‘åˆ†æžé¡µé¢å¤±è´¥:",c)}}function p(c){t.selectPage(c)}return ke(async()=>{await U(),await b(),o.value.includes(l.value)&&await x()}),ue(()=>t.currentBookId,async c=>{c&&(a.value="",o.value=[],i.value=[],await U(),await b(),o.value.includes(l.value)&&await x())}),ue(()=>t.dataRefreshKey,async c=>{c>0&&t.currentBookId&&(console.log("OverviewPanel: æ”¶åˆ°åˆ·æ–°ä¿¡å·ï¼Œé‡æ–°åŠ è½½æ•°æ®"),await U(),await b(),o.value.includes(l.value)&&await x())}),(c,h)=>(v(),g("div",Sa,[e("div",Pa,[e("div",Ia,[e("div",Ma,[e("span",Ra,_(d.value),1),X(he,{modelValue:l.value,"onUpdate:modelValue":h[0]||(h[0]=P=>l.value=P),options:K(r),onChange:w},null,8,["modelValue","options"])]),e("div",Ta,[e("span",Ua,_(k.value),1),e("button",{class:"btn-icon",title:"ç”Ÿæˆ/åŠ è½½",onClick:h[1]||(h[1]=P=>S(!1))}," ðŸ“„ "),e("button",{class:"btn-icon",title:"é‡æ–°ç”Ÿæˆ",onClick:h[2]||(h[2]=P=>S(!0))}," ðŸ”„ ")])]),e("p",Aa,_(m.value),1),e("div",Ba,[s.value?(v(),g("div",Ea,"åŠ è½½ä¸­...")):a.value?(v(),g("div",{key:1,innerHTML:$.value},null,8,La)):(v(),g("div",Da,"é€‰æ‹©æ¨¡æ¿ç±»åž‹ï¼Œç‚¹å‡»ç”ŸæˆæŒ‰é’®"))])]),e("div",za,[h[5]||(h[5]=e("h3",{class:"card-title"},"ðŸ“Š åˆ†æžç»Ÿè®¡",-1)),e("div",Oa,[e("div",Ga,[e("span",Va,_(K(t).analyzedPageCount),1),h[3]||(h[3]=e("span",{class:"stat-label"},"å·²åˆ†æžé¡µé¢",-1))]),e("div",qa,[e("span",Fa,_(K(t).chapters.length),1),h[4]||(h[4]=e("span",{class:"stat-label"},"ç« èŠ‚æ•°",-1))])]),e("div",Ka,[e("button",{class:"btn btn-secondary btn-sm",disabled:R.value||!a.value,title:"å¯¼å‡ºå½“å‰æ¦‚è§ˆ",onClick:f}," ðŸ“„ å¯¼å‡ºå½“å‰ ",8,Na),e("button",{class:"btn btn-primary btn-sm",disabled:R.value,title:"å¯¼å‡ºå®Œæ•´åˆ†æžæ•°æ®",onClick:D},_(R.value?"å¯¼å‡ºä¸­...":"ðŸ“¤ å¯¼å‡ºå…¨éƒ¨"),9,ja)])]),e("div",Ha,[h[6]||(h[6]=e("h3",{class:"card-title"},"ðŸ• æœ€è¿‘åˆ†æž",-1)),e("div",Qa,[i.value.length===0?(v(),g("div",Ja,"æš‚æ— åˆ†æžè®°å½•")):E("",!0),(v(!0),g(Q,null,W(i.value,P=>(v(),g("div",{key:P.page_num,class:"recent-page-item",onClick:T=>p(P.page_num)},[e("span",Wa,"ç¬¬ "+_(P.page_num)+" é¡µ",1),P.summary?(v(),g("span",Xa,_(P.summary),1)):E("",!0)],8,Za))),128))])])]))}}),el=oe(Ya,[["__scopeId","data-v-ab7103d7"]]),tl={class:"timeline-tab"},sl={class:"timeline-header"},nl=["disabled"],al={key:0,class:"btn-spinner"},ll={key:0,class:"error-message"},ol={class:"timeline-container"},rl={key:0,class:"loading-state"},il={key:1,class:"timeline-empty-state"},ul=["disabled"],cl={class:"timeline-stats"},dl={key:0,class:"stat-badge"},pl={class:"stat-badge"},vl={key:1,class:"stat-badge"},ml={key:2,class:"stat-badge"},gl={class:"stat-badge"},fl={key:0,class:"timeline-summary-card"},hl={class:"one-sentence"},bl={key:0,class:"themes"},yl={key:1,class:"characters-section"},kl={class:"characters-grid"},_l=["onClick"],$l={class:"character-name"},wl={class:"character-desc"},xl={class:"character-page"},Cl={key:2,class:"timeline-section"},Sl={key:3,class:"timeline-track"},Pl={class:"timeline-node"},Il=["onClick"],Ml={class:"timeline-card"},Rl=["onClick"],Tl=["src","alt","onClick"],Ul={class:"timeline-card-title"},Al={class:"timeline-page-range"},Bl={class:"timeline-event-count"},El={class:"expand-icon"},Ll={key:0,class:"timeline-summary"},Dl={key:1,class:"timeline-mood"},zl={key:4,class:"timeline-track"},Ol={class:"timeline-node"},Gl=["onClick"],Vl={class:"timeline-card"},ql=["onClick"],Fl=["src","alt","onClick"],Kl={class:"timeline-card-title"},Nl={class:"timeline-page-range"},jl={class:"timeline-event-count"},Hl={class:"expand-icon"},Ql={key:0,class:"timeline-summary"},Jl={key:1,class:"timeline-events-list"},Zl={key:5,class:"timeline-section"},Wl={class:"plot-threads-list"},Xl={class:"thread-header"},Yl={class:"thread-name"},eo={key:0,class:"thread-desc"},to={key:1,class:"thread-intro"},so={key:6,class:"placeholder-text"},no=te({__name:"TimelinePanel",setup(n){const t=ce(),l=y(!1),a=y(!1),s=y(null);y("simple");const o=y(new Set),i=y(""),u=G(()=>{if(!s.value)return!1;const b=s.value.groups&&s.value.groups.length>0,p=s.value.plot_arcs&&s.value.plot_arcs.length>0;return b||p}),r=G(()=>s.value?.stats?.total_events||0),d=G(()=>s.value?.stats?.total_pages||0),m=G(()=>s.value?.mode==="enhanced"||!!s.value?.story_summary||!!s.value?.plot_arcs?.length),k=G(()=>s.value?.main_characters||[]),$=G(()=>s.value?.plot_arcs||[]),w=G(()=>s.value?.story_summary||"");async function x(){if(t.currentBookId){l.value=!0,i.value="";try{const b=await Ns(t.currentBookId);console.log("Timeline API response:",b),b.success?(s.value={mode:b.mode||"simple",groups:b.groups||[],stats:b.stats,story_summary:b.summary?.one_sentence||"",main_characters:b.characters||[],plot_arcs:b.story_arcs||[],plot_threads:b.plot_threads||[],events:b.events||[],cached:b.cached},console.log("Parsed timelineData:",s.value)):i.value=b.error||"åŠ è½½æ—¶é—´çº¿å¤±è´¥"}catch(b){console.error("åŠ è½½æ—¶é—´çº¿å¤±è´¥:",b),i.value=b instanceof Error?b.message:"åŠ è½½å¤±è´¥"}finally{l.value=!1}}}async function S(){if(t.currentBookId){a.value=!0,i.value="";try{const b=await js(t.currentBookId);b.success?s.value=b:i.value="é‡æ–°ç”Ÿæˆå¤±è´¥"}catch(b){console.error("é‡æ–°ç”Ÿæˆæ—¶é—´çº¿å¤±è´¥:",b),i.value=b instanceof Error?b.message:"é‡æ–°ç”Ÿæˆå¤±è´¥"}finally{a.value=!1}}}function U(b){return t.currentBookId?nt(t.currentBookId,b):""}function R(b){t.selectPage(b)}function D(b){o.value.has(b)?o.value.delete(b):o.value.add(b)}function f(b){return o.value.has(b)}return ke(()=>{t.currentBookId&&x()}),ue(()=>t.currentBookId,b=>{b&&(s.value=null,x())}),ue(()=>t.dataRefreshKey,b=>{b>0&&t.currentBookId&&(console.log("TimelinePanel: æ”¶åˆ°åˆ·æ–°ä¿¡å·ï¼Œé‡æ–°åŠ è½½æ•°æ®"),x())}),(b,p)=>(v(),g("div",tl,[e("div",sl,[p[2]||(p[2]=e("h3",null,"ðŸ“ˆ å‰§æƒ…æ—¶é—´çº¿",-1)),e("button",{class:H(["btn btn-secondary btn-sm",{loading:a.value}]),disabled:l.value||a.value,onClick:S},[a.value?(v(),g("span",al)):E("",!0),se(" "+_(a.value?"ç”Ÿæˆä¸­...":"ðŸ”„ é‡æ–°ç”Ÿæˆ"),1)],10,nl)]),i.value?(v(),g("div",ll," âš ï¸ "+_(i.value),1)):E("",!0),e("div",ol,[l.value?(v(),g("div",rl,[...p[3]||(p[3]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"åŠ è½½æ—¶é—´çº¿...",-1)])])):u.value?(v(),g(Q,{key:2},[e("div",cl,[s.value?.stats?.total_arcs?(v(),g("span",dl,"ðŸŽ­ "+_(s.value.stats.total_arcs)+" ä¸ªå‰§æƒ…å¼§",1)):E("",!0),e("span",pl,"ðŸ“Š "+_(r.value)+" ä¸ªäº‹ä»¶",1),s.value?.stats?.total_characters?(v(),g("span",vl,"ðŸ‘¥ "+_(s.value.stats.total_characters)+" ä¸ªè§’è‰²",1)):E("",!0),s.value?.stats?.total_threads?(v(),g("span",ml,"ðŸ”— "+_(s.value.stats.total_threads)+" æ¡çº¿ç´¢",1)):E("",!0),e("span",gl,"ðŸ“„ "+_(d.value)+" é¡µ",1)]),w.value?(v(),g("div",fl,[p[8]||(p[8]=e("h4",null,"ðŸ“– æ•…äº‹æ¦‚è¦",-1)),e("p",hl,_(w.value),1),s.value?.plot_threads?.length?(v(),g("div",bl,[p[7]||(p[7]=e("span",null,"ä¸»é¢˜ï¼š",-1)),(v(!0),g(Q,null,W(s.value.plot_threads.slice(0,5),c=>(v(),g("span",{key:c.id,class:"theme-tag"},_(c.name),1))),128))])):E("",!0)])):E("",!0),k.value.length>0?(v(),g("div",yl,[p[9]||(p[9]=e("h4",null,"ðŸ‘¥ ä¸»è¦è§’è‰²",-1)),e("div",kl,[(v(!0),g(Q,null,W(k.value,c=>(v(),g("div",{key:c.name,class:"character-card",onClick:h=>R(c.first_appearance)},[e("div",$l,_(c.name),1),e("div",wl,_(c.description),1),e("div",xl,"é¦–æ¬¡å‡ºçŽ°ï¼šç¬¬ "+_(c.first_appearance)+" é¡µ",1)],8,_l))),128))])])):E("",!0),m.value&&$.value.length>0?(v(),g("div",Cl,[...p[10]||(p[10]=[e("h4",null,"ðŸŽ­ å‰§æƒ…å‘å±•",-1)])])):E("",!0),m.value&&$.value.length>0?(v(),g("div",Sl,[(v(!0),g(Q,null,W($.value,(c,h)=>(v(),g("div",{key:c.id||c.name,class:H(["timeline-group",{expanded:f(c.id||`arc-${h}`)}])},[e("div",Pl,[e("div",{class:"timeline-node-dot",onClick:P=>D(c.id||`arc-${h}`)},null,8,Il),p[11]||(p[11]=e("div",{class:"timeline-node-line"},null,-1))]),e("div",Ml,[e("div",{class:"timeline-card-header",onClick:P=>D(c.id||`arc-${h}`)},[e("img",{class:"timeline-thumbnail",src:U(c.page_range?.start||1),alt:`ç¬¬${c.page_range?.start||1}é¡µ`,loading:"lazy",onError:p[0]||(p[0]=P=>P.target.style.display="none"),onClick:ie(P=>R(c.page_range?.start||1),["stop"])},null,40,Tl),e("div",Ul,[e("span",Al," ç¬¬ "+_(c.page_range?.start||c.start_page||"?")+"-"+_(c.page_range?.end||c.end_page||"?")+" é¡µ ",1),e("span",Bl,_(c.name),1)]),e("span",El,_(f(c.id||`arc-${h}`)?"â–¼":"â–¶"),1)],8,Rl),c.description?(v(),g("div",Ll,_(c.description),1)):E("",!0),c.mood?(v(),g("div",Dl,[p[12]||(p[12]=e("span",{class:"label"},"ðŸŽ¨ æ°›å›´ï¼š",-1)),se(_(c.mood),1)])):E("",!0)])],2))),128))])):s.value?.groups&&s.value.groups.length>0?(v(),g("div",zl,[(v(!0),g(Q,null,W(s.value.groups,c=>(v(),g("div",{key:c.id,class:H(["timeline-group",{expanded:f(c.id)}])},[e("div",Ol,[e("div",{class:"timeline-node-dot",onClick:h=>D(c.id)},null,8,Gl),p[13]||(p[13]=e("div",{class:"timeline-node-line"},null,-1))]),e("div",Vl,[e("div",{class:"timeline-card-header",onClick:h=>D(c.id)},[e("img",{class:"timeline-thumbnail",src:U(c.thumbnail_page||c.page_range.start),alt:`ç¬¬${c.page_range.start}é¡µ`,loading:"lazy",onError:p[1]||(p[1]=h=>h.target.style.display="none"),onClick:ie(h=>R(c.page_range.start),["stop"])},null,40,Fl),e("div",Kl,[e("span",Nl," ç¬¬ "+_(c.page_range.start)+"-"+_(c.page_range.end)+" é¡µ ",1),e("span",jl,_(c.events.length)+" ä¸ªäº‹ä»¶",1)]),e("span",Hl,_(f(c.id)?"â–¼":"â–¶"),1)],8,ql),c.summary?(v(),g("div",Ql,_(c.summary),1)):E("",!0),f(c.id)&&c.events.length>0?(v(),g("ul",Jl,[(v(!0),g(Q,null,W(c.events,(h,P)=>(v(),g("li",{key:P,class:"timeline-event-item"},_(h),1))),128))])):E("",!0)])],2))),128))])):E("",!0),s.value?.plot_threads&&s.value.plot_threads.length>0?(v(),g("div",Zl,[p[14]||(p[14]=e("h4",null,"ðŸ”— ä¼ç¬”ä¸Žçº¿ç´¢",-1)),e("div",Wl,[(v(!0),g(Q,null,W(s.value.plot_threads,c=>(v(),g("div",{key:c.id,class:H(["plot-thread-item",{resolved:c.status==="å·²è§£å†³"}])},[e("div",Xl,[e("span",Yl,_(c.name||"æœªå‘½åçº¿ç´¢"),1),e("span",{class:H(["thread-status",{resolved:c.status==="å·²è§£å†³"}])},_(c.status||"è¿›è¡Œä¸­"),3)]),c.description?(v(),g("p",eo,_(c.description),1)):E("",!0),c.introduced_at?(v(),g("span",to,"ç¬¬ "+_(c.introduced_at)+" é¡µå¼•å…¥",1)):E("",!0)],2))),128))])])):E("",!0),u.value?E("",!0):(v(),g("div",so,' æš‚æ— è¯¦ç»†æ—¶é—´çº¿æ•°æ®ï¼Œç‚¹å‡»"é‡æ–°ç”Ÿæˆ"æŒ‰é’®ç”Ÿæˆ '))],64)):(v(),g("div",il,[p[4]||(p[4]=e("div",{class:"empty-icon"},"ðŸ“ˆ",-1)),p[5]||(p[5]=e("h4",null,"æ—¶é—´çº¿å°šæœªç”Ÿæˆ",-1)),p[6]||(p[6]=e("p",null,"å®Œæˆæ¼«ç”»åˆ†æžåŽä¼šè‡ªåŠ¨ç”Ÿæˆæ—¶é—´çº¿ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰‹åŠ¨ç”Ÿæˆ",-1)),e("button",{class:"btn btn-primary btn-sm",disabled:a.value,onClick:S},_(a.value?"ç”Ÿæˆä¸­...":"ç”Ÿæˆæ—¶é—´çº¿"),9,ul)]))])]))}}),ao=oe(no,[["__scopeId","data-v-42a23730"]]),lo={class:"qa-container"},oo={key:0,class:"welcome-message"},ro={class:"message-avatar"},io={key:0,src:Ts,alt:"ç”¨æˆ·",class:"avatar-img"},uo={key:0,class:"message-content"},co={key:1,class:"message-content markdown-content"},po={key:0,class:"loading-dots"},vo={key:0,class:"answer-mode-badge"},mo=["innerHTML"],go={key:1,class:"message-citations"},fo=["onClick"],ho=["disabled","onClick"],bo={class:"chat-input-container"},yo={class:"chat-options"},ko={class:"qa-mode-toggle",title:"ç²¾ç¡®æ¨¡å¼ï¼šä½¿ç”¨RAGæ£€ç´¢ç›¸å…³ç‰‡æ®µï¼›å…¨å±€æ¨¡å¼ï¼šä½¿ç”¨å…¨æ–‡æ‘˜è¦"},_o={key:0,class:"precise-mode-options"},$o={class:"checkbox-label compact",title:"å¯ç”¨çˆ¶å­å—æ¨¡å¼"},wo={class:"checkbox-label compact",title:"å¯ç”¨æŽ¨ç†æ£€ç´¢"},xo={class:"checkbox-label compact",title:"å¯ç”¨é‡æŽ’åº"},Co={class:"input-label compact",title:"è¿”å›žçš„æœ€å¤§ç»“æžœæ•°"},So={class:"input-label compact",title:"ç›¸å…³æ€§é˜ˆå€¼"},Po={key:1,class:"global-mode-hint"},Io={class:"welcome-examples"},Mo=["onClick"],Ro={class:"chat-input-wrapper"},To=["disabled"],Uo=["disabled"],Ao={key:0,class:"modal note-modal show"},Bo={class:"modal-content note-modal-content"},Eo={class:"modal-body"},Lo={key:0,class:"qa-preview"},Do={class:"qa-preview-section"},zo={class:"qa-preview-content"},Oo={class:"qa-preview-section"},Go=["innerHTML"],Vo={key:0,class:"qa-preview-section"},qo={class:"qa-preview-citations"},Fo={class:"note-form"},Ko={class:"form-group"},No={class:"form-group"},jo=te({__name:"QAPanel",setup(n){const t=ce(),l=y(""),a=y("precise"),s=y(!0),o=y(!0),i=y(!0),u=y(5),r=y(0),d=y(null),m=G(()=>t.qaHistory),k=G(()=>t.isStreaming),$=G(()=>a.value==="precise");function w(j){a.value=j}async function x(){const j=l.value.trim();if(!j||!t.currentBookId||k.value)return;l.value="",t.clearQAHistory(),t.addQAMessage({id:Date.now().toString(),role:"user",content:j,timestamp:new Date().toISOString()}),await Ne(),U();const A=a.value==="global"?"æ­£åœ¨åˆ†æžå…¨æ–‡...":"æ€è€ƒä¸­...";t.addQAMessage({id:(Date.now()+1).toString(),role:"assistant",content:A,timestamp:new Date().toISOString(),isLoading:!0}),t.setStreaming(!0);try{const C=await Hs(t.currentBookId,j,{use_parent_child:s.value,use_reasoning:o.value,use_reranker:i.value,top_k:u.value,threshold:r.value,use_global_context:a.value==="global"});if(t.removeLoadingMessages(),C.success){const I=C.mode==="global"?"ðŸŒ å…¨å±€æ¨¡å¼":"ðŸŽ¯ ç²¾ç¡®æ¨¡å¼";t.addQAMessage({id:(Date.now()+2).toString(),role:"assistant",content:C.answer||"",timestamp:new Date().toISOString(),mode:I,citations:C.citations||[]})}else t.addQAMessage({id:(Date.now()+2).toString(),role:"assistant",content:"æŠ±æ­‰ï¼Œå¤„ç†é—®é¢˜æ—¶å‡ºé”™: "+(C.error||"æœªçŸ¥é”™è¯¯"),timestamp:new Date().toISOString()})}catch(C){console.error("é—®ç­”è¯·æ±‚å¤±è´¥:",C),t.removeLoadingMessages(),t.addQAMessage({id:(Date.now()+2).toString(),role:"assistant",content:"æŠ±æ­‰ï¼Œç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•ã€‚",timestamp:new Date().toISOString()})}finally{t.setStreaming(!1),await Ne(),U()}}function S(j){j.key==="Enter"&&!j.shiftKey&&(j.preventDefault(),x())}function U(){d.value&&(d.value.scrollTop=d.value.scrollHeight)}async function R(){if(t.currentBookId&&confirm(`ç¡®å®šè¦é‡å»ºå‘é‡ç´¢å¼•å—ï¼Ÿ

è¿™å°†åˆ é™¤çŽ°æœ‰çš„å‘é‡æ•°æ®å¹¶é‡æ–°æž„å»ºï¼Œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚`)){t.setLoading(!0);try{const j=await Qs(t.currentBookId);if(j.success){let A="å‘é‡ç´¢å¼•é‡å»ºå®Œæˆ";j.stats&&(A+=`
é¡µé¢å‘é‡: ${j.stats.pages_count||0} æ¡`,j.stats.dialogues_count&&(A+=`
å¯¹è¯å‘é‡: ${j.stats.dialogues_count} æ¡`)),alert(A)}else alert("é‡å»ºå¤±è´¥: "+(j.error||"æœªçŸ¥é”™è¯¯"))}catch(j){console.error("é‡å»ºå‘é‡ç´¢å¼•å¤±è´¥:",j),alert("é‡å»ºå‘é‡ç´¢å¼•å¤±è´¥")}finally{t.setLoading(!1)}}}function D(j){return j?ne.parse(j):""}function f(j){t.setCurrentPage(j)}const b=["æ•…äº‹çš„ä¸»é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ","ä¸»è§’çš„æ€§æ ¼æœ‰ä»€ä¹ˆå˜åŒ–ï¼Ÿ","ç»“å±€æ˜¯æ€Žæ ·çš„ï¼Ÿ"];function p(j){l.value=j,x()}const c=y(!1),h=y(null),P=y(""),T=y("");function M(j){if(!t.currentBookId)return;const C=t.qaHistory.find(I=>I.role==="user")?.content||"";h.value={messageId:j.id,question:C,answer:j.content,citations:j.citations||[]},P.value="",T.value="",c.value=!0}function z(){c.value=!1,h.value=null}async function Y(){if(!t.currentBookId||!h.value)return;const j=new Date().toISOString(),A={id:Date.now().toString(),type:"qa",title:P.value||h.value.question.substring(0,30),content:h.value.answer,question:h.value.question,answer:h.value.answer,citations:h.value.citations,comment:T.value||void 0,createdAt:j,updatedAt:j};try{await t.addNote(A);const C=t.qaHistory.find(I=>I.id===h.value?.messageId);C&&(C.saved=!0),z()}catch(C){console.error("ä¿å­˜ç¬”è®°å¤±è´¥:",C),alert("ä¿å­˜ç¬”è®°å¤±è´¥")}}return ke(()=>{U()}),(j,A)=>(v(),g("div",lo,[e("div",{ref_key:"messagesContainer",ref:d,class:"chat-messages"},[m.value.length===0?(v(),g("div",oo,[...A[10]||(A[10]=[e("div",{class:"welcome-icon"},"ðŸ’¬",-1),e("h3",null,"æ™ºèƒ½é—®ç­”",-1),e("p",null,"é’ˆå¯¹å·²åˆ†æžçš„æ¼«ç”»å†…å®¹æé—®ï¼ŒèŽ·å–ç²¾å‡†å›žç­”",-1)])])):E("",!0),(v(!0),g(Q,null,W(m.value,C=>(v(),g("div",{key:C.id,class:H(["chat-message",C.role])},[e("div",ro,[C.role==="user"?(v(),g("img",io)):(v(),g(Q,{key:1},[se(" ðŸ¤– ")],64))]),C.role==="user"?(v(),g("div",uo,_(C.content),1)):(v(),g("div",co,[C.isLoading?(v(),g("div",po,_(C.content),1)):(v(),g(Q,{key:1},[C.mode?(v(),g("div",vo,_(C.mode),1)):E("",!0),e("div",{class:"answer-text",innerHTML:D(C.content)},null,8,mo),C.citations&&C.citations.length>0?(v(),g("div",go,[A[11]||(A[11]=e("span",null,"ðŸ“– å¼•ç”¨: ",-1)),(v(!0),g(Q,null,W(C.citations,I=>(v(),g("span",{key:I.page,class:"citation-item",onClick:L=>f(I.page)}," ç¬¬"+_(I.page)+"é¡µ ",9,fo))),128))])):E("",!0),C.content&&!C.isLoading?(v(),g("button",{key:2,class:H(["message-save-btn",{saved:C.saved}]),disabled:C.saved,onClick:I=>M(C)},_(C.saved?"âœ… å·²ä¿å­˜":"ðŸ“ ä¿å­˜ä¸ºç¬”è®°"),11,ho)):E("",!0)],64))]))],2))),128))],512),e("div",bo,[e("div",yo,[e("div",ko,[e("button",{type:"button",class:H(["qa-mode-btn",{active:a.value==="precise"}]),onClick:A[0]||(A[0]=C=>w("precise"))}," ðŸŽ¯ ç²¾ç¡®æ¨¡å¼ ",2),e("button",{type:"button",class:H(["qa-mode-btn",{active:a.value==="global"}]),onClick:A[1]||(A[1]=C=>w("global"))}," ðŸŒ å…¨å±€æ¨¡å¼ ",2)]),A[20]||(A[20]=e("span",{class:"chat-option-divider"},"|",-1)),$.value?(v(),g("div",_o,[e("label",$o,[O(e("input",{"onUpdate:modelValue":A[2]||(A[2]=C=>s.value=C),type:"checkbox"},null,512),[[Ue,s.value]]),A[12]||(A[12]=e("span",null,"çˆ¶å­å—æ¨¡å¼",-1))]),e("label",wo,[O(e("input",{"onUpdate:modelValue":A[3]||(A[3]=C=>o.value=C),type:"checkbox"},null,512),[[Ue,o.value]]),A[13]||(A[13]=e("span",null,"æŽ¨ç†æ£€ç´¢",-1))]),e("label",xo,[O(e("input",{"onUpdate:modelValue":A[4]||(A[4]=C=>i.value=C),type:"checkbox"},null,512),[[Ue,i.value]]),A[14]||(A[14]=e("span",null,"é‡æŽ’åº",-1))]),A[17]||(A[17]=e("span",{class:"chat-option-divider"},"|",-1)),e("label",Co,[A[15]||(A[15]=e("span",null,"Top K:",-1)),O(e("input",{"onUpdate:modelValue":A[5]||(A[5]=C=>u.value=C),type:"number",min:"1",max:"20",class:"input-small"},null,512),[[N,u.value,void 0,{number:!0}]])]),e("label",So,[A[16]||(A[16]=e("span",null,"é˜ˆå€¼:",-1)),O(e("input",{"onUpdate:modelValue":A[6]||(A[6]=C=>r.value=C),type:"number",min:"0",max:"1",step:"0.1",class:"input-small"},null,512),[[N,r.value,void 0,{number:!0}]])]),A[18]||(A[18]=e("span",{class:"chat-option-divider"},"|",-1)),e("button",{type:"button",class:"btn btn-sm btn-secondary",title:"é‡å»ºå‘é‡ç´¢å¼•",onClick:R}," ðŸ”„ é‡å»ºå‘é‡ ")])):(v(),g("div",Po,[A[19]||(A[19]=e("span",{class:"hint-text"},"ðŸ’¡ å…¨å±€æ¨¡å¼ä½¿ç”¨å…¨æ–‡æ‘˜è¦å›žç­”ï¼Œé€‚åˆæ€»ç»“æ€§é—®é¢˜",-1)),e("div",Io,[(v(),g(Q,null,W(b,(C,I)=>e("span",{key:I,class:"example-tag",onClick:L=>p(C)},_(C),9,Mo)),64))])]))]),e("div",Ro,[O(e("textarea",{"onUpdate:modelValue":A[7]||(A[7]=C=>l.value=C),placeholder:"è¾“å…¥ä½ çš„é—®é¢˜...",rows:"1",disabled:k.value,onKeydown:S},null,40,To),[[N,l.value]]),e("button",{class:"send-btn",disabled:k.value||!l.value.trim(),onClick:x},[...A[21]||(A[21]=[e("span",null,"å‘é€",-1)])],8,Uo)])]),c.value?(v(),g("div",Ao,[e("div",{class:"modal-overlay",onClick:z}),e("div",Bo,[e("div",{class:"modal-header"},[A[22]||(A[22]=e("h2",null,"ðŸ“ æ·»åŠ ç¬”è®°",-1)),e("button",{class:"modal-close",onClick:z},"Ã—")]),e("div",Eo,[h.value?(v(),g("div",Lo,[e("div",Do,[A[23]||(A[23]=e("label",null,"é—®é¢˜",-1)),e("div",zo,_(h.value.question),1)]),e("div",Oo,[A[24]||(A[24]=e("label",null,"å›žç­”",-1)),e("div",{class:"qa-preview-content",innerHTML:D(h.value.answer)},null,8,Go)]),h.value.citations.length>0?(v(),g("div",Vo,[A[25]||(A[25]=e("label",null,"å¼•ç”¨é¡µç ",-1)),e("div",qo,[(v(!0),g(Q,null,W(h.value.citations,C=>(v(),g("span",{key:C.page,class:"qa-citation-badge"}," ç¬¬"+_(C.page)+"é¡µ ",1))),128))])])):E("",!0)])):E("",!0),e("div",Fo,[e("div",Ko,[A[26]||(A[26]=e("label",{for:"qaNoteTitle"},[se("ç¬”è®°æ ‡é¢˜ "),e("span",{class:"optional"},"(å¯é€‰)")],-1)),O(e("input",{"onUpdate:modelValue":A[8]||(A[8]=C=>P.value=C),type:"text",id:"qaNoteTitle",class:"form-input",placeholder:"é»˜è®¤ä½¿ç”¨é—®é¢˜ä½œä¸ºæ ‡é¢˜..."},null,512),[[N,P.value]])]),e("div",No,[A[27]||(A[27]=e("label",{for:"qaNoteComment"},[se("è¡¥å……è¯´æ˜Ž "),e("span",{class:"optional"},"(å¯é€‰)")],-1)),O(e("textarea",{"onUpdate:modelValue":A[9]||(A[9]=C=>T.value=C),id:"qaNoteComment",class:"form-textarea",rows:"3",placeholder:"æ·»åŠ ä½ çš„è¯„è®ºæˆ–è¡¥å……..."},null,512),[[N,T.value]])])])]),e("div",{class:"modal-footer"},[e("button",{class:"btn btn-secondary",onClick:z},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:Y},"ä¿å­˜ç¬”è®°")])])])):E("",!0)]))}}),Ho=oe(jo,[["__scopeId","data-v-0019a5fe"]]),Qo={class:"workspace-section notes-section"},Jo={class:"section-header-with-actions"},Zo={class:"notes-filter"},Wo={class:"notes-list"},Xo={key:0,class:"placeholder-text"},Yo=["onClick"],er={class:"note-header"},tr={class:"note-type-icon"},sr={class:"note-date"},nr={class:"note-actions"},ar=["onClick"],lr=["onClick"],or={key:0,class:"note-title"},rr={key:1,class:"note-content"},ir={class:"qa-preview-text"},ur={key:2,class:"note-content"},cr={key:3,class:"note-tags"},dr={key:4,class:"note-citations"},pr=["onClick"],vr={key:0,class:"citation-badge"},mr={key:5,class:"note-page-link"},gr=["onClick"],fr={class:"modal-content modal-sm"},hr={class:"modal-header"},br={class:"modal-body"},yr={class:"qa-note-view"},kr={class:"qa-section"},_r={class:"qa-content"},$r={class:"qa-section"},wr={class:"qa-content qa-answer"},xr={key:0,class:"qa-section"},Cr={class:"qa-citations"},Sr=["onClick"],Pr={key:1,class:"qa-section"},Ir={class:"qa-content"},Mr={class:"form-group"},Rr={class:"form-group"},Tr={class:"form-group"},Ur={class:"form-group"},Ar={class:"form-group"},Br={class:"form-group"},Er={class:"modal-footer"},Lr=["disabled"],Dr=te({__name:"NotesPanel",setup(n){const t=[{label:"å…¨éƒ¨",value:"all"},{label:"æ–‡æœ¬ç¬”è®°",value:"text"},{label:"é—®ç­”ç¬”è®°",value:"qa"}],l=[{label:"æ–‡æœ¬ç¬”è®°",value:"text"},{label:"é—®ç­”ç¬”è®°",value:"qa"}],a=ce(),s=y(!1),o=y(null),i=y(""),u=y(""),r=y("text"),d=y(null),m=y(""),k=G(()=>a.filteredNotes),$=G({get:()=>a.noteTypeFilter,set:c=>a.setNoteTypeFilter(c)});function w(){o.value=null,i.value="",u.value="",r.value="text",d.value=a.selectedPageNum,m.value="",s.value=!0}function x(c){o.value=c,i.value=c.title||"",u.value=c.content,r.value=c.type,d.value=c.pageNum||null,m.value=(c.tags||[]).join(", "),s.value=!0}function S(){s.value=!1,o.value=null,i.value="",u.value="",m.value=""}function U(c){return c.trim()?c.split(/[,ï¼Œ]/).map(h=>h.trim()).filter(h=>h):[]}async function R(){if(!u.value.trim())return;const c=U(m.value);if(o.value)await a.updateNote(o.value.id,{title:i.value||void 0,content:u.value,type:r.value,pageNum:d.value||void 0,tags:c.length>0?c:void 0});else{const h={id:Date.now().toString(),type:r.value,title:i.value||void 0,content:u.value,pageNum:d.value||void 0,tags:c.length>0?c:void 0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};await a.addNote(h)}S()}async function D(c){confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ")&&await a.deleteNote(c)}function f(c){a.selectPage(c)}function b(c){return new Date(c).toLocaleDateString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function p(c){return c==="qa"?"ðŸ’¬":"ðŸ“"}return(c,h)=>(v(),g("div",Qo,[e("div",Jo,[h[7]||(h[7]=e("h3",{class:"section-title"},"ðŸ“ ç¬”è®°",-1)),e("div",Zo,[X(he,{modelValue:$.value,"onUpdate:modelValue":h[0]||(h[0]=P=>$.value=P),options:t},null,8,["modelValue"])])]),e("div",Wo,[k.value.length===0?(v(),g("div",Xo," æš‚æ— ç¬”è®° ")):E("",!0),(v(!0),g(Q,null,W(k.value,P=>(v(),g("div",{key:P.id,class:H(["note-item",{"qa-note":P.type==="qa"}]),onClick:T=>x(P)},[e("div",er,[e("span",tr,_(p(P.type)),1),e("span",sr,_(b(P.createdAt)),1),e("div",nr,[e("button",{class:"btn-icon-sm",title:"ç¼–è¾‘",onClick:ie(T=>x(P),["stop"])}," âœï¸ ",8,ar),e("button",{class:"btn-icon-sm",title:"åˆ é™¤",onClick:ie(T=>D(P.id),["stop"])}," ðŸ—‘ï¸ ",8,lr)])]),P.title?(v(),g("div",or,_(P.title),1)):E("",!0),P.type==="qa"?(v(),g("div",rr,[e("div",ir,"Q: "+_(P.question?.substring(0,60))+"...",1)])):(v(),g("div",ur,_(P.content),1)),P.tags&&P.tags.length>0?(v(),g("div",cr,[(v(!0),g(Q,null,W(P.tags,T=>(v(),g("span",{key:T,class:"note-tag"},_(T),1))),128))])):E("",!0),P.type==="qa"&&P.citations&&P.citations.length>0?(v(),g("div",dr,[(v(!0),g(Q,null,W(P.citations.slice(0,3),T=>(v(),g("span",{key:T.page,class:"citation-badge",onClick:ie(M=>f(T.page),["stop"])}," ç¬¬"+_(T.page)+"é¡µ ",9,pr))),128)),P.citations.length>3?(v(),g("span",vr,"+"+_(P.citations.length-3),1)):E("",!0)])):E("",!0),P.pageNum?(v(),g("div",mr,[e("button",{class:"btn-link",onClick:ie(T=>f(P.pageNum),["stop"])}," ðŸ“„ ç¬¬ "+_(P.pageNum)+" é¡µ ",9,gr)])):E("",!0)],10,Yo))),128))]),e("button",{class:"btn btn-secondary btn-block btn-sm",onClick:w}," + æ·»åŠ ç¬”è®° "),s.value?(v(),g("div",{key:0,class:"modal show",onClick:ie(S,["self"])},[e("div",fr,[e("div",hr,[e("h3",null,_(o.value?"ç¼–è¾‘ç¬”è®°":"æ·»åŠ ç¬”è®°"),1),e("button",{class:"modal-close",onClick:S},"Ã—")]),e("div",br,[o.value&&o.value.type==="qa"?(v(),g(Q,{key:0},[e("div",yr,[e("div",kr,[h[8]||(h[8]=e("label",{class:"qa-label"},"é—®é¢˜",-1)),e("div",_r,_(o.value.question),1)]),e("div",$r,[h[9]||(h[9]=e("label",{class:"qa-label"},"å›žç­”",-1)),e("div",wr,_(o.value.answer),1)]),o.value.citations&&o.value.citations.length>0?(v(),g("div",xr,[h[10]||(h[10]=e("label",{class:"qa-label"},"å¼•ç”¨é¡µç ",-1)),e("div",Cr,[(v(!0),g(Q,null,W(o.value.citations,P=>(v(),g("span",{key:P.page,class:"qa-citation-badge",onClick:T=>f(P.page)}," ç¬¬"+_(P.page)+"é¡µ ",9,Sr))),128))])])):E("",!0),o.value.comment?(v(),g("div",Pr,[h[11]||(h[11]=e("label",{class:"qa-label"},"è¡¥å……è¯´æ˜Ž",-1)),e("div",Ir,_(o.value.comment),1)])):E("",!0)]),e("div",Mr,[h[12]||(h[12]=e("label",null,[se("ç¬”è®°æ ‡é¢˜ "),e("span",{class:"label-optional"},"(å¯é€‰)")],-1)),O(e("input",{"onUpdate:modelValue":h[1]||(h[1]=P=>i.value=P),type:"text",class:"form-input",placeholder:"ä¿®æ”¹æ ‡é¢˜..."},null,512),[[N,i.value]])])],64)):(v(),g(Q,{key:1},[e("div",Rr,[h[13]||(h[13]=e("label",null,"ç¬”è®°ç±»åž‹",-1)),X(he,{modelValue:r.value,"onUpdate:modelValue":h[2]||(h[2]=P=>r.value=P),options:l},null,8,["modelValue"])]),e("div",Tr,[h[14]||(h[14]=e("label",null,[se("æ ‡é¢˜ "),e("span",{class:"label-optional"},"(å¯é€‰)")],-1)),O(e("input",{"onUpdate:modelValue":h[3]||(h[3]=P=>i.value=P),type:"text",class:"form-input",placeholder:"ç»™ç¬”è®°èµ·ä¸ªæ ‡é¢˜..."},null,512),[[N,i.value]])]),e("div",Ur,[h[15]||(h[15]=e("label",null,[se("å†…å®¹ "),e("span",{class:"label-required"},"*")],-1)),O(e("textarea",{"onUpdate:modelValue":h[4]||(h[4]=P=>u.value=P),class:"form-textarea",rows:"5",placeholder:"å†™ä¸‹ä½ çš„æƒ³æ³•..."},null,512),[[N,u.value]])]),e("div",Ar,[h[16]||(h[16]=e("label",null,[se("å…³è”é¡µç  "),e("span",{class:"label-optional"},"(å¯é€‰)")],-1)),O(e("input",{"onUpdate:modelValue":h[5]||(h[5]=P=>d.value=P),type:"number",class:"form-input",placeholder:"è¾“å…¥é¡µç ",min:"1"},null,512),[[N,d.value,void 0,{number:!0}]])]),e("div",Br,[h[17]||(h[17]=e("label",null,[se("æ ‡ç­¾ "),e("span",{class:"label-optional"},"(å¯é€‰)")],-1)),O(e("input",{"onUpdate:modelValue":h[6]||(h[6]=P=>m.value=P),type:"text",class:"form-input",placeholder:"å¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: è§’è‰²,å‰§æƒ…"},null,512),[[N,m.value]])])],64))]),e("div",Er,[e("button",{class:"btn btn-secondary",onClick:S},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",disabled:o.value?.type!=="qa"&&!u.value.trim(),onClick:R}," ä¿å­˜ ",8,Lr)])])])):E("",!0)]))}}),zr=oe(Dr,[["__scopeId","data-v-45521d3c"]]),Or={class:"workspace-section page-detail-section"},Gr={class:"page-detail"},Vr={key:0,class:"placeholder-text"},qr={key:1,class:"loading-state"},Fr={key:2,class:"page-detail-content"},Kr={class:"page-detail-header"},Nr={class:"page-nav-buttons"},jr=["disabled"],Hr={class:"page-indicator"},Qr=["disabled"],Jr={key:0,class:"error-message"},Zr=["src","alt"],Wr={key:1,class:"page-summary"},Xr={key:2,class:"page-summary empty"},Yr={key:3,class:"scene-mood-info"},ei={key:0,class:"info-item"},ti={class:"info-value"},si={key:1,class:"info-item"},ni={class:"info-value"},ai={key:4,class:"dialogues-section"},li={class:"dialogue-speaker"},oi={class:"dialogue-text"},ri={key:0,class:"dialogue-original"},ii={key:5,class:"dialogues-section empty"},ui={class:"page-detail-actions"},ci=["disabled"],di={key:0,class:"btn-spinner"},pi=["disabled"],vi=["src","alt"],mi={class:"preview-nav"},gi=["disabled"],fi={class:"preview-page-info"},hi=["disabled"],bi=te({__name:"PageDetail",setup(n){const t=ce(),l=y(null),a=y(!1),s=y(!1),o=y(!1),i=y(""),u=G(()=>t.selectedPageNum),r=G(()=>t.totalPageCount),d=G(()=>u.value!==null&&u.value>1),m=G(()=>u.value!==null&&u.value<r.value),k=G(()=>!t.currentBookId||!u.value?"":Gs(t.currentBookId,u.value)),$=G(()=>{if(!l.value?.panels)return[];const T=[];for(const M of l.value.panels)if(M.dialogues)for(const z of M.dialogues){const Y=z.translated_text||z.text;Y&&T.push({speaker:z.speaker_name||z.character||"æœªçŸ¥",text:Y,originalText:z.text!==z.translated_text?z.text:void 0})}return T}),w=G(()=>l.value?.analyzed===!0||!!l.value?.page_summary),x=G(()=>l.value?.scene||""),S=G(()=>l.value?.mood||"");async function U(){if(!t.currentBookId||!u.value){l.value=null;return}a.value=!0,i.value="";try{const T=await Os(t.currentBookId,u.value);T.success?T.analysis?l.value=T.analysis:T.page?l.value=T.page:l.value=null:(l.value=null,T.error&&(i.value=T.error))}catch(T){console.error("åŠ è½½é¡µé¢è¯¦æƒ…å¤±è´¥:",T),l.value=null,i.value=T instanceof Error?T.message:"åŠ è½½å¤±è´¥"}finally{a.value=!1}}function R(){d.value&&u.value&&t.selectPage(u.value-1)}function D(){m.value&&u.value&&t.selectPage(u.value+1)}async function f(){if(!(!t.currentBookId||!u.value)){s.value=!0,i.value="";try{const T=await zs(t.currentBookId,u.value);T.success?await U():i.value=T.error||"é‡æ–°åˆ†æžå¤±è´¥"}catch(T){console.error("é‡æ–°åˆ†æžå¤±è´¥:",T),i.value=T instanceof Error?T.message:"é‡æ–°åˆ†æžå¤±è´¥"}finally{s.value=!1}}}function b(){o.value=!0}function p(){o.value=!1}function c(T){if(o.value)switch(T.key){case"Escape":p();break;case"ArrowLeft":d.value&&R();break;case"ArrowRight":m.value&&D();break}}const h=y(!1);async function P(){if(!(!t.currentBookId||!u.value||!l.value)){h.value=!0;try{let T=`# ç¬¬ ${u.value} é¡µåˆ†æžæ•°æ®

`;if(l.value.page_summary&&(T+=`## ðŸ“ é¡µé¢æ‘˜è¦

${l.value.page_summary}

`),l.value.scene&&(T+=`## ðŸŽ¬ åœºæ™¯

${l.value.scene}

`),l.value.mood&&(T+=`## ðŸŽ­ æ°›å›´

${l.value.mood}

`),$.value.length>0){T+=`## ðŸ’¬ å¯¹è¯å†…å®¹

`;for(const j of $.value)T+=`**${j.speaker}**: ${j.text}

`,j.originalText&&(T+=`> åŽŸæ–‡: ${j.originalText}

`)}const M=new Blob([T],{type:"text/markdown"}),z=URL.createObjectURL(M),Y=document.createElement("a");Y.href=z,Y.download=`${t.currentBookId}_page_${u.value}.md`,Y.click(),URL.revokeObjectURL(z)}catch(T){console.error("å¯¼å‡ºé¡µé¢æ•°æ®å¤±è´¥:",T),i.value="å¯¼å‡ºå¤±è´¥"}finally{h.value=!1}}}return ue(u,()=>{U()},{immediate:!0}),(T,M)=>(v(),g("div",Or,[M[12]||(M[12]=e("h3",{class:"section-title"},"ðŸ“„ é¡µé¢è¯¦æƒ…",-1)),e("div",Gr,[u.value?a.value?(v(),g("div",qr,[...M[3]||(M[3]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"åŠ è½½ä¸­...",-1)])])):(v(),g("div",Fr,[e("div",Kr,[e("h4",null,"ðŸ“„ ç¬¬ "+_(u.value)+" é¡µ",1),e("div",Nr,[e("button",{class:H(["btn-page-nav",{disabled:!d.value}]),disabled:!d.value,title:"ä¸Šä¸€é¡µ (â†)",onClick:R}," â—€ ä¸Šä¸€å¼  ",10,jr),e("span",Hr,_(u.value)+" / "+_(r.value),1),e("button",{class:H(["btn-page-nav",{disabled:!m.value}]),disabled:!m.value,title:"ä¸‹ä¸€é¡µ (â†’)",onClick:D}," ä¸‹ä¸€å¼  â–¶ ",10,Qr)])]),i.value?(v(),g("div",Jr," âš ï¸ "+_(i.value),1)):E("",!0),e("div",{class:"page-detail-image",onClick:b},[e("img",{src:k.value,alt:`ç¬¬${u.value}é¡µ`,onError:M[0]||(M[0]=z=>z.target.style.display="none")},null,40,Zr),M[4]||(M[4]=e("div",{class:"image-overlay"},[e("span",{class:"zoom-hint"},"ðŸ” ç‚¹å‡»æ”¾å¤§")],-1))]),e("div",{class:H(["analysis-status-tag",{analyzed:w.value}])},_(w.value?"âœ“ å·²åˆ†æž":"â—‹ æœªåˆ†æž"),3),l.value?.page_summary?(v(),g("div",Wr,[M[5]||(M[5]=e("h5",null,"ðŸ“ é¡µé¢æ‘˜è¦",-1)),e("p",null,_(l.value.page_summary),1)])):(v(),g("div",Xr,[...M[6]||(M[6]=[e("p",null,"æ­¤é¡µå°šæœªåˆ†æžï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹åˆ†æž",-1)])])),x.value||S.value?(v(),g("div",Yr,[x.value?(v(),g("div",ei,[M[7]||(M[7]=e("span",{class:"info-label"},"ðŸŽ¬ åœºæ™¯ï¼š",-1)),e("span",ti,_(x.value),1)])):E("",!0),S.value?(v(),g("div",si,[M[8]||(M[8]=e("span",{class:"info-label"},"ðŸŽ­ æ°›å›´ï¼š",-1)),e("span",ni,_(S.value),1)])):E("",!0)])):E("",!0),$.value.length>0?(v(),g("div",ai,[e("h5",null,"ðŸ’¬ å¯¹è¯å†…å®¹ ("+_($.value.length)+")",1),(v(!0),g(Q,null,W($.value,(z,Y)=>(v(),g("div",{key:Y,class:"dialogue-item"},[e("div",li,[M[9]||(M[9]=e("span",{class:"speaker-icon"},"ðŸ‘¤",-1)),se(" "+_(z.speaker),1)]),e("div",oi,_(z.text),1),z.originalText?(v(),g("div",ri,[M[10]||(M[10]=e("span",{class:"original-label"},"åŽŸæ–‡ï¼š",-1)),se(_(z.originalText),1)])):E("",!0)]))),128))])):w.value?(v(),g("div",ii,[...M[11]||(M[11]=[e("p",null,"æ­¤é¡µæ²¡æœ‰æ£€æµ‹åˆ°å¯¹è¯å†…å®¹",-1)])])):E("",!0),e("div",ui,[e("button",{class:H(["btn btn-secondary btn-sm",{loading:s.value}]),disabled:s.value,onClick:f},[s.value?(v(),g("span",di)):E("",!0),se(" "+_(s.value?"åˆ†æžä¸­...":"ðŸ”„ é‡æ–°åˆ†æž"),1)],10,ci),w.value?(v(),g("button",{key:0,class:"btn btn-secondary btn-sm",disabled:h.value,onClick:P},_(h.value?"å¯¼å‡ºä¸­...":"ðŸ“„ å¯¼å‡ºæ­¤é¡µ"),9,pi)):E("",!0)])])):(v(),g("div",Vr,[...M[2]||(M[2]=[e("div",{class:"empty-icon"},"ðŸ“„",-1),e("p",null,"ç‚¹å‡»å·¦ä¾§å¯¼èˆªæ ‘ä¸­çš„é¡µé¢æŸ¥çœ‹è¯¦æƒ…",-1)])]))]),o.value?(v(),g("div",{key:0,class:"image-preview-modal",tabindex:"0",onClick:p,onKeydown:c},[e("div",{class:"image-preview-content",onClick:M[1]||(M[1]=ie(()=>{},["stop"]))},[e("button",{class:"preview-close",title:"å…³é—­ (Esc)",onClick:p},"Ã—"),e("img",{src:k.value,alt:`ç¬¬${u.value}é¡µ`},null,8,vi),e("div",mi,[e("button",{class:"preview-nav-btn prev",disabled:!d.value,title:"ä¸Šä¸€é¡µ (â†)",onClick:ie(R,["stop"])}," â—€ ",8,gi),e("span",fi,_(u.value)+" / "+_(r.value),1),e("button",{class:"preview-nav-btn next",disabled:!m.value,title:"ä¸‹ä¸€é¡µ (â†’)",onClick:ie(D,["stop"])}," â–¶ ",8,hi)])])],32)):E("",!0)]))}}),yi=oe(bi,[["__scopeId","data-v-25a66086"]]),ki={class:"sidebar-section pages-tree-section"},_i={class:"section-header"},$i={class:"page-count-badge"},wi={class:"pages-tree"},xi={key:0,class:"empty-hint"},Ci={key:1,class:"tree-all-pages"},Si=["data-page","onClick"],Pi=["src","alt"],Ii={class:"tree-page-num"},Mi={key:2,class:"tree-load-more"},Ri=["onClick"],Ti={class:"tree-chapter-info"},Ui={class:"tree-chapter-title"},Ai={class:"tree-chapter-meta"},Bi=["onClick"],Ei={class:"tree-pages-grid"},Li=["data-page","onClick"],Di=["src","alt"],zi={class:"tree-page-num"},Oi=te({__name:"PagesTree",setup(n){const t=ce(),l=y(new Set),a=y(new Map),s=y(100),o=G(()=>t.chapters),i=G(()=>t.totalPageCount);function u(f){l.value.has(f)?l.value.delete(f):l.value.add(f)}function r(f){return l.value.has(f)}function d(f){t.selectPage(f)}function m(f){return a.value.get(f)||!1}function k(f){return t.selectedPageNum===f}function $(f,b){const p=[];for(let c=f;c<=b;c++)p.push(c);return p}function w(f){return t.currentBookId?nt(t.currentBookId,f):""}function x(){s.value=Math.min(s.value+100,i.value)}function S(f){const b=f.target;b.style.opacity="0"}function U(f){const b=f.endPage-f.startPage+1;let p=0;for(let c=f.startPage;c<=f.endPage;c++)a.value.get(c)&&p++;return p===b}async function R(f){if(confirm("ç¡®å®šè¦é‡æ–°åˆ†æžæ­¤ç« èŠ‚å—ï¼Ÿ"))try{const p=await(await fetch(`/api/manga-insight/${t.currentBookId}/reanalyze/chapter/${f}`,{method:"POST"})).json();p.success?alert("ç« èŠ‚åˆ†æžå·²å¯åŠ¨"):alert("å¯åŠ¨å¤±è´¥: "+(p.error||"æœªçŸ¥é”™è¯¯"))}catch(b){console.error("é‡æ–°åˆ†æžç« èŠ‚å¤±è´¥:",b),alert("é‡æ–°åˆ†æžå¤±è´¥")}}async function D(){if(t.currentBookId)try{const b=await(await fetch(`/api/manga-insight/${t.currentBookId}/pages`)).json();b.success&&b.pages&&b.pages.forEach(c=>{a.value.set(c,!0)})}catch(f){console.error("åŠ è½½å·²åˆ†æžé¡µé¢å¤±è´¥:",f)}}return ke(async()=>{await D(),o.value.length>0&&o.value[0]&&l.value.add(o.value[0].id)}),ue(()=>t.analyzedPageCount,async(f,b)=>{f!==b&&f>0&&(console.log(`å·²åˆ†æžé¡µæ•°å˜åŒ–: ${b} -> ${f}ï¼Œåˆ·æ–°é¡µé¢æ ‡è®°`),a.value.clear(),await D())}),(f,b)=>(v(),g("div",ki,[e("div",_i,[b[2]||(b[2]=e("h3",{class:"section-title"},"å†…å®¹å¯¼èˆª",-1)),e("span",$i,_(i.value)+"é¡µ",1)]),e("div",wi,[o.value.length===0?(v(),g(Q,{key:0},[i.value===0?(v(),g("div",xi," æš‚æ— é¡µé¢ ")):(v(),g("div",Ci,[(v(!0),g(Q,null,W($(1,Math.min(i.value,s.value)),p=>(v(),g("div",{key:p,class:H(["tree-page-item",{selected:k(p),analyzed:m(p)}]),"data-page":p,onClick:c=>d(p)},[e("img",{src:w(p),alt:`ç¬¬${p}é¡µ`,class:"tree-page-thumb",loading:"lazy",onError:b[0]||(b[0]=c=>S(c))},null,40,Pi),e("span",Ii,_(p),1)],10,Si))),128))])),i.value>s.value?(v(),g("div",Mi,[e("button",{class:"btn-load-more",onClick:x}," åŠ è½½æ›´å¤š (è¿˜æœ‰ "+_(i.value-s.value)+" é¡µ) ",1)])):E("",!0)],64)):(v(!0),g(Q,{key:1},W(o.value,p=>(v(),g("div",{key:p.id,class:H(["tree-chapter",{expanded:r(p.id)}])},[e("div",{class:"tree-chapter-header",onClick:c=>u(p.id)},[b[3]||(b[3]=e("span",{class:"tree-expand-icon"},[e("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M8 5l8 7-8 7z"})])],-1)),e("div",Ti,[e("span",Ui,_(p.title),1),e("span",Ai,_(p.endPage-p.startPage+1)+"é¡µ",1)]),e("span",{class:H(["tree-chapter-status",{analyzed:U(p)}])},null,2),e("button",{class:"btn-reanalyze-chapter",title:"é‡æ–°åˆ†æžæ­¤ç« èŠ‚",onClick:ie(c=>R(p.id),["stop"])}," ðŸ”„ ",8,Bi)],8,Ri),e("div",Ei,[(v(!0),g(Q,null,W($(p.startPage,p.endPage),c=>(v(),g("div",{key:c,class:H(["tree-page-item",{selected:k(c),analyzed:m(c)}]),"data-page":c,onClick:h=>d(c)},[e("img",{src:w(c),alt:`ç¬¬${c}é¡µ`,class:"tree-page-thumb",loading:"lazy",onError:b[1]||(b[1]=h=>S(h))},null,40,Di),e("span",zi,_(c),1)],10,Li))),128))])],2))),128))])]))}}),Gi=oe(Oi,[["__scopeId","data-v-3a1c7721"]]),Xe=[{value:"openai",label:"OpenAI"},{value:"gemini",label:"Google Gemini"},{value:"qwen",label:"é€šä¹‰åƒé—®"},{value:"siliconflow",label:"SiliconFlow"},{value:"deepseek",label:"DeepSeek"},{value:"volcano",label:"ç«å±±å¼•æ“Ž"},{value:"custom",label:"è‡ªå®šä¹‰ API"}],Vi={openai:{vlm:!0,embedding:!0,rerank:!1,imageGen:!0},gemini:{vlm:!0,embedding:!0,rerank:!1,imageGen:!1},qwen:{vlm:!0,embedding:!0,rerank:!0,imageGen:!0},siliconflow:{vlm:!0,embedding:!0,rerank:!0,imageGen:!0},deepseek:{vlm:!0,embedding:!0,rerank:!0,imageGen:!1},volcano:{vlm:!0,embedding:!0,rerank:!0,imageGen:!0},custom:{vlm:!0,embedding:!0,rerank:!0,imageGen:!0}},Ft=Xe,qi=Xe,Fi=Xe,Ki=Xe,Ni=[{value:"simple",label:"ç®€æ´æ¨¡å¼ - æ‰¹é‡åˆ†æž â†’ å…¨ä¹¦æ€»ç»“ï¼ˆçŸ­ç¯‡ï¼‰"},{value:"standard",label:"æ ‡å‡†æ¨¡å¼ - æ‰¹é‡åˆ†æž â†’ æ®µè½æ€»ç»“ â†’ å…¨ä¹¦æ€»ç»“"},{value:"chapter_based",label:"ç« èŠ‚æ¨¡å¼ - æ‰¹é‡åˆ†æž â†’ ç« èŠ‚æ€»ç»“ â†’ å…¨ä¹¦æ€»ç»“"},{value:"full",label:"å®Œæ•´æ¨¡å¼ - æ‰¹é‡åˆ†æž â†’ å°æ€»ç»“ â†’ ç« èŠ‚æ€»ç»“ â†’ å…¨ä¹¦æ€»ç»“"},{value:"custom",label:"è‡ªå®šä¹‰æ¨¡å¼ - å®Œå…¨è‡ªå®šä¹‰å±‚çº§æž¶æž„"}],ji=[{value:"batch_analysis",label:"ðŸ“„ æ‰¹é‡åˆ†æžæç¤ºè¯"},{value:"segment_summary",label:"ðŸ“‘ æ®µè½æ€»ç»“æç¤ºè¯"},{value:"chapter_summary",label:"ðŸ“– ç« èŠ‚æ€»ç»“æç¤ºè¯"},{value:"qa_response",label:"ðŸ’¬ é—®ç­”å“åº”æç¤ºè¯"}],Ve={openai:{vlm:"gpt-4o",chat:"gpt-4o-mini",embedding:"text-embedding-3-small",imageGen:"dall-e-3"},gemini:{vlm:"gemini-2.0-flash",chat:"gemini-2.0-flash",embedding:"text-embedding-004"},qwen:{vlm:"qwen-vl-max",chat:"qwen-turbo",embedding:"text-embedding-v3",imageGen:"wanx-v1"},siliconflow:{vlm:"Qwen/Qwen2.5-VL-72B-Instruct",chat:"Qwen/Qwen2.5-72B-Instruct",embedding:"BAAI/bge-m3",reranker:"BAAI/bge-reranker-v2-m3",imageGen:"stabilityai/stable-diffusion-3-5-large"},deepseek:{vlm:"deepseek-chat",chat:"deepseek-chat"},volcano:{vlm:"doubao-1.5-vision-pro-32k",chat:"doubao-1.5-pro-32k",imageGen:"high_aes_general_v21"},jina:{reranker:"jina-reranker-v2-base-multilingual"},cohere:{reranker:"rerank-multilingual-v3.0"}},Hi=Object.fromEntries(Object.entries(Ve).filter(([n,t])=>t.vlm).map(([n,t])=>[n,t.vlm])),Qi=Object.fromEntries(Object.entries(Ve).filter(([n,t])=>t.chat).map(([n,t])=>[n,t.chat])),Ji=Object.fromEntries(Object.entries(Ve).filter(([n,t])=>t.embedding).map(([n,t])=>[n,t.embedding])),Zi=Object.fromEntries(Object.entries(Ve).filter(([n,t])=>t.reranker).map(([n,t])=>[n,t.reranker])),Wi=Object.fromEntries(Object.entries(Ve).filter(([n,t])=>t.imageGen).map(([n,t])=>[n,t.imageGen])),Ye={simple:{name:"ç®€æ´æ¨¡å¼",description:"é€‚åˆ100é¡µä»¥å†…çš„çŸ­ç¯‡æ¼«ç”»",layers:[{name:"æ‰¹é‡åˆ†æž",units:5,align:!1},{name:"å…¨ä¹¦æ€»ç»“",units:0,align:!1}]},standard:{name:"æ ‡å‡†æ¨¡å¼",description:"é€‚åˆå¤§å¤šæ•°æ¼«ç”»ï¼Œå¹³è¡¡æ•ˆæžœä¸Žé€Ÿåº¦",layers:[{name:"æ‰¹é‡åˆ†æž",units:5,align:!1},{name:"æ®µè½æ€»ç»“",units:5,align:!1},{name:"å…¨ä¹¦æ€»ç»“",units:0,align:!1}]},chapter_based:{name:"ç« èŠ‚æ¨¡å¼",description:"é€‚åˆæœ‰æ˜Žç¡®ç« èŠ‚åˆ’åˆ†çš„æ¼«ç”»ï¼Œä¼šåœ¨ç« èŠ‚è¾¹ç•Œå¤„åˆ‡åˆ†",layers:[{name:"æ‰¹é‡åˆ†æž",units:5,align:!0},{name:"ç« èŠ‚æ€»ç»“",units:0,align:!0},{name:"å…¨ä¹¦æ€»ç»“",units:0,align:!1}]},full:{name:"å®Œæ•´æ¨¡å¼",description:"é€‚åˆé•¿ç¯‡è¿žè½½ï¼Œæä¾›æœ€è¯¦ç»†çš„åˆ†å±‚æ€»ç»“",layers:[{name:"æ‰¹é‡åˆ†æž",units:5,align:!1},{name:"å°æ€»ç»“",units:5,align:!1},{name:"ç« èŠ‚æ€»ç»“",units:0,align:!0},{name:"å…¨ä¹¦æ€»ç»“",units:0,align:!1}]}},qe=["siliconflow","deepseek","volcano","gemini","qwen","openai","custom"],Xi={openai:{base:"https://api.openai.com/v1"},gemini:{base:"https://generativelanguage.googleapis.com/v1beta/openai/"},qwen:{base:"https://dashscope.aliyuncs.com/compatible-mode/v1",imageGen:"https://dashscope.aliyuncs.com/api/v1"},siliconflow:{base:"https://api.siliconflow.cn/v1"},deepseek:{base:"https://api.deepseek.com/v1"},volcano:{base:"https://ark.cn-beijing.volces.com/api/v3",imageGen:"https://visual.volcengineapi.com"},jina:{base:"https://api.jina.ai/v1"},cohere:{base:"https://api.cohere.ai/v1"}},Yi=Object.fromEntries(Object.entries(Xi).filter(([n])=>Vi[n]?.imageGen).map(([n,t])=>[n,t.imageGen||t.base||""])),eu={class:"insight-settings-content"},tu={class:"form-group"},su={class:"form-group"},nu={class:"form-group"},au={class:"model-input-row"},lu=["disabled"],ou={key:0,class:"model-select-container"},ru=["value"],iu=["value"],uu={class:"model-count"},cu={key:0,class:"form-group"},du={class:"form-row"},pu={class:"form-group"},vu={class:"form-group"},mu={class:"form-group"},gu={class:"checkbox-label"},fu={class:"form-group"},hu={class:"checkbox-label"},bu={class:"form-group"},yu=["disabled"],ku=te({__name:"VlmSettingsTab",emits:["showMessage"],setup(n,{expose:t,emit:l}){const a=l,s=ce(),o=y(!1),i=y(!1),u=y([]),r=y(!1),d=y(s.config.vlm.provider),m=y(s.config.vlm.apiKey),k=y(s.config.vlm.model),$=y(s.config.vlm.baseUrl),w=y(s.config.vlm.rpmLimit),x=y(s.config.vlm.temperature),S=y(s.config.vlm.forceJson),U=y(s.config.vlm.useStream),R=y(s.config.vlm.imageMaxSize),D=G(()=>d.value==="custom");function f(){const T=d.value;if(s.config.vlm.provider!==T&&(s.config.vlm.apiKey=m.value,s.config.vlm.model=k.value,s.config.vlm.baseUrl=$.value,s.config.vlm.rpmLimit=w.value,s.config.vlm.temperature=x.value,s.config.vlm.forceJson=S.value,s.config.vlm.useStream=U.value,s.config.vlm.imageMaxSize=R.value),s.setVlmProvider(T),m.value=s.config.vlm.apiKey,k.value=s.config.vlm.model,$.value=s.config.vlm.baseUrl,w.value=s.config.vlm.rpmLimit,x.value=s.config.vlm.temperature,S.value=s.config.vlm.forceJson,U.value=s.config.vlm.useStream,R.value=s.config.vlm.imageMaxSize,!k.value){const z=Hi[T];z&&(k.value=z)}}async function b(){if(!m.value){a("showMessage","è¯·å…ˆå¡«å†™ API Key","error");return}if(!qe.includes(d.value)){a("showMessage",`${d.value} ä¸æ”¯æŒè‡ªåŠ¨èŽ·å–æ¨¡åž‹åˆ—è¡¨`,"error");return}if(d.value==="custom"&&!$.value){a("showMessage","è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL","error");return}const T=d.value==="custom"?"custom_openai":d.value;i.value=!0;try{const M=await Oe(T,m.value,$.value||void 0);M.success&&M.models&&M.models.length>0?(u.value=M.models,r.value=!0,a("showMessage",`èŽ·å–åˆ° ${M.models.length} ä¸ªæ¨¡åž‹`,"success")):(a("showMessage",M.message||"æœªèŽ·å–åˆ°æ¨¡åž‹åˆ—è¡¨","error"),r.value=!1)}catch(M){a("showMessage","èŽ·å–æ¨¡åž‹åˆ—è¡¨å¤±è´¥: "+(M instanceof Error?M.message:"ç½‘ç»œé”™è¯¯"),"error"),r.value=!1}finally{i.value=!1}}function p(T){T&&(k.value=T)}async function c(){if(!o.value){o.value=!0;try{const T=await tn({provider:d.value,api_key:m.value,model:k.value,base_url:$.value||void 0});T.success?a("showMessage","VLM è¿žæŽ¥æˆåŠŸ","success"):a("showMessage","è¿žæŽ¥å¤±è´¥: "+(T.error||"æœªçŸ¥é”™è¯¯"),"error")}catch(T){a("showMessage","æµ‹è¯•å¤±è´¥: "+(T instanceof Error?T.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{o.value=!1}}}function h(){return{provider:d.value,apiKey:m.value,model:k.value,baseUrl:d.value==="custom"?$.value:"",rpmLimit:w.value,temperature:x.value,forceJson:S.value,useStream:U.value,imageMaxSize:R.value}}function P(){d.value=s.config.vlm.provider,m.value=s.config.vlm.apiKey,k.value=s.config.vlm.model,$.value=s.config.vlm.baseUrl,w.value=s.config.vlm.rpmLimit,x.value=s.config.vlm.temperature,S.value=s.config.vlm.forceJson,U.value=s.config.vlm.useStream,R.value=s.config.vlm.imageMaxSize}return t({getConfig:h,syncFromStore:P}),(T,M)=>(v(),g("div",eu,[M[25]||(M[25]=e("p",{class:"settings-hint"},"VLMï¼ˆè§†è§‰è¯­è¨€æ¨¡åž‹ï¼‰ç”¨äºŽåˆ†æžæ¼«ç”»å›¾ç‰‡å†…å®¹ï¼Œæå–å¯¹è¯å’Œåœºæ™¯ä¿¡æ¯ã€‚",-1)),e("div",tu,[M[10]||(M[10]=e("label",null,"æœåŠ¡å•†",-1)),X(he,{modelValue:d.value,"onUpdate:modelValue":M[0]||(M[0]=z=>d.value=z),options:K(Ft),onChange:f},null,8,["modelValue","options"])]),e("div",su,[M[11]||(M[11]=e("label",null,"API Key",-1)),O(e("input",{"onUpdate:modelValue":M[1]||(M[1]=z=>m.value=z),type:"password",placeholder:"è¾“å…¥ API Key"},null,512),[[N,m.value]])]),e("div",nu,[M[13]||(M[13]=e("label",null,"æ¨¡åž‹",-1)),e("div",au,[O(e("input",{"onUpdate:modelValue":M[2]||(M[2]=z=>k.value=z),type:"text",placeholder:"ä¾‹å¦‚: gemini-2.0-flash"},null,512),[[N,k.value]]),e("button",{class:"btn btn-secondary btn-sm fetch-btn",disabled:i.value,onClick:b},_(i.value?"èŽ·å–ä¸­...":"ðŸ” èŽ·å–æ¨¡åž‹"),9,lu)]),r.value&&u.value.length>0?(v(),g("div",ou,[e("select",{class:"model-select",value:k.value,onChange:M[3]||(M[3]=z=>p(z.target.value))},[M[12]||(M[12]=e("option",{value:""},"-- é€‰æ‹©æ¨¡åž‹ --",-1)),(v(!0),g(Q,null,W(u.value,z=>(v(),g("option",{key:z.id,value:z.id},_(z.name||z.id),9,iu))),128))],40,ru),e("span",uu,"å…± "+_(u.value.length)+" ä¸ªæ¨¡åž‹",1)])):E("",!0)]),D.value?(v(),g("div",cu,[M[14]||(M[14]=e("label",null,"Base URL",-1)),O(e("input",{"onUpdate:modelValue":M[4]||(M[4]=z=>$.value=z),type:"text",placeholder:"è‡ªå®šä¹‰ API åœ°å€"},null,512),[[N,$.value]])])):E("",!0),e("div",du,[e("div",pu,[M[15]||(M[15]=e("label",null,"RPM é™åˆ¶",-1)),O(e("input",{"onUpdate:modelValue":M[5]||(M[5]=z=>w.value=z),type:"number",min:"1",max:"100"},null,512),[[N,w.value,void 0,{number:!0}]]),M[16]||(M[16]=e("p",{class:"form-hint"},"æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°",-1))]),e("div",vu,[M[17]||(M[17]=e("label",null,"æ¸©åº¦",-1)),O(e("input",{"onUpdate:modelValue":M[6]||(M[6]=z=>x.value=z),type:"number",min:"0",max:"1",step:"0.1"},null,512),[[N,x.value,void 0,{number:!0}]]),M[18]||(M[18]=e("p",{class:"form-hint"},"0-1ï¼Œè¶Šä½Žè¶Šç¡®å®š",-1))])]),e("div",mu,[e("label",gu,[O(e("input",{"onUpdate:modelValue":M[7]||(M[7]=z=>S.value=z),type:"checkbox"},null,512),[[Ue,S.value]]),M[19]||(M[19]=e("span",null,"å¼ºåˆ¶ JSON è¾“å‡º",-1))]),M[20]||(M[20]=e("p",{class:"form-hint"},"å¯¹ OpenAI å…¼å®¹ API å¯ç”¨ response_format: json_object",-1))]),e("div",fu,[e("label",hu,[O(e("input",{"onUpdate:modelValue":M[8]||(M[8]=z=>U.value=z),type:"checkbox"},null,512),[[Ue,U.value]]),M[21]||(M[21]=e("span",null,"ä½¿ç”¨æµå¼è¯·æ±‚",-1))]),M[22]||(M[22]=e("p",{class:"form-hint"},"æµå¼è¯·æ±‚å¯é¿å…é•¿æ—¶é—´ç­‰å¾…å¯¼è‡´çš„è¶…æ—¶é—®é¢˜",-1))]),e("div",bu,[M[23]||(M[23]=e("label",null,"å›¾ç‰‡åŽ‹ç¼©ï¼ˆæœ€å¤§è¾¹é•¿ï¼‰",-1)),O(e("input",{"onUpdate:modelValue":M[9]||(M[9]=z=>R.value=z),type:"number",min:"0",max:"4096",step:"128",placeholder:"0 è¡¨ç¤ºä¸åŽ‹ç¼©"},null,512),[[N,R.value,void 0,{number:!0}]]),M[24]||(M[24]=e("p",{class:"form-hint"},"å‘é€å‰å°†å›¾ç‰‡ç­‰æ¯”ä¾‹ç¼©æ”¾åˆ°æŒ‡å®šæœ€å¤§è¾¹é•¿ï¼ˆåƒç´ ï¼‰ï¼Œ0 è¡¨ç¤ºä¸åŽ‹ç¼©",-1))]),e("button",{class:"btn btn-secondary",disabled:o.value,onClick:c},_(o.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿žæŽ¥"),9,yu)]))}}),_u={class:"insight-settings-content"},$u={class:"form-group"},wu={class:"form-group"},xu={class:"form-group"},Cu={class:"model-input-row"},Su=["disabled"],Pu={key:0,class:"model-select-container"},Iu=["value"],Mu=["value"],Ru={class:"model-count"},Tu={key:0,class:"form-group"},Uu={class:"form-group"},Au={class:"checkbox-label"},Bu=["disabled"],Eu=te({__name:"LlmSettingsTab",emits:["showMessage"],setup(n,{expose:t,emit:l}){const a=l,s=ce(),o=y(!1),i=y(!1),u=y([]),r=y(!1),d=y(s.config.llm.provider),m=y(s.config.llm.apiKey),k=y(s.config.llm.model),$=y(s.config.llm.baseUrl),w=y(s.config.llm.useStream),x=G(()=>d.value==="custom");function S(){const p=d.value;if(s.config.llm.provider!==p&&(s.config.llm.apiKey=m.value,s.config.llm.model=k.value,s.config.llm.baseUrl=$.value,s.config.llm.useStream=w.value),s.setLlmProvider(p),m.value=s.config.llm.apiKey,k.value=s.config.llm.model,$.value=s.config.llm.baseUrl,w.value=s.config.llm.useStream,!k.value){const h=Qi[p];h&&(k.value=h)}}async function U(){if(!m.value){a("showMessage","è¯·å…ˆå¡«å†™ API Key","error");return}if(!qe.includes(d.value)){a("showMessage",`${d.value} ä¸æ”¯æŒè‡ªåŠ¨èŽ·å–æ¨¡åž‹åˆ—è¡¨`,"error");return}if(d.value==="custom"&&!$.value){a("showMessage","è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL","error");return}const p=d.value==="custom"?"custom_openai":d.value;i.value=!0;try{const c=await Oe(p,m.value,$.value||void 0);c.success&&c.models&&c.models.length>0?(u.value=c.models,r.value=!0,a("showMessage",`èŽ·å–åˆ° ${c.models.length} ä¸ªæ¨¡åž‹`,"success")):(a("showMessage",c.message||"æœªèŽ·å–åˆ°æ¨¡åž‹åˆ—è¡¨","error"),r.value=!1)}catch{a("showMessage","èŽ·å–æ¨¡åž‹åˆ—è¡¨å¤±è´¥","error"),r.value=!1}finally{i.value=!1}}function R(p){p&&(k.value=p)}async function D(){if(!o.value){o.value=!0;try{const p=await an({provider:d.value,api_key:m.value,model:k.value,base_url:$.value||void 0});p.success?a("showMessage","LLM è¿žæŽ¥æˆåŠŸ","success"):a("showMessage","è¿žæŽ¥å¤±è´¥: "+(p.error||"æœªçŸ¥é”™è¯¯"),"error")}catch{a("showMessage","æµ‹è¯•å¤±è´¥","error")}finally{o.value=!1}}}function f(){return{useSameAsVlm:!1,provider:d.value,apiKey:m.value,model:k.value,baseUrl:d.value==="custom"?$.value:"",useStream:w.value}}function b(){d.value=s.config.llm.provider,m.value=s.config.llm.apiKey,k.value=s.config.llm.model,$.value=s.config.llm.baseUrl,w.value=s.config.llm.useStream}return t({getConfig:f,syncFromStore:b}),(p,c)=>(v(),g("div",_u,[c[12]||(c[12]=e("p",{class:"settings-hint"},"LLMï¼ˆå¯¹è¯æ¨¡åž‹ï¼‰ç”¨äºŽç”Ÿæˆæ•…äº‹æ¦‚è¦ã€æ™ºèƒ½é—®ç­”ç­‰æ–‡æœ¬ç”Ÿæˆä»»åŠ¡ã€‚",-1)),e("div",$u,[c[6]||(c[6]=e("label",null,"æœåŠ¡å•†",-1)),X(he,{modelValue:d.value,"onUpdate:modelValue":c[0]||(c[0]=h=>d.value=h),options:K(Ft),onChange:S},null,8,["modelValue","options"])]),e("div",wu,[c[7]||(c[7]=e("label",null,"API Key",-1)),O(e("input",{"onUpdate:modelValue":c[1]||(c[1]=h=>m.value=h),type:"password",placeholder:"è¾“å…¥ API Key"},null,512),[[N,m.value]])]),e("div",xu,[c[9]||(c[9]=e("label",null,"æ¨¡åž‹",-1)),e("div",Cu,[O(e("input",{"onUpdate:modelValue":c[2]||(c[2]=h=>k.value=h),type:"text",placeholder:"ä¾‹å¦‚: gpt-4o-mini"},null,512),[[N,k.value]]),e("button",{class:"btn btn-secondary btn-sm fetch-btn",disabled:i.value,onClick:U},_(i.value?"èŽ·å–ä¸­...":"ðŸ” èŽ·å–æ¨¡åž‹"),9,Su)]),r.value&&u.value.length>0?(v(),g("div",Pu,[e("select",{class:"model-select",value:k.value,onChange:c[3]||(c[3]=h=>R(h.target.value))},[c[8]||(c[8]=e("option",{value:""},"-- é€‰æ‹©æ¨¡åž‹ --",-1)),(v(!0),g(Q,null,W(u.value,h=>(v(),g("option",{key:h.id,value:h.id},_(h.name||h.id),9,Mu))),128))],40,Iu),e("span",Ru,"å…± "+_(u.value.length)+" ä¸ªæ¨¡åž‹",1)])):E("",!0)]),x.value?(v(),g("div",Tu,[c[10]||(c[10]=e("label",null,"Base URL",-1)),O(e("input",{"onUpdate:modelValue":c[4]||(c[4]=h=>$.value=h),type:"text",placeholder:"è‡ªå®šä¹‰ API åœ°å€"},null,512),[[N,$.value]])])):E("",!0),e("div",Uu,[e("label",Au,[O(e("input",{"onUpdate:modelValue":c[5]||(c[5]=h=>w.value=h),type:"checkbox"},null,512),[[Ue,w.value]]),c[11]||(c[11]=e("span",null,"ä½¿ç”¨æµå¼è¯·æ±‚",-1))])]),e("button",{class:"btn btn-secondary",disabled:o.value,onClick:D},_(o.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿žæŽ¥"),9,Bu)]))}}),Lu={class:"insight-settings-content"},Du={class:"form-group"},zu={class:"form-hint"},Ou={class:"form-group"},Gu={class:"form-group"},Vu={class:"form-hint"},qu={key:0,style:{"margin-top":"16px"}},Fu={style:{"margin-bottom":"8px"}},Ku={style:{"min-width":"50px",color:"#666","font-size":"13px"}},Nu=["value","disabled","onChange"],ju=["value","disabled","title","onChange"],Hu={style:{display:"flex","flex-direction":"column","align-items":"center",gap:"2px","font-size":"11px",cursor:"pointer","min-width":"40px","text-align":"center"}},Qu=["checked","onChange"],Ju=["onClick"],Zu={class:"batch-info-box"},Wu={class:"layers-preview-list"},Xu={key:0,class:"align-badge"},Yu={class:"batch-estimate-box"},ec=te({__name:"BatchSettingsTab",setup(n,{expose:t}){const l=ce(),a=y(l.config.batch.pagesPerBatch),s=y(l.config.batch.contextBatchCount),o=y(l.config.batch.architecturePreset),i=y(l.config.batch.customLayers?.length>0?l.config.batch.customLayers.map(p=>({name:p.name,units:p.units_per_group??p.units??5,align:p.align_to_chapter??p.align??!1})):[{name:"æ‰¹é‡åˆ†æž",units:5,align:!1},{name:"æ®µè½æ€»ç»“",units:5,align:!1},{name:"å…¨ä¹¦æ€»ç»“",units:0,align:!1}]),u=G(()=>`æ¯æ‰¹æ¬¡åˆ†æž ${a.value||5} é¡µ`),r=G(()=>o.value==="custom"),d=G(()=>o.value==="custom"?"å®Œå…¨è‡ªå®šä¹‰å±‚çº§æž¶æž„ï¼Œçµæ´»é…ç½®åˆ†æžæµç¨‹":Ye[o.value]?.description||"æ ¹æ®æ¼«ç”»ç±»åž‹é€‰æ‹©åˆé€‚çš„åˆ†æžæž¶æž„"),m=G(()=>o.value==="custom"?i.value:Ye[o.value]?.layers||Ye.standard.layers);function k(){const p=i.value.length-1;i.value.splice(p,0,{name:`æ±‡æ€»å±‚${p}`,units:5,align:!1})}function $(p){p>0&&p<i.value.length-1&&i.value.splice(p,1)}function w(p,c,h){i.value[p]&&(i.value[p][c]=h,p===0&&c==="units"&&(a.value=h))}function x(){i.value.length>0&&i.value[0]&&(i.value[0].units=a.value)}function S(p){return p>0&&p<i.value.length-1&&i.value.length>2}function U(p){return p>0&&p<i.value.length-1}function R(p){return p<i.value.length-1}function D(p){return p===0?"æ¯æ‰¹åˆ†æžçš„é¡µæ•°":"æ¯ç»„åŒ…å«å•å…ƒæ•°ï¼ˆ0=å…¨éƒ¨æ±‡æ€»ï¼‰"}function f(){return{pagesPerBatch:a.value,contextBatchCount:s.value,architecturePreset:o.value,customLayers:i.value.map(p=>({name:p.name,units:p.units,align:p.align}))}}function b(){a.value=l.config.batch.pagesPerBatch,s.value=l.config.batch.contextBatchCount,o.value=l.config.batch.architecturePreset,l.config.batch.customLayers?.length>0&&(i.value=l.config.batch.customLayers.map(p=>({name:p.name,units:p.units_per_group??p.units??5,align:p.align_to_chapter??p.align??!1})))}return t({getConfig:f,syncFromStore:b}),(p,c)=>(v(),g("div",Lu,[c[13]||(c[13]=e("p",{class:"settings-hint"},"é…ç½®æ‰¹é‡åˆ†æžçš„å‚æ•°ï¼Œå½±å“åˆ†æžé€Ÿåº¦å’Œè´¨é‡ã€‚",-1)),e("div",Du,[c[3]||(c[3]=e("label",null,"æ¯æ‰¹æ¬¡åˆ†æžé¡µæ•°",-1)),O(e("input",{"onUpdate:modelValue":c[0]||(c[0]=h=>a.value=h),type:"number",min:"1",max:"10",onChange:x},null,544),[[N,a.value,void 0,{number:!0}]]),e("p",zu,"æ¯æ¬¡å‘é€ç»™ VLM çš„å›¾ç‰‡æ•°é‡ï¼Œå»ºè®® 3-5 å¼ ã€‚"+_(u.value),1)]),e("div",Ou,[c[4]||(c[4]=e("label",null,"ä¸Šæ–‡å‚è€ƒæ‰¹æ¬¡æ•°",-1)),O(e("input",{"onUpdate:modelValue":c[1]||(c[1]=h=>s.value=h),type:"number",min:"0",max:"5"},null,512),[[N,s.value,void 0,{number:!0}]]),c[5]||(c[5]=e("p",{class:"form-hint"},"æ¯æ‰¹åˆ†æžæ—¶å‚è€ƒå‰å‡ æ‰¹çš„ç»“æžœä½œä¸ºä¸Šä¸‹æ–‡ï¼Œ0 è¡¨ç¤ºä¸å‚è€ƒ",-1))]),e("div",Gu,[c[6]||(c[6]=e("label",null,"åˆ†æžæž¶æž„",-1)),X(he,{modelValue:o.value,"onUpdate:modelValue":c[2]||(c[2]=h=>o.value=h),options:K(Ni)},null,8,["modelValue","options"]),e("p",Vu,_(d.value),1)]),r.value?(v(),g("div",qu,[c[8]||(c[8]=e("label",{style:{display:"block","margin-bottom":"8px","font-weight":"500","font-size":"14px"}},"è‡ªå®šä¹‰å±‚çº§",-1)),e("div",Fu,[(v(!0),g(Q,null,W(i.value,(h,P)=>(v(),g("div",{key:P,style:{display:"flex","flex-direction":"row",gap:"8px","align-items":"center","margin-bottom":"8px",padding:"12px",background:"#f5f5f5","border-radius":"8px",border:"1px solid #e0e0e0"}},[e("span",Ku,"ç¬¬"+_(P+1)+"å±‚",1),e("input",{type:"text",value:h.name,disabled:!U(P),placeholder:"å±‚çº§åç§°",style:{flex:"1",padding:"8px 12px",border:"1px solid #e0e0e0","border-radius":"6px","font-size":"14px"},onChange:T=>w(P,"name",T.target.value)},null,40,Nu),e("input",{type:"number",value:h.units,disabled:!R(P),title:D(P),min:"0",max:"20",style:{width:"70px",padding:"8px 12px",border:"1px solid #e0e0e0","border-radius":"6px","font-size":"14px"},onChange:T=>w(P,"units",parseInt(T.target.value)||0)},null,40,ju),e("label",Hu,[e("input",{type:"checkbox",checked:h.align,style:{width:"16px",height:"16px"},onChange:T=>w(P,"align",T.target.checked)},null,40,Qu),c[7]||(c[7]=e("span",{style:{"line-height":"1.2"}},[se("ç« èŠ‚"),e("br"),se("å¯¹é½")],-1))]),S(P)?(v(),g("button",{key:0,type:"button",style:{padding:"6px 12px",background:"#ef4444",color:"white",border:"none","border-radius":"6px",cursor:"pointer","font-size":"13px","font-weight":"500"},onClick:T=>$(P)},"åˆ é™¤",8,Ju)):E("",!0)]))),128))]),e("button",{type:"button",class:"btn btn-sm",style:{"margin-top":"4px",border:"1px solid #e0e0e0"},onClick:k},"+ æ·»åŠ å±‚çº§"),c[9]||(c[9]=e("p",{class:"form-hint"},"ç¬¬ä¸€å±‚å›ºå®šä¸ºæ‰¹é‡åˆ†æžï¼Œæœ€åŽä¸€å±‚å›ºå®šä¸ºå…¨ä¹¦æ€»ç»“ã€‚ä¸­é—´å¯æ·»åŠ ä»»æ„æ±‡æ€»å±‚çº§ã€‚",-1))])):E("",!0),e("div",Zu,[c[10]||(c[10]=e("h4",null,"å½“å‰æž¶æž„é¢„è§ˆ",-1)),e("ul",Wu,[(v(!0),g(Q,null,W(m.value,(h,P)=>(v(),g("li",{key:P},[e("strong",null,"ç¬¬"+_(P+1)+"å±‚ - "+_(h.name),1),se(" "+_(h.units>0?` - æ¯${h.units}ä¸ªå•å…ƒæ±‡æ€»`:" - æ±‡æ€»å…¨éƒ¨")+" ",1),h.align?(v(),g("span",Xu,"(æŒ‰ç« èŠ‚å¯¹é½)")):E("",!0)]))),128))])]),e("div",Yu,[e("p",null,[c[11]||(c[11]=se("å½“å‰é…ç½®ï¼šæ¯ ",-1)),e("strong",null,_(a.value),1),c[12]||(c[12]=se(" é¡µä¸€æ‰¹",-1))])])]))}}),tc={class:"insight-settings-content"},sc={class:"form-group"},nc={class:"form-group"},ac={class:"form-group"},lc={class:"model-input-row"},oc=["disabled"],rc={key:0,class:"model-select-container"},ic=["value"],uc=["value"],cc={class:"model-count"},dc={key:0,class:"form-group"},pc={class:"form-group"},vc=["disabled"],mc=te({__name:"EmbeddingSettingsTab",emits:["showMessage"],setup(n,{expose:t,emit:l}){const a=l,s=ce(),o=y(!1),i=y(!1),u=y([]),r=y(!1),d=y(s.config.embedding.provider),m=y(s.config.embedding.apiKey),k=y(s.config.embedding.model),$=y(s.config.embedding.baseUrl),w=y(s.config.embedding.rpmLimit),x=G(()=>d.value==="custom");function S(){const p=d.value;if(s.config.embedding.provider!==p&&(s.config.embedding.apiKey=m.value,s.config.embedding.model=k.value,s.config.embedding.baseUrl=$.value,s.config.embedding.rpmLimit=w.value),s.setEmbeddingProvider(p),m.value=s.config.embedding.apiKey,k.value=s.config.embedding.model,$.value=s.config.embedding.baseUrl,w.value=s.config.embedding.rpmLimit,!k.value){const h=Ji[p];h&&(k.value=h)}}async function U(){if(!m.value){a("showMessage","è¯·å…ˆå¡«å†™ API Key","error");return}if(!qe.includes(d.value)){a("showMessage",`${d.value} ä¸æ”¯æŒè‡ªåŠ¨èŽ·å–æ¨¡åž‹åˆ—è¡¨`,"error");return}if(d.value==="custom"&&!$.value){a("showMessage","è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL","error");return}const p=d.value==="custom"?"custom_openai":d.value;i.value=!0;try{const c=await Oe(p,m.value,$.value||void 0);c.success&&c.models?.length?(u.value=c.models,r.value=!0,a("showMessage",`èŽ·å–åˆ° ${c.models.length} ä¸ªæ¨¡åž‹`,"success")):(a("showMessage",c.message||"æœªèŽ·å–åˆ°æ¨¡åž‹åˆ—è¡¨","error"),r.value=!1)}catch{a("showMessage","èŽ·å–æ¨¡åž‹åˆ—è¡¨å¤±è´¥","error"),r.value=!1}finally{i.value=!1}}function R(p){p&&(k.value=p)}async function D(){if(!o.value){o.value=!0;try{const p=await sn({provider:d.value,api_key:m.value,model:k.value,base_url:$.value||void 0});a("showMessage",p.success?"Embedding è¿žæŽ¥æˆåŠŸ":"è¿žæŽ¥å¤±è´¥: "+(p.error||"æœªçŸ¥é”™è¯¯"),p.success?"success":"error")}catch{a("showMessage","æµ‹è¯•å¤±è´¥","error")}finally{o.value=!1}}}function f(){return{provider:d.value,apiKey:m.value,model:k.value,baseUrl:d.value==="custom"?$.value:"",rpmLimit:w.value}}function b(){d.value=s.config.embedding.provider,m.value=s.config.embedding.apiKey,k.value=s.config.embedding.model,$.value=s.config.embedding.baseUrl,w.value=s.config.embedding.rpmLimit}return t({getConfig:f,syncFromStore:b}),(p,c)=>(v(),g("div",tc,[c[13]||(c[13]=e("p",{class:"settings-hint"},"Embeddingï¼ˆå‘é‡åŒ–æ¨¡åž‹ï¼‰ç”¨äºŽå°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡ï¼Œæ”¯æŒè¯­ä¹‰æœç´¢å’Œé—®ç­”åŠŸèƒ½ã€‚",-1)),e("div",sc,[c[6]||(c[6]=e("label",null,"æœåŠ¡å•†",-1)),X(he,{modelValue:d.value,"onUpdate:modelValue":c[0]||(c[0]=h=>d.value=h),options:K(qi),onChange:S},null,8,["modelValue","options"])]),e("div",nc,[c[7]||(c[7]=e("label",null,"API Key",-1)),O(e("input",{"onUpdate:modelValue":c[1]||(c[1]=h=>m.value=h),type:"password",placeholder:"è¾“å…¥ API Key"},null,512),[[N,m.value]])]),e("div",ac,[c[9]||(c[9]=e("label",null,"æ¨¡åž‹",-1)),e("div",lc,[O(e("input",{"onUpdate:modelValue":c[2]||(c[2]=h=>k.value=h),type:"text",placeholder:"ä¾‹å¦‚: text-embedding-3-small"},null,512),[[N,k.value]]),e("button",{class:"btn btn-secondary btn-sm fetch-btn",disabled:i.value,onClick:U},_(i.value?"èŽ·å–ä¸­...":"ðŸ” èŽ·å–æ¨¡åž‹"),9,oc)]),r.value&&u.value.length>0?(v(),g("div",rc,[e("select",{class:"model-select",value:k.value,onChange:c[3]||(c[3]=h=>R(h.target.value))},[c[8]||(c[8]=e("option",{value:""},"-- é€‰æ‹©æ¨¡åž‹ --",-1)),(v(!0),g(Q,null,W(u.value,h=>(v(),g("option",{key:h.id,value:h.id},_(h.name||h.id),9,uc))),128))],40,ic),e("span",cc,"å…± "+_(u.value.length)+" ä¸ªæ¨¡åž‹",1)])):E("",!0)]),x.value?(v(),g("div",dc,[c[10]||(c[10]=e("label",null,"Base URL",-1)),O(e("input",{"onUpdate:modelValue":c[4]||(c[4]=h=>$.value=h),type:"text",placeholder:"è‡ªå®šä¹‰ API åœ°å€"},null,512),[[N,$.value]])])):E("",!0),e("div",pc,[c[11]||(c[11]=e("label",null,"RPM é™åˆ¶",-1)),O(e("input",{"onUpdate:modelValue":c[5]||(c[5]=h=>w.value=h),type:"number",min:"0",max:"1000"},null,512),[[N,w.value,void 0,{number:!0}]]),c[12]||(c[12]=e("p",{class:"form-hint"},"æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶",-1))]),e("button",{class:"btn btn-secondary",disabled:o.value,onClick:D},_(o.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿žæŽ¥"),9,vc)]))}}),gc={class:"insight-settings-content"},fc={class:"form-group"},hc={class:"form-group"},bc={class:"form-group"},yc={class:"model-input-row"},kc=["disabled"],_c={key:0,class:"model-select-container"},$c=["value"],wc=["value"],xc={class:"model-count"},Cc={key:0,class:"form-group"},Sc={class:"form-group"},Pc=["disabled"],Ic=te({__name:"RerankerSettingsTab",emits:["showMessage"],setup(n,{expose:t,emit:l}){const a=l,s=ce(),o=y(!1),i=y(!1),u=y([]),r=y(!1),d=y(s.config.reranker.provider),m=y(s.config.reranker.apiKey),k=y(s.config.reranker.model),$=y(s.config.reranker.baseUrl),w=y(s.config.reranker.topK),x=G(()=>d.value==="custom");function S(){const p=d.value;if(s.config.reranker.provider!==p&&(s.config.reranker.apiKey=m.value,s.config.reranker.model=k.value,s.config.reranker.baseUrl=$.value,s.config.reranker.topK=w.value),s.setRerankerProvider(p),m.value=s.config.reranker.apiKey,k.value=s.config.reranker.model,$.value=s.config.reranker.baseUrl,w.value=s.config.reranker.topK,!k.value){const h=Zi[p];h&&(k.value=h)}}async function U(){if(!m.value){a("showMessage","è¯·å…ˆå¡«å†™ API Key","error");return}if(!qe.includes(d.value)){a("showMessage",`${d.value} ä¸æ”¯æŒè‡ªåŠ¨èŽ·å–æ¨¡åž‹åˆ—è¡¨`,"error");return}if(d.value==="custom"&&!$.value){a("showMessage","è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL","error");return}const p=d.value==="custom"?"custom_openai":d.value;i.value=!0;try{const c=await Oe(p,m.value,$.value||void 0);c.success&&c.models?.length?(u.value=c.models,r.value=!0,a("showMessage",`èŽ·å–åˆ° ${c.models.length} ä¸ªæ¨¡åž‹`,"success")):(a("showMessage",c.message||"æœªèŽ·å–åˆ°æ¨¡åž‹åˆ—è¡¨","error"),r.value=!1)}catch{a("showMessage","èŽ·å–æ¨¡åž‹åˆ—è¡¨å¤±è´¥","error"),r.value=!1}finally{i.value=!1}}function R(p){p&&(k.value=p)}async function D(){if(!o.value){o.value=!0;try{const p=await nn({provider:d.value,api_key:m.value,model:k.value,base_url:$.value||void 0});a("showMessage",p.success?"Reranker è¿žæŽ¥æˆåŠŸ":"è¿žæŽ¥å¤±è´¥: "+(p.error||"æœªçŸ¥é”™è¯¯"),p.success?"success":"error")}catch{a("showMessage","æµ‹è¯•å¤±è´¥","error")}finally{o.value=!1}}}function f(){return{provider:d.value,apiKey:m.value,model:k.value,baseUrl:d.value==="custom"?$.value:"",topK:w.value}}function b(){d.value=s.config.reranker.provider,m.value=s.config.reranker.apiKey,k.value=s.config.reranker.model,$.value=s.config.reranker.baseUrl,w.value=s.config.reranker.topK}return t({getConfig:f,syncFromStore:b}),(p,c)=>(v(),g("div",gc,[c[13]||(c[13]=e("p",{class:"settings-hint"},"Rerankerï¼ˆé‡æŽ’åºæ¨¡åž‹ï¼‰ç”¨äºŽå¯¹æœç´¢ç»“æžœè¿›è¡Œé‡æ–°æŽ’åºï¼Œæé«˜é—®ç­”å‡†ç¡®æ€§ã€‚",-1)),e("div",fc,[c[6]||(c[6]=e("label",null,"æœåŠ¡å•†",-1)),X(he,{modelValue:d.value,"onUpdate:modelValue":c[0]||(c[0]=h=>d.value=h),options:K(Fi),onChange:S},null,8,["modelValue","options"])]),e("div",hc,[c[7]||(c[7]=e("label",null,"API Key",-1)),O(e("input",{"onUpdate:modelValue":c[1]||(c[1]=h=>m.value=h),type:"password",placeholder:"è¾“å…¥ API Key"},null,512),[[N,m.value]])]),e("div",bc,[c[9]||(c[9]=e("label",null,"æ¨¡åž‹",-1)),e("div",yc,[O(e("input",{"onUpdate:modelValue":c[2]||(c[2]=h=>k.value=h),type:"text",placeholder:"ä¾‹å¦‚: jina-reranker-v2-base-multilingual"},null,512),[[N,k.value]]),e("button",{class:"btn btn-secondary btn-sm fetch-btn",disabled:i.value,onClick:U},_(i.value?"èŽ·å–ä¸­...":"ðŸ” èŽ·å–æ¨¡åž‹"),9,kc)]),r.value&&u.value.length>0?(v(),g("div",_c,[e("select",{class:"model-select",value:k.value,onChange:c[3]||(c[3]=h=>R(h.target.value))},[c[8]||(c[8]=e("option",{value:""},"-- é€‰æ‹©æ¨¡åž‹ --",-1)),(v(!0),g(Q,null,W(u.value,h=>(v(),g("option",{key:h.id,value:h.id},_(h.name||h.id),9,wc))),128))],40,$c),e("span",xc,"å…± "+_(u.value.length)+" ä¸ªæ¨¡åž‹",1)])):E("",!0)]),x.value?(v(),g("div",Cc,[c[10]||(c[10]=e("label",null,"Base URL",-1)),O(e("input",{"onUpdate:modelValue":c[4]||(c[4]=h=>$.value=h),type:"text",placeholder:"è‡ªå®šä¹‰ API åœ°å€"},null,512),[[N,$.value]])])):E("",!0),e("div",Sc,[c[11]||(c[11]=e("label",null,"Top K",-1)),O(e("input",{"onUpdate:modelValue":c[5]||(c[5]=h=>w.value=h),type:"number",min:"1",max:"20"},null,512),[[N,w.value,void 0,{number:!0}]]),c[12]||(c[12]=e("p",{class:"form-hint"},"é‡æŽ’åºåŽè¿”å›žçš„ç»“æžœæ•°é‡",-1))]),e("button",{class:"btn btn-secondary",disabled:o.value,onClick:D},_(o.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿žæŽ¥"),9,Pc)]))}}),Mc={class:"insight-settings-content prompts-settings"},Rc={class:"form-group"},Tc={class:"form-hint"},Uc={class:"form-group"},Ac={class:"prompts-library-section"},Bc={class:"library-header"},Ec={class:"library-actions"},Lc={class:"saved-prompts-list"},Dc={key:0,class:"loading-text"},zc={key:1,class:"placeholder-text"},Oc=["onClick"],Gc={class:"prompt-name"},Vc={class:"prompt-type-badge"},qc=["onClick"],Fc=te({__name:"PromptsSettingsTab",emits:["showMessage"],setup(n,{expose:t,emit:l}){const a=l,s=ce(),o=y("batch_analysis"),i=y(""),u=y({}),r=y([]),d=y(!1),m=y({batch_analysis:"",segment_summary:"",chapter_summary:"",qa_response:""});async function k(){try{const P=await ln();P.success&&P.prompts&&(m.value=P.prompts)}catch(P){console.error("åŠ è½½é»˜è®¤æç¤ºè¯å¤±è´¥:",P)}}async function $(){d.value=!0;try{const P=await on();P.success&&P.library&&(r.value=P.library)}catch{r.value=[]}finally{d.value=!1}}function w(){confirm("ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿå½“å‰ç¼–è¾‘çš„å†…å®¹å°†ä¸¢å¤±ã€‚")&&(i.value=m.value[o.value]||"",delete u.value[o.value],a("showMessage","å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯","success"))}async function x(){try{await navigator.clipboard.writeText(i.value),a("showMessage","å·²å¤åˆ¶åˆ°å‰ªè´´æ¿","success")}catch{a("showMessage","å¤åˆ¶å¤±è´¥","error")}}async function S(){const P=i.value.trim();if(!P){a("showMessage","æç¤ºè¯å†…å®¹ä¸èƒ½ä¸ºç©º","error");return}const T=prompt("è¯·è¾“å…¥æç¤ºè¯åç§°ï¼š");if(!T?.trim())return;const M={id:Date.now().toString(),name:T.trim(),type:o.value,content:P,created_at:new Date().toISOString()};try{(await rn(M)).success?(r.value.push(M),a("showMessage","æç¤ºè¯å·²ä¿å­˜åˆ°åº“","success")):a("showMessage","ä¿å­˜å¤±è´¥","error")}catch{a("showMessage","ä¿å­˜å¤±è´¥","error")}}function U(P){o.value=P.type,i.value=P.content,u.value[P.type]=P.content,a("showMessage",`å·²åŠ è½½æç¤ºè¯: ${P.name}`,"success")}async function R(P){if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºè¯å—ï¼Ÿ"))try{(await un(P)).success?(r.value=r.value.filter(M=>M.id!==P),a("showMessage","æç¤ºè¯å·²åˆ é™¤","success")):a("showMessage","åˆ é™¤å¤±è´¥","error")}catch{a("showMessage","åˆ é™¤å¤±è´¥","error")}}function D(){i.value&&(u.value[o.value]=i.value);const P={version:"1.0",exported_at:new Date().toISOString(),prompts:u.value,library:r.value},T=new Blob([JSON.stringify(P,null,2)],{type:"application/json"}),M=URL.createObjectURL(T),z=document.createElement("a");z.href=M,z.download=`manga-insight-prompts-${new Date().toISOString().slice(0,10)}.json`,z.click(),URL.revokeObjectURL(M),a("showMessage","æç¤ºè¯å·²å¯¼å‡º","success")}function f(){document.getElementById("promptsFileInput")?.click()}async function b(P){const T=P.target,M=T.files?.[0];if(M){try{const z=await M.text(),Y=JSON.parse(z);if(Y.prompts&&(u.value={...u.value,...Y.prompts}),Y.library&&Array.isArray(Y.library)){const j=new Set(r.value.map(A=>A.id));for(const A of Y.library)j.has(A.id)||r.value.push(A);await cn(r.value)}a("showMessage","æç¤ºè¯å¯¼å…¥æˆåŠŸ","success")}catch{a("showMessage","å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼","error")}T.value=""}}ue(o,(P,T)=>{T&&i.value&&(u.value[T]=i.value),P&&(i.value=u.value[P]||m.value[P]||"")});function p(){return i.value&&(u.value[o.value]=i.value),u.value}function c(){s.config.prompts?u.value={...s.config.prompts}:u.value={},i.value=u.value[o.value]||m.value[o.value]||""}async function h(){await k(),await $()}return ke(h),t({getCustomPrompts:p,syncFromStore:c,initialize:h}),(P,T)=>(v(),g("div",Mc,[T[5]||(T[5]=e("p",{class:"settings-hint"},"è‡ªå®šä¹‰åˆ†æžè¿‡ç¨‹ä¸­ä½¿ç”¨çš„æç¤ºè¯æ¨¡æ¿ã€‚",-1)),e("div",Rc,[T[2]||(T[2]=e("label",null,"æç¤ºè¯ç±»åž‹",-1)),X(he,{modelValue:o.value,"onUpdate:modelValue":T[0]||(T[0]=M=>o.value=M),options:K(ji)},null,8,["modelValue","options"]),e("p",Tc,_(ft[o.value]?.hint),1)]),e("div",Uc,[T[3]||(T[3]=e("label",null,"æç¤ºè¯å†…å®¹",-1)),O(e("textarea",{"onUpdate:modelValue":T[1]||(T[1]=M=>i.value=M),class:"prompt-editor",rows:"12",placeholder:"è¾“å…¥æç¤ºè¯å†…å®¹..."},null,512),[[N,i.value]])]),e("div",{class:"prompt-actions-bar"},[e("button",{class:"btn btn-secondary btn-sm",onClick:w,title:"é‡ç½®ä¸ºé»˜è®¤"},"ðŸ”„ é‡ç½®"),e("button",{class:"btn btn-secondary btn-sm",onClick:x,title:"å¤åˆ¶åˆ°å‰ªè´´æ¿"},"ðŸ“‹ å¤åˆ¶"),e("button",{class:"btn btn-primary btn-sm",onClick:S,title:"ä¿å­˜åˆ°åº“"},"ðŸ’¾ ä¿å­˜åˆ°åº“")]),T[6]||(T[6]=e("hr",{class:"section-divider"},null,-1)),e("div",Ac,[e("div",Bc,[T[4]||(T[4]=e("h4",null,"ðŸ“š æç¤ºè¯åº“",-1)),e("div",Ec,[e("button",{class:"btn btn-secondary btn-sm",onClick:D,title:"å¯¼å‡ºæ‰€æœ‰æç¤ºè¯"},"ðŸ“¤ å¯¼å‡º"),e("button",{class:"btn btn-secondary btn-sm",onClick:f,title:"å¯¼å…¥æç¤ºè¯"},"ðŸ“¥ å¯¼å…¥"),e("input",{id:"promptsFileInput",type:"file",accept:".json",style:{display:"none"},onChange:b},null,32)])]),e("div",Lc,[d.value?(v(),g("div",Dc,"åŠ è½½ä¸­...")):r.value.length===0?(v(),g("div",zc,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(v(!0),g(Q,{key:2},W(r.value,M=>(v(),g("div",{key:M.id,class:"saved-prompt-item",onClick:z=>U(M)},[e("span",Gc,_(M.name),1),e("span",Vc,_(ft[M.type]?.label||M.type),1),e("button",{class:"btn-icon-sm",onClick:ie(z=>R(M.id),["stop"]),title:"åˆ é™¤"},"ðŸ—‘ï¸",8,qc)],8,Oc))),128))])])]))}}),Kc={class:"insight-settings-content"},Nc={class:"form-group"},jc={class:"form-group"},Hc={class:"form-group"},Qc={class:"model-input-row"},Jc=["disabled"],Zc={key:0,class:"model-select-container"},Wc=["value"],Xc=["value"],Yc={class:"model-count"},ed={key:0,class:"form-group"},td={class:"form-group"},sd=te({__name:"ImageGenSettingsTab",emits:["showMessage"],setup(n,{expose:t,emit:l}){const a=l,s=ce(),o=y(!1),i=y([]),u=y(!1),r=y(s.config.imageGen?.provider||"siliconflow"),d=y(s.config.imageGen?.apiKey||""),m=y(s.config.imageGen?.model||"stabilityai/stable-diffusion-3-5-large"),k=y(s.config.imageGen?.baseUrl||""),$=y(s.config.imageGen?.maxRetries||3),w=G(()=>r.value==="custom");function x(){const f=r.value,b=Wi[f];b&&(m.value=b),f==="custom"?k.value=s.config.imageGen?.baseUrl||"":k.value=Yi[f]||"",i.value=[],u.value=!1}async function S(){if(!d.value){a("showMessage","è¯·å…ˆå¡«å†™ API Key","error");return}if(!qe.includes(r.value)){a("showMessage",`${r.value} ä¸æ”¯æŒè‡ªåŠ¨èŽ·å–æ¨¡åž‹åˆ—è¡¨`,"error");return}if(r.value==="custom"&&!k.value){a("showMessage","è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL","error");return}const f=r.value==="custom"?"custom_openai":r.value;o.value=!0;try{const b=await Oe(f,d.value,k.value||void 0);b.success&&b.models&&b.models.length>0?(i.value=b.models,u.value=!0,a("showMessage",`èŽ·å–åˆ° ${b.models.length} ä¸ªæ¨¡åž‹`,"success")):(a("showMessage",b.message||"æœªèŽ·å–åˆ°æ¨¡åž‹åˆ—è¡¨","error"),u.value=!1)}catch(b){a("showMessage","èŽ·å–æ¨¡åž‹åˆ—è¡¨å¤±è´¥: "+(b instanceof Error?b.message:"ç½‘ç»œé”™è¯¯"),"error"),u.value=!1}finally{o.value=!1}}function U(f){f&&(m.value=f)}function R(){return{provider:r.value,apiKey:d.value,model:m.value,baseUrl:r.value==="custom"?k.value:"",maxRetries:$.value}}function D(){const f=s.config.imageGen;f&&(r.value=f.provider||"siliconflow",d.value=f.apiKey||"",m.value=f.model||"stabilityai/stable-diffusion-3-5-large",k.value=f.baseUrl||"",$.value=f.maxRetries||3)}return t({getConfig:R,syncFromStore:D}),(f,b)=>(v(),g("div",Kc,[b[14]||(b[14]=e("p",{class:"settings-hint"},"ç”Ÿå›¾æ¨¡åž‹ç”¨äºŽç»­å†™åŠŸèƒ½ä¸­ç”Ÿæˆæ¼«ç”»é¡µé¢å›¾ç‰‡ã€‚",-1)),e("div",Nc,[b[6]||(b[6]=e("label",null,"æœåŠ¡å•†",-1)),X(he,{modelValue:r.value,"onUpdate:modelValue":b[0]||(b[0]=p=>r.value=p),options:K(Ki),onChange:x},null,8,["modelValue","options"])]),e("div",jc,[b[7]||(b[7]=e("label",null,"API Key",-1)),O(e("input",{"onUpdate:modelValue":b[1]||(b[1]=p=>d.value=p),type:"password",placeholder:"è¾“å…¥ API Key"},null,512),[[N,d.value]])]),e("div",Hc,[b[9]||(b[9]=e("label",null,"æ¨¡åž‹",-1)),e("div",Qc,[O(e("input",{"onUpdate:modelValue":b[2]||(b[2]=p=>m.value=p),type:"text",placeholder:"ä¾‹å¦‚: dall-e-3"},null,512),[[N,m.value]]),e("button",{class:"btn btn-secondary btn-sm fetch-btn",disabled:o.value,onClick:S},_(o.value?"èŽ·å–ä¸­...":"ðŸ” èŽ·å–æ¨¡åž‹"),9,Jc)]),u.value&&i.value.length>0?(v(),g("div",Zc,[e("select",{class:"model-select",value:m.value,onChange:b[3]||(b[3]=p=>U(p.target.value))},[b[8]||(b[8]=e("option",{value:""},"-- é€‰æ‹©æ¨¡åž‹ --",-1)),(v(!0),g(Q,null,W(i.value,p=>(v(),g("option",{key:p.id,value:p.id},_(p.name||p.id),9,Xc))),128))],40,Wc),e("span",Yc,"å…± "+_(i.value.length)+" ä¸ªæ¨¡åž‹",1)])):E("",!0),b[10]||(b[10]=e("p",{class:"form-hint"},"ä¸åŒæœåŠ¡å•†æ”¯æŒçš„æ¨¡åž‹ä¸åŒï¼Œè¯·å‚è€ƒå„æœåŠ¡å•†æ–‡æ¡£",-1))]),w.value?(v(),g("div",ed,[b[11]||(b[11]=e("label",null,"Base URL",-1)),O(e("input",{"onUpdate:modelValue":b[4]||(b[4]=p=>k.value=p),type:"text",placeholder:"è‡ªå®šä¹‰ API åœ°å€"},null,512),[[N,k.value]])])):E("",!0),e("div",td,[b[12]||(b[12]=e("label",null,"å¤±è´¥é‡è¯•æ¬¡æ•°",-1)),O(e("input",{"onUpdate:modelValue":b[5]||(b[5]=p=>$.value=p),type:"number",min:"1",max:"10"},null,512),[[N,$.value,void 0,{number:!0}]]),b[13]||(b[13]=e("p",{class:"form-hint"},"æ¯å¼ å›¾ç‰‡ç”Ÿæˆå¤±è´¥åŽçš„é‡è¯•æ¬¡æ•°",-1))])]))}}),nd=oe(sd,[["__scopeId","data-v-2563c612"]]),ad={class:"settings-tabs"},ld=["disabled"],od=te({__name:"InsightSettingsModal",emits:["close"],setup(n,{emit:t}){const l=t,a=ce(),s=y("vlm"),o=y(!1),i=y(""),u=y(""),r=y(null),d=y(null),m=y(null),k=y(null),$=y(null),w=y(null),x=y(null);function S(p){s.value=p,i.value="",u.value=""}function U(){l("close")}function R(p,c){i.value=p,u.value=c,setTimeout(()=>{i.value="",u.value=""},3e3)}async function D(){if(!o.value){o.value=!0;try{r.value&&a.updateVlmConfig(r.value.getConfig()),d.value&&a.updateLlmConfig(d.value.getConfig()),m.value&&a.updateBatchConfig(m.value.getConfig()),k.value&&a.updateEmbeddingConfig(k.value.getConfig()),$.value&&a.updateRerankerConfig($.value.getConfig()),w.value&&a.updatePrompts(w.value.getCustomPrompts()),x.value&&a.updateImageGenConfig(x.value.getConfig());const p=a.getConfigForApi(),c=await en(p);c.success?(R("è®¾ç½®å·²ä¿å­˜","success"),setTimeout(()=>{U()},500)):R("ä¿å­˜å¤±è´¥: "+(c.error||"æœªçŸ¥é”™è¯¯"),"error")}catch(p){R("ä¿å­˜å¤±è´¥: "+(p instanceof Error?p.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{o.value=!1}}}async function f(){try{a.loadConfigFromStorage();const p=await Ys();p.success&&p.config&&a.setConfigFromApi(p.config),b()}catch(p){console.error("åŠ è½½é…ç½®å¤±è´¥:",p),b()}}function b(){r.value?.syncFromStore(),d.value?.syncFromStore(),m.value?.syncFromStore(),k.value?.syncFromStore(),$.value?.syncFromStore(),w.value?.syncFromStore(),x.value?.syncFromStore()}return ke(async()=>{await f()}),(p,c)=>(v(),fe(As,{title:"æ¼«ç”»åˆ†æžè®¾ç½®",size:"large","custom-class":"insight-settings-modal",onClose:U},{footer:je(()=>[e("button",{class:"btn btn-secondary",onClick:U},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",disabled:o.value,onClick:D},_(o.value?"ä¿å­˜ä¸­...":"ä¿å­˜"),9,ld)]),default:je(()=>[e("div",ad,[e("button",{class:H(["settings-tab",{active:s.value==="vlm"}]),onClick:c[0]||(c[0]=h=>S("vlm"))}," ðŸ–¼ï¸ VLM å¤šæ¨¡æ€ ",2),e("button",{class:H(["settings-tab",{active:s.value==="llm"}]),onClick:c[1]||(c[1]=h=>S("llm"))}," ðŸ’¬ LLM å¯¹è¯ ",2),e("button",{class:H(["settings-tab",{active:s.value==="batch"}]),onClick:c[2]||(c[2]=h=>S("batch"))}," ðŸ“Š æ‰¹é‡åˆ†æž ",2),e("button",{class:H(["settings-tab",{active:s.value==="embedding"}]),onClick:c[3]||(c[3]=h=>S("embedding"))}," ðŸ”¢ å‘é‡æ¨¡åž‹ ",2),e("button",{class:H(["settings-tab",{active:s.value==="reranker"}]),onClick:c[4]||(c[4]=h=>S("reranker"))}," ðŸ”„ é‡æŽ’åº ",2),e("button",{class:H(["settings-tab",{active:s.value==="imagegen"}]),onClick:c[5]||(c[5]=h=>S("imagegen"))}," ðŸŽ¨ ç”Ÿå›¾æ¨¡åž‹ ",2),e("button",{class:H(["settings-tab",{active:s.value==="prompts"}]),onClick:c[6]||(c[6]=h=>S("prompts"))}," ðŸ“ æç¤ºè¯ ",2)]),i.value?(v(),g("div",{key:0,class:H(["test-message",u.value])},_(i.value),3)):E("",!0),O(X(ku,{ref_key:"vlmTabRef",ref:r,onShowMessage:R},null,512),[[de,s.value==="vlm"]]),O(X(Eu,{ref_key:"llmTabRef",ref:d,onShowMessage:R},null,512),[[de,s.value==="llm"]]),O(X(ec,{ref_key:"batchTabRef",ref:m},null,512),[[de,s.value==="batch"]]),O(X(mc,{ref_key:"embeddingTabRef",ref:k,onShowMessage:R},null,512),[[de,s.value==="embedding"]]),O(X(Ic,{ref_key:"rerankerTabRef",ref:$,onShowMessage:R},null,512),[[de,s.value==="reranker"]]),O(X(Fc,{ref_key:"promptsTabRef",ref:w,onShowMessage:R},null,512),[[de,s.value==="prompts"]]),O(X(nd,{ref_key:"imageGenTabRef",ref:x,onShowMessage:R},null,512),[[de,s.value==="imagegen"]])]),_:1}))}}),rd={class:"modal chapter-select-modal show"},id={class:"modal-content"},ud={class:"modal-body"},cd={class:"chapters-list"},dd=["onClick"],pd={class:"chapter-info"},vd={class:"chapter-title"},md={key:0,class:"chapter-pages"},gd={key:0,class:"check-icon"},fd={class:"modal-footer"},hd=["disabled"],bd=te({__name:"ChapterSelectModal",props:{chapters:{}},emits:["close","select"],setup(n,{emit:t}){const l=t,a=y("");function s(u){a.value=u}function o(){a.value&&l("select",a.value)}function i(){l("close")}return(u,r)=>(v(),g("div",rd,[e("div",{class:"modal-overlay",onClick:i}),e("div",id,[e("div",{class:"modal-header"},[r[0]||(r[0]=e("h2",null,"ðŸ“– é€‰æ‹©ç« èŠ‚",-1)),e("button",{class:"modal-close",onClick:i},"Ã—")]),e("div",ud,[r[1]||(r[1]=e("p",{class:"hint-text"},"è¯·é€‰æ‹©è¦ç¿»è¯‘çš„ç« èŠ‚ï¼š",-1)),e("div",cd,[(v(!0),g(Q,null,W(n.chapters,d=>(v(),g("div",{key:d.id,class:H(["chapter-item",{selected:a.value===d.id}]),onClick:m=>s(d.id)},[e("div",pd,[e("span",vd,_(d.title),1),d.startPage&&d.endPage?(v(),g("span",md," ç¬¬ "+_(d.startPage)+"-"+_(d.endPage)+" é¡µ ",1)):E("",!0)]),a.value===d.id?(v(),g("span",gd,"âœ“")):E("",!0)],10,dd))),128))])]),e("div",fd,[e("button",{class:"btn btn-secondary",onClick:i},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",disabled:!a.value,onClick:o}," ç¡®å®š ",8,hd)])])]))}}),yd=oe(bd,[["__scopeId","data-v-5f4c62c9"]]);async function kd(n){return q.get(`/api/manga-insight/${n}/continuation/prepare`)}async function _d(n){return q.get(`/api/manga-insight/${n}/continuation/characters`)}async function $d(n,t){return q.post(`/api/manga-insight/${n}/continuation/characters`,t)}async function wd(n,t){return q.delete(`/api/manga-insight/${n}/continuation/characters/${encodeURIComponent(t)}`)}async function xt(n,t,l){return q.put(`/api/manga-insight/${n}/continuation/characters/${encodeURIComponent(t)}`,l)}async function xd(n,t,l){return q.post(`/api/manga-insight/${n}/continuation/characters/${encodeURIComponent(t)}/forms`,l)}async function Cd(n,t,l,a){return q.put(`/api/manga-insight/${n}/continuation/characters/${encodeURIComponent(t)}/forms/${encodeURIComponent(l)}`,a)}async function Sd(n,t,l){return q.delete(`/api/manga-insight/${n}/continuation/characters/${encodeURIComponent(t)}/forms/${encodeURIComponent(l)}`)}async function Pd(n,t,l,a){return q.post(`/api/manga-insight/${n}/continuation/characters/${encodeURIComponent(t)}/forms/${encodeURIComponent(l)}/toggle`,{enabled:a})}async function Id(n,t,l,a){return q.upload(`/api/manga-insight/${n}/continuation/characters/${encodeURIComponent(t)}/forms/${encodeURIComponent(l)}/image`,a)}async function Md(n,t,l){return q.delete(`/api/manga-insight/${n}/continuation/characters/${encodeURIComponent(t)}/forms/${encodeURIComponent(l)}/image`)}async function Rd(n,t,l,a){const s=new FormData;return a.forEach(o=>{s.append("images",o)}),q.post(`/api/manga-insight/${n}/continuation/characters/${encodeURIComponent(t)}/forms/${encodeURIComponent(l)}/orthographic`,s,{headers:{"Content-Type":"multipart/form-data"},timeout:0})}async function Td(n,t,l,a){return q.post(`/api/manga-insight/${n}/continuation/characters/${encodeURIComponent(t)}/forms/${encodeURIComponent(l)}/set-reference`,{image_path:a})}async function Ud(n,t,l){return q.post(`/api/manga-insight/${n}/continuation/script`,{direction:t,page_count:l},{timeout:0})}async function Ie(n,t){return q.post(`/api/manga-insight/${n}/continuation/save-pages`,{pages:t})}async function Kt(n,t){return q.post(`/api/manga-insight/${n}/continuation/save-config`,t)}async function Ad(n){return q.delete(`/api/manga-insight/${n}/continuation/clear`)}async function Bd(n,t,l){return q.post(`/api/manga-insight/${n}/continuation/pages/${l}`,{script:t},{timeout:0})}async function Ed(n,t){return q.post(`/api/manga-insight/${n}/continuation/prompts`,{pages:t},{timeout:0})}async function Ct(n,t,l){return q.post(`/api/manga-insight/${n}/continuation/prompts/${l}`,{page:t},{timeout:0})}async function St(n,t=3){return q.get(`/api/manga-insight/${n}/continuation/style-references?count=${t}`)}async function Ld(n,t,l,a,s,o=3){return q.post(`/api/manga-insight/${n}/continuation/generate/${t}`,{page:l,style_reference_images:a,session_id:s,style_ref_count:o},{timeout:0})}async function Dd(n,t,l,a,s,o=3){return q.post(`/api/manga-insight/${n}/continuation/regenerate/${t}`,{page:l,style_reference_images:a,session_id:s,style_ref_count:o},{timeout:0})}async function zd(n){const t=await fetch(`/api/manga-insight/${n}/continuation/export/images`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!t.ok){const l=await t.json().catch(()=>({}));throw new Error(l.error||"å¯¼å‡ºå¤±è´¥")}return t.blob()}async function Od(n){const t=await fetch(`/api/manga-insight/${n}/continuation/export/pdf`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!t.ok){const l=await t.json().catch(()=>({}));throw new Error(l.error||"å¯¼å‡ºå¤±è´¥")}return t.blob()}async function vt(n,t="script",l=0){const a=new URLSearchParams({mode:t,current_page:l.toString()});return q.get(`/api/manga-insight/${n}/continuation/available-images?${a}`)}async function Gd(n,t,l,a){return q.post(`/api/manga-insight/${n}/continuation/script`,{direction:t,page_count:l,reference_images:a||null},{timeout:0})}const Nt=Symbol("ContinuationState");function Vd(n){const t=y(!1),l=y(!1),a=y(0),s=y(""),o=y(""),i=y(10),u=y(3),r=y(""),d=y([]),m=y(null),k=y([]),$=y(0),w=y(!1),x=y(!1),S=y(Date.now());async function U(){if(n.value){t.value=!0;try{const c=await kd(n.value);if(c.success&&c.saved_data){const h=c.saved_data,P=await _d(n.value);P.success&&P.characters&&(d.value=P.characters),m.value=h.script,k.value=h.pages||[],h.config&&(i.value=h.config.page_count||10,u.value=h.config.style_reference_pages||3,r.value=h.config.continuation_direction||"");try{const T=await vt(n.value,"script");T.success&&T.total_original_pages&&($.value=T.total_original_pages)}catch(T){console.warn("èŽ·å–åŽŸä½œæ€»é¡µæ•°å¤±è´¥:",T)}l.value=!0}}catch(c){console.error("åˆå§‹åŒ–æ•°æ®å¤±è´¥:",c),D("åˆå§‹åŒ–æ•°æ®å¤±è´¥","error")}finally{t.value=!1}}}async function R(){a.value=0,l.value=!1,d.value=[],m.value=null,k.value=[],i.value=10,u.value=3,r.value="",S.value=Date.now(),$.value=0}function D(c,h="info"){h==="error"?(s.value=c,o.value=""):h==="success"&&(o.value=c,s.value=""),setTimeout(()=>{s.value="",o.value=""},3e3)}function f(c){return n.value?`/api/manga-insight/${n.value}/continuation/characters/${encodeURIComponent(c)}/image?t=${S.value}`:""}function b(c){return!n.value||!c?"":`/api/manga-insight/file?path=${encodeURIComponent(c)}&t=${S.value}`}function p(c){return!n.value||!c?"":`/api/manga-insight/${n.value}/continuation/generated-image?path=${encodeURIComponent(c)}`}return{isLoading:gt(t),isDataReady:gt(l),currentStep:a,errorMessage:s,successMessage:o,pageCount:i,styleRefPages:u,continuationDirection:r,characters:d,chapterScript:m,pages:k,imageRefreshKey:S,totalOriginalPages:$,isGeneratingPages:w,isGeneratingPrompts:x,initializeData:U,resetState:R,showMessage:D,getCharacterImageUrl:f,getFormImageUrl:b,getGeneratedImageUrl:p}}function mt(){const n=It(Nt);if(!n)throw new Error("useContinuationStateInject must be used after provideContinuationState");return n}const jt=Symbol("CharacterManagement");function qd(n,t){async function l(x,S,U){if(n.value)try{const R=await $d(n.value,{name:x,aliases:S,description:U});R.success?(await t.initializeData(),t.showMessage("è§’è‰²æ·»åŠ æˆåŠŸ","success")):t.showMessage("æ·»åŠ å¤±è´¥: "+R.error,"error")}catch(R){t.showMessage("æ·»åŠ å¤±è´¥: "+(R instanceof Error?R.message:"ç½‘ç»œé”™è¯¯"),"error")}}async function a(x){if(n.value)try{const S=await wd(n.value,x);S.success?(await t.initializeData(),t.showMessage("è§’è‰²åˆ é™¤æˆåŠŸ","success")):t.showMessage("åˆ é™¤å¤±è´¥: "+S.error,"error")}catch(S){t.showMessage("åˆ é™¤å¤±è´¥: "+(S instanceof Error?S.message:"ç½‘ç»œé”™è¯¯"),"error")}}async function s(x,S,U){if(n.value)try{const R=await xt(n.value,x,{name:S,aliases:U});R.success?(await t.initializeData(),t.showMessage("è§’è‰²ä¿¡æ¯æ›´æ–°æˆåŠŸ","success")):t.showMessage("æ›´æ–°å¤±è´¥: "+R.error,"error")}catch(R){t.showMessage("æ›´æ–°å¤±è´¥: "+(R instanceof Error?R.message:"ç½‘ç»œé”™è¯¯"),"error")}}async function o(x,S){if(!n.value)return;const U=t.characters.value.find(D=>D.name===x);if(!U)return;const R=U.enabled;U.enabled=S;try{const D=await xt(n.value,x,{name:U.name,aliases:U.aliases||[],enabled:S});D.success||(U.enabled=R,t.showMessage("æ“ä½œå¤±è´¥: "+D.error,"error"))}catch(D){U.enabled=R,t.showMessage("æ“ä½œå¤±è´¥: "+(D instanceof Error?D.message:"ç½‘ç»œé”™è¯¯"),"error")}}async function i(x,S,U){if(n.value)try{const f=`form_${(t.characters.value.find(p=>p.name===x)?.forms?.length||0)+1}`,b=await xd(n.value,x,{form_id:f,form_name:S,description:U});b.success?(await t.initializeData(),t.showMessage("å½¢æ€æ·»åŠ æˆåŠŸ","success")):t.showMessage("æ·»åŠ å¤±è´¥: "+b.error,"error")}catch(R){t.showMessage("æ·»åŠ å¤±è´¥: "+(R instanceof Error?R.message:"ç½‘ç»œé”™è¯¯"),"error")}}async function u(x,S,U,R){if(n.value)try{const D=await Cd(n.value,x,S,{form_name:U,description:R});D.success?(await t.initializeData(),t.showMessage("å½¢æ€æ›´æ–°æˆåŠŸ","success")):t.showMessage("æ›´æ–°å¤±è´¥: "+D.error,"error")}catch(D){t.showMessage("æ›´æ–°å¤±è´¥: "+(D instanceof Error?D.message:"ç½‘ç»œé”™è¯¯"),"error")}}async function r(x,S){if(n.value)try{const U=await Sd(n.value,x,S);U.success?(await t.initializeData(),t.showMessage("å½¢æ€åˆ é™¤æˆåŠŸ","success")):t.showMessage("åˆ é™¤å¤±è´¥: "+U.error,"error")}catch(U){t.showMessage("åˆ é™¤å¤±è´¥: "+(U instanceof Error?U.message:"ç½‘ç»œé”™è¯¯"),"error")}}async function d(x,S,U){if(n.value)try{const R=new FormData;R.append("file",U);const D=await Id(n.value,x,S,R);D.success?(t.imageRefreshKey.value=Date.now(),await t.initializeData(),t.showMessage("å›¾ç‰‡ä¸Šä¼ æˆåŠŸ","success")):t.showMessage("ä¸Šä¼ å¤±è´¥: "+D.error,"error")}catch(R){t.showMessage("ä¸Šä¼ å¤±è´¥: "+(R instanceof Error?R.message:"ç½‘ç»œé”™è¯¯"),"error")}}async function m(x,S){if(n.value)try{const U=await Md(n.value,x,S);U.success?(t.imageRefreshKey.value=Date.now(),await t.initializeData(),t.showMessage("å›¾ç‰‡åˆ é™¤æˆåŠŸ","success")):t.showMessage("åˆ é™¤å¤±è´¥: "+U.error,"error")}catch(U){t.showMessage("åˆ é™¤å¤±è´¥: "+(U instanceof Error?U.message:"ç½‘ç»œé”™è¯¯"),"error")}}async function k(x,S,U){if(!n.value)return;const R=t.characters.value.find(b=>b.name===x);if(!R)return;const D=R.forms?.find(b=>b.form_id===S);if(!D)return;const f=D.enabled;D.enabled=U;try{const b=await Pd(n.value,x,S,U);b.success||(D.enabled=f,t.showMessage("æ“ä½œå¤±è´¥: "+b.error,"error"))}catch(b){D.enabled=f,t.showMessage("æ“ä½œå¤±è´¥: "+(b instanceof Error?b.message:"ç½‘ç»œé”™è¯¯"),"error")}}async function $(x,S,U){if(!n.value)return{success:!1,error:"No book ID"};try{return await Rd(n.value,x,S,U)}catch(R){return{success:!1,error:R instanceof Error?R.message:"ç½‘ç»œé”™è¯¯"}}}async function w(x,S,U){if(n.value)try{const R=await Td(n.value,x,S,U);if(R.success)t.imageRefreshKey.value=Date.now(),await t.initializeData();else throw new Error(R.error)}catch(R){throw R}}return{addCharacter:l,deleteCharacter:a,updateCharacterInfo:s,toggleCharacterEnabled:o,addForm:i,updateForm:u,deleteForm:r,uploadFormImage:d,deleteFormImage:m,toggleFormEnabled:k,generateOrtho:$,setFormReference:w}}function Fd(){const n=It(jt);if(!n)throw new Error("useCharacterManagementInject must be used after provideCharacterManagement");return n}const Kd=Symbol("ScriptGenerationKey");function Nd(n,t){const l=y(!1);async function a(){if(n.value){l.value=!0,t.errorMessage.value="";try{const s=await Ud(n.value,t.continuationDirection.value,t.pageCount.value);if(s.success&&s.script){t.chapterScript.value=s.script;try{await Kt(n.value,{page_count:t.pageCount.value,style_reference_pages:t.styleRefPages.value,continuation_direction:t.continuationDirection.value}),console.log("é…ç½®å·²ä¿å­˜")}catch(o){console.error("ä¿å­˜é…ç½®å¤±è´¥:",o)}t.showMessage("è„šæœ¬ç”ŸæˆæˆåŠŸ","success")}else t.showMessage("è„šæœ¬ç”Ÿæˆå¤±è´¥: "+s.error,"error")}catch(s){t.showMessage("è„šæœ¬ç”Ÿæˆå¤±è´¥: "+(s instanceof Error?s.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{l.value=!1}}}return{isGenerating:l,generateScript:a}}const jd=Symbol("ImageGeneration");function Hd(n,t){const l=y(!1),a=y(0);async function s(i,u){if(!n.value||i.length===0)return;l.value=!0,a.value=0;const r=i.length;let d=0;try{let m;if(u&&u.length>0)m=[...u];else{const k=await St(n.value,t.styleRefPages.value);m=k.success&&k.images?k.images:[]}for(const k of i){if(k.image_url){d++,a.value=Math.round(d/r*100);continue}t.showMessage(`æ­£åœ¨ç”Ÿæˆç¬¬ ${k.page_number}/${r} é¡µå›¾ç‰‡...`,"info");try{const $=await Ld(n.value,k.page_number,k,m,void 0,t.styleRefPages.value);$.success&&$.image_path?(k.image_url=$.image_path,k.status="generated",m.length>=t.styleRefPages.value&&m.shift(),m.push($.image_path)):k.status="failed"}catch($){console.error(`ç”Ÿæˆç¬¬ ${k.page_number} é¡µå¤±è´¥:`,$),k.status="failed"}d++,a.value=Math.round(d/r*100)}await Ie(n.value,i),t.showMessage(`å›¾ç‰‡ç”Ÿæˆå®Œæˆ (${d}/${r})`,"success")}catch(m){t.showMessage("æ‰¹é‡ç”Ÿæˆå¤±è´¥: "+(m instanceof Error?m.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{l.value=!1,a.value=0}}async function o(i){if(!n.value)return;const u=t.pages.value.find(r=>r.page_number===i);if(u)try{u.status="generating";const r=await St(n.value,t.styleRefPages.value),d=r.success&&r.images?r.images:[],m=await Dd(n.value,i,u,d,void 0,t.styleRefPages.value);m.success&&m.image_path?(u.image_url&&(u.previous_url=u.image_url),u.image_url=m.image_path,u.status="generated",await Ie(n.value,t.pages.value),t.showMessage(`ç¬¬ ${i} é¡µå›¾ç‰‡å·²é‡æ–°ç”Ÿæˆ`,"success")):(u.status="failed",t.showMessage("é‡æ–°ç”Ÿæˆå¤±è´¥: "+m.error,"error"))}catch(r){u.status="failed",t.showMessage("é‡æ–°ç”Ÿæˆå¤±è´¥: "+(r instanceof Error?r.message:"ç½‘ç»œé”™è¯¯"),"error")}}return{isGenerating:l,generationProgress:a,batchGenerateImages:s,regeneratePageImage:o}}const Qd={class:"form-image-section"},Jd=["src"],Zd={key:1,class:"image-placeholder"},Wd={class:"upload-overlay"},Xd={class:"upload-text"},Yd={class:"form-content"},ep={class:"form-header"},tp={class:"form-title"},sp={key:0,class:"status-badge disabled"},np={key:0,class:"form-description"},ap={class:"form-actions"},lp={class:"action-row"},op=["title"],rp=["checked"],ip={class:"action-row secondary"},up=te({__name:"FormTile",props:{form:{},characterName:{},formImageUrl:{}},emits:["edit","delete","upload-image","delete-image","generate-orthographic","toggle-enabled"],setup(n,{emit:t}){const l=t;function a(s){const o=s.target;if(!o.files?.length)return;const i=o.files[0];i&&(l("upload-image",i),o.value="")}return(s,o)=>(v(),g("div",{class:H(["form-tile",{disabled:n.form.enabled===!1}])},[e("div",Qd,[n.form.reference_image?(v(),g("img",{key:0,src:n.formImageUrl,alt:""},null,8,Jd)):(v(),g("div",Zd,[...o[5]||(o[5]=[e("span",{class:"placeholder-icon"},"ðŸ“·",-1),e("p",{class:"placeholder-text"},"æœªä¸Šä¼ å‚è€ƒå›¾",-1)])])),e("label",Wd,[e("span",Xd,_(n.form.reference_image?"æ›´æ¢å›¾ç‰‡":"ä¸Šä¼ å›¾ç‰‡"),1),e("input",{type:"file",accept:"image/*",hidden:"",onChange:a},null,32)])]),e("div",Yd,[e("div",ep,[e("h4",tp,_(n.form.form_name),1),n.form.enabled===!1?(v(),g("span",sp,"å·²ç¦ç”¨")):E("",!0)]),n.form.description?(v(),g("p",np,_(n.form.description),1)):E("",!0)]),e("div",ap,[e("div",lp,[e("label",{class:"toggle-control",title:n.form.enabled!==!1?"ç‚¹å‡»ç¦ç”¨":"ç‚¹å‡»å¯ç”¨"},[e("input",{type:"checkbox",checked:n.form.enabled!==!1,onChange:o[0]||(o[0]=i=>s.$emit("toggle-enabled",i.target.checked))},null,40,rp),o[6]||(o[6]=e("span",{class:"toggle-track"},null,-1))],8,op),e("button",{class:"action-btn generate-btn",onClick:o[1]||(o[1]=i=>s.$emit("generate-orthographic")),title:"ç”Ÿæˆä¸‰è§†å›¾"},[...o[7]||(o[7]=[e("span",null,"ðŸŽ¨",-1)])]),n.form.reference_image?(v(),g("button",{key:0,class:"action-btn delete-btn",onClick:o[2]||(o[2]=i=>s.$emit("delete-image")),title:"åˆ é™¤å›¾ç‰‡"},[...o[8]||(o[8]=[e("span",null,"ðŸ—‘ï¸",-1)])])):E("",!0)]),e("div",ip,[e("button",{class:"icon-btn edit-btn",onClick:o[3]||(o[3]=i=>s.$emit("edit")),title:"ç¼–è¾‘å½¢æ€"},"âœï¸"),e("button",{class:"icon-btn delete-btn",onClick:o[4]||(o[4]=i=>s.$emit("delete")),title:"åˆ é™¤å½¢æ€"},"ðŸ—‘ï¸")])])],2))}}),cp=oe(up,[["__scopeId","data-v-76e2e25f"]]),dp={key:0,class:"empty-detail"},pp={class:"detail-header"},vp={class:"detail-main-info"},mp={class:"detail-avatar"},gp=["src"],fp={key:1,class:"detail-avatar-placeholder"},hp={class:"detail-info"},bp={key:0,class:"detail-aliases"},yp={class:"detail-actions"},kp={class:"toggle-switch",title:"å¯ç”¨/ç¦ç”¨è§’è‰²"},_p=["checked"],$p={class:"forms-section"},wp={class:"section-header"},xp={key:0,class:"empty-forms"},Cp={key:1,class:"forms-grid"},Sp=te({__name:"CharacterDetailPanel",props:{character:{},avatarUrl:{},getFormImageUrl:{type:Function}},emits:["toggle-character","edit-character","delete-character","add-form","edit-form","delete-form","upload-form-image","delete-form-image","generate-orthographic","toggle-form-enabled"],setup(n){return(t,l)=>(v(),g("div",{class:H(["character-detail-panel",{"has-selection":!!n.character}])},[n.character?(v(),g(Q,{key:1},[e("div",pp,[e("div",vp,[e("div",mp,[n.character.reference_image?(v(),g("img",{key:0,src:n.avatarUrl,alt:""},null,8,gp)):(v(),g("div",fp,_(n.character.name.charAt(0)),1))]),e("div",hp,[e("h4",null,_(n.character.name),1),n.character.aliases&&n.character.aliases.length>0?(v(),g("p",bp," åˆ«åï¼š"+_(n.character.aliases.join("ã€")),1)):E("",!0)])]),e("div",yp,[e("label",kp,[e("input",{type:"checkbox",checked:n.character.enabled!==!1,onChange:l[0]||(l[0]=a=>t.$emit("toggle-character",a.target.checked))},null,40,_p),l[5]||(l[5]=e("span",{class:"toggle-slider"},null,-1))]),e("button",{class:"icon-btn-lg",onClick:l[1]||(l[1]=a=>t.$emit("edit-character")),title:"ç¼–è¾‘è§’è‰²"},"âœï¸"),e("button",{class:"icon-btn-lg danger",onClick:l[2]||(l[2]=a=>t.$emit("delete-character")),title:"åˆ é™¤è§’è‰²"},"ðŸ—‘ï¸")])]),e("div",$p,[e("div",wp,[l[6]||(l[6]=e("h4",null,"å½¢æ€åˆ—è¡¨",-1)),e("button",{class:"btn small primary",onClick:l[3]||(l[3]=a=>t.$emit("add-form"))}," âž• æ–°å¢žå½¢æ€ ")]),!n.character.forms||n.character.forms.length===0?(v(),g("div",xp,[...l[7]||(l[7]=[e("p",null,'æš‚æ— å½¢æ€ï¼Œç‚¹å‡»"æ–°å¢žå½¢æ€"æ·»åŠ ',-1)])])):(v(),g("div",Cp,[(v(!0),g(Q,null,W(n.character.forms,a=>(v(),fe(cp,{key:a.form_id,form:a,"character-name":n.character.name,"form-image-url":n.getFormImageUrl(a.form_id),onEdit:s=>t.$emit("edit-form",a),onDelete:s=>t.$emit("delete-form",a),onUploadImage:s=>t.$emit("upload-form-image",a.form_id,s),onDeleteImage:s=>t.$emit("delete-form-image",a.form_id),onGenerateOrthographic:s=>t.$emit("generate-orthographic",a.form_id,a.form_name),onToggleEnabled:s=>t.$emit("toggle-form-enabled",a.form_id,s)},null,8,["form","character-name","form-image-url","onEdit","onDelete","onUploadImage","onDeleteImage","onGenerateOrthographic","onToggleEnabled"]))),128))]))])],64)):(v(),g("div",dp,[...l[4]||(l[4]=[e("span",null,"ðŸ‘ˆ",-1),e("p",null,"ç‚¹å‡»å·¦ä¾§è§’è‰²æŸ¥çœ‹è¯¦æƒ…",-1)])]))],2))}}),Pp=oe(Sp,[["__scopeId","data-v-f0f09941"]]),Ip={class:"modal-dialog add-char-dialog"},Mp={class:"modal-header"},Rp={class:"modal-body"},Tp={class:"form-group"},Up={class:"form-group"},Ap={class:"form-group"},Bp={class:"modal-footer"},Ep=["disabled"],Lp=te({__name:"AddCharacterDialog",emits:["close","add"],setup(n,{emit:t}){const l=t,a=y(""),s=y(""),o=y(""),i=y(!1);function u(){const r=a.value.trim();if(!r){alert("è§’è‰²åä¸èƒ½ä¸ºç©º");return}const d=s.value.split(/[,ï¼Œ]/).map(m=>m.trim()).filter(m=>m.length>0);i.value=!0,l("add",r,d,o.value.trim()),setTimeout(()=>{i.value=!1},500)}return(r,d)=>(v(),g("div",{class:"modal-overlay",onClick:d[5]||(d[5]=ie(m=>r.$emit("close"),["self"]))},[e("div",Ip,[e("div",Mp,[d[6]||(d[6]=e("h3",null,"âž• æ–°å¢žè§’è‰²",-1)),e("button",{class:"close-btn",onClick:d[0]||(d[0]=m=>r.$emit("close"))},"Ã—")]),e("div",Rp,[e("div",Tp,[d[7]||(d[7]=e("label",null,[se("è§’è‰²åç§° "),e("span",{class:"required"},"*")],-1)),O(e("input",{"onUpdate:modelValue":d[1]||(d[1]=m=>a.value=m),type:"text",class:"form-input",placeholder:"è¾“å…¥è§’è‰²åç§°"},null,512),[[N,a.value]])]),e("div",Up,[d[8]||(d[8]=e("label",null,"åˆ«åï¼ˆç”¨é€—å·åˆ†éš”ï¼Œå¯é€‰ï¼‰",-1)),O(e("input",{"onUpdate:modelValue":d[2]||(d[2]=m=>s.value=m),type:"text",class:"form-input",placeholder:"ä¾‹å¦‚: å°æ˜Ž, é˜¿æ˜Ž"},null,512),[[N,s.value]])]),e("div",Ap,[d[9]||(d[9]=e("label",null,"è§’è‰²æè¿°ï¼ˆå¯é€‰ï¼‰",-1)),O(e("textarea",{"onUpdate:modelValue":d[3]||(d[3]=m=>o.value=m),rows:"3",class:"form-input",placeholder:"ç®€å•æè¿°è§’è‰²çš„å¤–è§‚ç‰¹å¾..."},null,512),[[N,o.value]])])]),e("div",Bp,[e("button",{class:"btn secondary",onClick:d[4]||(d[4]=m=>r.$emit("close"))},"å–æ¶ˆ"),e("button",{class:"btn primary",disabled:!a.value.trim()||i.value,onClick:u},_(i.value?"æ·»åŠ ä¸­...":"âœ“ ç¡®è®¤æ·»åŠ "),9,Ep)])])]))}}),Dp=oe(Lp,[["__scopeId","data-v-5696c2fc"]]),zp={class:"modal-dialog edit-char-dialog"},Op={class:"modal-header"},Gp={class:"modal-body"},Vp={class:"form-group"},qp={class:"form-group"},Fp={class:"modal-footer"},Kp=te({__name:"EditCharacterDialog",props:{character:{}},emits:["close","save"],setup(n,{emit:t}){const l=n,a=t,s=y(l.character.name),o=y(l.character.aliases.join(", "));ue(()=>l.character,u=>{s.value=u.name,o.value=u.aliases.join(", ")},{immediate:!0});function i(){const u=s.value.trim(),r=o.value.split(/[,ï¼Œ]/).map(d=>d.trim()).filter(d=>d.length>0);if(!u){alert("è§’è‰²åä¸èƒ½ä¸ºç©º");return}a("save",u,r)}return(u,r)=>(v(),g("div",{class:"modal-overlay",onClick:r[4]||(r[4]=ie(d=>u.$emit("close"),["self"]))},[e("div",zp,[e("div",Op,[r[5]||(r[5]=e("h3",null,"âœï¸ ç¼–è¾‘è§’è‰²",-1)),e("button",{class:"close-btn",onClick:r[0]||(r[0]=d=>u.$emit("close"))},"Ã—")]),e("div",Gp,[e("div",Vp,[r[6]||(r[6]=e("label",null,"è§’è‰²åç§°",-1)),O(e("input",{"onUpdate:modelValue":r[1]||(r[1]=d=>s.value=d),type:"text",class:"form-input",placeholder:"è¾“å…¥è§’è‰²ä¸»åç§°"},null,512),[[N,s.value]])]),e("div",qp,[r[7]||(r[7]=e("label",null,"åˆ«åï¼ˆç”¨é€—å·åˆ†éš”ï¼‰",-1)),O(e("input",{"onUpdate:modelValue":r[2]||(r[2]=d=>o.value=d),type:"text",class:"form-input",placeholder:"ä¾‹å¦‚: æ¡ä¹ƒ, æ–°åž£å½©ä¸–"},null,512),[[N,o.value]]),r[8]||(r[8]=e("p",{class:"form-hint"},"AIç”Ÿæˆè„šæœ¬æ—¶å¯èƒ½ä½¿ç”¨è¿™äº›åå­—å¼•ç”¨è§’è‰²",-1))])]),e("div",Fp,[e("button",{class:"btn secondary",onClick:r[3]||(r[3]=d=>u.$emit("close"))},"å–æ¶ˆ"),e("button",{class:"btn primary",onClick:i},"ðŸ’¾ ä¿å­˜")])])]))}}),Np=oe(Kp,[["__scopeId","data-v-ef2467b9"]]),jp={class:"modal-dialog add-form-dialog"},Hp={class:"modal-header"},Qp={class:"modal-body"},Jp={class:"form-group"},Zp={class:"form-group"},Wp={class:"modal-footer"},Xp=["disabled"],Yp=te({__name:"AddFormDialog",emits:["close","add"],setup(n,{emit:t}){const l=t,a=y(""),s=y(""),o=y(!1);function i(){const u=a.value.trim();if(!u){alert("è¯·å¡«å†™å½¢æ€åç§°");return}o.value=!0,l("add",u,s.value.trim()),setTimeout(()=>{o.value=!1},500)}return(u,r)=>(v(),g("div",{class:"modal-overlay",onClick:r[4]||(r[4]=ie(d=>u.$emit("close"),["self"]))},[e("div",jp,[e("div",Hp,[r[5]||(r[5]=e("h3",null,"âž• æ–°å¢žå½¢æ€",-1)),e("button",{class:"close-btn",onClick:r[0]||(r[0]=d=>u.$emit("close"))},"Ã—")]),e("div",Qp,[e("div",Jp,[r[6]||(r[6]=e("label",null,[se("å½¢æ€åç§° "),e("span",{class:"required"},"*")],-1)),O(e("input",{"onUpdate:modelValue":r[1]||(r[1]=d=>a.value=d),type:"text",class:"form-input",placeholder:"ä¾‹å¦‚: æˆ˜æ–—æœã€é»‘åŒ–å½¢æ€ã€å¸¸æœ"},null,512),[[N,a.value]])]),e("div",Zp,[r[7]||(r[7]=e("label",null,"å½¢æ€æè¿°ï¼ˆå¯é€‰ï¼‰",-1)),O(e("textarea",{"onUpdate:modelValue":r[2]||(r[2]=d=>s.value=d),rows:"2",class:"form-input",placeholder:"ç®€å•æè¿°è¯¥å½¢æ€çš„ç‰¹å¾..."},null,512),[[N,s.value]])])]),e("div",Wp,[e("button",{class:"btn secondary",onClick:r[3]||(r[3]=d=>u.$emit("close"))},"å–æ¶ˆ"),e("button",{class:"btn primary",disabled:!a.value.trim()||o.value,onClick:i},_(o.value?"æ·»åŠ ä¸­...":"âœ“ ç¡®è®¤æ·»åŠ "),9,Xp)])])]))}}),ev=oe(Yp,[["__scopeId","data-v-a1ebb270"]]),tv={class:"modal-dialog edit-form-dialog"},sv={class:"modal-header"},nv={class:"modal-body"},av={class:"form-group"},lv={class:"form-group"},ov={class:"modal-footer"},rv=["disabled"],iv=te({__name:"EditFormDialog",props:{form:{}},emits:["close","save"],setup(n,{emit:t}){const l=n,a=t,s=y(l.form.form_name),o=y(l.form.description),i=y(!1);ue(()=>l.form,r=>{s.value=r.form_name,o.value=r.description},{immediate:!0});function u(){i.value=!0,a("save",s.value.trim(),o.value.trim()),setTimeout(()=>{i.value=!1},500)}return(r,d)=>(v(),g("div",{class:"modal-overlay",onClick:d[4]||(d[4]=ie(m=>r.$emit("close"),["self"]))},[e("div",tv,[e("div",sv,[d[5]||(d[5]=e("h3",null,"âœï¸ ç¼–è¾‘å½¢æ€",-1)),e("button",{class:"close-btn",onClick:d[0]||(d[0]=m=>r.$emit("close"))},"Ã—")]),e("div",nv,[e("div",av,[d[6]||(d[6]=e("label",null,"å½¢æ€åç§°",-1)),O(e("input",{"onUpdate:modelValue":d[1]||(d[1]=m=>s.value=m),type:"text",class:"form-input",placeholder:"å½¢æ€æ˜¾ç¤ºå"},null,512),[[N,s.value]])]),e("div",lv,[d[7]||(d[7]=e("label",null,"å½¢æ€æè¿°",-1)),O(e("textarea",{"onUpdate:modelValue":d[2]||(d[2]=m=>o.value=m),rows:"2",class:"form-input",placeholder:"å½¢æ€æè¿°..."},null,512),[[N,o.value]])])]),e("div",ov,[e("button",{class:"btn secondary",onClick:d[3]||(d[3]=m=>r.$emit("close"))},"å–æ¶ˆ"),e("button",{class:"btn primary",disabled:i.value,onClick:u},_(i.value?"ä¿å­˜ä¸­...":"ðŸ’¾ ä¿å­˜"),9,rv)])])]))}}),uv=oe(iv,[["__scopeId","data-v-2d4f813e"]]),cv={class:"modal-dialog ortho-dialog"},dv={class:"modal-header"},pv={key:0},vv={class:"modal-body"},mv={class:"ortho-upload-section"},gv={class:"upload-placeholder"},fv={class:"upload-icon"},hv={key:0},bv={key:1},yv={key:0,class:"source-images"},kv=["src","alt"],_v={class:"image-index"},$v={key:0,class:"generating-state"},wv={class:"progress-message"},xv={key:1,class:"ortho-result"},Cv={class:"result-preview"},Sv=["src"],Pv={class:"modal-footer"},Iv=["disabled"],Mv={key:1,class:"result-actions"},Rv=te({__name:"OrthographicDialog",props:{characterName:{},formId:{},formName:{},bookId:{}},emits:["close","generate","use-result"],setup(n,{expose:t,emit:l}){const a=n,s=l,o=y([]),i=y(!1),u=y(!1),r=y(""),d=y(null);function m(p){const c=p.target;if(!c.files)return;const h=Array.from(c.files).slice(0,5);o.value=h}function k(p){p.preventDefault(),p.stopPropagation(),i.value=!0}function $(p){p.preventDefault(),p.stopPropagation(),i.value=!0}function w(p){p.preventDefault(),p.stopPropagation(),i.value=!1}function x(p){p.preventDefault(),p.stopPropagation(),i.value=!1;const c=p.dataTransfer?.files;if(!c||c.length===0)return;const h=Array.from(c).filter(P=>P.type.startsWith("image/")).slice(0,5);h.length>0&&(o.value=h)}async function S(){o.value.length!==0&&(u.value=!0,r.value=`æ­£åœ¨ä¸Šä¼  ${o.value.length} å¼ å›¾ç‰‡...`,setTimeout(()=>{u.value&&(r.value="AI æ­£åœ¨åˆ†æžè§’è‰²ç‰¹å¾...")},500),setTimeout(()=>{u.value&&(r.value="æ­£åœ¨ç”Ÿæˆä¸‰è§†å›¾ï¼Œè¯·è€å¿ƒç­‰å¾…...")},2e3),s("generate",o.value))}function U(){d.value&&s("use-result",d.value)}function R(p){return window.URL.createObjectURL(p)}function D(){return!a.bookId||!d.value?"":`/api/manga-insight/${a.bookId}/continuation/generated-image?path=${encodeURIComponent(d.value)}`}function f(p){d.value=p,u.value=!1}function b(p){u.value=p}return t({setResult:f,setGenerating:b}),(p,c)=>(v(),g("div",{class:"modal-overlay",onClick:c[2]||(c[2]=ie(h=>p.$emit("close"),["self"]))},[e("div",cv,[e("div",dv,[e("h3",null,[se("ðŸŽ¨ ç”Ÿæˆä¸‰è§†å›¾ - "+_(n.characterName)+" ",1),n.formName&&n.formName!=="é»˜è®¤"?(v(),g("span",pv,"("+_(n.formName)+")",1)):E("",!0)]),e("button",{class:"close-btn",onClick:c[0]||(c[0]=h=>p.$emit("close"))},"Ã—")]),e("div",vv,[e("div",mv,[e("label",{class:H(["upload-area",{"drag-over":i.value}]),onDragenter:k,onDragover:$,onDragleave:w,onDrop:x},[e("input",{type:"file",accept:"image/*",multiple:"",hidden:"",onChange:m},null,32),e("div",gv,[e("span",fv,_(i.value?"ðŸ“¥":"ðŸ“"),1),i.value?(v(),g("p",hv,"é‡Šæ”¾ä»¥ä¸Šä¼ å›¾ç‰‡")):(v(),g("p",bv,"ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½è§’è‰²å›¾ç‰‡ï¼ˆ1-5å¼ ï¼‰")),c[3]||(c[3]=e("p",{class:"hint"},"å¯ä¸Šä¼ å¤šå¼ å›¾ç‰‡å¸®åŠ©AIç†è§£è§’è‰²ç‰¹å¾",-1))])],34),o.value.length>0?(v(),g("div",yv,[(v(!0),g(Q,null,W(o.value,(h,P)=>(v(),g("div",{key:P,class:"source-image"},[e("img",{src:R(h),alt:`æºå›¾${P+1}`},null,8,kv),e("span",_v,_(P+1),1)]))),128))])):E("",!0)]),u.value?(v(),g("div",$v,[c[4]||(c[4]=e("div",{class:"spinner"},null,-1)),e("p",wv,_(r.value),1),c[5]||(c[5]=e("p",{class:"progress-tip"},"â±ï¸ AI ç”Ÿæˆé€šå¸¸éœ€è¦ 30-60 ç§’",-1))])):d.value?(v(),g("div",xv,[c[6]||(c[6]=e("h4",null,"ç”Ÿæˆç»“æžœï¼š",-1)),e("div",Cv,[e("img",{src:D(),alt:"ä¸‰è§†å›¾"},null,8,Sv)])])):E("",!0)]),e("div",Pv,[e("button",{class:"btn secondary",onClick:c[1]||(c[1]=h=>p.$emit("close"))},"å–æ¶ˆ"),d.value?(v(),g("div",Mv,[e("button",{class:"btn secondary",onClick:S},"é‡æ–°ç”Ÿæˆ"),e("button",{class:"btn primary",onClick:U},"âœ“ ä½¿ç”¨ä¸‰è§†å›¾")])):(v(),g("button",{key:0,class:"btn primary",disabled:o.value.length===0||u.value,onClick:S},_(u.value?"ç”Ÿæˆä¸­...":"ðŸŽ¨ ç”Ÿæˆä¸‰è§†å›¾"),9,Iv))])])]))}}),Tv=oe(Rv,[["__scopeId","data-v-93f998e0"]]),Uv={class:"character-management-panel"},Av={key:0,class:"empty-state"},Bv={key:0},Ev={key:1},Lv={key:1,class:"character-panel-layout"},Dv={class:"character-grid-panel"},zv=["onClick"],Ov={class:"tile-avatar"},Gv=["src"],Vv={key:1,class:"tile-avatar-placeholder"},qv={key:2,class:"tile-form-badge"},Fv={key:3,class:"tile-disabled-badge"},Kv={class:"tile-name"},Nv=te({__name:"CharacterManagementPanel",props:{bookId:{},isLoading:{type:Boolean}},setup(n){const t=Fd(),l=mt(),a=y(null),s=y(!1),o=y(!1),i=y(!1),u=y(!1),r=y(!1),d=y(null),m=y(null),k=y(""),$=y(""),w=y(null),x=G(()=>l.characters.value);function S(J){a.value=J}function U(){return a.value&&x.value.find(J=>J.name===a.value)||null}function R(J){return l.getCharacterImageUrl(J)}function D(J,Z){const Pe=x.value.find(xe=>xe.name===J)?.forms?.find(xe=>xe.form_id===Z);return Pe?.reference_image?l.getFormImageUrl(Pe.reference_image):""}function f(){s.value=!0}function b(){const J=U();J&&(d.value=J,o.value=!0)}async function p(J,Z,le){await t.addCharacter(J,Z,le),s.value=!1}async function c(J,Z){a.value&&(await t.updateCharacterInfo(a.value,J,Z),o.value=!1)}async function h(){a.value&&confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰²"${a.value}"å—ï¼Ÿ`)&&(await t.deleteCharacter(a.value),a.value=null)}async function P(J){a.value&&await t.toggleCharacterEnabled(a.value,J)}function T(){a.value&&(i.value=!0)}function M(J){a.value&&(m.value=J,u.value=!0)}async function z(J,Z){a.value&&(await t.addForm(a.value,J,Z),i.value=!1)}async function Y(J,Z){!a.value||!m.value||(await t.updateForm(a.value,m.value.form_id,J,Z),u.value=!1)}async function j(J){a.value&&confirm(`ç¡®å®šè¦åˆ é™¤å½¢æ€"${J.form_name}"å—ï¼Ÿ`)&&await t.deleteForm(a.value,J.form_id)}async function A(J,Z){a.value&&await t.uploadFormImage(a.value,J,Z)}async function C(J){a.value&&confirm("ç¡®å®šè¦åˆ é™¤å½¢æ€å‚è€ƒå›¾å—ï¼Ÿ")&&await t.deleteFormImage(a.value,J)}async function I(J,Z){a.value&&await t.toggleFormEnabled(a.value,J,Z)}function L(J,Z){k.value=J,$.value=Z,r.value=!0}async function F(J){if(a.value){w.value?.setGenerating(!0);try{const Z=await t.generateOrtho(a.value,k.value,J);Z.success&&Z.image_path?(w.value?.setResult(Z.image_path),l.showMessage("ä¸‰è§†å›¾ç”ŸæˆæˆåŠŸ","success")):(l.showMessage("ç”Ÿæˆå¤±è´¥: "+Z.error,"error"),w.value?.setGenerating(!1))}catch(Z){l.showMessage("ç”Ÿæˆå¤±è´¥: "+(Z instanceof Error?Z.message:"ç½‘ç»œé”™è¯¯"),"error"),w.value?.setGenerating(!1)}}}async function re(J){if(a.value)try{await t.setFormReference(a.value,k.value,J),l.showMessage("ä¸‰è§†å›¾å·²è®¾ç½®ä¸ºå½¢æ€å‚è€ƒå›¾","success"),ve()}catch(Z){l.showMessage("è®¾ç½®å¤±è´¥: "+(Z instanceof Error?Z.message:"ç½‘ç»œé”™è¯¯"),"error")}}function ve(){r.value=!1,k.value="",$.value=""}return(J,Z)=>(v(),g("div",Uv,[e("div",{class:"section-header"},[Z[4]||(Z[4]=e("div",{class:"section-title"},[e("h4",null,"ðŸŽ­ è§’è‰²æ¡£æ¡ˆ"),e("p",{class:"hint"},"ç‚¹å‡»è§’è‰²æŸ¥çœ‹å’Œç®¡ç†å½¢æ€")],-1)),e("button",{class:"btn small primary",onClick:f}," âž• æ–°å¢žè§’è‰² ")]),x.value.length===0?(v(),g("div",Av,[n.isLoading?(v(),g("span",Bv,"åŠ è½½ä¸­...")):(v(),g("span",Ev,'æš‚æ— è§’è‰²æ•°æ®ï¼Œç‚¹å‡»"æ–°å¢žè§’è‰²"æ·»åŠ '))])):(v(),g("div",Lv,[e("div",Dv,[(v(!0),g(Q,null,W(x.value,le=>(v(),g("div",{key:le.name,class:H(["character-tile",{selected:a.value===le.name,disabled:le.enabled===!1}]),onClick:Pe=>S(le.name)},[e("div",Ov,[le.reference_image?(v(),g("img",{key:0,src:R(le.name),alt:""},null,8,Gv)):(v(),g("div",Vv,[e("span",null,_(le.name.charAt(0)),1)])),le.forms&&le.forms.length>1?(v(),g("div",qv,_(le.forms.length),1)):E("",!0),le.enabled===!1?(v(),g("div",Fv,"ç¦ç”¨")):E("",!0)]),e("div",Kv,_(le.name),1)],10,zv))),128))]),X(Pp,{character:U(),"avatar-url":a.value?R(a.value):"","get-form-image-url":le=>D(a.value,le),onToggleCharacter:P,onEditCharacter:b,onDeleteCharacter:h,onAddForm:T,onEditForm:M,onDeleteForm:j,onUploadFormImage:A,onDeleteFormImage:C,onGenerateOrthographic:L,onToggleFormEnabled:I},null,8,["character","avatar-url","get-form-image-url"])])),s.value?(v(),fe(Dp,{key:2,onClose:Z[0]||(Z[0]=le=>s.value=!1),onAdd:p})):E("",!0),o.value&&d.value?(v(),fe(Np,{key:3,character:d.value,onClose:Z[1]||(Z[1]=le=>o.value=!1),onSave:c},null,8,["character"])):E("",!0),i.value?(v(),fe(ev,{key:4,onClose:Z[2]||(Z[2]=le=>i.value=!1),onAdd:z})):E("",!0),u.value&&m.value?(v(),fe(uv,{key:5,form:m.value,onClose:Z[3]||(Z[3]=le=>u.value=!1),onSave:Y},null,8,["form"])):E("",!0),r.value&&a.value?(v(),fe(Tv,{key:6,"character-name":a.value,"form-id":k.value,"form-name":$.value,"book-id":n.bookId,ref_key:"orthoDialogRef",ref:w,onClose:ve,onGenerate:F,onUseResult:re},null,8,["character-name","form-id","form-name","book-id"])):E("",!0)]))}}),jv=oe(Nv,[["__scopeId","data-v-e086a6d1"]]),Hv={class:"reference-selector-modal"},Qv={class:"modal-header"},Jv={class:"header-actions"},Zv={key:0,class:"character-section"},Wv={class:"thumbnails-row"},Xv=["src","alt"],Yv={class:"character-label"},em={class:"manga-section"},tm=["onClick"],sm=["src","alt"],nm={key:0,class:"selection-badge"},am={class:"page-badge"},lm={key:1,class:"disabled-overlay",title:"å·²è¾¾åˆ°æœ€å¤§æ•°é‡ï¼Œè¯·å…ˆå–æ¶ˆå…¶ä»–é€‰æ‹©"},om=te({__name:"ReferenceImageSelector",props:{visible:{type:Boolean},mode:{},maxCount:{},originalImages:{},continuationImages:{},characterForms:{},initialSelection:{},bookId:{}},emits:["update:visible","confirm","cancel"],setup(n,{emit:t}){const l=n,a=t,s=y([]),o=y(null),i=G(()=>s.value.length);ue(()=>l.visible,f=>{f&&(l.initialSelection&&l.initialSelection.length>0?s.value=[...l.initialSelection]:k(),Ne(()=>{w()}))},{immediate:!0});function u(f){return f.path||""}function r(f){const b=u(f);return b?s.value.includes(b):!1}function d(f){const b=u(f),p=s.value.indexOf(b);return p>=0?p+1:0}function m(f){const b=u(f);if(!b)return;const p=s.value.indexOf(b);p>=0?s.value.splice(p,1):s.value.length<l.maxCount&&s.value.push(b)}function k(){s.value=[];const b=l.originalImages.filter(p=>p.path).slice(-l.maxCount);s.value=b.map(p=>p.path),Ne(()=>{w()})}function $(){s.value=[]}function w(){o.value&&(o.value.scrollTop=o.value.scrollHeight)}function x(f){return l.bookId?nt(l.bookId,f):""}function S(f){return f?`/api/manga-insight/file?path=${encodeURIComponent(f)}`:""}function U(f){const b=f.target;b.style.display="none"}function R(){a("confirm",[...s.value]),a("update:visible",!1)}function D(){a("cancel"),a("update:visible",!1)}return(f,b)=>n.visible?(v(),g("div",{key:0,class:"reference-selector-overlay",onClick:ie(D,["self"])},[e("div",Hv,[e("div",Qv,[e("h3",null,"é€‰æ‹©å‚è€ƒå›¾ ("+_(i.value)+"/"+_(n.maxCount)+")",1),e("div",Jv,[e("button",{class:"btn secondary",onClick:k}," è‡ªåŠ¨é€‰æ‹©æœ€åŽ"+_(n.maxCount)+"å¼  ",1),e("button",{class:"btn secondary",onClick:$}," æ¸…ç©º ")]),e("div",{class:"header-right"},[e("button",{class:"btn secondary",onClick:D},"å–æ¶ˆ"),e("button",{class:"btn primary",onClick:R},"ç¡®å®š")]),e("button",{class:"close-btn",onClick:D},"Ã—")]),n.mode==="image"&&n.characterForms.length>0?(v(),g("div",Zv,[b[0]||(b[0]=e("div",{class:"section-label"},[e("span",null,"è§’è‰²æ¡£æ¡ˆ"),e("span",{class:"section-hint"},"ï¼ˆè‡ªåŠ¨æ·»åŠ ï¼Œä¸è®¡å…¥é€‰æ‹©æ•°é‡ï¼‰")],-1)),e("div",Wv,[(v(!0),g(Q,null,W(n.characterForms,p=>(v(),g("div",{key:`${p.character_name}-${p.form_id}`,class:"thumbnail character-thumbnail"},[e("img",{src:S(p.reference_image),alt:`${p.character_name} - ${p.form_name}`,loading:"lazy",onError:U},null,40,Xv),e("div",Yv,_(p.character_name)+" - "+_(p.form_name),1)]))),128))])])):E("",!0),e("div",em,[b[1]||(b[1]=e("div",{class:"section-label"},[e("span",null,"æ¼«ç”»å›¾ç‰‡")],-1)),e("div",{class:"thumbnails-grid",ref_key:"thumbnailsGrid",ref:o},[(v(!0),g(Q,null,W(n.originalImages,p=>(v(),g("div",{key:`original-${p.page_number}`,class:H(["thumbnail",{selected:r(p),disabled:!r(p)&&i.value>=n.maxCount}]),onClick:c=>m(p)},[e("img",{src:x(p.page_number),alt:`ç¬¬${p.page_number}é¡µ`,loading:"lazy",onError:U},null,40,sm),r(p)?(v(),g("div",nm,_(d(p)),1)):E("",!0),e("div",am,_(p.page_number),1),!r(p)&&i.value>=n.maxCount?(v(),g("div",lm)):E("",!0)],10,tm))),128))],512)])])])):E("",!0)}}),Ht=oe(om,[["__scopeId","data-v-612aea0f"]]),rm={class:"script-panel"},im={key:0,class:"script-editor"},um={class:"script-header"},cm={class:"script-meta"},dm={class:"script-actions"},pm={key:1,class:"no-script"},vm={class:"reference-config"},mm={class:"config-row"},gm=["disabled"],fm=te({__name:"ScriptGenerationPanel",props:{script:{},isGenerating:{type:Boolean},bookId:{}},emits:["generate"],setup(n,{emit:t}){const l=n,a=t,s=y(""),o=y(5),i=y(!1),u=y([]),r=y([]);ue(()=>l.script,S=>{S&&(s.value=S.script_text)},{immediate:!0});async function d(){if(l.bookId)try{const S=await vt(l.bookId,"script");S.success&&S.original_images&&(r.value=S.original_images)}catch(S){console.error("åŠ è½½å¯ç”¨å›¾ç‰‡å¤±è´¥:",S)}}function m(){r.value.length===0&&d(),i.value=!0}function k(S){u.value=S}function $(){}function w(){return u.value.length>0?u.value.length:o.value}function x(){const S=u.value.length>0?u.value:null;a("generate",S)}return ke(()=>{l.bookId&&d()}),ue(()=>l.bookId,S=>{S&&(d(),u.value=[])}),(S,U)=>(v(),g("div",rm,[U[6]||(U[6]=e("h3",null,"ðŸ“ ç”Ÿæˆç»­å†™è„šæœ¬",-1)),n.script?(v(),g("div",im,[e("div",um,[e("h4",null,_(n.script.chapter_title),1),e("span",cm,"å…± "+_(n.script.page_count)+" é¡µ Â· "+_(n.script.generated_at),1)]),O(e("textarea",{"onUpdate:modelValue":U[0]||(U[0]=R=>s.value=R),class:"script-textarea",rows:"15",placeholder:"è„šæœ¬å°†åœ¨æ­¤æ˜¾ç¤º..."},null,512),[[N,s.value]]),e("div",dm,[e("button",{class:"btn secondary small",onClick:U[1]||(U[1]=R=>s.value=n.script.script_text)},"â†º é‡ç½®")])])):(v(),g("div",pm,[...U[4]||(U[4]=[e("p",null,"ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆç»­å†™è„šæœ¬",-1)])])),e("div",vm,[e("div",mm,[U[5]||(U[5]=e("label",null,"VLMå‚è€ƒå›¾æ•°:",-1)),O(e("input",{type:"number","onUpdate:modelValue":U[2]||(U[2]=R=>o.value=R),min:"1",max:"10",class:"ref-count-input"},null,512),[[N,o.value,void 0,{number:!0}]]),e("button",{class:"btn secondary small ref-btn",onClick:m}," ðŸ“· å‚è€ƒå›¾ ("+_(w())+") ",1)])]),e("button",{class:"btn primary",disabled:n.isGenerating,onClick:x},_(n.isGenerating?"ç”Ÿæˆä¸­...":"ðŸŽ¯ ç”Ÿæˆè„šæœ¬"),9,gm),X(Ht,{visible:i.value,"onUpdate:visible":U[3]||(U[3]=R=>i.value=R),mode:"script","max-count":o.value,"original-images":r.value,"continuation-images":[],"character-forms":[],"initial-selection":u.value,"book-id":n.bookId,onConfirm:k,onCancel:$},null,8,["visible","max-count","original-images","initial-selection","book-id"])]))}}),hm=oe(fm,[["__scopeId","data-v-f0a02c45"]]),bm={class:"page-details-panel"},ym={class:"panel-header"},km=["disabled"],_m={key:0,class:"empty-state"},$m=["disabled"],wm={key:1,class:"pages-list"},xm={class:"page-header"},Cm={class:"page-fields"},Sm={class:"page-field"},Pm=["value","onInput"],Im={class:"page-field"},Mm=["onUpdate:modelValue"],Rm={class:"page-field"},Tm={class:"dialogues"},Um={class:"page-field prompt-field"},Am=["onUpdate:modelValue"],Bm=["disabled","onClick"],Em={class:"page-actions"},Lm=te({__name:"PageDetailsPanel",props:{pages:{},isGenerating:{type:Boolean},regeneratingPage:{}},emits:["generate-details","regenerate-prompt","regenerate-all-prompts","save-changes","data-change"],setup(n,{emit:t}){const l=t;function a(i,u){const d=u.target.value;i.characters=d.split(",").map(m=>m.trim()).filter(m=>m),s()}function s(){l("data-change")}function o(i){return{pending:"å¾…å¤„ç†",generating:"ç”Ÿæˆä¸­",generated:"å·²ç”Ÿæˆ",failed:"å¤±è´¥"}[i]||i}return(i,u)=>(v(),g("div",bm,[e("div",ym,[u[3]||(u[3]=e("h3",null,"ðŸ“„ é¡µé¢è¯¦æƒ…ç®¡ç†",-1)),n.pages.length>0?(v(),g("button",{key:0,class:"btn secondary small",disabled:n.isGenerating,onClick:u[0]||(u[0]=r=>i.$emit("regenerate-all-prompts"))},_(n.isGenerating?"ç”Ÿæˆä¸­...":"ðŸŽ¨ é‡æ–°ç”Ÿæˆæç¤ºè¯"),9,km)):E("",!0)]),n.pages.length===0?(v(),g("div",_m,[u[4]||(u[4]=e("p",null,"å°šæœªç”Ÿæˆé¡µé¢è¯¦æƒ…",-1)),e("button",{class:"btn primary",disabled:n.isGenerating,onClick:u[1]||(u[1]=r=>i.$emit("generate-details"))},_(n.isGenerating?"ç”Ÿæˆä¸­...":"ðŸŽ¯ ç”Ÿæˆé¡µé¢è¯¦æƒ…"),9,$m)])):(v(),g("div",wm,[(v(!0),g(Q,null,W(n.pages,r=>(v(),g("div",{key:r.page_number,class:"page-card"},[e("div",xm,[e("h4",null,"é¡µé¢ "+_(r.page_number),1),e("span",{class:H(["page-status",r.status])},_(o(r.status)),3)]),e("div",Cm,[e("div",Sm,[u[5]||(u[5]=e("label",null,"è§’è‰²ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼š",-1)),e("input",{value:r.characters.join(", "),onInput:d=>a(r,d),type:"text",class:"field-input"},null,40,Pm)]),e("div",Im,[u[6]||(u[6]=e("label",null,"åœºæ™¯æè¿°ï¼š",-1)),O(e("textarea",{"onUpdate:modelValue":d=>r.description=d,rows:"2",class:"field-input",onInput:s},null,40,Mm),[[N,r.description]])]),e("div",Rm,[u[7]||(u[7]=e("label",null,"å¯¹è¯ï¼š",-1)),e("div",Tm,[(v(!0),g(Q,null,W(r.dialogues,(d,m)=>(v(),g("div",{key:m,class:"dialogue-item"},[e("strong",null,_(d.character)+":",1),se(" "+_(d.text),1)]))),128))])]),e("div",Um,[u[8]||(u[8]=e("label",null,"å›¾ç‰‡æç¤ºè¯ï¼š",-1)),O(e("textarea",{"onUpdate:modelValue":d=>r.image_prompt=d,rows:"3",class:"field-input",onInput:s},null,40,Am),[[N,r.image_prompt]]),e("button",{class:"btn secondary small",disabled:n.regeneratingPage===r.page_number,onClick:d=>i.$emit("regenerate-prompt",r.page_number)},_(n.regeneratingPage===r.page_number?"ç”Ÿæˆä¸­...":"ðŸŽ¨ é‡æ–°ç”Ÿæˆæç¤ºè¯"),9,Bm)])])]))),128)),e("div",Em,[e("button",{class:"btn secondary",onClick:u[2]||(u[2]=r=>i.$emit("save-changes"))},"ðŸ’¾ ä¿å­˜ä¿®æ”¹")])]))]))}}),Dm=oe(Lm,[["__scopeId","data-v-9479cd56"]]),zm={class:"image-generation-panel"},Om={class:"generation-controls"},Gm={class:"batch-config"},Vm={class:"config-row"},qm=["disabled"],Fm={key:0,class:"progress-bar"},Km={class:"progress-text"},Nm={class:"generated-images"},jm={class:"image-header"},Hm={class:"image-preview"},Qm=["src","alt"],Jm={key:1,class:"no-image"},Zm={class:"prompt-section"},Wm={class:"prompt-header"},Xm=["onClick"],Ym={key:0,class:"prompt-edit"},eg=["onUpdate:modelValue","onInput"],tg={key:1,class:"prompt-preview"},sg={key:0,class:"prompt-text"},ng={key:1,class:"prompt-empty"},ag={class:"image-actions"},lg=["disabled","onClick"],og=["onClick"],rg=te({__name:"ImageGenerationPanel",props:{pages:{},isGenerating:{type:Boolean},progress:{},bookId:{},totalOriginalPages:{}},emits:["batch-generate","regenerate","use-previous","prompt-change"],setup(n,{emit:t}){const l=n,a=t,s=mt(),o=y(null),i=y(s.styleRefPages?.value||3),u=y([]),r=y(!1),d=y([]),m=y([]);function k(f){o.value===f?o.value=null:o.value=f}function $(f){return s.getGeneratedImageUrl(f)}function w(f){return{pending:"å¾…ç”Ÿæˆ",generating:"ç”Ÿæˆä¸­",generated:"å·²ç”Ÿæˆ",failed:"å¤±è´¥"}[f]||f}function x(){return u.value.length>0?u.value.length:i.value}async function S(){try{const f=await vt(l.bookId,"image",l.totalOriginalPages+1);f.success&&(d.value=f.original_images||[],m.value=f.character_forms||[])}catch(f){console.error("åŠ è½½å¯ç”¨å›¾ç‰‡å¤±è´¥:",f)}r.value=!0}function U(f){u.value=f}function R(){}function D(){const f=u.value.length>0?u.value:null;a("batch-generate",f)}return ke(()=>{s.styleRefPages?.value&&(i.value=s.styleRefPages.value)}),ue(i,f=>{s.styleRefPages&&f>0&&(s.styleRefPages.value=f)}),ue(()=>s.styleRefPages?.value,f=>{f&&f!==i.value&&(i.value=f)}),(f,b)=>(v(),g("div",zm,[b[4]||(b[4]=e("h3",null,"ðŸŽ¨ å›¾ç‰‡ç”Ÿæˆ",-1)),e("div",Om,[e("div",Gm,[e("div",Vm,[b[2]||(b[2]=e("label",null,"ç”»é£Žå‚è€ƒå›¾æ•°é‡:",-1)),O(e("input",{type:"number","onUpdate:modelValue":b[0]||(b[0]=p=>i.value=p),min:"1",max:"10",class:"ref-count-input"},null,512),[[N,i.value,void 0,{number:!0}]]),e("button",{class:"btn secondary",onClick:S}," ðŸ“· é€‰æ‹©åˆå§‹å‚è€ƒå›¾ ("+_(x())+") ",1)])]),e("button",{class:"btn primary large",disabled:n.isGenerating||n.pages.length===0,onClick:D},_(n.isGenerating?"ç”Ÿæˆä¸­...":"ðŸš€ æ‰¹é‡ç”Ÿæˆå›¾ç‰‡"),9,qm),n.isGenerating?(v(),g("div",Fm,[e("div",{class:"progress-fill",style:Pt({width:n.progress+"%"})},null,4),e("span",Km,_(n.progress)+"%",1)])):E("",!0)]),e("div",Nm,[(v(!0),g(Q,null,W(n.pages,p=>(v(),g("div",{key:p.page_number,class:"image-card"},[e("div",jm,[e("h4",null,"é¡µé¢ "+_(p.page_number),1),e("span",{class:H(["image-status",p.status])},_(w(p.status)),3)]),e("div",Hm,[p.image_url?(v(),g("img",{key:0,src:$(p.image_url),alt:`é¡µé¢ ${p.page_number}`},null,8,Qm)):(v(),g("div",Jm,[e("span",null,_(p.status==="generating"?"â³":"ðŸ“·"),1),e("p",null,_(p.status==="generating"?"ç”Ÿæˆä¸­...":"æœªç”Ÿæˆ"),1)]))]),e("div",Zm,[e("div",Wm,[b[3]||(b[3]=e("label",null,"ðŸ“ ç”Ÿå›¾æç¤ºè¯",-1)),e("button",{class:"btn-mini",onClick:c=>k(p.page_number)},_(o.value===p.page_number?"æ”¶èµ·":"ç¼–è¾‘"),9,Xm)]),o.value===p.page_number?(v(),g("div",Ym,[O(e("textarea",{"onUpdate:modelValue":c=>p.image_prompt=c,rows:"4",class:"prompt-input",placeholder:"è¾“å…¥ç”Ÿå›¾æç¤ºè¯...",onInput:c=>f.$emit("prompt-change",p.page_number,p.image_prompt)},null,40,eg),[[N,p.image_prompt]])])):(v(),g("div",tg,[p.image_prompt?(v(),g("p",sg,_(p.image_prompt),1)):(v(),g("p",ng,"æš‚æ— æç¤ºè¯"))]))]),e("div",ag,[e("button",{class:"btn secondary small",disabled:p.status==="generating",onClick:c=>f.$emit("regenerate",p.page_number)}," â†º é‡æ–°ç”Ÿæˆ ",8,lg),p.previous_url?(v(),g("button",{key:0,class:"btn secondary small",onClick:c=>f.$emit("use-previous",p.page_number)}," â—€ ä¸Šä¸€ç‰ˆæœ¬ ",8,og)):E("",!0)])]))),128))]),X(Ht,{visible:r.value,"onUpdate:visible":b[1]||(b[1]=p=>r.value=p),mode:"image","max-count":i.value,"original-images":d.value,"continuation-images":[],"character-forms":m.value,"initial-selection":u.value,"book-id":n.bookId,onConfirm:U,onCancel:R},null,8,["visible","max-count","original-images","character-forms","initial-selection","book-id"])]))}}),ig=oe(rg,[["__scopeId","data-v-91c4fd6b"]]),ug={class:"export-panel"},cg={class:"export-options"},dg={class:"export-summary"},pg={class:"export-formats"},vg=["disabled"],mg=te({__name:"ExportPanel",props:{bookId:{},generatedCount:{}},emits:["clear-and-restart"],setup(n,{emit:t}){const l=n,a=t,s=mt(),o=y("images"),i=y(!1);async function u(){if(!l.bookId||s.pages.value.length===0){s.showMessage("æ²¡æœ‰å¯å¯¼å‡ºçš„é¡µé¢","error");return}i.value=!0;try{let d,m;o.value==="images"?(d=await zd(l.bookId),m=`continuation_${Date.now()}.zip`):(d=await Od(l.bookId),m=`continuation_${Date.now()}.pdf`);const k=window.URL.createObjectURL(d),$=document.createElement("a");$.href=k,$.download=m,document.body.appendChild($),$.click(),document.body.removeChild($),window.URL.revokeObjectURL(k),s.showMessage("å¯¼å‡ºæˆåŠŸ","success")}catch(d){s.showMessage("å¯¼å‡ºå¤±è´¥: "+(d instanceof Error?d.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{i.value=!1}}async function r(){confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»­å†™æ•°æ®å¹¶é‡æ–°å¼€å§‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")&&a("clear-and-restart")}return(d,m)=>(v(),g("div",ug,[m[6]||(m[6]=e("h3",null,"ðŸ“¦ å¯¼å‡ºæˆå“",-1)),e("div",cg,[e("div",dg,[e("p",null,[m[2]||(m[2]=se("å…±ç”Ÿæˆ ",-1)),e("strong",null,_(n.generatedCount),1),m[3]||(m[3]=se(" é¡µå›¾ç‰‡ï¼Œå¯å¯¼å‡ºä¸ºä»¥ä¸‹æ ¼å¼ï¼š",-1))])]),e("div",pg,[e("div",{class:H(["format-card",{selected:o.value==="images"}]),onClick:m[0]||(m[0]=k=>o.value="images")},[...m[4]||(m[4]=[e("span",{class:"format-icon"},"ðŸ–¼ï¸",-1),e("span",{class:"format-name"},"å›¾ç‰‡ ZIP",-1),e("span",{class:"format-desc"},"æ‰€æœ‰é¡µé¢æ‰“åŒ…ä¸‹è½½",-1)])],2),e("div",{class:H(["format-card",{selected:o.value==="pdf"}]),onClick:m[1]||(m[1]=k=>o.value="pdf")},[...m[5]||(m[5]=[e("span",{class:"format-icon"},"ðŸ“„",-1),e("span",{class:"format-name"},"PDF æ–‡æ¡£",-1),e("span",{class:"format-desc"},"æ–¹ä¾¿é˜…è¯»å’Œåˆ†äº«",-1)])],2)]),e("button",{class:"btn primary large",disabled:i.value,onClick:u},_(i.value?"å¯¼å‡ºä¸­...":"ðŸ“¥ ä¸‹è½½"),9,vg),e("div",{class:"export-actions"},[e("button",{class:"btn secondary",onClick:r},"ðŸ—‘ï¸ æ¸…ç©ºå¹¶é‡æ–°å¼€å§‹")])])]))}}),gg=oe(mg,[["__scopeId","data-v-bdbd3415"]]),fg={class:"continuation-panel"},hg={class:"step-indicator"},bg=["onClick"],yg={class:"step-number"},kg={class:"step-name"},_g={class:"step-content"},$g={class:"step-panel"},wg={class:"form-group"},xg={class:"form-group"},Cg={class:"form-group"},Sg={class:"actions"},Pg=["disabled"],Ig={class:"step-panel"},Mg={class:"actions"},Rg=["disabled"],Tg={class:"step-panel"},Ug={class:"actions"},Ag=["disabled"],Bg={class:"step-panel"},Eg={class:"actions"},Lg=["disabled"],Dg={class:"step-panel"},zg={class:"actions"},Og=te({__name:"ContinuationPanel",setup(n){const t=ce(),l=G(()=>t.currentBookId||""),a=Vd(l);Fe(Nt,a);const s=qd(l,a);Fe(jt,s);const o=Nd(l,a);Fe(Kd,o);const i=Hd(l,a);Fe(jd,i);const u=a,r=o,d=i,m=["è§’è‰²è®¾ç½®","ç”Ÿæˆè„šæœ¬","é¡µé¢è¯¦æƒ…","å›¾ç‰‡ç”Ÿæˆ","å¯¼å‡º"],k=y(null),$=G(()=>u.characters.value.length>0),w=G(()=>u.chapterScript.value!==null),x=G(()=>u.pages.value.length>0&&u.pages.value.every(I=>I.image_prompt)),S=G(()=>u.pages.value.some(I=>I.image_url&&I.status==="generated")),U=G(()=>u.pages.value.filter(I=>I.image_url&&I.status==="generated").length),R=G(()=>u.totalOriginalPages?.value||0);function D(I){return I===0?!0:I===1?$.value:I===2?w.value:I===3?x.value:I===4?S.value:!1}function f(I){D(I)&&(u.currentStep.value=I)}function b(I){u.currentStep.value=I}async function p(I){if(t.currentBookId){r.isGenerating.value=!0,u.errorMessage.value="";try{const L=await Gd(t.currentBookId,u.continuationDirection.value,u.pageCount.value,I||void 0);if(L.success&&L.script){u.chapterScript.value=L.script;try{await Kt(t.currentBookId,{page_count:u.pageCount.value,style_reference_pages:u.styleRefPages.value,continuation_direction:u.continuationDirection.value})}catch(F){console.error("ä¿å­˜é…ç½®å¤±è´¥:",F)}u.showMessage("è„šæœ¬ç”ŸæˆæˆåŠŸ","success")}else u.showMessage("ç”Ÿæˆå¤±è´¥: "+L.error,"error")}catch(L){u.showMessage("ç”Ÿæˆå¤±è´¥: "+(L instanceof Error?L.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{r.isGenerating.value=!1}}}async function c(){if(!t.currentBookId||!u.chapterScript.value)return;u.isGeneratingPages.value=!0,u.isGeneratingPrompts.value=!0,u.errorMessage.value="";const I=u.chapterScript.value.page_count||u.pageCount.value;u.pages.value=[];try{for(let L=1;L<=I;L++){u.showMessage(`æ­£åœ¨ç”Ÿæˆç¬¬ ${L}/${I} é¡µè¯¦æƒ…...`,"info");const F=await Bd(t.currentBookId,u.chapterScript.value,L);if(!F.success||!F.page){u.pages.value.push({page_number:L,characters:[],description:`ç”Ÿæˆå¤±è´¥: ${F.error||"æœªçŸ¥é”™è¯¯"}`,dialogues:[],image_prompt:"",image_url:"",previous_url:"",status:"failed"});continue}u.showMessage(`æ­£åœ¨ç”Ÿæˆç¬¬ ${L}/${I} é¡µæç¤ºè¯...`,"info");const re=await Ct(t.currentBookId,F.page,L);if(re.success&&re.page)u.pages.value.push(re.page);else{const ve={...F.page};ve.image_prompt=`æç¤ºè¯ç”Ÿæˆå¤±è´¥: ${re.error||"æœªçŸ¥é”™è¯¯"}`,u.pages.value.push(ve)}}await Ie(t.currentBookId,u.pages.value),u.showMessage(`é¡µé¢è¯¦æƒ…å’Œæç¤ºè¯ç”Ÿæˆå®Œæˆ (${u.pages.value.length} é¡µ)`,"success")}catch(L){u.showMessage("ç”Ÿæˆå¤±è´¥: "+(L instanceof Error?L.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{u.isGeneratingPages.value=!1,u.isGeneratingPrompts.value=!1}}async function h(I){if(!t.currentBookId)return;const L=u.pages.value.find(F=>F.page_number===I);if(L){k.value=I;try{const F=await Ct(t.currentBookId,L,I);F.success&&F.page?(L.image_prompt=F.page.image_prompt,await Ie(t.currentBookId,u.pages.value),u.showMessage(`ç¬¬ ${I} é¡µæç¤ºè¯å·²æ›´æ–°`,"success")):u.showMessage("ç”Ÿæˆå¤±è´¥: "+F.error,"error")}catch(F){u.showMessage("ç”Ÿæˆå¤±è´¥: "+(F instanceof Error?F.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{k.value=null}}}async function P(){if(!(!t.currentBookId||u.pages.value.length===0)&&confirm("ç¡®å®šè¦é‡æ–°ç”Ÿæˆæ‰€æœ‰é¡µé¢çš„æç¤ºè¯å—ï¼Ÿè¿™å°†è¦†ç›–çŽ°æœ‰çš„æç¤ºè¯ã€‚")){u.isGeneratingPages.value=!0,u.errorMessage.value="";try{const I=await Ed(t.currentBookId,u.pages.value);I.success&&I.pages?(u.pages.value=I.pages,await Ie(t.currentBookId,u.pages.value),u.showMessage("æ‰€æœ‰æç¤ºè¯å·²é‡æ–°ç”Ÿæˆ","success")):u.showMessage("ç”Ÿæˆå¤±è´¥: "+I.error,"error")}catch(I){u.showMessage("ç”Ÿæˆå¤±è´¥: "+(I instanceof Error?I.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{u.isGeneratingPages.value=!1}}}async function T(){if(!(!t.currentBookId||u.pages.value.length===0))try{await Ie(t.currentBookId,u.pages.value),u.showMessage("é¡µé¢æ•°æ®ä¿å­˜æˆåŠŸ","success")}catch(I){u.showMessage("ä¿å­˜å¤±è´¥: "+(I instanceof Error?I.message:"ç½‘ç»œé”™è¯¯"),"error")}}function M(){console.log("é¡µé¢æ•°æ®å·²ä¿®æ”¹")}async function z(I){t.currentBookId&&await d.batchGenerateImages(u.pages.value,I||void 0)}async function Y(I){t.currentBookId&&await d.regeneratePageImage(I)}async function j(I){const L=u.pages.value.find(re=>re.page_number===I);if(!L||!L.previous_url)return;const F=L.image_url;L.image_url=L.previous_url,L.previous_url=F,t.currentBookId&&await Ie(t.currentBookId,u.pages.value)}async function A(I,L){console.log(`é¡µé¢ ${I} æç¤ºè¯å·²ä¿®æ”¹`)}async function C(){if(t.currentBookId)try{await Ad(t.currentBookId),await u.resetState(),u.currentStep.value=0,u.showMessage("æ•°æ®å·²æ¸…ç©º","success")}catch(I){u.showMessage("æ¸…ç©ºå¤±è´¥: "+(I instanceof Error?I.message:"ç½‘ç»œé”™è¯¯"),"error")}}return ke(()=>{t.currentBookId&&u.initializeData()}),ue(()=>t.currentBookId,I=>{I&&u.initializeData()}),(I,L)=>(v(),g("div",fg,[K(u).errorMessage.value||K(u).successMessage.value?(v(),g("div",{key:0,class:H(["message",K(u).errorMessage.value?"error":"success"])},_(K(u).errorMessage.value||K(u).successMessage.value),3)):E("",!0),e("div",hg,[(v(),g(Q,null,W(m,(F,re)=>e("div",{key:re,class:H(["step",{active:K(u).currentStep.value===re,completed:K(u).currentStep.value>re,clickable:D(re)}]),onClick:ve=>f(re)},[e("span",yg,_(re+1),1),e("span",kg,_(F),1)],10,bg)),64))]),e("div",_g,[O(e("div",$g,[L[17]||(L[17]=e("h3",null,"ðŸ“ ç»­å†™è®¾ç½®",-1)),e("div",wg,[L[11]||(L[11]=e("label",null,"ç»­å†™é¡µæ•°",-1)),O(e("input",{"onUpdate:modelValue":L[0]||(L[0]=F=>K(u).pageCount.value=F),type:"number",min:"5",max:"50"},null,512),[[N,K(u).pageCount.value,void 0,{number:!0}]]),L[12]||(L[12]=e("p",{class:"hint"},"å»ºè®® 10-20 é¡µ",-1))]),e("div",xg,[L[13]||(L[13]=e("label",null,"ç”»é£Žå‚è€ƒé¡µæ•°",-1)),O(e("input",{"onUpdate:modelValue":L[1]||(L[1]=F=>K(u).styleRefPages.value=F),type:"number",min:"1",max:"10"},null,512),[[N,K(u).styleRefPages.value,void 0,{number:!0}]]),L[14]||(L[14]=e("p",{class:"hint"},"ç”¨äºŽç»´æŒç”»é£Žä¸€è‡´æ€§",-1))]),e("div",Cg,[L[15]||(L[15]=e("label",null,"ç»­å†™æ–¹å‘ï¼ˆå¯é€‰ï¼‰",-1)),O(e("textarea",{"onUpdate:modelValue":L[2]||(L[2]=F=>K(u).continuationDirection.value=F),rows:"4",placeholder:"ä¾‹å¦‚ï¼šå»¶ç»­ä¸»çº¿å‰§æƒ…ï¼ŒæŽ¢ç´¢æ–°çš„å†’é™©..."},null,512),[[N,K(u).continuationDirection.value]]),L[16]||(L[16]=e("p",{class:"hint"},"ç•™ç©ºå°†è‡ªåŠ¨æ ¹æ®å‰§æƒ…å‘å±•ç”Ÿæˆ",-1))]),K(t).currentBookId?(v(),fe(jv,{key:0,"book-id":K(t).currentBookId,"is-loading":K(u).isLoading.value},null,8,["book-id","is-loading"])):E("",!0),e("div",Sg,[e("button",{class:"btn secondary danger",onClick:C},"ðŸ—‘ï¸ æ¸…é™¤æ•°æ®é‡æ–°å¼€å§‹"),e("button",{class:"btn primary",disabled:!$.value,onClick:L[3]||(L[3]=F=>b(1))}," ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆè„šæœ¬ â†’ ",8,Pg)])],512),[[de,K(u).currentStep.value===0]]),O(e("div",Ig,[X(hm,{script:K(u).chapterScript.value,"is-generating":K(r).isGenerating.value,"book-id":K(t).currentBookId||"",onGenerate:p},null,8,["script","is-generating","book-id"]),e("div",Mg,[e("button",{class:"btn secondary",onClick:L[4]||(L[4]=F=>b(0))},"â† ä¸Šä¸€æ­¥"),e("button",{class:"btn primary",disabled:!w.value,onClick:L[5]||(L[5]=F=>b(2))}," ä¸‹ä¸€æ­¥ï¼šé¡µé¢è¯¦æƒ… â†’ ",8,Rg)])],512),[[de,K(u).currentStep.value===1]]),O(e("div",Tg,[X(Dm,{pages:K(u).pages.value,"is-generating":K(u).isGeneratingPages.value,"regenerating-page":k.value,onGenerateDetails:c,onRegeneratePrompt:h,onRegenerateAllPrompts:P,onSaveChanges:T,onDataChange:M},null,8,["pages","is-generating","regenerating-page"]),e("div",Ug,[e("button",{class:"btn secondary",onClick:L[6]||(L[6]=F=>b(1))},"â† ä¸Šä¸€æ­¥"),e("button",{class:"btn primary",disabled:!x.value,onClick:L[7]||(L[7]=F=>b(3))}," ä¸‹ä¸€æ­¥ï¼šå›¾ç‰‡ç”Ÿæˆ â†’ ",8,Ag)])],512),[[de,K(u).currentStep.value===2]]),O(e("div",Bg,[X(ig,{pages:K(u).pages.value,"is-generating":K(d).isGenerating.value,progress:K(d).generationProgress.value,"book-id":K(t).currentBookId||"","total-original-pages":R.value,onBatchGenerate:z,onRegenerate:Y,onUsePrevious:j,onPromptChange:A},null,8,["pages","is-generating","progress","book-id","total-original-pages"]),e("div",Eg,[e("button",{class:"btn secondary",onClick:L[8]||(L[8]=F=>b(2))},"â† ä¸Šä¸€æ­¥"),e("button",{class:"btn primary",disabled:!S.value,onClick:L[9]||(L[9]=F=>b(4))}," ä¸‹ä¸€æ­¥ï¼šå¯¼å‡º â†’ ",8,Lg)])],512),[[de,K(u).currentStep.value===3]]),O(e("div",Dg,[K(t).currentBookId?(v(),fe(gg,{key:0,"book-id":K(t).currentBookId,"generated-count":U.value,onClearAndRestart:C},null,8,["book-id","generated-count"])):E("",!0),e("div",zg,[e("button",{class:"btn secondary",onClick:L[10]||(L[10]=F=>b(3))},"â† è¿”å›žç”Ÿæˆ")])],512),[[de,K(u).currentStep.value===4]])])]))}}),Gg=oe(Og,[["__scopeId","data-v-f72c8acd"]]),Vg={class:"insight-page"},qg={class:"app-header"},Fg={class:"header-content"},Kg={class:"logo-container"},Ng={class:"header-links"},jg={class:"insight-main"},Hg={class:"sidebar-section book-info-section"},Qg={class:"book-cover-wrapper"},Jg=["src"],Zg={key:1,class:"book-cover-placeholder"},Wg=["title"],Xg={class:"book-meta"},Yg={class:"meta-item"},ef={id:"totalPages"},tf={class:"meta-item"},sf={id:"analyzedPages"},nf={class:"insight-content"},af={key:0,class:"select-book-prompt"},lf={key:1,class:"content-tabs"},of={class:"tabs-wrapper"},rf={class:"tab-content"},uf={class:"tab-content"},cf={class:"tab-content"},df={class:"tab-content"},pf=te({__name:"InsightView",setup(n){const t=Ps(),l=Rs(),a=ce(),s=Mt(),o=y("overview"),i=y(!1),u=y(!1),r=y(!1);let d=null;const m=y(null),k=y(!1),$=G(()=>m.value?m.value:a.currentBookId?s.books.find(C=>C.id===a.currentBookId):null),w=G(()=>!!a.currentBookId),x=G(()=>$.value?.cover?$.value.cover:"");function S(C){o.value=C}async function U(C){if(C){a.setCurrentBook(C),a.setLoading(!0);try{const L=await(await fetch(`/api/bookshelf/books/${C}`)).json();if(!L.success)throw new Error(L.error||"èŽ·å–ä¹¦ç±ä¿¡æ¯å¤±è´¥");if(L.book&&(m.value={id:L.book.id,title:L.book.title,cover:L.book.cover,total_pages:L.book.total_pages||0},a.setBookTotalPages(L.book.total_pages||0),L.book.chapters&&L.book.chapters.length>0)){let F=0;const re=L.book.chapters.map((ve,J)=>{const Z=ve.id||ve.chapter_id||`ch_${J+1}`,le=ve.page_count||ve.pages?.length||0,Pe=F+1,xe=F+le;return F=xe,{id:Z,title:ve.title||`ç¬¬ ${J+1} ç« `,startPage:Pe,endPage:xe}});a.setChapters(re)}if(await R(),a.chapters.length===0)try{const F=await Vs(C);F.success&&F.chapters&&F.chapters.length>0&&a.setChapters(F.chapters.map(re=>({id:re.id,title:re.title,startPage:re.start_page,endPage:re.end_page,analyzed:!0})))}catch(F){console.warn("èŽ·å–ç« èŠ‚åˆ—è¡¨å¤±è´¥:",F)}await a.loadNotesFromAPI(),l.replace({query:{book:C}}),a.isAnalyzing&&D()}catch(I){console.error("åŠ è½½ä¹¦ç±å¤±è´¥:",I),a.setError(I instanceof Error?I.message:"åŠ è½½ä¹¦ç±å¤±è´¥")}finally{a.setLoading(!1)}}}async function R(){if(a.currentBookId)try{const C=await Rt(a.currentBookId);if(C.success)if(C.analyzed_pages_count!==void 0&&a.setAnalyzedPagesCount(C.analyzed_pages_count),C.current_task){const I=C.current_task.status;I==="running"?(a.setAnalysisStatus("running"),C.current_task.progress&&a.updateProgress(C.current_task.progress.analyzed_pages||0,C.current_task.progress.total_pages||0)):I==="paused"?a.setAnalysisStatus("paused"):I==="completed"?a.setAnalysisStatus("completed"):I==="failed"?a.setAnalysisStatus("failed"):a.setAnalysisStatus("idle")}else C.analyzed?a.setAnalysisStatus("completed"):a.setAnalysisStatus("idle")}catch(C){console.error("èŽ·å–åˆ†æžçŠ¶æ€å¤±è´¥:",C)}}function D(){f(),d=setInterval(async()=>{await R();const C=a.analysisStatus;(C==="completed"||C==="failed"||C==="idle")&&(f(),C==="completed"&&(console.log("åˆ†æžå®Œæˆï¼Œç­‰å¾…1ç§’åŽåˆ·æ–°æ•°æ®..."),setTimeout(async()=>{console.log("å¼€å§‹åˆ·æ–°æ¦‚è§ˆå’Œæ—¶é—´çº¿æ•°æ®"),await R(),a.triggerDataRefresh()},1e3)))},3e3)}function f(){d&&(clearInterval(d),d=null)}function b(){i.value=!0}function p(){Us("ðŸŒ™ è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼","info")}function c(){i.value=!1}function h(){u.value=!u.value,u.value&&(r.value=!1)}function P(){r.value=!r.value,r.value&&(u.value=!1)}function T(){if(!a.currentBookId){l.push("/translate");return}const C=a.chapters;!C||C.length===0?l.push({path:"/translate",query:{book:a.currentBookId}}):C.length===1?l.push({path:"/translate",query:{book:a.currentBookId,chapter:C[0].id}}):k.value=!0}function M(C){k.value=!1,l.push({path:"/translate",query:{book:a.currentBookId,chapter:C}})}function z(){k.value=!1}let Y="",j="",A="";return ke(async()=>{const C=document.body.style;Y=C.padding,j=C.margin,A=C.overflow,C.padding="0",C.margin="0",C.overflow="hidden",await s.fetchBooks();const I=t.query.book;I&&await U(I)}),Is(()=>{f();const C=document.body.style;C.padding=Y,C.margin=j,C.overflow=A}),ue(()=>a.isAnalyzing,C=>{C?D():f()}),(C,I)=>{const L=Ms("router-link");return v(),g("div",Vg,[e("header",qg,[e("div",Fg,[e("div",Kg,[X(L,{to:"/",title:"ä¹¦æž¶é¦–é¡µ"},{default:je(()=>[...I[4]||(I[4]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",Ng,[X(L,{to:"/",class:"nav-link"},{default:je(()=>[...I[5]||(I[5]=[se("ðŸ“š ä¹¦æž¶",-1)])]),_:1}),e("a",{href:"javascript:void(0)",class:"nav-link",onClick:T},"ðŸŒ ç¿»è¯‘"),I[7]||(I[7]=e("span",{class:"nav-link active"},"ðŸ” åˆ†æž",-1)),I[8]||(I[8]=e("a",{href:"https://www.mashirosaber.top/use/manga-insight.html",target:"_blank",class:"nav-link",title:"ä½¿ç”¨æ•™ç¨‹"},"ðŸ“– æ•™ç¨‹",-1)),e("button",{id:"settingsBtn",class:"btn btn-icon",title:"è®¾ç½®",onClick:b},"âš™ï¸"),e("button",{id:"themeToggle",class:"theme-toggle",title:"åŠŸèƒ½å¼€å‘ä¸­",onClick:p},[...I[6]||(I[6]=[e("span",{class:"theme-icon"},"â˜€ï¸",-1)])])])])]),e("main",jg,[e("aside",{class:H(["insight-sidebar",{"mobile-visible":u.value}])},[e("div",Hg,[e("div",Qg,[x.value?(v(),g("img",{key:0,src:x.value,alt:"å°é¢",class:"book-cover"},null,8,Jg)):(v(),g("div",Zg,[...I[9]||(I[9]=[e("span",null,"ðŸ“–",-1)])]))]),e("h2",{class:"book-title",title:$.value?.title},_($.value?.title||"é€‰æ‹©ä¹¦ç±"),9,Wg),e("div",Xg,[e("span",Yg,[I[10]||(I[10]=e("span",{class:"meta-icon"},"ðŸ“„",-1)),e("span",ef,_($.value?.total_pages||0),1),I[11]||(I[11]=se(" é¡µ ",-1))]),e("span",tf,[I[12]||(I[12]=e("span",{class:"meta-icon"},"ðŸ“Š",-1)),e("span",sf,_(K(a).analyzedPageCount),1),I[13]||(I[13]=se(" å·²åˆ†æž ",-1))])])]),w.value?(v(),fe(qn,{key:0,onStartPolling:D,onStopPolling:f})):E("",!0),w.value?(v(),fe(Gi,{key:1})):E("",!0)],2),e("div",nf,[w.value?(v(),g("div",lf,[e("button",{class:"mobile-nav-btn",onClick:h,"aria-label":"æ‰“å¼€å¯¼èˆª"}," ðŸ“š "),e("div",of,[e("button",{class:H(["tab-btn",{active:o.value==="overview"}]),onClick:I[0]||(I[0]=F=>S("overview"))},[...I[17]||(I[17]=[e("span",{class:"tab-icon"},"ðŸ“Š",-1),se(" æ¦‚è§ˆ ",-1)])],2),e("button",{class:H(["tab-btn",{active:o.value==="qa"}]),onClick:I[1]||(I[1]=F=>S("qa"))},[...I[18]||(I[18]=[e("span",{class:"tab-icon"},"ðŸ’¬",-1),se(" æ™ºèƒ½é—®ç­” ",-1)])],2),e("button",{class:H(["tab-btn",{active:o.value==="timeline"}]),onClick:I[2]||(I[2]=F=>S("timeline"))},[...I[19]||(I[19]=[e("span",{class:"tab-icon"},"ðŸ“ˆ",-1),se(" æ—¶é—´çº¿ ",-1)])],2),e("button",{class:H(["tab-btn",{active:o.value==="continuation"}]),onClick:I[3]||(I[3]=F=>S("continuation"))},[...I[20]||(I[20]=[e("span",{class:"tab-icon"},"ðŸŽ¨",-1),se(" ç»­å†™ ",-1)])],2)]),e("button",{class:"mobile-nav-btn",onClick:P,"aria-label":"æ‰“å¼€ç¬”è®°"}," ðŸ“ ")])):(v(),g("div",af,[I[14]||(I[14]=e("div",{class:"prompt-icon"},"ðŸ“š",-1)),I[15]||(I[15]=e("h2",null,"é€‰æ‹©è¦åˆ†æžçš„ä¹¦ç±",-1)),I[16]||(I[16]=e("p",null,"ä»Žä¸‹æ–¹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€æœ¬ä¹¦ç±å¼€å§‹æ™ºèƒ½åˆ†æž",-1)),X(hn,{onSelect:U})])),O(e("div",rf,[X(el)],512),[[de,o.value==="overview"&&w.value]]),O(e("div",uf,[X(Ho)],512),[[de,o.value==="qa"&&w.value]]),O(e("div",cf,[X(ao)],512),[[de,o.value==="timeline"&&w.value]]),O(e("div",df,[X(Gg)],512),[[de,o.value==="continuation"&&w.value]])]),w.value?(v(),g("aside",{key:0,class:H(["insight-workspace",{"mobile-visible":r.value}])},[X(yi),X(zr)],2)):E("",!0)]),i.value?(v(),fe(od,{key:0,onClose:c})):E("",!0),k.value&&K(a).currentBookId?(v(),fe(yd,{key:1,chapters:K(a).chapters,onSelect:M,onClose:z},null,8,["chapters"])):E("",!0)])}}}),$f=oe(pf,[["__scopeId","data-v-910e43ec"]]);export{$f as default};
