const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/session.C_VZSWrV.js","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js"])))=>i.map(i=>d[i]);
import{D as In,b as Co,c as _o,d as ko,e as Pn,f as ft,a as it,S as en,_ as Je,g as Fe,s as ye,u as ct,P as tn,h as on,i as ks,j as Ss,k as ws,l as $s,m as Ts,n as Is,o as nn,p as sn,B as an,q as ln,r as Ps,F as vo,t as rn,v as un,w as Rs,L as cn,W as Ds}from"./index.hqaqi8h8.js";import{d as eo,r as w,c as J,a as Ge,e as L,h as ce,f as e,t as ee,i as ot,k as E,g as ut,n as Re,u as ge,o as dt,v as oe,x as Oe,l as _e,s as dn,m as xt,K as Xe,D as H,F as ze,j as Ye,P as So,Q as Ms,O as Rn,w as Se,B as pt,S as St,z as Pe,p as nt,U as ho,b as Wt,V as yt,W as gn,X as Bs,A as Dn,Y as As,T as Mn,C as Es}from"./vue-vendor.BAHshaBR.js";import{p as Ls,a as Fs,b as Us,c as Os,d as zs,e as Ns,f as Vs,h as Ws,i as Ks,j as qs,k as wo,l as Hs,m as Bn}from"./system.DR5RJocQ.js";import{getFontList as An,uploadFont as js,getTextboxPrompts as Js,getPrompts as Gs,configApi as He,getFontListApi as Ys}from"./config.CwRcCkM9.js";import{_ as We}from"./CustomSelect.vue_vue_type_style_index_0_lang.CQaT8Lug.js";import{apiClient as et}from"./client.Bht704G-.js";import{B as En}from"./BaseModal.B5VqfWE9.js";import{getBookDetail as Xs}from"./bookshelf.B4ums9uK.js";import"./utils-vendor.B9ygI19o.js";function pn(){return{firecrawl:{apiKey:""},agent:{provider:"openai",apiKey:"",customBaseUrl:"",modelName:"gpt-4o-mini",useStream:!1,forceJsonOutput:!0,maxRetries:3,timeout:120},extraction:{prompt:In,maxIterations:10},download:{concurrency:3,timeout:30,retries:3,delay:100,useReferer:!0},imagePreprocess:{enabled:!1,autoRotate:!0,compression:{enabled:!1,quality:85,maxWidth:0,maxHeight:0},formatConvert:{enabled:!1,targetFormat:"original"}},advanced:{customCookie:"",customHeaders:"",bypassProxy:!1},ui:{showAgentLogs:!0,autoImport:!1}}}function Zs(n,t){function s(v){n.value.firecrawl.apiKey=v,t()}function o(v){n.value.agent.provider=v,t()}function a(v){n.value.agent.apiKey=v,t()}function l(v){n.value.agent.customBaseUrl=v,t()}function r(v){n.value.agent.modelName=v,t()}function x(v){n.value.agent.useStream=v,t()}function g(v){n.value.agent.forceJsonOutput=v,t()}function i(v){n.value.agent.timeout=v,t()}function c(v){n.value.extraction.prompt=v,t()}function C(v){n.value.extraction.maxIterations=v,t()}function $(){n.value.extraction.prompt=In,t()}function R(v){n.value.download.concurrency=v,t()}function k(v){n.value.download.timeout=v,t()}function D(v){n.value.download.retries=v,t()}function N(v){n.value.download.delay=v,t()}function B(v){n.value.download.useReferer=v,t()}function A(v){n.value.imagePreprocess.enabled=v,t()}function h(v){n.value.imagePreprocess.autoRotate=v,t()}function p(v){n.value.imagePreprocess.compression.enabled=v,t()}function T(v){n.value.imagePreprocess.compression.quality=v,t()}function S(v){n.value.imagePreprocess.compression.maxWidth=v,t()}function F(v){n.value.imagePreprocess.compression.maxHeight=v,t()}function O(v){n.value.imagePreprocess.formatConvert.enabled=v,t()}function te(v){n.value.imagePreprocess.formatConvert.targetFormat=v,t()}function j(v){n.value.advanced.customCookie=v,t()}function se(v){n.value.advanced.customHeaders=v,t()}function U(v){n.value.advanced.bypassProxy=v,t()}function Z(v){n.value.ui.showAgentLogs=v,t()}function ae(v){n.value.ui.autoImport=v,t()}function Y(v){n.value={...n.value,...v},t()}return{setFirecrawlApiKey:s,setAgentProvider:o,setAgentApiKey:a,setAgentBaseUrl:l,setAgentModelName:r,setAgentUseStream:x,setAgentForceJson:g,setAgentTimeout:i,setExtractionPrompt:c,setExtractionMaxIterations:C,resetExtractionPrompt:$,setDownloadConcurrency:R,setDownloadTimeout:k,setDownloadRetries:D,setDownloadDelay:N,setDownloadUseReferer:B,setImagePreprocessEnabled:A,setImageAutoRotate:h,setImageCompressionEnabled:p,setImageCompressionQuality:T,setImageMaxWidth:S,setImageMaxHeight:F,setImageFormatConvertEnabled:O,setImageTargetFormat:te,setCustomCookie:j,setCustomHeaders:se,setBypassProxy:U,setShowAgentLogs:Z,setAutoImport:ae,updateWebImportSettings:Y}}const xo=Object.freeze(Object.defineProperty({__proto__:null,useSettingsStore:Fe},Symbol.toStringTag,{value:"Module"}));async function $o(n){return et.post("/api/re_render_image",n)}async function Ft(n){try{return{success:!0,data:await et.post("/api/translate_single_text",n)}}catch(t){return{success:!1,error:t instanceof Error?t.message:"ç¿»è¯‘å¤±è´¥"}}}async function Ut(n){return et.post("/api/hq_translate_batch",n)}async function Ln(n,t,s,o){return et.post("/api/ocr_single_bubble",{image_data:n,bubble_coords:t,ocr_engine:s,...o})}async function To(n,t,s){return et.post("/api/inpaint_single_bubble",{image_data:n,bubble_coords:t,bubble_angle:s?.bubbleAngle??0,method:s?.method??"lama",lama_model:s?.lamaModel??"lama_mpe",...s?.maskData&&{mask_data:s.maskData}})}const Qs=Object.freeze(Object.defineProperty({__proto__:null,hqTranslateBatch:Ut,inpaintSingleBubble:To,ocrSingleBubble:Ln,reRenderImage:$o,translateSingleText:Ft},Symbol.toStringTag,{value:"Module"}));async function Fn(n,t){return et.post(`/api/sessions/meta/${n}`,t)}async function Xt(n,t,s,o){return et.post(`/api/sessions/page/${n}/${t}/${s}`,{data:o})}async function Un(n,t,s){return et.post(`/api/sessions/page/${n}/${t}/meta`,s)}async function On(n,t,s){return et.post(`/api/sessions/save_translated/${n}/${t}`,s)}function Zt(n){if(!n||typeof n!="string"||n.startsWith("/api/"))return null;if(n.startsWith("data:")){const t=n.split(",");return t.length>1?t[1]??null:null}return n}async function ea(n,t,s){const o=t.length;let a=0;for(let l=0;l<o;l++){const r=t[l];if(r){s?.onProgress?.(l+1,o);try{const x=Zt(r.originalDataURL);x&&await Xt(n,l,"original",x);const g=Zt(r.translatedDataURL);g&&await Xt(n,l,"translated",g);const i=Zt(r.cleanImageData);i&&await Xt(n,l,"clean",i);const c={fileName:r.fileName,translationStatus:r.translationStatus,translationFailed:r.translationFailed,bubbleStates:r.bubbleStates,isManuallyAnnotated:r.isManuallyAnnotated,relativePath:r.relativePath,folderPath:r.folderPath,fontSize:r.fontSize,autoFontSize:r.autoFontSize,fontFamily:r.fontFamily,layoutDirection:r.layoutDirection,useAutoTextColor:r.useAutoTextColor,textColor:r.textColor,fillColor:r.fillColor,inpaintMethod:r.inpaintMethod,strokeEnabled:r.strokeEnabled,strokeColor:r.strokeColor,strokeWidth:r.strokeWidth,textMask:r.textMask,userMask:r.userMask};await Un(n,l,c),a++}catch(x){console.error(`ä¿å­˜ç¬¬ ${l+1} é¡µå¤±è´¥:`,x)}}}return a}const zn=Object.freeze(Object.defineProperty({__proto__:null,extractBase64:Zt,saveAllPagesSequentially:ea,savePageImage:Xt,savePageMeta:Un,saveSessionMeta:Fn,saveTranslatedPage:On},Symbol.toStringTag,{value:"Module"}));async function ta(){return et.get("/api/plugins")}async function oa(n){const t=encodeURIComponent(n);return et.post(`/api/plugins/${t}/enable`)}async function na(n){const t=encodeURIComponent(n);return et.post(`/api/plugins/${t}/disable`)}async function sa(n){const t=encodeURIComponent(n);return et.delete(`/api/plugins/${t}`)}async function aa(n){const t=encodeURIComponent(n);return et.get(`/api/plugins/${t}/config_schema`)}async function la(n){const t=encodeURIComponent(n);return et.get(`/api/plugins/${t}/config`)}async function ia(n,t){const s=encodeURIComponent(n);return et.post(`/api/plugins/${s}/config`,t)}async function ra(){return et.get("/api/plugins/default_states")}async function ua(n,t){const s=encodeURIComponent(n);return et.post(`/api/plugins/${s}/set_default_state`,{enabled:t})}async function ca(){return{states:(await ra()).default_states}}const da=ua,ga=aa,pa=la,ma=ia;function va(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function mn(n,t,s){return{id:va(),fileName:n,width:0,height:0,originalDataURL:t,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!1,fontFamily:ft,layoutDirection:"auto",textColor:"#000000",fillColor:Pn,inpaintMethod:"solid",strokeEnabled:ko,strokeColor:_o,strokeWidth:Co,hasUnsavedChanges:!1,...s}}const Ze=eo("image",()=>{const n=w([]),t=w(-1),s=w(!1),o=J(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),a=J(()=>n.value.length),l=J(()=>n.value.length>0),r=J(()=>t.value>0),x=J(()=>t.value<n.value.length-1),g=J(()=>n.value.filter(m=>m.translationFailed).length),i=J(()=>n.value.filter(m=>m.translationStatus==="completed").length),c=J(()=>n.value.filter(m=>m.translationStatus==="pending").length);function C(m,b,f){const u=mn(m,b,f);return n.value.push(u),n.value.length===1&&(t.value=0),console.log(`å›¾ç‰‡å·²æ·»åŠ : ${m}ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),u}function $(m){const b=m.map(({fileName:u,originalDataURL:y,overrides:I})=>mn(u,y,I)),f=n.value.length===0;return n.value.push(...b),f&&n.value.length>0&&(t.value=0),console.log(`æ‰¹é‡æ·»åŠ äº† ${b.length} å¼ å›¾ç‰‡ï¼Œå½“å‰å…± ${n.value.length} å¼ `),b}function R(m){n.value=m.map(b=>({...b,width:b.width||0,height:b.height||0,strokeEnabled:b.strokeEnabled??ko,strokeColor:b.strokeColor||_o,strokeWidth:b.strokeWidth??Co,hasUnsavedChanges:b.hasUnsavedChanges||!1})),n.value.length>0?t.value=Math.min(Math.max(0,t.value),n.value.length-1):t.value=-1,console.log(`å›¾ç‰‡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${n.value.length} å¼ å›¾ç‰‡`)}function k(m){return m<0||m>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${m}`),!1):(n.value.splice(m,1),t.value===m?(t.value=Math.min(m,n.value.length-1),n.value.length===0&&(t.value=-1)):t.value>m&&t.value--,console.log(`å›¾ç‰‡å·²åˆ é™¤ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),!0)}function D(){return k(t.value)}function N(){n.value=[],t.value=-1,s.value=!1,console.log("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤")}function B(){const m=o.value?.id||null;if(n.value.sort((b,f)=>{const u=b.relativePath||b.fileName,y=f.relativePath||f.fileName;return u.localeCompare(y,void 0,{numeric:!0,sensitivity:"base"})}),m){const b=n.value.findIndex(f=>f.id===m);b>=0&&b!==t.value&&(console.log(`å›¾ç‰‡æ’åº: currentImageIndex ä» ${t.value} æ›´æ–°ä¸º ${b}`),t.value=b)}console.log("å›¾ç‰‡å·²æŒ‰æ–‡ä»¶åæ’åº")}function A(m){m>=-1&&m<n.value.length?(t.value=m,console.log(`å½“å‰å›¾ç‰‡ç´¢å¼•å·²è®¾ç½®ä¸º ${m}`)):console.warn(`è®¾ç½®ç´¢å¼•å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${m}`)}function h(){return r.value?(t.value--,!0):!1}function p(){return x.value?(t.value++,!0):!1}function T(m){o.value?(Object.assign(o.value,m),console.log("å½“å‰å›¾ç‰‡å±æ€§å·²æ›´æ–°:",Object.keys(m))):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function S(m,b){if(m>=0&&m<n.value.length){const f=n.value[m];f&&(Object.assign(f,b),console.log(`å›¾ç‰‡ ${m} å±æ€§å·²æ›´æ–°:`,Object.keys(b)))}else console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${m}`)}function F(m){o.value&&(o.value.bubbleStates=m,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡æ°”æ³¡çŠ¶æ€å·²æ›´æ–°ï¼Œå…± ${m?.length??0} ä¸ªæ°”æ³¡`))}function O(m){o.value&&(o.value.isManuallyAnnotated=m,o.value.hasUnsavedChanges=!0,console.log(`æ‰‹åŠ¨æ ‡æ³¨æ ‡è®°å·²è®¾ç½®ä¸º: ${m}`))}function te(m,b){o.value?(o.value[m]=b,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡å±æ€§ ${String(m)} å·²æ›´æ–°`)):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function j(m,b){o.value&&(o.value.translatedDataURL=m,b&&(o.value.cleanImageData=b),o.value.translationStatus="completed",o.value.translationFailed=!1,o.value.hasUnsavedChanges=!0,console.log("å½“å‰å›¾ç‰‡ç¿»è¯‘ç»“æœå·²æ›´æ–°"))}function se(m,b){o.value&&(o.value.width=m,o.value.height=b,console.log(`å½“å‰å›¾ç‰‡å°ºå¯¸å·²æ›´æ–°: ${m} x ${b}`))}function U(m,b,f){if(m>=0&&m<n.value.length){const u=n.value[m];u&&(u.translationStatus=b,u.translationFailed=b==="failed",f&&(u.errorMessage=f),console.log(`å›¾ç‰‡ ${m} ç¿»è¯‘çŠ¶æ€: ${b}`))}}function Z(m){o.value&&(o.value.translationStatus="failed",o.value.translationFailed=!0,o.value.errorMessage=m,console.log(`å½“å‰å›¾ç‰‡ç¿»è¯‘å¤±è´¥: ${m}`))}function ae(){n.value.forEach(m=>{m.translationStatus="pending",m.translationFailed=!1,m.errorMessage=void 0}),console.log("æ‰€æœ‰å›¾ç‰‡ç¿»è¯‘çŠ¶æ€å·²é‡ç½®")}function Y(m){s.value=m,console.log(`æ‰¹é‡ç¿»è¯‘çŠ¶æ€: ${m?"è¿›è¡Œä¸­":"å·²å®Œæˆ"}`)}function v(){return n.value.map((m,b)=>m.translationFailed?b:-1).filter(m=>m!==-1)}return{images:n,currentImageIndex:t,isBatchTranslationInProgress:s,currentImage:o,imageCount:a,hasImages:l,canGoPrevious:r,canGoNext:x,failedImageCount:g,completedImageCount:i,pendingImageCount:c,addImage:C,addImages:$,setImages:R,deleteImage:k,deleteCurrentImage:D,clearImages:N,sortImagesByFileName:B,setCurrentImageIndex:A,goToPrevious:h,goToNext:p,updateCurrentImage:T,updateImageByIndex:S,updateCurrentBubbleStates:F,setManuallyAnnotated:O,updateCurrentImageProperty:te,updateCurrentTranslationResult:j,updateCurrentImageDimensions:se,setTranslationStatus:U,markCurrentAsFailed:Z,resetAllTranslationStatus:ae,setBatchTranslationInProgress:Y,getFailedImageIndices:v}}),vn=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:Ze},Symbol.toStringTag,{value:"Module"})),$t=eo("session",()=>{const n=w(null),t=w({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),s=w([]),o=w(!1),a=w({current:0,total:0,message:""}),l=w(null),r=w(!1),x=J(()=>t.value.bookId!==null&&t.value.chapterId!==null),g=J(()=>t.value.bookId),i=J(()=>t.value.chapterId);function c(U,Z,ae=null,Y=null){t.value={bookId:U,chapterId:Z,bookTitle:ae,chapterTitle:Y},console.log(`ä¼šè¯ä¸Šä¸‹æ–‡å·²è®¾ç½®: ä¹¦ç±=${U}, ç« èŠ‚=${Z}`)}function C(U,Z,ae,Y){c(U,Z,ae,Y)}function $(){t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("ä¼šè¯ä¸Šä¸‹æ–‡å·²æ¸…é™¤")}function R(U){const Z=U.get("book"),ae=U.get("chapter");Z&&ae&&c(Z,ae)}function k(U){n.value=U,console.log(`å½“å‰ä¼šè¯åç§°: ${U}`)}function D(){n.value=null}function N(U){s.value=U,console.log(`ä¼šè¯åˆ—è¡¨å·²æ›´æ–°ï¼Œå…± ${U.length} ä¸ªä¼šè¯`)}function B(U){const Z=s.value.findIndex(ae=>ae.name===U.name);Z>=0?s.value[Z]=U:s.value.unshift(U)}function A(U){const Z=s.value.findIndex(ae=>ae.name===U);Z>=0&&s.value.splice(Z,1)}function h(U,Z){const ae=s.value.find(Y=>Y.name===U);ae&&(ae.name=Z)}function p(U){o.value=U}function T(U){r.value=U}function S(U){l.value=U}function F(){n.value=null,t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},s.value=[],o.value=!1,r.value=!1,l.value=null,console.log("ä¼šè¯çŠ¶æ€å·²é‡ç½®")}async function O(U){if(!U||typeof U!="string")return null;if(U.startsWith("data:"))return U;if(!U.startsWith("/api/"))return null;try{const Z=await fetch(U);if(!Z.ok)return null;const ae=await Z.blob();return new Promise(Y=>{const v=new FileReader;v.onloadend=()=>Y(v.result),v.onerror=()=>Y(null),v.readAsDataURL(ae)})}catch(Z){return console.error(`è½¬æ¢å›¾ç‰‡ URL å¤±è´¥: ${U}`,Z),null}}async function te(U,Z){const ae=U.length;for(let Y=0;Y<ae;Y++){const v=U[Y];if(v){if(Z&&Z(Y+1,ae),v.originalDataURL&&v.originalDataURL.startsWith("/api/")){const m=await O(v.originalDataURL);m&&(v.originalDataURL=m)}if(v.translatedDataURL&&v.translatedDataURL.startsWith("/api/")){const m=await O(v.translatedDataURL);m&&(v.translatedDataURL=m)}if(v.cleanImageData&&v.cleanImageData.startsWith("/api/")){const m=await O(v.cleanImageData);m&&(v.cleanImageData=m.replace(/^data:image\/\w+;base64,/,""))}}}}async function j(U){p(!0),S(null),a.value={current:0,total:0,message:"æ­£åœ¨åŠ è½½..."};try{const{useImageStore:Z}=await it(async()=>{const{useImageStore:M}=await Promise.resolve().then(()=>vn);return{useImageStore:M}},void 0),{useSettingsStore:ae}=await it(async()=>{const{useSettingsStore:M}=await Promise.resolve().then(()=>xo);return{useSettingsStore:M}},void 0),{useBubbleStore:Y}=await it(async()=>{const{useBubbleStore:M}=await Promise.resolve().then(()=>wi);return{useBubbleStore:M}},void 0),v=Z(),m=ae(),b=Y(),{loadSessionByPathApi:f}=await it(async()=>{const{loadSessionByPathApi:M}=await import("./session.C_VZSWrV.js");return{loadSessionByPathApi:M}},__vite__mapDeps([0,1,2])),u=await f(U);if(!u.success||!u.session)throw new Error(u.error||"åŠ è½½ä¼šè¯å¤±è´¥");const y=u.session;if(y.images&&y.images.length>0){const M=y.images.map((d,_)=>({id:`session-${_}-${Date.now()}`,originalDataURL:d.originalDataURL,translatedDataURL:d.translatedDataURL||null,cleanImageData:d.cleanImageData||null,width:d.width||void 0,height:d.height||void 0,bubbleStates:d.bubbleStates!==void 0&&d.bubbleStates!==null?d.bubbleStates:null,isManuallyAnnotated:!!d.isManuallyAnnotated,relativePath:d.relativePath||void 0,folderPath:d.folderPath||void 0,fileName:d.fileName||`image-${_+1}.png`,translationStatus:d.translationStatus||"pending",translationFailed:!!d.translationFailed,hasUnsavedChanges:!1,fontSize:d.fontSize||24,autoFontSize:d.autoFontSize??!1,fontFamily:d.fontFamily||"Microsoft YaHei",layoutDirection:d.layoutDirection||"auto",useAutoTextColor:d.useAutoTextColor??void 0,textColor:d.textColor||"#000000",fillColor:d.fillColor||"#FFFFFF",inpaintMethod:d.inpaintMethod||"litelama",strokeEnabled:d.strokeEnabled??!1,strokeColor:d.strokeColor||"#FFFFFF",strokeWidth:d.strokeWidth||2,textMask:d.textMask||null,userMask:d.userMask||null}));M.length>0&&(console.log("æ­£åœ¨åŠ è½½å›¾ç‰‡..."),a.value={current:0,total:M.length,message:"æ­£åœ¨åŠ è½½å›¾ç‰‡..."},await te(M,(d,_)=>{const ie=d/_*100;a.value={current:d,total:_,message:`åŠ è½½å›¾ç‰‡ ${d}/${_}...`},console.log(`åŠ è½½å›¾ç‰‡ ${d}/${_}... (${ie.toFixed(0)}%)`)}),a.value={current:M.length,total:M.length,message:"åŠ è½½å®Œæˆ"},console.log("å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²è½¬æ¢ä¸º Base64"),setTimeout(()=>{a.value={current:0,total:0,message:""}},500)),v.setImages(M);let V=0;typeof y.currentImageIndex=="number"&&(V=y.currentImageIndex,(V>=M.length||V<0)&&(V=M.length>0?0:-1)),v.setCurrentImageIndex(V);const G=M[V];G&&G.bubbleStates&&G.bubbleStates.length>0?b.setBubbles(G.bubbleStates,!0):b.clearBubblesLocal(),console.log(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯æˆåŠŸ: ${U}, å…± ${M.length} å¼ å›¾ç‰‡`)}const I=y.ui_settings;if(I){(I.targetLanguage||I.sourceLanguage)&&m.updateSettings({targetLanguage:I.targetLanguage||void 0,sourceLanguage:I.sourceLanguage||void 0});const M=I.useInpaintingMethod,G=["solid","lama_mpe","litelama"].includes(M)?M:m.settings.textStyle.inpaintMethod;m.updateTextStyle({fontSize:I.fontSize||m.settings.textStyle.fontSize,autoFontSize:I.autoFontSize??m.settings.textStyle.autoFontSize,fontFamily:I.fontFamily||m.settings.textStyle.fontFamily,layoutDirection:I.layoutDirection||m.settings.textStyle.layoutDirection,textColor:I.textColor||m.settings.textStyle.textColor,fillColor:I.fillColor||m.settings.textStyle.fillColor,inpaintMethod:G,strokeEnabled:I.strokeEnabled??m.settings.textStyle.strokeEnabled,strokeColor:I.strokeColor||m.settings.textStyle.strokeColor,strokeWidth:I.strokeWidth||m.settings.textStyle.strokeWidth,useAutoTextColor:I.useAutoTextColor??m.settings.textStyle.useAutoTextColor}),console.log("UI è®¾ç½®å·²æ¢å¤")}return k(U),!0}catch(Z){const ae=Z instanceof Error?Z.message:"åŠ è½½ä¼šè¯å¤±è´¥";throw S(ae),console.error(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯å¤±è´¥: ${U}`,Z),Z}finally{p(!1)}}async function se(U,Z){if(!U||!Z)return console.log("æœªåœ¨ä¹¦ç±/ç« èŠ‚æ¨¡å¼ï¼Œä¸æ”¯æŒä¿å­˜"),!1;console.log(`ä¿å­˜ç« èŠ‚ä¼šè¯: book=${U}, chapter=${Z}`);const{useImageStore:ae}=await it(async()=>{const{useImageStore:y}=await Promise.resolve().then(()=>vn);return{useImageStore:y}},void 0),{useSettingsStore:Y}=await it(async()=>{const{useSettingsStore:y}=await Promise.resolve().then(()=>xo);return{useSettingsStore:y}},void 0),v=ae(),m=Y(),b=Array.isArray(v.images)?v.images:[];if(!b||b.length===0)return console.log("æ²¡æœ‰å›¾ç‰‡æ•°æ®å¯ä¿å­˜"),!1;const f=`bookshelf/${U}/chapters/${Z}/session`;T(!0),S(null);const u=b.length;a.value={current:0,total:u,message:`å‡†å¤‡ä¿å­˜ ${u} å¼ å›¾ç‰‡...`};try{b.some(_=>_.originalDataURL&&_.originalDataURL.startsWith("/api/")||_.translatedDataURL&&_.translatedDataURL.startsWith("/api/")||_.cleanImageData&&_.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] æ£€æµ‹åˆ° /api/ URL æ ¼å¼å›¾ç‰‡ï¼Œå¼€å§‹è½¬æ¢ä¸º Base64..."),a.value={current:0,total:u,message:"è½¬æ¢å›¾ç‰‡æ ¼å¼..."},await te(b,(_,ie)=>{a.value={current:0,total:u,message:`è½¬æ¢å›¾ç‰‡ ${_}/${ie}...`}}),console.log("[saveChapterSession] å›¾ç‰‡æ ¼å¼è½¬æ¢å®Œæˆ"));const{textStyle:I}=m.settings,M={fontSize:I.fontSize,autoFontSize:I.autoFontSize,fontFamily:I.fontFamily,layoutDirection:I.layoutDirection,textColor:I.textColor,useInpaintingMethod:I.inpaintMethod,fillColor:I.fillColor,strokeEnabled:I.strokeEnabled,strokeColor:I.strokeColor,strokeWidth:I.strokeWidth,useAutoTextColor:I.useAutoTextColor},{saveAllPagesSequentially:V,saveSessionMeta:G}=await it(async()=>{const{saveAllPagesSequentially:_,saveSessionMeta:ie}=await Promise.resolve().then(()=>zn);return{saveAllPagesSequentially:_,saveSessionMeta:ie}},void 0),d=await V(f,b,{onProgress:(_,ie)=>{a.value={current:_,total:ie,message:`ä¿å­˜å›¾ç‰‡ ${_}/${ie}...`}}});a.value={current:u,total:u,message:"å®Œæˆä¿å­˜..."},await G(f,{ui_settings:M,total_pages:u,currentImageIndex:v.currentImageIndex}),console.log(`ç« èŠ‚ä¿å­˜å®Œæˆ: ${d}/${u} å¼ å›¾ç‰‡`);try{const{apiClient:_}=await it(async()=>{const{apiClient:ie}=await import("./client.Bht704G-.js");return{apiClient:ie}},__vite__mapDeps([1,2]));await _.put(`/api/bookshelf/books/${U}/chapters/${Z}/image-count`,{count:u})}catch(_){console.warn("æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",_)}return a.value={current:u,total:u,message:"ä¿å­˜å®Œæˆ"},setTimeout(()=>{a.value={current:0,total:0,message:""}},1e3),!0}catch(y){const I=y instanceof Error?y.message:"ä¿å­˜ç« èŠ‚ä¼šè¯å¤±è´¥";return S(I),console.error("ä¿å­˜å¤±è´¥:",y),a.value={current:0,total:0,message:""},!1}finally{T(!1)}}return{currentSessionName:n,context:t,sessionList:s,isLoading:o,isSaving:r,error:l,loadingProgress:a,isBookshelfMode:x,currentBookId:g,currentChapterId:i,setContext:c,clearContext:$,parseContextFromUrl:R,setSessionName:k,clearSessionName:D,setSessionList:N,addToSessionList:B,removeFromSessionList:A,renameInSessionList:h,setLoading:p,setSaving:T,setError:S,imageUrlToBase64:O,saveChapterSession:se,loadSessionByPath:j,setBookChapterContext:C,reset:F}}),qt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:ft,textDirection:"vertical",autoTextDirection:"vertical",textColor:"#000000",fillColor:Pn,rotationAngle:0,position:{x:0,y:0},strokeEnabled:ko,strokeColor:_o,strokeWidth:Co,inpaintMethod:"solid",autoFgColor:null,autoBgColor:null,colorConfidence:0};function fa(n){return{...{...qt,...n},coords:n?.coords?[...n.coords]:[...qt.coords],polygon:n?.polygon?n.polygon.map(s=>[...s]):[],position:n?.position?{...qt.position,...n.position}:{...qt.position}}}function ba(n){const[t,s,o,a]=n,l=Math.abs(o-t);return Math.abs(a-s)>l?"vertical":"horizontal"}function Ht(n){return n.map(t=>({...t,coords:[...t.coords],polygon:t.polygon?t.polygon.map(s=>[...s]):[],position:{...t.position},autoFgColor:t.autoFgColor?[...t.autoFgColor]:null,autoBgColor:t.autoBgColor?[...t.autoBgColor]:null}))}function ha(n){if(!n||typeof n!="object")return!1;const t=n;if(!Array.isArray(t.coords)||t.coords.length!==4||!t.coords.every(a=>typeof a=="number"&&!isNaN(a))||typeof t.fontSize!="number"||t.fontSize<=0)return!1;const s=["vertical","horizontal","auto"];if(typeof t.textDirection!="string"||!s.includes(t.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof t.inpaintMethod!="string"||!o.includes(t.inpaintMethod))}function xa(n){let t=n,s=0,o=0,a=Date.now();const l=()=>t<=0?0:Math.ceil(6e4/t);return{async acquire(){if(t<=0)return;const r=Date.now(),x=l();if(r-a>=6e4&&(a=r,o=0),o>=t){const i=6e4-(r-a);i>0&&await fn(i),a=Date.now(),o=0}const g=r-s;g<x&&await fn(x-g),s=Date.now(),o++},reset(){s=0,o=0,a=Date.now()},getRpm(){return t},setRpm(r){t=r,this.reset()}}}function fn(n){return new Promise(t=>setTimeout(t,n))}function bn(n){const t=n.replace(/\\/g,"/"),s=[],o=/(\d+)/g;let a=0,l;for(;(l=o.exec(t))!==null;){if(l.index>a){const r=t.slice(a,l.index);r&&s.push([!0,r.toLowerCase()])}s.push([!1,parseInt(l[0],10)]),a=o.lastIndex}if(a<t.length){const r=t.slice(a);r&&s.push([!0,r.toLowerCase()])}return s}function ya(n,t){const s=bn(n),o=bn(t),a=Math.min(s.length,o.length);for(let l=0;l<a;l++){const[r,x]=s[l],[g,i]=o[l];if(r!==g)return r?1:-1;if(x<i)return-1;if(x>i)return 1}return s.length-o.length}function Ca(n,t=s=>String(s)){return[...n].sort((s,o)=>ya(t(s),t(o)))}const hn="webImportDisclaimerAccepted",Io=eo("webImport",()=>{const n=w(pn()),t=w("idle"),s=w(""),o=w([]),a=w(null),l=w(new Set),r=w({current:0,total:0}),x=w([]),g=w(null),i=w(!1),c=w(!1),C=w(!1),$=J(()=>t.value==="extracting"),R=J(()=>t.value==="downloading"),k=J(()=>$.value||R.value),D=J(()=>l.value.size),N=J(()=>r.value.total===0?0:Math.round(r.value.current/r.value.total*100));function B(){try{localStorage.setItem(en,JSON.stringify(n.value))}catch(I){console.error("ä¿å­˜ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",I)}}function A(){try{const I=localStorage.getItem(en);if(I){const M=JSON.parse(I);n.value=h(pn(),M)}}catch(I){console.error("åŠ è½½ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",I)}}function h(I,M){const V={...I};for(const G in M)if(Object.prototype.hasOwnProperty.call(M,G)){const d=M[G],_=I[G];d!==null&&typeof d=="object"&&!Array.isArray(d)&&_!==null&&typeof _=="object"&&!Array.isArray(_)?V[G]=h(_,d):d!==void 0&&(V[G]=d)}return V}function p(){c.value?i.value=!0:C.value=!0}function T(){c.value=!0,C.value=!1,i.value=!0;try{localStorage.setItem(hn,"true")}catch(I){console.error("ä¿å­˜å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",I)}}function S(){C.value=!1}function F(){try{const I=localStorage.getItem(hn);c.value=I==="true"}catch(I){console.error("åŠ è½½å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",I)}}function O(){i.value=!1}function te(){t.value="idle",s.value="",o.value=[],a.value=null,l.value=new Set,r.value={current:0,total:0},x.value=[],g.value=null}function j(I){s.value=I}function se(I){o.value.push(I)}function U(){o.value=[]}function Z(I){a.value&&a.value.pages.length>0?(a.value.comicTitle=I.comicTitle,a.value.chapterTitle=I.chapterTitle,a.value.totalPages=I.totalPages,a.value.sourceUrl=I.sourceUrl,a.value.referer=I.referer,a.value.engine=I.engine,a.value.success=I.success,a.value.error=I.error):(a.value=I,I.success&&I.pages&&(l.value=new Set(I.pages.map(M=>M.pageNumber))))}function ae(I){l.value.has(I)?l.value.delete(I):l.value.add(I),l.value=new Set(l.value)}function Y(){a.value?.pages&&(l.value.size===a.value.pages.length?l.value=new Set:l.value=new Set(a.value.pages.map(I=>I.pageNumber)))}function v(I){t.value=I}function m(I){g.value=I,I&&(t.value="error")}function b(I,M){r.value={current:I,total:M}}function f(I){x.value=I}function u(I){a.value||(a.value={success:!0,comicTitle:"",chapterTitle:"",pages:[],totalPages:0,sourceUrl:s.value,referer:"",engine:"gallery-dl"}),a.value.pages.push(I),a.value.totalPages=a.value.pages.length,l.value.add(I.pageNumber),l.value=new Set(l.value)}const y=Zs(n,B);return A(),F(),{settings:n,status:t,url:s,logs:o,extractResult:a,selectedPages:l,downloadProgress:r,downloadedImages:x,error:g,modalVisible:i,disclaimerAccepted:c,disclaimerVisible:C,isExtracting:$,isDownloading:R,isProcessing:k,selectedCount:D,downloadProgressPercent:N,saveToStorage:B,loadFromStorage:A,openModal:p,closeModal:O,resetState:te,setUrl:j,addLog:se,clearLogs:U,setExtractResult:Z,togglePageSelection:ae,toggleSelectAll:Y,setStatus:v,setError:m,updateDownloadProgress:b,setDownloadedImages:f,addPageIncremental:u,acceptDisclaimer:T,rejectDisclaimer:S,...y}}),_a={key:0,class:"translation-progress-bar"},ka={class:"progress-bar-label"},Sa={class:"progress-bar"},wa=Ge({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"è¿›åº¦"}},setup(n){return(t,s)=>n.visible?(E(),L("div",_a,[e("div",ka,ee(n.label),1),e("div",Sa,[e("div",{class:"progress",style:ot({width:`${n.percentage}%`})},null,4)])])):ce("",!0)}}),Po=Je(wa,[["__scopeId","data-v-f915cadf"]]),$a={class:"image-upload"},Ta={class:"error-text"},Ia={key:2,class:"loading-overlay"},Pa=Ge({__name:"ImageUpload",emits:["uploadComplete"],setup(n,{expose:t,emit:s}){const o=s,a=Ze(),l=Fe(),r=Io(),x=w(null),g=w(null),i=w(!1),c=w(!1),C=w(""),$=w(0),R=w(""),k=w(!1),D=J(()=>l.settings.pdfProcessingMethod);function N(){x.value?.click()}function B(){r.openModal()}function A(){g.value?.click()}async function h(m){const b=m.target;if(!b.files||b.files.length===0)return;const u=Array.from(b.files).filter(I=>I.type.startsWith("image/"));if(u.length===0){ye("æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶","warning"),b.value="";return}const y=Ca(u,I=>I.webkitRelativePath);console.log(`ä»æ–‡ä»¶å¤¹å¯¼å…¥ ${y.length} å¼ å›¾ç‰‡`),await p(y),b.value=""}async function p(m){if(m.length!==0){i.value=!0,k.value=!0,$.value=0;try{let b=0;const f=m.length;for(let u=0;u<m.length;u++){const y=m[u];if(!y||!y.type.startsWith("image/"))continue;R.value=y.name;const I=y.webkitRelativePath||"",M=I.includes("/")?I.substring(0,I.lastIndexOf("/")):"";await new Promise((V,G)=>{const d=new FileReader;d.onload=_=>{const ie=_.target?.result;a.addImage(y.name,ie,{relativePath:I,folderPath:M}),V()},d.onerror=()=>G(new Error(`è¯»å–å›¾ç‰‡å¤±è´¥: ${y.name}`)),d.readAsDataURL(y)}),b++,$.value=Math.round((u+1)/f*100)}b>0&&(ye(`å·²æ·»åŠ  ${b} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",b))}catch(b){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",b);const f=b instanceof Error?b.message:"å¤„ç†æ–‡ä»¶å¤±è´¥";ye(f,"error")}finally{i.value=!1,k.value=!1}}}async function T(m){const b=m.target;!b.files||b.files.length===0||(await te(Array.from(b.files)),b.value="")}async function S(m){m.preventDefault(),c.value=!1,!(!m.dataTransfer?.files||m.dataTransfer.files.length===0)&&await te(Array.from(m.dataTransfer.files))}function F(m){m.preventDefault(),c.value=!0}function O(m){const b=m.currentTarget.getBoundingClientRect(),f=m.clientX,u=m.clientY;(f<b.left||f>b.right||u<b.top||u>b.bottom)&&(c.value=!1)}async function te(m){if(m.length!==0){i.value=!0,C.value="",k.value=!0,$.value=0;try{let b=0;const f=m.length;for(let u=0;u<m.length;u++){const y=m[u];if(!y)continue;R.value=y.name;const I=y.type,M=y.name.toLowerCase();if(I.startsWith("image/"))await j(y),b++;else if(I==="application/pdf"||M.endsWith(".pdf")){const V=await se(y);b+=V}else if(M.endsWith(".mobi")||M.endsWith(".azw")||M.endsWith(".azw3")){const V=await Y(y);b+=V}else console.warn(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${y.name}`),ye(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${y.name}`,"warning");$.value=Math.round((u+1)/f*100)}b>0&&(ye(`å·²æ·»åŠ  ${b} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",b))}catch(b){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",b);const f=b instanceof Error?b.message:"å¤„ç†æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•";C.value=f,ye(f,"error")}finally{i.value=!1,k.value=!1,R.value=""}}}async function j(m){return new Promise((b,f)=>{const u=new FileReader;u.onload=y=>{const I=y.target?.result;a.addImage(m.name,I),b()},u.onerror=()=>f(new Error(`è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥: ${m.name}`)),u.readAsDataURL(m)})}async function se(m){return D.value==="frontend"?await Z(m):await ae(m)}function U(m){return new Promise((b,f)=>{const u=new FileReader;u.onload=()=>b(u.result),u.onerror=f,u.readAsDataURL(m)})}async function Z(m){try{const b=await it(()=>import("./pdf.U7tdldy2.js").then(V=>V.p),[]);b.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${b.version}/pdf.worker.min.js`;const f=await m.arrayBuffer(),u=await b.getDocument({data:f}).promise,y=u.numPages;console.log(`PDF ${m.name} å…± ${y} é¡µï¼Œå¼€å§‹æœ¬åœ°æ¸²æŸ“...`),ye(`æ­£åœ¨è§£æ PDFï¼Œå…± ${y} é¡µ...`,"info");const I=typeof OffscreenCanvas<"u";I&&console.log("ä½¿ç”¨ OffscreenCanvas åå°æ¸²æŸ“æ¨¡å¼");let M=0;for(let V=1;V<=y;V++){R.value=`${m.name} - ç¬¬ ${V}/${y} é¡µ`,$.value=Math.round(V/y*100);try{const G=await u.getPage(V),_=G.getViewport({scale:2});let ie;if(I){const X=new OffscreenCanvas(_.width,_.height),pe=X.getContext("2d");await G.render({canvasContext:pe,viewport:_}).promise;const Ce=await X.convertToBlob({type:"image/jpeg",quality:1});ie=await U(Ce)}else{const X=document.createElement("canvas"),pe=X.getContext("2d");X.width=_.width,X.height=_.height,await G.render({canvasContext:pe,viewport:_}).promise,ie=X.toDataURL("image/jpeg",1)}const z=`${m.name}_é¡µé¢${V}`;a.addImage(z,ie),M++,console.log(`  é¡µé¢ ${V}/${y} å¤„ç†å®Œæˆ`)}catch(G){console.warn(`PDF ${m.name} ç¬¬ ${V} é¡µæ¸²æŸ“å¤±è´¥:`,G)}}return console.log(`PDF ${m.name} å…¨éƒ¨ ${y} é¡µå¤„ç†å®Œæˆ`),M}catch(b){return console.error("å‰ç«¯ PDF è§£æå¤±è´¥:",b),ye("å‰ç«¯ PDF è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åç«¯è§£æ...","warning"),await ae(m)}}async function ae(m){let f=null;try{ye("æ­£åœ¨ä¸Šä¼  PDF æ–‡ä»¶...","info");const u=await Ls(m,5);if(!u.success||!u.session_id)throw new Error(u.error||"PDF è§£æå¯åŠ¨å¤±è´¥");f=u.session_id;const y=u.total_pages||0;console.log(`PDF ${m.name} å…± ${y} é¡µï¼Œå¼€å§‹åç«¯åˆ†æ‰¹è§£æ...`),ye(`æ­£åœ¨è§£æ PDFï¼Œå…± ${y} é¡µ...`,"info");let I=0;for(let M=0;M<y;M+=5){R.value=`${m.name} - å¤„ç†ä¸­ ${Math.min(M+5,y)}/${y} é¡µ`,$.value=y>0?Math.round(M/y*100):0;const V=await Fs(f,M,5);if(!V.success){console.warn(`æ‰¹æ¬¡ ${M} è·å–å¤±è´¥:`,V.error);continue}if(V.images&&V.images.length>0)for(const G of V.images){if(!G||!G.data_url)continue;const d=`${m.name}_é¡µé¢${String(G.page_index+1).padStart(4,"0")}`;a.addImage(d,G.data_url),I++}console.log(`  å·²åŠ è½½ ${I}/${y} é¡µ`)}return console.log(`PDF ${m.name} å…¨éƒ¨ ${I} é¡µå¤„ç†å®Œæˆ`),I}catch(u){throw console.error("åç«¯ PDF è§£æå¤±è´¥:",u),u}finally{if(f)try{await Us(f)}catch(u){console.warn("PDF ä¼šè¯æ¸…ç†å¤±è´¥:",u)}}}async function Y(m){let b=null;try{ye("æ­£åœ¨ä¸Šä¼ ç”µå­ä¹¦æ–‡ä»¶...","info");const f=await Os(m,5);if(!f.success||!f.session_id)throw new Error(f.error||"MOBI/AZW è§£æå¯åŠ¨å¤±è´¥");b=f.session_id;const u=f.total_pages||f.total_images||0;ye(`æ­£åœ¨è§£æç”µå­ä¹¦ï¼Œå…± ${u} å¼ å›¾ç‰‡...`,"info");let y=0,I=!0;for(;I;){R.value=`${m.name} - å·²å¤„ç† ${y}/${u} å¼ `,$.value=u>0?Math.round(y/u*100):0;const M=await zs(b,y,5);if(!M.success)throw new Error(M.error||"MOBI/AZW æ‰¹æ¬¡è§£æå¤±è´¥");if(M.images&&M.images.length>0){for(let V=0;V<M.images.length;V++){const G=M.images[V];if(!G||!G.data_url)continue;const d=y+V+1,_=`${m.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(d).padStart(3,"0")}.png`;a.addImage(_,G.data_url)}y+=M.images.length}I=M.has_more??!1}return y}catch(f){throw console.error("MOBI/AZW è§£æå¤±è´¥:",f),f}finally{if(b)try{await Ns(b)}catch(f){console.warn("MOBI/AZW ä¼šè¯æ¸…ç†å¤±è´¥:",f)}}}function v(){C.value=""}return t({triggerFileSelect:N,triggerFolderSelect:A,processFiles:te,clearError:v}),(m,b)=>(E(),L("div",$a,[e("div",{id:"drop-area",class:Re(["drop-area",{"drag-over":c.value,loading:i.value}]),onDragover:F,onDragleave:O,onDrop:S},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[b[0]||(b[0]=ge(" æ‹–æ‹½å›¾ç‰‡ã€PDFæˆ–MOBIæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ– ",-1)),e("span",{class:"select-link",onClick:N}," é€‰æ‹©æ–‡ä»¶ "),b[1]||(b[1]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link folder-link",onClick:A}," ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹ "),b[2]||(b[2]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link web-import-link",onClick:B}," ğŸŒ ä»ç½‘é¡µå¯¼å…¥ ")])]),e("input",{ref_key:"fileInputRef",ref:x,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:T},null,544),e("input",{ref_key:"folderInputRef",ref:g,type:"file",webkitdirectory:"",class:"file-input",onChange:h},null,544)],34),k.value?(E(),ut(Po,{key:0,visible:!0,percentage:$.value,label:R.value||"å¤„ç†ä¸­..."},null,8,["percentage","label"])):ce("",!0),C.value?(E(),L("div",{key:1,class:"error-message",onClick:v},[b[3]||(b[3]=e("span",{class:"error-icon"},"âš ï¸",-1)),e("span",Ta,ee(C.value),1),b[4]||(b[4]=e("span",{class:"error-close"},"Ã—",-1))])):ce("",!0),i.value&&!k.value?(E(),L("div",Ia,[...b[5]||(b[5]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"å¤„ç†ä¸­...",-1)])])):ce("",!0)]))}}),Ra=Je(Pa,[["__scopeId","data-v-f8791a41"]]),Da={id:"settings-sidebar",class:"settings-sidebar"},Ma={class:"card settings-card"},Ba={id:"font-settings",class:"settings-card collapsible-panel"},Aa={class:"toggle-icon"},Ea={class:"collapsible-content"},La={class:"settings-form"},Fa={class:"form-group"},Ua=["value","disabled","title"],Oa={class:"auto-fontSize-option",title:"å‹¾é€‰åï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶è‡ªåŠ¨ä¸ºæ¯ä¸ªæ°”æ³¡è®¡ç®—åˆé€‚çš„å­—å·"},za=["checked"],Na={class:"form-group"},Va={class:"form-group"},Wa={class:"form-group"},Ka={class:"color-with-auto"},qa={class:"auto-color-toggle",title:"ç¿»è¯‘æ—¶è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰²"},Ha=["checked"],ja=["value","disabled"],Ja={key:0,class:"auto-color-hint"},Ga={class:"form-group"},Ya={class:"checkbox-label"},Xa=["checked"],Za={key:0,id:"strokeOptions",class:"stroke-options"},Qa={class:"form-group"},el=["value"],tl={class:"form-group"},ol=["value"],nl={class:"form-group"},sl={key:0,id:"solidColorOptions",class:"form-group"},al=["value"],ll={class:"apply-settings-group"},il=["disabled"],rl={key:0,class:"apply-options-dropdown"},ul={class:"apply-option"},cl=["checked"],dl={class:"apply-option"},gl={class:"apply-option"},pl={class:"apply-option"},ml={class:"apply-option"},vl={class:"apply-option"},fl={class:"apply-option"},bl={class:"apply-option"},hl={class:"apply-option"},xl={id:"page-range-settings",class:"settings-card collapsible-panel"},yl={class:"toggle-icon"},Cl={class:"collapsible-content"},_l={class:"settings-form page-range-form"},kl={class:"range-header-row"},Sl={class:"range-toggle-compact"},wl=["disabled"],$l={class:"total-count"},Tl={class:"page-range-inputs-compact"},Il=["value"],Pl=["value"],Rl={key:0,class:"range-error-compact"},Dl={class:"action-buttons"},Ml=["disabled"],Bl=["disabled","title"],Al=["disabled","title"],El=["disabled","title"],Ll=["disabled"],Fl=["disabled","title"],Ul=["disabled"],Ol=["disabled"],zl={class:"navigation-buttons"},Nl=["disabled"],Vl=["disabled"],Wl=Ge({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","translateRange","hqTranslate","hqTranslateRange","proofread","proofreadRange","removeText","removeAllText","removeTextRange","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(n,{emit:t}){const s=t,o=Ze(),a=Fe(),l=w(!0),r=w(!1),x=w({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),g=w(!1),i=w(!1),c=w(1),C=w(1),$=[{label:"è‡ªåŠ¨ (æ ¹æ®æ£€æµ‹)",value:"auto"},{label:"ç«–å‘æ’ç‰ˆ",value:"vertical"},{label:"æ¨ªå‘æ’ç‰ˆ",value:"horizontal"}],R=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤ (é€Ÿåº¦ä¼˜åŒ–)",value:"lama_mpe"},{label:"LAMAä¿®å¤ (é€šç”¨)",value:"litelama"}],k=J(()=>o.currentImage),D=J(()=>o.hasImages),N=J(()=>o.images.length),B=J(()=>c.value>=1&&C.value<=N.value&&c.value<=C.value),A=J(()=>D.value&&!o.isBatchTranslationInProgress),h=J(()=>o.canGoPrevious),p=J(()=>o.canGoNext),T=J(()=>a.textStyle),S=w([]),F=[ft,"fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],O=w(null),te=J(()=>{const re=S.value.map(P=>({label:Y(P),value:P}));return re.push({label:"è‡ªå®šä¹‰å­—ä½“...",value:"custom-font"}),re});dt(async()=>{await j();const re=T.value.fontFamily;re&&!S.value.includes(re)&&(S.value=[re,...S.value])});async function j(){try{const re=await An();if(re.fonts&&Array.isArray(re.fonts)&&re.fonts.length>0){const P=re.fonts[0];if(typeof P=="object"&&"path"in P){const Q=re.fonts.map(he=>typeof he=="object"?he.path:he);S.value=Q}else S.value=re.fonts}else S.value=[...F]}catch(re){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",re),S.value=[...F]}}function se(){l.value=!l.value}function U(re){const P=parseInt(re.target.value);isNaN(P)||(a.updateTextStyle({fontSize:P}),s("textStyleChanged","fontSize",P))}function Z(re){const P=re.target.checked;a.updateTextStyle({autoFontSize:P}),console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${P}`),s("autoFontSizeChanged",P)}async function ae(re){const P=re.target,Q=P.files?.[0];if(!Q)return;const he=[".ttf",".ttc",".otf"],me=Q.name.toLowerCase();if(!he.some(W=>me.endsWith(W))){ye("è¯·é€‰æ‹© .ttfã€.ttc æˆ– .otf æ ¼å¼çš„å­—ä½“æ–‡ä»¶","error"),P.value="";return}try{const W=await js(Q);W.success&&W.fontPath?(await j(),a.updateTextStyle({fontFamily:W.fontPath}),ye("å­—ä½“ä¸Šä¼ æˆåŠŸ","success")):ye(W.error||"å­—ä½“ä¸Šä¼ å¤±è´¥","error")}catch(W){console.error("å­—ä½“ä¸Šä¼ å¤±è´¥:",W),ye("å­—ä½“ä¸Šä¼ å¤±è´¥","error")}finally{P.value=""}}function Y(re){const P={"fonts/STXINGKA.TTF":"åæ–‡è¡Œæ¥·","fonts/STXINWEI.TTF":"åæ–‡æ–°é­","fonts/STZHONGS.TTF":"åæ–‡ä¸­å®‹","fonts/STKAITI.TTF":"æ¥·ä½“","fonts/STLITI.TTF":"éš¶ä¹¦","fonts/æ€æºé»‘ä½“SourceHanSansK-Bold.TTF":"æ€æºé»‘ä½“","fonts/STSONG.TTF":"åæ–‡å®‹ä½“","fonts/msyh.ttc":"å¾®è½¯é›…é»‘","fonts/msyhbd.ttc":"å¾®è½¯é›…é»‘ç²—ä½“","fonts/SIMYOU.TTF":"å¹¼åœ†","fonts/STFANGSO.TTF":"ä»¿å®‹","fonts/STHUPO.TTF":"åæ–‡ç¥ç€","fonts/STXIHEI.TTF":"åæ–‡ç»†é»‘","fonts/simkai.ttf":"ä¸­æ˜“æ¥·ä½“","fonts/simfang.ttf":"ä¸­æ˜“ä»¿å®‹","fonts/simhei.ttf":"ä¸­æ˜“é»‘ä½“","fonts/SIMLI.TTF":"ä¸­æ˜“éš¶ä¹¦","fonts/simsun.ttc":"å®‹ä½“"};if(P[re])return P[re];const Q=re.split("/").pop()||re;for(const[he,me]of Object.entries(P))if((he.split("/").pop()||"").toLowerCase()===Q.toLowerCase())return me;return Q.replace(/\.(ttf|ttc|otf)$/i,"")}function v(re){const P=String(re);if(P==="custom-font"){O.value?.click();return}a.updateTextStyle({fontFamily:P}),s("textStyleChanged","fontFamily",P)}function m(re){const P=String(re);a.updateTextStyle({layoutDirection:P}),s("textStyleChanged","layoutDirection",P)}function b(re){const P=String(re);a.updateTextStyle({inpaintMethod:P})}function f(re){const P=re.target.value;a.updateTextStyle({textColor:P}),s("textStyleChanged","textColor",P)}function u(re){const P=re.target.checked;a.updateTextStyle({useAutoTextColor:P})}function y(re){const P=re.target.checked;a.updateTextStyle({strokeEnabled:P}),s("textStyleChanged","strokeEnabled",P)}function I(re){const P=re.target.value;a.updateTextStyle({strokeColor:P}),s("textStyleChanged","strokeColor",P)}function M(re){const P=parseInt(re.target.value);isNaN(P)||(a.updateTextStyle({strokeWidth:P}),s("textStyleChanged","strokeWidth",P))}function V(re){const P=re.target.value;a.updateTextStyle({fillColor:P}),s("textStyleChanged","fillColor",P)}function G(){r.value=!r.value}function d(){const P=!Object.values(x.value).every(Q=>Q);x.value={fontSize:P,fontFamily:P,layoutDirection:P,textColor:P,fillColor:P,strokeEnabled:P,strokeColor:P,strokeWidth:P}}function _(){s("applyToAll",{...x.value}),r.value=!1}function ie(re){re.target.closest(".apply-settings-group")||(r.value=!1)}function z(){g.value=!g.value,g.value&&N.value>0&&(!B.value||c.value===1&&C.value===1)&&(c.value=1,C.value=N.value)}function X(re){const P=parseInt(re.target.value);isNaN(P)||(c.value=Math.max(1,Math.min(P,N.value)))}function pe(re){const P=parseInt(re.target.value);isNaN(P)||(C.value=Math.max(1,Math.min(P,N.value)))}function Ce(){i.value&&B.value?s("translateRange",c.value,C.value):s("translateAll")}function ke(){i.value&&B.value?s("hqTranslateRange",c.value,C.value):s("hqTranslate")}function $e(){i.value&&B.value?s("proofreadRange",c.value,C.value):s("proofread")}function Me(){i.value&&B.value?s("removeTextRange",c.value,C.value):s("removeAllText")}return typeof window<"u"&&window.addEventListener("click",ie),(re,P)=>(E(),L("aside",Da,[e("div",Ma,[P[43]||(P[43]=e("h2",null,"ç¿»è¯‘è®¾ç½®",-1)),e("div",Ba,[e("h3",{class:"collapsible-header",onClick:se},[P[17]||(P[17]=ge(" æ–‡å­—è®¾ç½® ",-1)),e("span",Aa,ee(l.value?"â–¼":"â–¶"),1)]),oe(e("div",Ea,[e("div",La,[e("div",Fa,[P[19]||(P[19]=e("label",{for:"fontSize"},"å­—å·å¤§å°:",-1)),e("input",{type:"number",id:"fontSize",value:T.value.fontSize,min:"10",disabled:T.value.autoFontSize,class:Re({"disabled-input":T.value.autoFontSize}),title:T.value.autoFontSize?"å·²å¯ç”¨è‡ªåŠ¨å­—å·ï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶å°†è‡ªåŠ¨è®¡ç®—":"",onInput:U},null,42,Ua),e("span",Oa,[e("input",{type:"checkbox",id:"autoFontSize",checked:T.value.autoFontSize,onChange:Z},null,40,za),P[18]||(P[18]=e("label",{for:"autoFontSize"},"è‡ªåŠ¨è®¡ç®—åˆå§‹å­—å·",-1))])]),e("div",Na,[P[20]||(P[20]=e("label",{for:"fontFamily"},"æ–‡æœ¬å­—ä½“:",-1)),_e(We,{"model-value":T.value.fontFamily,options:te.value,onChange:v},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:O,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:ae},null,544)]),e("div",Va,[P[21]||(P[21]=e("label",{for:"layoutDirection"},"æ’ç‰ˆè®¾ç½®:",-1)),_e(We,{"model-value":T.value.layoutDirection,options:$,onChange:m},null,8,["model-value"])]),e("div",Wa,[P[23]||(P[23]=e("label",{for:"textColor"},"æ–‡å­—é¢œè‰²:",-1)),e("div",Ka,[e("label",qa,[e("input",{type:"checkbox",checked:T.value.useAutoTextColor,onChange:u},null,40,Ha),P[22]||(P[22]=e("span",null,"è‡ªåŠ¨",-1))]),e("input",{type:"color",id:"textColor",value:T.value.textColor,disabled:T.value.useAutoTextColor,onInput:f},null,40,ja)]),T.value.useAutoTextColor?(E(),L("div",Ja," ğŸ’¡ ç¿»è¯‘æ—¶å°†è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰² ")):ce("",!0)]),e("div",Ga,[e("span",Ya,[e("input",{type:"checkbox",id:"strokeEnabled",checked:T.value.strokeEnabled,onChange:y},null,40,Xa),P[24]||(P[24]=e("label",{for:"strokeEnabled"},"å¯ç”¨æ–‡æœ¬æè¾¹:",-1))])]),_e(dn,{name:"stroke-slide"},{default:xt(()=>[T.value.strokeEnabled?(E(),L("div",Za,[e("div",Qa,[P[25]||(P[25]=e("label",{for:"strokeColor"},"æè¾¹é¢œè‰²:",-1)),e("input",{type:"color",id:"strokeColor",value:T.value.strokeColor,onInput:I},null,40,el)]),e("div",tl,[P[26]||(P[26]=e("label",{for:"strokeWidth"},"æè¾¹å®½åº¦ (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:T.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:M},null,40,ol),P[27]||(P[27]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— æè¾¹ã€‚",-1))])])):ce("",!0)]),_:1}),e("div",nl,[P[28]||(P[28]=e("label",{for:"useInpainting"},"æ°”æ³¡å¡«å……æ–¹å¼:",-1)),_e(We,{"model-value":T.value.inpaintMethod,options:R,onChange:b},null,8,["model-value"])]),_e(dn,{name:"slide-fade"},{default:xt(()=>[T.value.inpaintMethod==="solid"?(E(),L("div",sl,[P[29]||(P[29]=e("label",{for:"fillColor"},"å¡«å……é¢œè‰²:",-1)),e("input",{type:"color",id:"fillColor",value:T.value.fillColor,onInput:V},null,40,al)])):ce("",!0)]),_:1})]),e("div",ll,[e("button",{type:"button",class:"settings-button",disabled:!D.value,onClick:_}," åº”ç”¨åˆ°å…¨éƒ¨ ",8,il),e("button",{type:"button",class:"settings-gear-btn",title:"é€‰æ‹©è¦åº”ç”¨çš„å‚æ•°",onClick:G}," âš™ï¸ "),r.value?(E(),L("div",rl,[e("div",ul,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(x.value).every(Q=>Q),onChange:d},null,40,cl),P[30]||(P[30]=e("label",{for:"apply_selectAll"},"å…¨é€‰",-1))]),P[39]||(P[39]=e("hr",null,null,-1)),e("div",dl,[oe(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":P[0]||(P[0]=Q=>x.value.fontSize=Q)},null,512),[[Xe,x.value.fontSize]]),P[31]||(P[31]=e("label",{for:"apply_fontSize"},"å­—å·",-1))]),e("div",gl,[oe(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":P[1]||(P[1]=Q=>x.value.fontFamily=Q)},null,512),[[Xe,x.value.fontFamily]]),P[32]||(P[32]=e("label",{for:"apply_fontFamily"},"å­—ä½“",-1))]),e("div",pl,[oe(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":P[2]||(P[2]=Q=>x.value.layoutDirection=Q)},null,512),[[Xe,x.value.layoutDirection]]),P[33]||(P[33]=e("label",{for:"apply_layoutDirection"},"æ’ç‰ˆæ–¹å‘",-1))]),e("div",ml,[oe(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":P[3]||(P[3]=Q=>x.value.textColor=Q)},null,512),[[Xe,x.value.textColor]]),P[34]||(P[34]=e("label",{for:"apply_textColor"},"æ–‡å­—é¢œè‰²",-1))]),e("div",vl,[oe(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":P[4]||(P[4]=Q=>x.value.fillColor=Q)},null,512),[[Xe,x.value.fillColor]]),P[35]||(P[35]=e("label",{for:"apply_fillColor"},"å¡«å……é¢œè‰²",-1))]),e("div",fl,[oe(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":P[5]||(P[5]=Q=>x.value.strokeEnabled=Q)},null,512),[[Xe,x.value.strokeEnabled]]),P[36]||(P[36]=e("label",{for:"apply_strokeEnabled"},"æè¾¹å¼€å…³",-1))]),e("div",bl,[oe(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":P[6]||(P[6]=Q=>x.value.strokeColor=Q)},null,512),[[Xe,x.value.strokeColor]]),P[37]||(P[37]=e("label",{for:"apply_strokeColor"},"æè¾¹é¢œè‰²",-1))]),e("div",hl,[oe(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":P[7]||(P[7]=Q=>x.value.strokeWidth=Q)},null,512),[[Xe,x.value.strokeWidth]]),P[38]||(P[38]=e("label",{for:"apply_strokeWidth"},"æè¾¹å®½åº¦",-1))])])):ce("",!0)])],512),[[Oe,l.value]])]),e("div",xl,[e("h3",{class:"collapsible-header",onClick:z},[P[40]||(P[40]=ge(" æŒ‡å®šèŒƒå›´ ",-1)),e("span",yl,ee(g.value?"â–¼":"â–¶"),1)]),oe(e("div",Cl,[e("div",_l,[e("div",kl,[e("label",Sl,[oe(e("input",{type:"checkbox","onUpdate:modelValue":P[8]||(P[8]=Q=>i.value=Q),disabled:N.value===0},null,8,wl),[[Xe,i.value]]),P[41]||(P[41]=e("span",null,"å¯ç”¨",-1))]),e("span",$l,"å…± "+ee(N.value)+" å¼ ",1)]),oe(e("div",Tl,[e("input",{type:"number",id:"pageRangeStart",value:c.value,onInput:X,placeholder:"èµ·å§‹"},null,40,Il),P[42]||(P[42]=e("span",{class:"range-sep"},"~",-1)),e("input",{type:"number",id:"pageRangeEnd",value:C.value,onInput:pe,placeholder:"ç»“æŸ"},null,40,Pl)],512),[[Oe,i.value]]),i.value&&!B.value&&N.value>0?(E(),L("div",Rl," èŒƒå›´æ— æ•ˆ ")):ce("",!0)])],512),[[Oe,g.value]])]),e("div",Dl,[e("button",{id:"translateButton",disabled:!A.value,onClick:P[9]||(P[9]=Q=>s("translateCurrent"))}," ç¿»è¯‘å½“å‰å›¾ç‰‡ ",8,Ml),e("button",{id:"translateAllButton",disabled:!A.value||i.value&&!B.value,title:i.value?`ç¿»è¯‘ç¬¬ ${c.value}-${C.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡",onClick:Ce},ee(i.value?`ç¿»è¯‘ ${c.value}-${C.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡"),9,Bl),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!A.value||i.value&&!B.value,title:i.value?`é«˜è´¨é‡ç¿»è¯‘ç¬¬ ${c.value}-${C.value} é¡µ`:"ä½¿ç”¨é«˜è´¨é‡ç¿»è¯‘æ¨¡å¼ï¼ˆéœ€åœ¨è®¾ç½®ä¸­é…ç½®ï¼‰",onClick:ke},ee(i.value?`é«˜è´¨é‡ç¿»è¯‘ ${c.value}-${C.value}`:"é«˜è´¨é‡ç¿»è¯‘"),9,Al),e("button",{id:"proofreadButton",disabled:!A.value||i.value&&!B.value,title:i.value?`AIæ ¡å¯¹ç¬¬ ${c.value}-${C.value} é¡µ`:"AIæ ¡å¯¹",onClick:$e},ee(i.value?`AIæ ¡å¯¹ ${c.value}-${C.value}`:"AIæ ¡å¯¹"),9,El),e("button",{id:"removeTextOnlyButton",disabled:!k.value,title:"æ¶ˆé™¤å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:P[10]||(P[10]=Q=>s("removeText"))}," ä»…æ¶ˆé™¤æ–‡å­— ",8,Ll),e("button",{id:"removeAllTextButton",disabled:!D.value||i.value&&!B.value,title:i.value?`æ¶ˆé™¤ç¬¬ ${c.value}-${C.value} é¡µçš„æ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—",onClick:Me},ee(i.value?`æ¶ˆé™¤ ${c.value}-${C.value} é¡µæ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡æ–‡å­—"),9,Fl),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!k.value,onClick:P[11]||(P[11]=Q=>s("deleteCurrent"))}," åˆ é™¤å½“å‰å›¾ç‰‡ ",8,Ul),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!D.value,onClick:P[12]||(P[12]=Q=>s("clearAll"))}," æ¸…é™¤æ‰€æœ‰å›¾ç‰‡ ",8,Ol),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:P[13]||(P[13]=Q=>s("cleanTemp"))}," æ¸…ç†ä¸´æ—¶æ–‡ä»¶ "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:P[14]||(P[14]=Q=>s("openPlugins"))}," æ’ä»¶ç®¡ç† ")]),e("div",zl,[e("button",{id:"prevImageButton",disabled:!h.value,onClick:P[15]||(P[15]=Q=>s("previous"))}," ä¸Šä¸€å¼  ",8,Nl),e("button",{id:"nextImageButton",disabled:!p.value,onClick:P[16]||(P[16]=Q=>s("next"))}," ä¸‹ä¸€å¼  ",8,Vl)])])]))}}),Kl=Je(Wl,[["__scopeId","data-v-cf679ea9"]]);function Ot(n){if(n.textDirection==="vertical"||n.textDirection==="horizontal")return n.textDirection;if(n.autoTextDirection==="vertical"||n.autoTextDirection==="horizontal")return n.autoTextDirection;if(n.coords){const[t,s,o,a]=n.coords;return a-s>o-t?"vertical":"horizontal"}return"vertical"}function ql(){const n=Ze(),t=Fe(),s=ct(),o=w(!1),a=w(0),l=w(""),r=w(!1),x=w(0),g=w(""),i=J(()=>n.hasImages),c=J(()=>n.hasImages),C=J(()=>n.hasImages);function $(){const h=n.images;if(h.length===0){s.warning("æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾ç‰‡æ–‡æœ¬");return}const p=[];for(let se=0;se<h.length;se++){const U=h[se];if(!U)continue;const Z=U.bubbleStates||[],ae={imageIndex:se,bubbles:[]};for(let Y=0;Y<Z.length;Y++){const v=Z[Y];if(!v)continue;const m=v.originalText||"",b=v.translatedText||v.textboxText||"";let f="vertical";v.textDirection&&v.textDirection!=="auto"?f=v.textDirection:v.autoTextDirection&&(f=v.autoTextDirection),ae.bubbles.push({bubbleIndex:Y,original:m,translated:b,textDirection:f})}p.push(ae)}const T=JSON.stringify(p,null,2),S=new Blob([T],{type:"application/json"}),F=URL.createObjectURL(S),O=document.createElement("a");O.href=F;const j=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);O.download=`translations_${j}.json`,document.body.appendChild(O),O.click(),document.body.removeChild(O),URL.revokeObjectURL(F),s.success("æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼")}function R(){const h=n.images;if(h.length===0)return null;const p=[];for(let T=0;T<h.length;T++){const S=h[T];if(!S)continue;const F=S.bubbleStates||[],O={imageIndex:T,bubbles:[]};for(let te=0;te<F.length;te++){const j=F[te];if(!j)continue;const se=j.originalText||"",U=j.translatedText||j.textboxText||"";let Z="vertical";j.textDirection&&j.textDirection!=="auto"?Z=j.textDirection:j.autoTextDirection&&(Z=j.autoTextDirection),O.bubbles.push({bubbleIndex:te,original:se,translated:U,textDirection:Z})}p.push(O)}return p}async function k(h){if(!h){s.warning("æœªé€‰æ‹©æ–‡ä»¶");return}r.value=!0,x.value=0,g.value="å‡†å¤‡å¯¼å…¥æ–‡æœ¬...",s.info("æ­£åœ¨å¯¼å…¥æ–‡æœ¬...",0);try{const p=await D(h);x.value=10,g.value="è§£æ JSON æ•°æ®...";const T=JSON.parse(p);if(!Array.isArray(T))throw new Error("å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„");let S=0,F=0;const O=t.settings.textStyle,te=O.autoFontSize?"auto":O.fontSize,j=O.fontFamily,se=O.textColor,U=O.fillColor;x.value=20,g.value="å¼€å§‹æ›´æ–°å›¾ç‰‡...";const Z=T.length;let ae=0;const Y=[];for(const b of T){ae++;const f=20+ae/Z*60;x.value=f,g.value=`å¤„ç†å›¾ç‰‡ ${ae}/${Z}`;const u=b.imageIndex;if(u<0||u>=n.images.length){console.warn(`è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${u}`);continue}const y=n.images[u];if(!y)continue;let I=!1;y.bubbleStates||(y.bubbleStates=[]),y.bubbleTexts||(y.bubbleTexts=[]),y.originalTexts||(y.originalTexts=[]);for(const M of b.bubbles){const V=M.bubbleIndex,G=M.original,d=M.translated,_=M.textDirection,ie=_==="vertical"||_==="horizontal"?_:"vertical";for(;y.bubbleTexts.length<=V;)y.bubbleTexts.push("");for(;y.originalTexts.length<=V;)y.originalTexts.push("");for(G&&(y.originalTexts[V]=G),d&&(y.bubbleTexts[V]=d);y.bubbleStates.length<=V;)y.bubbleStates.push(N(te,j,se,U));const z=y.bubbleStates[V];z&&(G&&(z.originalText=G),d&&(z.translatedText=d,z.textboxText=d),z.textDirection=ie,I=!0,F++)}I&&y.bubbleStates&&(y.bubbleTexts=y.bubbleStates.map(M=>M.translatedText||"")),I&&(S++,y.hasUnsavedChanges=!0,y.translatedDataURL&&y.bubbleStates&&y.bubbleStates.length>0&&Y.push(u))}if(Y.length>0){x.value=80,g.value="å¼€å§‹æ¸²æŸ“å›¾ç‰‡...",s.info("æ­£åœ¨æ¸²æŸ“å›¾ç‰‡ï¼Œè¯·ç¨å€™...",0);const b=t.settings.textStyle,f=b.layoutDirection,u=f==="auto";for(let y=0;y<Y.length;y++){const I=Y[y];if(I===void 0)continue;const M=n.images[I];if(!(!M||!M.bubbleStates)){x.value=80+y/Y.length*20,g.value=`æ¸²æŸ“å›¾ç‰‡ ${y+1}/${Y.length}`;try{let V="";if(M.cleanImageData?V=M.cleanImageData.includes("base64,")?M.cleanImageData.split("base64,")[1]||"":M.cleanImageData:M.originalDataURL&&(V=M.originalDataURL.includes("base64,")?M.originalDataURL.split("base64,")[1]||"":M.originalDataURL,console.log(`importText: å›¾ç‰‡ ${I} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!V){console.log(`importText: å›¾ç‰‡ ${I} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const G=M.bubbleStates.map(_=>({translatedText:_.translatedText||"",coords:_.coords,fontSize:_.fontSize||b.fontSize,fontFamily:_.fontFamily||b.fontFamily,textDirection:Ot(_),textColor:_.textColor||b.textColor,rotationAngle:_.rotationAngle||0,position:_.position||{x:0,y:0},strokeEnabled:_.strokeEnabled??b.strokeEnabled,strokeColor:_.strokeColor||b.strokeColor,strokeWidth:_.strokeWidth??b.strokeWidth})),d=await $o({clean_image:V,bubble_texts:G.map(_=>_.translatedText),bubble_coords:G.map(_=>_.coords),fontSize:b.fontSize,fontFamily:b.fontFamily,textDirection:u?"vertical":f,textColor:b.textColor,bubble_states:G,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:b.strokeEnabled,strokeColor:b.strokeColor,strokeWidth:b.strokeWidth});d.rendered_image&&(n.updateImageByIndex(I,{translatedDataURL:`data:image/png;base64,${d.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: å›¾ç‰‡ ${I} æ¸²æŸ“æˆåŠŸ`))}catch(V){console.error(`importText: é‡æ¸²æŸ“å›¾ç‰‡ ${I} å¤±è´¥:`,V)}}}}x.value=100,g.value="å¯¼å…¥å®Œæˆ";const v=Y.length,m=v>0?`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${S} å¼ å›¾ç‰‡ä¸­çš„ ${F} ä¸ªæ°”æ³¡æ–‡æœ¬ï¼Œé‡æ¸²æŸ“äº† ${v} å¼ å›¾ç‰‡`:`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${S} å¼ å›¾ç‰‡ä¸­çš„ ${F} ä¸ªæ°”æ³¡æ–‡æœ¬`;s.success(m)}catch(p){console.error("å¯¼å…¥æ–‡æœ¬å‡ºé”™:",p),s.error(`å¯¼å…¥å¤±è´¥: ${p instanceof Error?p.message:String(p)}`)}finally{r.value=!1,setTimeout(()=>{x.value=0,g.value=""},2e3)}}function D(h){return new Promise((p,T)=>{const S=new FileReader;S.onload=F=>{F.target?.result?p(F.target.result):T(new Error("è¯»å–æ–‡ä»¶å¤±è´¥"))},S.onerror=()=>T(new Error("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™")),S.readAsText(h)})}function N(h,p,T,S){const F=t.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof h=="number"?h:25,fontFamily:p,textDirection:"vertical",autoTextDirection:"vertical",textColor:T,fillColor:S,rotationAngle:0,position:{x:0,y:0},strokeEnabled:F.strokeEnabled,strokeColor:F.strokeColor,strokeWidth:F.strokeWidth,inpaintMethod:F.inpaintMethod}}function B(){const h=n.currentImage;if(!h){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}const p=h.translatedDataURL||h.originalDataURL;if(!p){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0;try{const T=p.split(",")[1];if(!T)throw new Error("æ— æ•ˆçš„å›¾ç‰‡æ•°æ®");const S=atob(T),F=[];for(let Z=0;Z<S.length;Z+=512){const ae=S.slice(Z,Z+512),Y=new Array(ae.length);for(let m=0;m<ae.length;m++)Y[m]=ae.charCodeAt(m);const v=new Uint8Array(Y);F.push(v.buffer)}const O=new Blob(F,{type:"image/png"}),te=URL.createObjectURL(O),j=document.createElement("a");j.href=te;let se=h.fileName||`image_${n.currentImageIndex}.png`;se=`${h.translatedDataURL?"translated":"original"}_${se.replace(/\.[^/.]+$/,"")}.png`,j.download=se,document.body.appendChild(j),j.click(),document.body.removeChild(j),URL.revokeObjectURL(te),s.success(`ä¸‹è½½æˆåŠŸ: ${se}`)}catch(T){console.error("ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™:",T),s.error("ä¸‹è½½å¤±è´¥")}finally{o.value=!1}}async function A(h="zip"){const p=n.images;if(p.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0,a.value=0,l.value="å‡†å¤‡ä¸‹è½½...",s.info("ä¸‹è½½ä¸­...å¤„ç†å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...",0);try{const T=[];let S=0,F=0;a.value=5,l.value="æ£€æŸ¥å›¾ç‰‡æ•°æ®...";for(let m=0;m<p.length;m++){const b=p[m];b&&(b.translatedDataURL?(T.push({index:m,type:"translated"}),S++):b.originalDataURL&&(T.push({index:m,type:"original"}),F++))}if(T.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}a.value=10,l.value="åˆ›å»ºä¸‹è½½ä¼šè¯...";const O=await Vs(T.length);if(!O.success||!O.session_id)throw new Error(O.error||"åˆ›å»ºä¼šè¯å¤±è´¥");const te=O.session_id,j=T.length;let se=0,U=0;for(let m=0;m<T.length;m++){const b=T[m];if(!b)continue;const f=p[b.index];if(!f)continue;const u=b.type==="translated"?f.translatedDataURL:f.originalDataURL;if(!u)continue;const y=10+m/j*70;a.value=y,l.value=`ä¸Šä¼ å›¾ç‰‡ ${m+1}/${j}...`;try{const I=await Ws(te,u,m);I.success?se++:(console.error(`ä¸Šä¼ å›¾ç‰‡ ${m} å¤±è´¥:`,I.error),U++)}catch(I){console.error(`ä¸Šä¼ å›¾ç‰‡ ${m} å‡ºé”™:`,I),U++}}if(se===0)throw new Error("æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å¤±è´¥");a.value=85,l.value="æ‰“åŒ…æ–‡ä»¶...";const Z=await Ks(te,h);if(!Z.success||!Z.file_id)throw new Error(Z.error||"æ‰“åŒ…å¤±è´¥");a.value=95,l.value="å‡†å¤‡ä¸‹è½½...";const ae=qs(Z.file_id,h),Y=document.createElement("a");Y.href=ae,document.body.appendChild(Y),Y.click(),document.body.removeChild(Y),a.value=100,l.value="ä¸‹è½½å·²å¼€å§‹";let v=`å·²æˆåŠŸå¤„ç† ${se} å¼ å›¾ç‰‡`;U>0&&(v+=`ï¼ˆ${U} å¼ å¤±è´¥ï¼‰`),S>0&&F>0?v+=`ï¼ˆ${S} å¼ ç¿»è¯‘å›¾ç‰‡å’Œ ${F} å¼ åŸå§‹å›¾ç‰‡ï¼‰`:S>0?v+="ï¼ˆå…¨éƒ¨ä¸ºç¿»è¯‘åå›¾ç‰‡ï¼‰":F>0&&(v+="ï¼ˆå…¨éƒ¨ä¸ºåŸå§‹å›¾ç‰‡ï¼‰"),v+="ï¼Œä¸‹è½½å³å°†å¼€å§‹",s.success(v),setTimeout(async()=>{try{const m=await wo();console.log("ä¸´æ—¶æ–‡ä»¶æ¸…ç†ç»“æœ:",m)}catch(m){console.error("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:",m)}},6e4)}catch(T){console.error("ä¸‹è½½æ‰€æœ‰å›¾ç‰‡æ—¶å‡ºé”™:",T),s.error(`ä¸‹è½½å¤±è´¥: ${T instanceof Error?T.message:String(T)}`)}finally{o.value=!1,setTimeout(()=>{a.value=0,l.value=""},2e3)}}return{isDownloading:o,downloadProgress:a,downloadProgressText:l,isImporting:r,importProgress:x,importProgressText:g,canExportText:i,canImportText:c,canDownload:C,exportText:$,exportTextToJson:R,importText:k,downloadCurrentImage:B,downloadAllImages:A}}const Hl={key:0,class:"result-section card result-card"},jl={class:"image-controls"},Jl={class:"image-size-control"},Gl=["value"],Yl={id:"imageSizeValue"},Xl={class:"content-container"},Zl={class:"image-container"},Ql=["src"],ei={id:"detectedTextInfo",class:"text-info"},ti={id:"detectedTextList"},oi={class:"original-text"},ni={class:"download-section"},si={class:"download-buttons"},ai=["disabled"],li={class:"download-all-container"},ii=["disabled"],ri={class:"download-format-selector"},ui=["disabled"],ci=["disabled"],di={key:1,class:"empty-state-section"},fo=60,gi=Ge({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(n,{emit:t}){const s=[{label:"ZIPå‹ç¼©åŒ…",value:"zip"},{label:"PDFæ–‡æ¡£",value:"pdf"},{label:"CBZæ¼«ç”»",value:"cbz"}],o=t,a=Ze(),l=Fe(),r=ql(),x=w(100),g=J({get:()=>D.value?.showOriginal??!1,set:y=>{D.value&&a.updateCurrentImage({showOriginal:y})}}),i=w("zip"),c=w(null),C=J(()=>r.isDownloading.value),$=J(()=>r.downloadProgressText.value),R=J(()=>r.downloadProgress.value),k=J(()=>a.hasImages),D=J(()=>a.currentImage),N=J(()=>!!D.value?.translatedDataURL),B=J(()=>!!(D.value?.translatedDataURL||D.value?.originalDataURL)),A=J(()=>D.value?g.value||!D.value.translatedDataURL?D.value.originalDataURL:D.value.translatedDataURL:""),h=J(()=>a.failedImageCount>0),p=J(()=>({width:`${x.value}%`})),T=J(()=>l.settings.useTextboxPrompt),S=J(()=>{if(!D.value)return[];if(D.value.bubbleStates&&D.value.bubbleStates.length>0)return D.value.bubbleStates.map(M=>({original:M.originalText||"",translated:T.value?M.textboxText||M.translatedText||"":M.translatedText||""}));const y=D.value.originalTexts||[],I=T.value?D.value.textboxTexts||D.value.bubbleTexts||[]:D.value.bubbleTexts||[];return y.length===0?[]:y.map((M,V)=>({original:M||"",translated:I[V]||""}))}),F=J(()=>S.value.length>0);function O(y){if(!y||y.length<=fo)return y;let I="",M="";for(let V=0;V<y.length;V++)if(M+=y[V],M.length>=fo){let G=-1;for(let d=M.length-1;d>=0;d--){const _=M[d];if(_&&["ã€‚","ï¼","ï¼Ÿ",".","!","?","ï¼›",";","ï¼Œ",","].includes(_)){G=d+1;break}}G>fo*.6?(I+=M.substring(0,G)+`
`,M=M.substring(G)):(I+=M+`
`,M="")}return M&&(I+=M),I}function te(y){return O((y||"").trim())}function j(y){const I=(y||"").trim();return O(I)}function se(y){const I=y||"";return I.includes("ã€ç¿»è¯‘å¤±è´¥ã€‘")||I.includes("[ç¿»è¯‘å¤±è´¥]")||I.includes("ç¿»è¯‘å¤±è´¥")}function U(){g.value=!g.value}function Z(){o("toggle-edit-mode")}function ae(y){const I=y.target;x.value=parseInt(I.value,10)}function Y(){o("retry-failed")}function v(){r.downloadCurrentImage()}function m(){r.downloadAllImages(i.value)}function b(){r.exportText()}function f(){c.value?.click()}async function u(y){const I=y.target,M=I.files?.[0];M&&(await r.importText(M),I.value="")}return(y,I)=>D.value?(E(),L("section",Hl,[e("div",jl,[N.value?(E(),L("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:U},ee(g.value?"æŸ¥çœ‹ç¿»è¯‘å›¾":"æŸ¥çœ‹åŸå›¾"),1)):ce("",!0),e("button",{id:"toggleEditModeButton",class:Re(["control-btn",{active:n.isEditMode}]),onClick:Z},ee(n.isEditMode?"é€€å‡ºç¼–è¾‘":"åˆ‡æ¢ç¼–è¾‘æ¨¡å¼"),3),e("div",Jl,[I[1]||(I[1]=e("label",{for:"imageSize"},"å›¾ç‰‡å¤§å°:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:x.value,class:"slider range-slider",onInput:ae},null,40,Gl),e("span",Yl,ee(x.value)+"%",1)]),h.value?(E(),L("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:Y,title:"é‡æ–°ç¿»è¯‘æ‰€æœ‰å¤±è´¥çš„å›¾ç‰‡"}," é‡æ–°ç¿»è¯‘å¤±è´¥å›¾ç‰‡ ("+ee(H(a).failedImageCount)+") ",1)):ce("",!0)]),e("div",Xl,[e("div",Zl,[e("img",{id:"translatedImageDisplay",src:A.value,alt:"ç¿»è¯‘åå›¾ç‰‡",style:ot(p.value)},null,12,Ql)])]),e("div",ei,[I[6]||(I[6]=e("h3",null,"æ£€æµ‹åˆ°çš„æ–‡æœ¬ï¼ˆåŸæ–‡ â†’ è¯‘æ–‡ï¼‰",-1)),e("pre",ti,[F.value?(E(!0),L(ze,{key:0},Ye(S.value,(M,V)=>(E(),L("span",{key:V,class:"text-item"},[e("span",oi,ee(te(M.original)),1),I[2]||(I[2]=ge(`
`,-1)),e("span",{class:Re(["translated-text",{"translation-error":se(M.translated)}])},ee(j(M.translated)),3),I[3]||(I[3]=ge(`
`,-1)),I[4]||(I[4]=e("span",{class:"separator"},"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",-1)),I[5]||(I[5]=ge(`

`,-1))]))),128)):(E(),L(ze,{key:1},[ge("æœªæ£€æµ‹åˆ°æ–‡æœ¬æˆ–å°šæœªç¿»è¯‘")],64))])]),e("div",ni,[C.value?(E(),ut(Po,{key:0,visible:!0,percentage:R.value,label:$.value||"ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™..."},null,8,["percentage","label"])):ce("",!0),e("div",si,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!B.value,onClick:v}," ä¸‹è½½å½“å‰å›¾ç‰‡ ",8,ai),e("div",li,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!k.value,onClick:m}," ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ ",8,ii),e("div",ri,[_e(We,{modelValue:i.value,"onUpdate:modelValue":I[0]||(I[0]=M=>i.value=M),options:s},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!k.value,onClick:b}," å¯¼å‡ºæ–‡æœ¬ ",8,ui),e("button",{id:"importTextButton",class:"download-btn success",disabled:!k.value,onClick:f}," å¯¼å…¥æ–‡æœ¬ ",8,ci),e("input",{type:"file",ref_key:"importFileInput",ref:c,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:u},null,544)])])])):(E(),L("section",di))}}),pi=Je(gi,[["__scopeId","data-v-7a09e8a5"]]),mi={class:"guide-content"},vi={class:"guide-footer"},fi={class:"dont-show-option"},jt="saber_translator_dismiss_setup_reminder",bi=Ge({__name:"FirstTimeGuide",emits:["openSettings"],setup(n,{expose:t,emit:s}){const o=s,a=w(!1),l=w(!1);dt(()=>{localStorage.getItem(jt)!=="true"&&(a.value=!0)});function r(){l.value&&localStorage.setItem(jt,"true"),a.value=!1}function x(){localStorage.setItem(jt,"true"),a.value=!1,o("openSettings")}function g(){localStorage.removeItem(jt)}return t({resetGuideState:g,showGuide:a}),(i,c)=>(E(),ut(En,{"model-value":a.value,title:"æ¬¢è¿ä½¿ç”¨ Saber-Translator",onClose:r},{default:xt(()=>[e("div",mi,[c[3]||(c[3]=e("div",{class:"guide-icon"},"ğŸ‰",-1)),c[4]||(c[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"é¦–æ¬¡ä½¿ç”¨æé†’"),e("p",{class:"guide-text"}," åœ¨å¼€å§‹ç¿»è¯‘ä¹‹å‰ï¼Œè¯·å…ˆé…ç½®ç¿»è¯‘æœåŠ¡ã€‚ "),e("p",{class:"guide-text"},[ge(" ç‚¹å‡»å³ä¸Šè§’çš„ "),e("span",{class:"highlight"},"âš™ï¸ è®¾ç½®"),ge(" æŒ‰é’®ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š ")]),e("ul",{class:"guide-list"},[e("li",null,"é€‰æ‹© OCR å¼•æ“ï¼ˆæ–‡å­—è¯†åˆ«ï¼‰"),e("li",null,"é…ç½®ç¿»è¯‘æœåŠ¡å•†å’Œ API Key"),e("li",null,"ï¼ˆå¯é€‰ï¼‰é…ç½®é«˜è´¨é‡ç¿»è¯‘å’Œ AI æ ¡å¯¹")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:x},[...c[1]||(c[1]=[e("span",{class:"btn-icon"},"âš™ï¸",-1),ge(" ç«‹å³é…ç½® ",-1)])]),e("button",{class:"guide-btn secondary",onClick:r}," ç¨åé…ç½® ")]),e("div",vi,[e("label",fi,[oe(e("input",{type:"checkbox","onUpdate:modelValue":c[0]||(c[0]=C=>l.value=C)},null,512),[[Xe,l.value]]),c[2]||(c[2]=e("span",null,"ä¸å†æ˜¾ç¤ºæ­¤æé†’",-1))])])])]),_:1},8,["model-value"]))}}),hi=Je(bi,[["__scopeId","data-v-eda18e4a"]]),bo="saber_translator_dismiss_setup_reminder",xi=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],yi={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"ç™¾åº¦OCR",ai_vision:"AIè§†è§‰OCR"},Ci=["ollama","sakura"],_i=["custom_openai"],ki=["custom_openai"],Si={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰ OpenAI",ollama:"Ollama",sakura:"Sakura"};function Nn(){const n=Fe(),t=ct(),s=w(!1),o=w(!1),a=J(()=>{try{return localStorage.getItem(bo)==="true"}catch{return!1}});function l(S){return Si[S]||S}function r(S){return xi.includes(S)}function x(S){return Ci.includes(S)}function g(S){return _i.includes(S)}function i(S){return ki.includes(S)}function c(S){return yi[S]||S}function C(){const S=n.settings,F=S.ocrEngine,O=S.baiduOcr,te=S.aiVisionOcr,j=[];return F?(F==="baidu_ocr"&&((!O?.apiKey||O.apiKey.trim()==="")&&j.push("ç™¾åº¦OCR çš„ API Key"),(!O?.secretKey||O.secretKey.trim()==="")&&j.push("ç™¾åº¦OCR çš„ Secret Key")),F==="ai_vision"&&(te?.provider||j.push("AIè§†è§‰OCR çš„æœåŠ¡å•†"),(!te?.apiKey||te.apiKey.trim()==="")&&j.push("AIè§†è§‰OCR çš„ API Key"),(!te?.modelName||te.modelName.trim()==="")&&j.push("AIè§†è§‰OCR çš„æ¨¡å‹åç§°"),te?.provider==="custom"&&(!te?.customBaseUrl||te.customBaseUrl.trim()==="")&&j.push("AIè§†è§‰OCR çš„è‡ªå®šä¹‰ Base URL")),j.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${j[0]}`,missingItems:j}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹© OCR å¼•æ“",missingItems:["OCR å¼•æ“"]}}function $(){const{translation:S}=n.settings,{provider:F,apiKey:O,modelName:te,customBaseUrl:j}=S,se=[];return F?(r(F)&&(!O||O.trim()==="")&&se.push(`${l(F)} çš„ API Key`),(!te||te.trim()==="")&&(x(F)||r(F))&&se.push(`${l(F)} çš„æ¨¡å‹åç§°`),g(F)&&(!j||j.trim()==="")&&se.push("è‡ªå®šä¹‰ OpenAI æœåŠ¡çš„ Base URL"),se.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${se[0]}`,missingItems:se}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©ç¿»è¯‘æœåŠ¡å•†",missingItems:["ç¿»è¯‘æœåŠ¡å•†"]}}function R(){const{hqTranslation:S}=n.settings,{provider:F,apiKey:O,modelName:te,customBaseUrl:j}=S,se=[];return F?((!O||O.trim()==="")&&se.push("é«˜è´¨é‡ç¿»è¯‘çš„ API Key"),(!te||te.trim()==="")&&se.push("é«˜è´¨é‡ç¿»è¯‘çš„æ¨¡å‹åç§°"),i(F)&&(!j||j.trim()==="")&&se.push("é«˜è´¨é‡ç¿»è¯‘çš„ Base URL"),se.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${se[0]}`,missingItems:se}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©é«˜è´¨é‡ç¿»è¯‘çš„æœåŠ¡å•†",missingItems:["é«˜è´¨é‡ç¿»è¯‘æœåŠ¡å•†"]}}function k(S){const F=S||n.settings.proofreading.rounds,O=[];if(!F||F.length===0)return{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­æ·»åŠ è‡³å°‘ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡",missingItems:["æ ¡å¯¹è½®æ¬¡"]};for(let te=0;te<F.length;te++){const j=F[te];if(!j)continue;const se=j.name||`è½®æ¬¡${te+1}`;if(j.provider||O.push(`æ ¡å¯¹ ${se} çš„æœåŠ¡å•†`),(!j.apiKey||j.apiKey.trim()==="")&&O.push(`æ ¡å¯¹ ${se} çš„ API Key`),(!j.modelName||j.modelName.trim()==="")&&O.push(`æ ¡å¯¹ ${se} çš„æ¨¡å‹åç§°`),O.length>0)return{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­ä¸º ${O[0]}`,missingItems:O}}return{valid:!0,message:""}}function D(S="normal",F={}){let O;switch(S){case"normal":O=$();break;case"hq":O=R();break;case"proofread":O=k(F.proofreadingRounds);break;case"ocr":O=C();break;default:O=$()}return O.valid?!0:(t.error(O.message),B(),!1)}function N(){const S=C();if(!S.valid)return t.error(S.message),B(),!1;const F=$();return F.valid?!0:(t.error(F.message),B(),!1)}function B(){const S=document.getElementById("openSettingsBtn");S&&(o.value=!0,S.style.animation="settingsBtnPulse 0.5s ease-in-out 3",S.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{S.style.animation="",S.style.boxShadow="",o.value=!1},3e3))}function A(){if(a.value){console.log("ç”¨æˆ·å·²é€‰æ‹©ä¸å†æ˜¾ç¤ºè®¾ç½®æé†’");return}s.value=!0}function h(S=!1){if(S)try{localStorage.setItem(bo,"true"),console.log("ç”¨æˆ·é€‰æ‹©æ°¸ä¹…å…³é—­è®¾ç½®æé†’")}catch(F){console.error("ä¿å­˜è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",F)}s.value=!1}function p(){try{localStorage.removeItem(bo),console.log("è®¾ç½®æé†’çŠ¶æ€å·²é‡ç½®")}catch(S){console.error("é‡ç½®è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",S)}}function T(){setTimeout(()=>{A()},500)}return{showSetupReminder:s,isSettingsButtonHighlighted:o,isSetupReminderDismissed:a,validateOcrConfig:C,validateTranslationConfig:$,validateHqTranslationConfig:R,validateProofreadingConfig:k,validateBeforeTranslation:D,validateFullTranslationConfig:N,highlightSettingsButton:B,checkAndShowSetupReminder:A,closeSetupReminder:h,resetSetupReminderDismiss:p,initValidation:T,getProviderDisplayName:l,getOcrEngineDisplayName:c,requiresApiKey:r,isLocalProvider:x,requiresBaseUrl:g}}const gt=eo("bubble",()=>{const n=w([]),t=w(-1),s=w([]),o=w([]),a=w(!1),l=w(-1),r=w(0),x=w(0),g=w(0),i=w(0),c=w(!1),C=w(-1),$=w(null),R=w(!1),k=w(-1),D=w(0),N=J(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),B=J(()=>n.value.length),A=J(()=>n.value.length>0),h=J(()=>t.value>=0),p=J(()=>s.value.length>1),T=J(()=>s.value.filter(z=>z>=0&&z<n.value.length).map(z=>n.value[z]).filter(z=>z!==void 0));function S(){const X=Ze().currentImage;X&&(X.bubbleStates=Ht(n.value),X.hasUnsavedChanges=!0,console.log("æ°”æ³¡çŠ¶æ€å·²åŒæ­¥åˆ°å½“å‰å›¾ç‰‡"))}function F(z,X=!1){n.value=z,o.value=Ht(z),Y(),console.log(`æ°”æ³¡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${z.length} ä¸ªæ°”æ³¡`),X||S()}function O(z,X){const pe=ba(z),ke=Fe().settings.textStyle,$e=ke.layoutDirection,Me=$e==="vertical"||$e==="horizontal"?$e:pe==="vertical"||pe==="horizontal"?pe:"vertical",re=fa({coords:z,translatedText:"",autoTextDirection:pe,fontSize:ke.fontSize,fontFamily:ke.fontFamily,textDirection:Me,textColor:ke.textColor,fillColor:ke.fillColor,inpaintMethod:ke.inpaintMethod,strokeEnabled:ke.strokeEnabled,strokeColor:ke.strokeColor,strokeWidth:ke.strokeWidth,rotationAngle:0,position:{x:0,y:0},...X});return n.value.push(re),console.log(`å·²æ·»åŠ æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),S(),re}function te(z){return z<0||z>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${z}`),!1):(n.value.splice(z,1),t.value===z?t.value=-1:t.value>z&&t.value--,s.value=s.value.filter(X=>X!==z).map(X=>X>z?X-1:X),console.log(`å·²åˆ é™¤æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),S(),!0)}function j(){if(s.value.length===0&&t.value<0)return;const z=[...new Set([...s.value,t.value])].filter(X=>X>=0).sort((X,pe)=>pe-X);for(const X of z)n.value.splice(X,1);Y(),console.log(`å·²åˆ é™¤ ${z.length} ä¸ªæ°”æ³¡`),S()}function se(){n.value=[],o.value=[],Y(),console.log("æ‰€æœ‰æ°”æ³¡å·²æ¸…é™¤"),S()}function U(){n.value=[],o.value=[],Y(),console.log("æœ¬åœ°æ°”æ³¡çŠ¶æ€å·²æ¸…é™¤ï¼ˆä¸åŒæ­¥åˆ°imageStoreï¼‰")}function Z(z){z>=-1&&z<n.value.length&&(t.value=z,s.value=z>=0?[z]:[],console.log(`å·²é€‰ä¸­æ°”æ³¡ ${z}`))}function ae(z){if(z<0||z>=n.value.length)return;const X=s.value.indexOf(z);X>=0?(s.value.splice(X,1),t.value===z&&(t.value=s.value[0]??-1)):(s.value.push(z),t.value=z),console.log(`å¤šé€‰çŠ¶æ€: ${s.value.join(", ")}`)}function Y(){t.value=-1,s.value=[]}function v(){t.value>=0?s.value=[t.value]:s.value=[]}function m(){if(n.value.length===0)return!1;const z=t.value<n.value.length-1?t.value+1:0;return Z(z),!0}function b(){if(n.value.length===0)return!1;const z=t.value>0?t.value-1:n.value.length-1;return Z(z),!0}function f(z,X){if(z<0||z>=n.value.length)return console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${z}`),!1;const pe=n.value[z];return pe?(Object.assign(pe,X),console.log(`å·²æ›´æ–°æ°”æ³¡ ${z}`),S(),!0):!1}function u(z){return t.value<0?(console.warn("æ›´æ–°å¤±è´¥: æ²¡æœ‰é€‰ä¸­çš„æ°”æ³¡"),!1):f(t.value,z)}function y(z){const X=s.value.length>0?s.value:t.value>=0?[t.value]:[];for(const pe of X){const Ce=n.value[pe];Ce&&Object.assign(Ce,z)}S(),console.log(`å·²æ‰¹é‡æ›´æ–° ${X.length} ä¸ªæ°”æ³¡`)}function I(z){for(let X=0;X<n.value.length;X++){const pe=n.value[X];pe&&Object.assign(pe,z)}S(),console.log(`å·²æ›´æ–°æ‰€æœ‰ ${n.value.length} ä¸ªæ°”æ³¡`)}function M(){if(n.value.length!==o.value.length)return!0;for(let z=0;z<n.value.length;z++){const X=n.value[z],pe=o.value[z];if(!(!X||!pe)&&(X.translatedText!==pe.translatedText||X.textboxText!==pe.textboxText||X.fontSize!==pe.fontSize||X.fontFamily!==pe.fontFamily||X.textDirection!==pe.textDirection||X.textColor!==pe.textColor||X.fillColor!==pe.fillColor||X.rotationAngle!==pe.rotationAngle||X.strokeEnabled!==pe.strokeEnabled||X.strokeColor!==pe.strokeColor||X.strokeWidth!==pe.strokeWidth||X.inpaintMethod!==pe.inpaintMethod||JSON.stringify(X.coords)!==JSON.stringify(pe.coords)))return!0}return!1}function V(){n.value=Ht(o.value),Y(),console.log("æ°”æ³¡çŠ¶æ€å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€")}function G(){o.value=Ht(n.value),console.log("å½“å‰çŠ¶æ€å·²ä¿å­˜ä¸ºåˆå§‹çŠ¶æ€")}function d(){return{bubble_coords:n.value.map(z=>z.coords),bubble_texts:n.value.map(z=>z.translatedText),textbox_texts:n.value.map(z=>z.textboxText),font_sizes:n.value.map(z=>z.fontSize),font_families:n.value.map(z=>z.fontFamily),text_directions:n.value.map(z=>z.textDirection==="vertical"||z.textDirection==="horizontal"?z.textDirection==="vertical"?"v":"h":z.autoTextDirection==="vertical"||z.autoTextDirection==="horizontal"?z.autoTextDirection==="vertical"?"v":"h":"v"),text_colors:n.value.map(z=>z.textColor),fill_colors:n.value.map(z=>z.fillColor),rotation_angles:n.value.map(z=>z.rotationAngle),stroke_enabled:n.value.map(z=>z.strokeEnabled),stroke_colors:n.value.map(z=>z.strokeColor),stroke_widths:n.value.map(z=>z.strokeWidth),inpaint_methods:n.value.map(z=>z.inpaintMethod)}}function _(){return JSON.stringify(n.value)}function ie(z){try{const X=JSON.parse(z);if(!Array.isArray(X))return console.error("ååºåˆ—åŒ–å¤±è´¥: æ•°æ®ä¸æ˜¯æ•°ç»„"),!1;const pe=[];for(const Ce of X)ha(Ce)?pe.push(Ce):console.warn("è·³è¿‡æ— æ•ˆçš„æ°”æ³¡çŠ¶æ€:",Ce);return F(pe),!0}catch(X){return console.error("ååºåˆ—åŒ–å¤±è´¥:",X),!1}}return{bubbles:n,selectedIndex:t,selectedIndices:s,initialStates:o,isDragging:a,draggingIndex:l,dragOffsetX:r,dragOffsetY:x,dragInitialX:g,dragInitialY:i,isResizing:c,resizingIndex:C,resizeCurrentCoords:$,isRotating:R,rotatingIndex:k,rotateCurrentAngle:D,selectedBubble:N,bubbleCount:B,hasBubbles:A,hasSelection:h,isMultiSelect:p,selectedBubbles:T,setBubbles:F,addBubble:O,deleteBubble:te,deleteSelected:j,clearBubbles:se,clearBubblesLocal:U,selectBubble:Z,toggleMultiSelect:ae,clearSelection:Y,clearMultiSelect:v,selectNext:m,selectPrevious:b,updateBubble:f,updateSelectedBubble:u,updateAllSelected:y,updateAllBubbles:I,hasChanges:M,resetToInitial:V,saveAsInitial:G,toApiRequest:d,serialize:_,deserialize:ie}}),wi=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:gt},Symbol.toStringTag,{value:"Module"}));function $i(){const n=w({current:0,total:0,completed:0,failed:0,isInProgress:!1,label:"",percentage:0});return{progress:n,reporter:{init(s,o){n.value={current:0,total:s,completed:0,failed:0,isInProgress:!0,label:o||"å‡†å¤‡ä¸­...",percentage:0}},update(s,o){n.value.current=s,o!==void 0&&(n.value.label=o),n.value.total>0&&(n.value.percentage=Math.round(s/n.value.total*100))},setPercentage(s,o){n.value.percentage=Math.min(100,Math.max(0,s)),o!==void 0&&(n.value.label=o)},incrementCompleted(){n.value.completed++},incrementFailed(){n.value.failed++},finish(){n.value.isInProgress=!1,n.value.percentage=100},getProgress(){return{...n.value}}}}}async function xn(n){return et.post("/api/parallel/detect",n)}async function Ti(n){return et.post("/api/parallel/ocr",n)}async function Ii(n){return et.post("/api/parallel/color",n)}async function Vn(n){return et.post("/api/parallel/translate",n)}async function Pi(n){return et.post("/api/parallel/inpaint",n)}async function Ri(n){return et.post("/api/parallel/render",n)}async function zt(n){const{imageIndex:t,image:s,forceDetect:o=!1}=n,a=Fe(),l=s.bubbleStates;if(!o&&l!==null&&l!==void 0)return l.length>0?(console.log(`å›¾ç‰‡ ${t+1} å·²æœ‰ ${l.length} ä¸ªæ°”æ³¡ï¼Œè·³è¿‡æ£€æµ‹`),{bubbleCoords:l.map(c=>c.coords.map(C=>Math.round(C))),bubbleAngles:l.map(c=>c.rotationAngle||0),bubblePolygons:l.map(c=>c.polygon||[]),autoDirections:l.map(c=>c.autoTextDirection||c.textDirection||"vertical"),textMask:s.textMask??void 0,textlinesPerBubble:[],originalTexts:l.map(c=>c.originalText||"")}):(console.log(`å›¾ç‰‡ ${t+1} æ°”æ³¡å·²è¢«æ¸…ç©ºï¼Œè·³è¿‡æ£€æµ‹`),{bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],textMask:void 0,textlinesPerBubble:[],originalTexts:[]});const r=a.settings,x=Di(s.originalDataURL),g=await xn({image:x,detector_type:r.textDetector,box_expand_ratio:r.boxExpand.ratio,box_expand_top:r.boxExpand.top,box_expand_bottom:r.boxExpand.bottom,box_expand_left:r.boxExpand.left,box_expand_right:r.boxExpand.right});if(!g.success)throw new Error(g.error||"æ£€æµ‹å¤±è´¥");let i;console.log("ä½¿ç”¨ Default æ£€æµ‹å™¨ç”Ÿæˆç²¾ç¡®æ–‡å­—æ©è†œ...");try{const c=await xn({image:x,detector_type:"default",box_expand_ratio:0,box_expand_top:0,box_expand_bottom:0,box_expand_left:0,box_expand_right:0});c.success&&c.raw_mask?(i=c.raw_mask,console.log("âœ… ç²¾ç¡®æ–‡å­—æ©è†œç”ŸæˆæˆåŠŸ")):console.warn("âš ï¸ Default æ£€æµ‹å™¨æœªèƒ½ç”Ÿæˆæ©è†œ")}catch(c){console.error("âŒ ç”Ÿæˆç²¾ç¡®æ–‡å­—æ©è†œå¤±è´¥:",c)}return{bubbleCoords:g.bubble_coords||[],bubbleAngles:g.bubble_angles||[],bubblePolygons:g.bubble_polygons||[],autoDirections:g.auto_directions||[],textMask:i,textlinesPerBubble:g.textlines_per_bubble||[]}}function Di(n){return n.includes("base64,")?n.split("base64,")[1]||"":n}function yo(n,t,s){const o=Ze(),a={bubbleCoords:t.bubbleCoords,bubbleAngles:t.bubbleAngles,textMask:t.textMask||null};s?.updateBubbleStates&&s.bubbleStates&&(a.bubbleStates=s.bubbleStates),o.updateImageByIndex(n,a)}async function Ro(n){const{image:t,bubbleCoords:s,textlinesPerBubble:o}=n;if(s.length===0)return{originalTexts:[]};const l=Fe().settings,r=Mi(t.originalDataURL),x=l.ocrEngine==="paddleocr_vl"?l.paddleOcrVl?.sourceLanguage||"japanese":l.sourceLanguage,g=await Ti({image:r,bubble_coords:s,source_language:x,ocr_engine:l.ocrEngine,baidu_api_key:l.baiduOcr?.apiKey,baidu_secret_key:l.baiduOcr?.secretKey,baidu_version:l.baiduOcr?.version,baidu_ocr_language:l.baiduOcr?.sourceLanguage,ai_vision_provider:l.aiVisionOcr?.provider,ai_vision_api_key:l.aiVisionOcr?.apiKey,ai_vision_model_name:l.aiVisionOcr?.modelName,ai_vision_ocr_prompt:l.aiVisionOcr?.prompt,custom_ai_vision_base_url:l.aiVisionOcr?.customBaseUrl,textlines_per_bubble:o});if(!g.success)throw new Error(g.error||"OCRå¤±è´¥");return{originalTexts:g.original_texts||[]}}function Mi(n){return n.includes("base64,")?n.split("base64,")[1]||"":n}async function Do(n){const{image:t,bubbleCoords:s,textlinesPerBubble:o}=n;if(s.length===0)return{colors:[]};const a=Bi(t.originalDataURL),l=await Ii({image:a,bubble_coords:s,textlines_per_bubble:o});if(!l.success)throw new Error(l.error||"é¢œè‰²æå–å¤±è´¥");return{colors:l.colors||[]}}function Bi(n){return n.includes("base64,")?n.split("base64,")[1]||"":n}async function Wn(n){const{originalTexts:t,rateLimiter:s=null}=n;if(t.length===0)return{translatedTexts:[],textboxTexts:[]};const a=Fe().settings;if((a.translation.translationMode||"batch")==="single"){console.log(`[ç¿»è¯‘] ä½¿ç”¨é€æ°”æ³¡ç¿»è¯‘æ¨¡å¼ï¼Œå…± ${t.length} ä¸ªæ°”æ³¡`);const r=[],x=[];for(let g=0;g<t.length;g++){const i=t[g];if(!i||i.trim()===""){r.push(""),a.useTextboxPrompt&&x.push("");continue}try{const c=a.translation.isJsonMode?a.translation.singleJsonPrompt:a.translation.singleNormalPrompt,C=await Ft({original_text:i,model_provider:a.translation.provider,model_name:a.translation.modelName,api_key:a.translation.apiKey,custom_base_url:a.translation.customBaseUrl,target_language:a.targetLanguage,prompt_content:c,use_json_format:a.translation.isJsonMode,rpm_limit_translation:a.translation.rpmLimit,max_retries:a.translation.maxRetries});if(C.success&&C.data?r.push(C.data.translated_text||""):(console.warn(`[ç¿»è¯‘] æ°”æ³¡ ${g+1} ç¿»è¯‘å¤±è´¥: ${C.error}`),r.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—")),a.useTextboxPrompt&&a.textboxPrompt){const $=await Ft({original_text:i,model_provider:a.translation.provider,model_name:a.translation.modelName,api_key:a.translation.apiKey,custom_base_url:a.translation.customBaseUrl,target_language:a.targetLanguage,prompt_content:a.textboxPrompt,rpm_limit_translation:a.translation.rpmLimit,max_retries:a.translation.maxRetries});$.success&&$.data?x.push($.data.translated_text||""):x.push("")}s&&g<t.length-1&&await s.acquire()}catch(c){console.error(`[ç¿»è¯‘] æ°”æ³¡ ${g+1} ç¿»è¯‘å‡ºé”™:`,c),r.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—"),a.useTextboxPrompt&&x.push("")}}return console.log(`[ç¿»è¯‘] é€æ°”æ³¡ç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${r.filter(g=>g&&!g.startsWith("[ç¿»è¯‘")).length}/${t.length}`),{translatedTexts:r,textboxTexts:x}}else{console.log(`[ç¿»è¯‘] ä½¿ç”¨æ•´é¡µæ‰¹é‡ç¿»è¯‘æ¨¡å¼ï¼Œå…± ${t.length} ä¸ªæ°”æ³¡`);const r=await Vn({original_texts:t,target_language:a.targetLanguage,source_language:a.sourceLanguage,model_provider:a.translation.provider,model_name:a.translation.modelName,api_key:a.translation.apiKey,custom_base_url:a.translation.customBaseUrl,prompt_content:a.translatePrompt,textbox_prompt_content:a.textboxPrompt,use_textbox_prompt:a.useTextboxPrompt,rpm_limit:a.translation.rpmLimit,max_retries:a.translation.maxRetries,use_json_format:a.translation.isJsonMode});if(!r.success)throw new Error(r.error||"ç¿»è¯‘å¤±è´¥");return{translatedTexts:r.translated_texts||[],textboxTexts:r.textbox_texts||[]}}}async function Kn(n){const s=Fe().settings,o=n.mode==="proofread",a=n.tasks.map(N=>o?{imageIndex:N.imageIndex,bubbles:(N.image.bubbleStates||[]).map((B,A)=>({bubbleIndex:A,original:B.originalText||"",translated:s.useTextboxPrompt?B.textboxText||B.translatedText||"":B.translatedText||"",textDirection:B.textDirection==="vertical"||B.textDirection==="horizontal"?B.textDirection:B.autoTextDirection==="vertical"||B.autoTextDirection==="horizontal"?B.autoTextDirection:"vertical"}))}:{imageIndex:N.imageIndex,bubbles:(N.originalTexts||[]).map((B,A)=>({bubbleIndex:A,original:B,translated:"",textDirection:N.autoDirections?.[A]||"vertical"}))}),l=n.tasks.map(N=>{const B=o&&N.image.translatedDataURL||N.image.originalDataURL;return Ai(B)}),r=o?s.proofreading.rounds[0]:s.hqTranslation,x=o?r?.prompt:s.hqTranslation.prompt,g=o?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",i=s.hqTranslation,c=o?r:null,C=await Ut({provider:(o?c?.provider:i.provider)||"openai",api_key:(o?c?.apiKey:i.apiKey)||"",model_name:(o?c?.modelName:i.modelName)||"",custom_base_url:o?c?.customBaseUrl:i.customBaseUrl,jsonData:a,imageBase64Array:l,prompt:x||"",systemPrompt:g,isProofreading:o,enableDebugLogs:s.enableVerboseLogs,low_reasoning:o?c?.lowReasoning:i.lowReasoning,force_json_output:o?c?.forceJsonOutput:i.forceJsonOutput,no_thinking_method:o?c?.noThinkingMethod:i.noThinkingMethod,use_stream:o?c?.useStream??!0:i.useStream,max_retries:o?s.proofreading.maxRetries||2:i.maxRetries||2}),$=o?c?.forceJsonOutput||!1:i.forceJsonOutput;let k=yn(C,$)||a;if(o&&s.proofreading.rounds.length>1)for(let N=1;N<s.proofreading.rounds.length;N++){const B=s.proofreading.rounds[N],A=await Ut({provider:B.provider,api_key:B.apiKey,model_name:B.modelName,custom_base_url:B.customBaseUrl,jsonData:k,imageBase64Array:l,prompt:B.prompt,systemPrompt:g,isProofreading:!0,enableDebugLogs:s.enableVerboseLogs,low_reasoning:B.lowReasoning,force_json_output:B.forceJsonOutput,no_thinking_method:B.noThinkingMethod,use_stream:B.useStream??!0,max_retries:B.maxRetries||s.proofreading.maxRetries||2}),h=yn(A,B.forceJsonOutput);h&&(k=h)}return{results:n.tasks.map(N=>{const B=k?.find(A=>A.imageIndex===N.imageIndex);return B?{imageIndex:N.imageIndex,translatedTexts:B.bubbles.map(A=>A.translated),textboxTexts:[]}:{imageIndex:N.imageIndex,translatedTexts:[],textboxTexts:[]}})}}function Ai(n){return n.includes("base64,")?n.split("base64,")[1]||"":n}function yn(n,t){if(!n.success)return console.error("APIè°ƒç”¨å¤±è´¥:",n.error),null;if(n.results&&n.results.length>0){const o=n.results[0];if(o&&"imageIndex"in o&&"bubbles"in o)return n.results}const s=n.content;if(s){let o=null;if(t)try{o=JSON.parse(s)}catch{return null}else{const a=s.match(/```json\s*([\s\S]*?)\s*```/);if(a?.[1])try{o=JSON.parse(a[1])}catch{return null}}if(o){if(Array.isArray(o))return o;if(typeof o=="object"&&"imageIndex"in o&&"bubbles"in o)return console.log("[executeAiTranslate] æ£€æµ‹åˆ°å•å¼ å›¾ç‰‡æ ¼å¼ï¼Œè‡ªåŠ¨åŒ…è£…ä¸ºæ•°ç»„"),[o]}}return null}async function Mo(n){const{image:t,bubbleCoords:s,bubblePolygons:o,textMask:a,userMask:l}=n;if(s.length===0)return{cleanImage:Cn(t.originalDataURL)};const x=Fe().settings,{textStyle:g,preciseMask:i}=x,c=Cn(t.originalDataURL);console.log(`ä¿®å¤æ­¥éª¤ - textMask: ${a?"âœ…":"âŒ"}, userMask: ${l?"âœ…":"âŒ"}`);const C=await Pi({image:c,bubble_coords:s,bubble_polygons:o,raw_mask:a||void 0,user_mask:l||void 0,method:g.inpaintMethod==="solid"?"solid":"lama",lama_model:g.inpaintMethod==="litelama"?"litelama":"lama_mpe",fill_color:g.fillColor,mask_dilate_size:i.dilateSize,mask_box_expand_ratio:i.boxExpandRatio});if(!C.success)throw new Error(C.error||"èƒŒæ™¯ä¿®å¤å¤±è´¥");return{cleanImage:C.clean_image||""}}function Cn(n){return n.includes("base64,")?n.split("base64,")[1]||"":n}async function Qt(n){const{cleanImage:t,bubbleCoords:s,bubbleAngles:o,autoDirections:a,originalTexts:l,translatedTexts:r,textboxTexts:x,colors:g,savedTextStyles:i,currentMode:c}=n;if(!t)throw c==="proofread"?new Error("æ­¤å›¾ç‰‡å°šæœªç¿»è¯‘ï¼Œè¯·å…ˆç¿»è¯‘åå†è¿›è¡Œæ ¡å¯¹"):new Error("ç¼ºå°‘å¹²å‡€èƒŒæ™¯å›¾ç‰‡");const C=Fe(),{textStyle:$}=C.settings,R=i?.autoTextDirection?"auto":i?.textDirection||$.layoutDirection,k=s.map((N,B)=>{const A=a[B]||"vertical",h=A==="v"?"vertical":A==="h"?"horizontal":A==="vertical"||A==="horizontal"?A:"vertical",p=R==="vertical"||R==="horizontal"?R:h,T=i?.useAutoTextColor??$.useAutoTextColor;let S=i?.textColor||$.textColor,F=i?.fillColor||$.fillColor;const O=g[B];return T&&O&&(O.textColor&&(S=O.textColor),O.bgColor&&(F=O.bgColor)),{coords:N,polygon:[],position:{x:0,y:0},rotationAngle:o[B]||0,originalText:l[B]||"",translatedText:r[B]||"",textboxText:x[B]||"",textDirection:p,autoTextDirection:h,fontSize:i?.fontSize||$.fontSize,fontFamily:i?.fontFamily||$.fontFamily,autoFontSize:i?.autoFontSize??$.autoFontSize,textColor:S,fillColor:F,strokeEnabled:i?.strokeEnabled??$.strokeEnabled,strokeColor:i?.strokeColor||$.strokeColor,strokeWidth:i?.strokeWidth||$.strokeWidth,inpaintMethod:i?.inpaintMethod||$.inpaintMethod,autoFgColor:g[B]?.autoFgColor||null,autoBgColor:g[B]?.autoBgColor||null}}),D=await Ri({clean_image:t,bubble_states:k,fontSize:i?.fontSize||$.fontSize,fontFamily:i?.fontFamily||$.fontFamily,textDirection:i?.textDirection||$.layoutDirection,textColor:i?.textColor||$.textColor,strokeEnabled:i?.strokeEnabled??$.strokeEnabled,strokeColor:i?.strokeColor||$.strokeColor,strokeWidth:i?.strokeWidth||$.strokeWidth,autoFontSize:i?.autoFontSize??$.autoFontSize,use_individual_styles:!0});if(!D.success)throw new Error(D.error||"æ¸²æŸ“å¤±è´¥");return{finalImage:D.final_image||"",bubbleStates:D.bubble_states||k}}const Ei=Object.freeze(Object.defineProperty({__proto__:null,executeAiTranslate:Kn,executeColor:Do,executeDetection:zt,executeInpaint:Mo,executeOcr:Ro,executeRender:Qt,executeTranslate:Wn,saveDetectionResultToImage:yo},Symbol.toStringTag,{value:"Module"}));let wt=null,Nt=!1;function Tt(){const n=$t();return Fe().settings.autoSaveInBookshelfMode&&n.isBookshelfMode}function Bo(){const n=$t(),t=n.currentBookId,s=n.currentChapterId;return!t||!s?null:`bookshelf/${t}/chapters/${s}/session`}function qn(){const n=Fe(),{textStyle:t}=n.settings;return{fontSize:t.fontSize,autoFontSize:t.autoFontSize,fontFamily:t.fontFamily,layoutDirection:t.layoutDirection,textColor:t.textColor,useInpaintingMethod:t.inpaintMethod,fillColor:t.fillColor,strokeEnabled:t.strokeEnabled,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,useAutoTextColor:t.useAutoTextColor}}async function Hn(n){const t=Ze();if(!Tt())return console.log("[AutoSave] è‡ªåŠ¨ä¿å­˜æœªå¯ç”¨æˆ–éä¹¦æ¶æ¨¡å¼ï¼Œè·³è¿‡é¢„ä¿å­˜"),!0;const s=Bo();if(!s)return console.warn("[AutoSave] ç¼ºå°‘ä¹¦ç±/ç« èŠ‚IDï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("ç¼ºå°‘ä¹¦ç±/ç« èŠ‚ID"),!1;const o=t.images,a=o.length;if(a===0)return console.warn("[AutoSave] æ²¡æœ‰å›¾ç‰‡ï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("æ²¡æœ‰å›¾ç‰‡"),!1;console.log(`[AutoSave] é¢„ä¿å­˜å¼€å§‹ï¼š${a} é¡µï¼ˆé€é¡µä¿å­˜ï¼‰`),n?.onStart?.(a);try{const{saveAllPagesSequentially:l,saveSessionMeta:r}=await it(async()=>{const{saveAllPagesSequentially:$,saveSessionMeta:R}=await Promise.resolve().then(()=>zn);return{saveAllPagesSequentially:$,saveSessionMeta:R}},void 0),x=qn(),g=await l(s,o,{onProgress:($,R)=>{n?.onProgress?.($,R)}});await r(s,{ui_settings:x,total_pages:a,currentImageIndex:t.currentImageIndex});const i=$t(),c=i.currentBookId,C=i.currentChapterId;if(c&&C)try{const{apiClient:$}=await it(async()=>{const{apiClient:R}=await import("./client.Bht704G-.js");return{apiClient:R}},__vite__mapDeps([1,2]));await $.put(`/api/bookshelf/books/${c}/chapters/${C}/image-count`,{count:a}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${a}`)}catch($){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",$)}return wt=s,Nt=!0,console.log(`[AutoSave] é¢„ä¿å­˜å®Œæˆï¼Œå…±ä¿å­˜ ${g}/${a} é¡µ`),n?.onComplete?.(),!0}catch(l){console.error("[AutoSave] é¢„ä¿å­˜å¤±è´¥:",l);const r=l instanceof Error?l.message:"é¢„ä¿å­˜å¤±è´¥";return n?.onError?.(r),wt=null,Nt=!1,!1}}async function jn(n){if(!Tt())return;const t=wt||Bo();if(!t){console.warn("[AutoSave] ä¼šè¯è·¯å¾„ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜");return}const s=Ze(),o=s.images[n];if(!o){console.warn(`[AutoSave] é¡µé¢ ${n} ä¸å­˜åœ¨`);return}try{const a={};o.translatedDataURL?.startsWith("data:")&&(a.translated=o.translatedDataURL),o.cleanImageData&&typeof o.cleanImageData=="string"&&!o.cleanImageData.startsWith("/api/")&&(a.clean=o.cleanImageData.startsWith("data:")?o.cleanImageData:`data:image/png;base64,${o.cleanImageData}`);const l={};for(const x of Object.keys(o))["originalDataURL","translatedDataURL","cleanImageData"].includes(x)||(l[x]=o[x]);a.meta=l;const r=await On(t,n,a);if(!r.success)throw new Error(r.error||"ä¿å­˜å¤±è´¥");s.updateImageByIndex(n,{hasUnsavedChanges:!1}),console.log(`[AutoSave] é¡µé¢ ${n+1} å·²ä¿å­˜`)}catch(a){throw console.error(`[AutoSave] ä¿å­˜é¡µé¢ ${n+1} å¤±è´¥:`,a),a}}async function Jn(){if(!Tt())return;const n=wt||Bo();if(!n||!Nt){console.log("[AutoSave] æœªæ‰§è¡Œé¢„ä¿å­˜ï¼Œè·³è¿‡å®Œæˆä¿å­˜");return}console.log("[AutoSave] å®Œæˆä¿å­˜...");const t=Ze(),s=$t(),o=t.images.length;try{await Fn(n,{ui_settings:qn(),total_pages:o,currentImageIndex:t.currentImageIndex});const a=s.currentBookId,l=s.currentChapterId;if(a&&l)try{const{apiClient:r}=await it(async()=>{const{apiClient:x}=await import("./client.Bht704G-.js");return{apiClient:x}},__vite__mapDeps([1,2]));await r.put(`/api/bookshelf/books/${a}/chapters/${l}/image-count`,{count:o}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${o}`)}catch(r){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",r)}console.log("[AutoSave] ä¼šè¯ä¿å­˜å®Œæˆ")}catch(a){console.error("[AutoSave] å®Œæˆä¿å­˜å¤±è´¥:",a)}finally{wt=null,Nt=!1}}function Gn(){wt=null,Nt=!1,console.log("[AutoSave] ä¿å­˜çŠ¶æ€å·²é‡ç½®")}const _n={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","aiTranslate","inpaint","render"],proofread:["aiTranslate","render"],removeText:["detection","inpaint","render"]},Jt={detection:"æ°”æ³¡æ£€æµ‹",ocr:"æ–‡å­—è¯†åˆ«",color:"é¢œè‰²æå–",translate:"ç¿»è¯‘",aiTranslate:"AIç¿»è¯‘",inpaint:"èƒŒæ™¯ä¿®å¤",render:"æ¸²æŸ“",save:"ä¿å­˜"};function Li(){const n=Ze(),t=gt(),s=Fe(),o=Nn(),a=ct(),{progress:l,reporter:r}=$i(),x=w(!1),g=w(null);let i=null,c="standard";const C=J(()=>x.value||n.isBatchTranslationInProgress),$=J(()=>l.value.percentage||0);function R(){const v=s.settings.translation.rpmLimit;g.value?g.value.setRpm(v):g.value=xa(v)}function k(v){const m=v.mode==="hq"?"hq":v.mode==="proofread"?"proofread":v.mode==="removeText"?"ocr":"normal";return o.validateBeforeTranslation(m)}function D(){const{textStyle:v}=s.settings,m=v.layoutDirection;i={fontFamily:v.fontFamily,fontSize:v.fontSize,autoFontSize:v.autoFontSize,autoTextDirection:m==="auto",textDirection:m==="auto"?"vertical":m,layoutDirection:m,fillColor:v.fillColor,textColor:v.textColor,rotationAngle:0,strokeEnabled:v.strokeEnabled,strokeColor:v.strokeColor,strokeWidth:v.strokeWidth,useAutoTextColor:v.useAutoTextColor,inpaintMethod:v.inpaintMethod}}function N(v){const m=n.images;if(v.scope==="current"){const b=n.currentImage;return b?[{image:b,index:n.currentImageIndex}]:[]}if(v.scope==="failed")return n.getFailedImageIndices().map(b=>({image:m[b],index:b})).filter(b=>b.image!==void 0);if(v.scope==="range"&&v.pageRange){const b=Math.max(0,v.pageRange.startPage-1),f=Math.min(m.length-1,v.pageRange.endPage-1);return b>f||b>=m.length?[]:m.slice(b,f+1).map((u,y)=>({image:u,index:b+y}))}return m.map((b,f)=>({image:b,index:f}))}async function B(v){const m=await zt({imageIndex:v.imageIndex,image:v.image,forceDetect:!1});v.bubbleCoords=m.bubbleCoords,v.bubbleAngles=m.bubbleAngles,v.bubblePolygons=m.bubblePolygons,v.autoDirections=m.autoDirections,v.textMask=m.textMask,v.textlinesPerBubble=m.textlinesPerBubble,m.originalTexts&&(v.originalTexts=m.originalTexts)}async function A(v){const m=await Ro({imageIndex:v.imageIndex,image:v.image,bubbleCoords:v.bubbleCoords,textlinesPerBubble:v.textlinesPerBubble});v.originalTexts=m.originalTexts}async function h(v){const m=await Do({imageIndex:v.imageIndex,image:v.image,bubbleCoords:v.bubbleCoords,textlinesPerBubble:v.textlinesPerBubble});v.colors=m.colors}async function p(v){const m=await Wn({imageIndex:v.imageIndex,originalTexts:v.originalTexts,rateLimiter:g.value});v.translatedTexts=m.translatedTexts,v.textboxTexts=m.textboxTexts}async function T(v){const b=await Kn({mode:c==="proofread"?"proofread":"hq",tasks:v.map(f=>({imageIndex:f.imageIndex,image:f.image,originalTexts:f.originalTexts,autoDirections:f.autoDirections}))});for(const f of v){const u=b.results.find(y=>y.imageIndex===f.imageIndex);u?(f.translatedTexts=u.translatedTexts,f.textboxTexts=u.textboxTexts):(f.translatedTexts=[],f.textboxTexts=[])}}async function S(v){const m=await Mo({imageIndex:v.imageIndex,image:v.image,bubbleCoords:v.bubbleCoords,bubblePolygons:v.bubblePolygons,textMask:v.textMask,userMask:v.image.userMask||void 0});v.cleanImage=m.cleanImage}async function F(v){const m=await Qt({imageIndex:v.imageIndex,cleanImage:v.cleanImage,bubbleCoords:v.bubbleCoords,bubbleAngles:v.bubbleAngles,autoDirections:v.autoDirections,originalTexts:v.originalTexts,translatedTexts:v.translatedTexts,textboxTexts:v.textboxTexts,colors:v.colors,savedTextStyles:i,currentMode:c});v.finalImage=m.finalImage,v.bubbleStates=m.bubbleStates}async function O(v,m){switch(v){case"detection":await B(m);break;case"ocr":await A(m);break;case"color":await h(m);break;case"translate":await p(m);break;case"inpaint":await S(m);break;case"render":await F(m);break;case"save":await jn(m.imageIndex);break;case"aiTranslate":throw new Error("aiTranslate åº”é€šè¿‡æ‰¹é‡å¤„ç†é€»è¾‘è°ƒç”¨")}}function te(v){const m=v.finalImage?`data:image/png;base64,${v.finalImage}`:v.cleanImage?`data:image/png;base64,${v.cleanImage}`:null,{textStyle:b}=s.settings;n.updateImageByIndex(v.imageIndex,{translatedDataURL:m,cleanImageData:v.cleanImage||null,bubbleStates:v.bubbleStates,bubbleCoords:v.bubbleCoords,bubbleAngles:v.bubbleAngles,originalTexts:v.originalTexts,textboxTexts:v.textboxTexts,bubbleTexts:v.translatedTexts,textMask:v.textMask||null,userMask:v.image.userMask||null,translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,fontSize:i?.fontSize??b.fontSize,autoFontSize:i?.autoFontSize??b.autoFontSize,fontFamily:i?.fontFamily??b.fontFamily,layoutDirection:i?.layoutDirection??b.layoutDirection,textColor:i?.textColor??b.textColor,fillColor:i?.fillColor??b.fillColor,strokeEnabled:i?.strokeEnabled??b.strokeEnabled,strokeColor:i?.strokeColor??b.strokeColor,strokeWidth:i?.strokeWidth??b.strokeWidth,inpaintMethod:i?.inpaintMethod??b.inpaintMethod,useAutoTextColor:i?.useAutoTextColor??b.useAutoTextColor}),v.imageIndex===n.currentImageIndex&&v.bubbleStates&&t.setBubbles(v.bubbleStates)}function j(v){return v==="standard"||v==="removeText"}function se(v){const m=s.settings;return v==="hq"?m.hqTranslation.batchSize||5:v==="proofread"?m.proofreading.rounds[0]?.batchSize||5:1}async function U(v,m,b,f){let u=0,y=0;for(let I=0;I<v.length;I++){const M=v[I];if(b.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const V=Math.floor(I/v.length*90);r.setPercentage(V,`å¤„ç†å›¾ç‰‡ ${I+1}/${v.length}`),a.info(`å¤„ç†å›¾ç‰‡ ${I+1}/${v.length}...`),n.setTranslationStatus(M.imageIndex,"processing");let G=!1;for(let d=0;d<m.length;d++){const _=m[d];if(G)break;g.value&&await g.value.acquire();try{const ie=V+Math.floor(d/m.length*(90/v.length));r.setPercentage(ie,`å›¾ç‰‡ ${I+1}: ${Jt[_]}`),await O(_,M)}catch(ie){const z=ie instanceof Error?ie.message:"æœªçŸ¥é”™è¯¯";f.push(`å›¾ç‰‡ ${M.imageIndex+1}: ${_} - ${z}`),n.setTranslationStatus(M.imageIndex,"failed",z),G=!0,y++}}G||(te(M),u++,console.log(`âœ… å›¾ç‰‡ ${I+1}/${v.length} å¤„ç†å®Œæˆ`))}return{completed:u,failed:y}}async function Z(v,m,b,f){let u=0,y=0;const I=se(b.mode),M=Math.ceil(v.length/I),V=m.indexOf("aiTranslate"),G=V>=0?m.slice(0,V):m,d=V>=0?m.slice(V+1):[];console.log(`ğŸ“¦ æ‰¹æ¬¡å¤„ç†æ¨¡å¼ï¼šå…± ${v.length} å¼ å›¾ç‰‡ï¼Œæ¯æ‰¹ ${I} å¼ ï¼Œå…± ${M} æ‰¹`),console.log(`   AIç¿»è¯‘å‰æ­¥éª¤: [${G.join(" â†’ ")}]`),console.log(`   AIç¿»è¯‘åæ­¥éª¤: [${d.join(" â†’ ")}]`);for(let _=0;_<M;_++){if(b.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const ie=_*I,z=Math.min(ie+I,v.length),X=v.slice(ie,z),pe=Math.floor(_/M*90);r.setPercentage(pe,`å¤„ç†æ‰¹æ¬¡ ${_+1}/${M}`),a.info(`å¤„ç†æ‰¹æ¬¡ ${_+1}/${M}ï¼ˆå›¾ç‰‡ ${ie+1}-${z}ï¼‰...`);for(const ke of X)n.setTranslationStatus(ke.imageIndex,"processing");const Ce=new Set;for(let ke=0;ke<X.length;ke++){const $e=X[ke];for(const Me of G){if(Ce.has($e.imageIndex))break;g.value&&await g.value.acquire();try{const re=pe+Math.floor(ke/X.length*30);r.setPercentage(re,`å›¾ç‰‡ ${ie+ke+1}: ${Jt[Me]}`),await O(Me,$e)}catch(re){const P=re instanceof Error?re.message:"æœªçŸ¥é”™è¯¯";f.push(`å›¾ç‰‡ ${$e.imageIndex+1}: ${Me} - ${P}`),n.setTranslationStatus($e.imageIndex,"failed",P),Ce.add($e.imageIndex)}}}if(V>=0){const ke=pe+40;r.setPercentage(ke,`æ‰¹æ¬¡ ${_+1}: ${Jt.aiTranslate}`);try{const $e=X.filter(Me=>!Ce.has(Me.imageIndex));$e.length>0&&await T($e)}catch($e){const Me=$e instanceof Error?$e.message:"æœªçŸ¥é”™è¯¯";f.push(`æ‰¹æ¬¡ ${_+1} AIç¿»è¯‘å¤±è´¥: ${Me}`);for(const re of X)Ce.has(re.imageIndex)||(n.setTranslationStatus(re.imageIndex,"failed",Me),Ce.add(re.imageIndex))}}for(let ke=0;ke<X.length;ke++){const $e=X[ke];if(!Ce.has($e.imageIndex)){for(const Me of d){if(Ce.has($e.imageIndex))break;g.value&&await g.value.acquire();try{const re=pe+50+Math.floor(ke/X.length*40);r.setPercentage(re,`å›¾ç‰‡ ${ie+ke+1}: ${Jt[Me]}`),await O(Me,$e)}catch(re){const P=re instanceof Error?re.message:"æœªçŸ¥é”™è¯¯";f.push(`å›¾ç‰‡ ${$e.imageIndex+1}: ${Me} - ${P}`),n.setTranslationStatus($e.imageIndex,"failed",P),Ce.add($e.imageIndex)}}Ce.has($e.imageIndex)||(te($e),u++,console.log(`âœ… å›¾ç‰‡ ${ie+ke+1} å¤„ç†å®Œæˆ`))}}y+=Ce.size,console.log(`âœ… æ‰¹æ¬¡ ${_+1}/${M} å¤„ç†å®Œæˆ`)}return{completed:u,failed:y}}async function ae(v){if(!k(v))return{success:!1,completed:0,failed:0,errors:["é…ç½®éªŒè¯å¤±è´¥"]};if(n.images.length===0)return a.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};c=v.mode;const b=j(v.mode);x.value=!0,(v.scope==="all"||v.scope==="failed")&&n.setBatchTranslationInProgress(!0),R(),D();const f=N(v),u=[];if(i&&f.length>1){console.log(`ğŸ“ é¢„åˆ†å‘æ–‡å­—è®¾ç½®åˆ° ${f.length} å¼ å¾…ç¿»è¯‘å›¾ç‰‡...`);for(const{index:V}of f)n.updateImageByIndex(V,{fontSize:i.fontSize,autoFontSize:i.autoFontSize,fontFamily:i.fontFamily,layoutDirection:i.layoutDirection,textColor:i.textColor,fillColor:i.fillColor,strokeEnabled:i.strokeEnabled,strokeColor:i.strokeColor,strokeWidth:i.strokeWidth,inpaintMethod:i.inpaintMethod,useAutoTextColor:i.useAutoTextColor})}const y=Tt();let I=[..._n[v.mode]];if(v.mode==="removeText"&&s.settings.removeTextWithOcr){const V=I.indexOf("detection");V!==-1&&I.splice(V+1,0,"ocr")}y&&I.push("save"),console.log("ğŸš€ é¡ºåºç®¡çº¿å¯åŠ¨"),console.log(`   æ¨¡å¼: ${v.mode}`),console.log(`   å¤„ç†æ–¹å¼: ${b?"é€å¼ å¤„ç†":"æ‰¹æ¬¡å¤„ç†"}`),console.log(`   æ­¥éª¤é“¾: [${I.join(" â†’ ")}]`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${y?"å¯ç”¨":"ç¦ç”¨"}`);const M=f.map(({image:V,index:G})=>{const d={imageIndex:G,image:V,bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],textMask:V.textMask||void 0,textlinesPerBubble:[],originalTexts:[],colors:[],translatedTexts:[],textboxTexts:[]};return v.mode==="proofread"&&V.bubbleStates&&V.bubbleStates.length>0&&(d.bubbleCoords=V.bubbleStates.map(_=>_.coords),d.bubbleAngles=V.bubbleStates.map(_=>_.rotationAngle||0),d.autoDirections=V.bubbleStates.map(_=>_.autoTextDirection||_.textDirection||"vertical"),d.originalTexts=V.bubbleStates.map(_=>_.originalText||""),d.translatedTexts=V.bubbleStates.map(_=>_.translatedText||""),d.textboxTexts=V.bubbleStates.map(_=>_.textboxText||""),d.colors=V.bubbleStates.map(_=>({textColor:_.textColor||"",bgColor:_.fillColor||"",autoFgColor:_.autoFgColor||null,autoBgColor:_.autoBgColor||null})),V.cleanImageData&&(d.cleanImage=V.cleanImageData)),d});try{r.init(f.length,`${v.mode} æ¨¡å¼å¯åŠ¨...`),y&&(r.setPercentage(0,"é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),await Hn({onStart:_=>{r.setPercentage(0,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ 0/${_}...`)},onProgress:(_,ie)=>{const z=Math.round(_/ie*10);r.setPercentage(z,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ ${_}/${ie}...`)},onComplete:()=>{r.setPercentage(10,"é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:_=>{r.setPercentage(0,`é¢„ä¿å­˜å¤±è´¥: ${_}`)}})||a.warning("é¢„ä¿å­˜å¤±è´¥ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜"));let V;b?V=await U(M,I,v,u):V=await Z(M,I,v,u),r.setPercentage(100,"å®Œæˆï¼");const G={standard:"ç¿»è¯‘",hq:"é«˜è´¨é‡ç¿»è¯‘",proofread:"AIæ ¡å¯¹",removeText:"æ¶ˆé™¤æ–‡å­—"};return a.success(`${G[v.mode]}å®Œæˆï¼`),{success:V.failed===0,completed:V.completed,failed:V.failed,errors:u.length>0?u:void 0}}catch(V){const G=V instanceof Error?V.message:"æ‰§è¡Œå¤±è´¥";return a.error(G),u.push(G),{success:!1,completed:0,failed:f.length,errors:u}}finally{x.value=!1,n.setBatchTranslationInProgress(!1),y&&await Jn();const V=n.currentImageIndex,G=n.images[V];G?.bubbleStates&&G.bubbleStates.length>0&&t.setBubbles(G.bubbleStates),setTimeout(()=>r.finish(),1e3)}}function Y(){n.isBatchTranslationInProgress&&(n.setBatchTranslationInProgress(!1),Gn(),a.info("æ“ä½œå·²å–æ¶ˆ"))}return{progress:l,isExecuting:x,isTranslating:C,progressPercent:$,execute:ae,cancel:Y,STEP_CHAIN_CONFIGS:_n}}class Fi{currentCount=0;maxCount;waitQueue=[];holders=[];constructor(t=1){this.maxCount=Math.max(1,t)}setSize(t){this.maxCount=Math.max(1,t),this.tryWakeUp()}getSize(){return this.maxCount}async acquire(t){if(this.currentCount<this.maxCount){this.currentCount++,this.holders.push(t);return}return new Promise(s=>{this.waitQueue.push({resolve:s,poolName:t})})}release(t){const s=this.holders.indexOf(t);s>=0&&(this.holders.splice(s,1),this.currentCount--),this.tryWakeUp()}tryWakeUp(){for(;this.currentCount<this.maxCount&&this.waitQueue.length>0;){const t=this.waitQueue.shift();this.currentCount++,this.holders.push(t.poolName),t.resolve()}}async withLock(t,s){await this.acquire(t);try{return await s()}finally{this.release(t)}}getStatus(){return{isLocked:this.currentCount>=this.maxCount,currentCount:this.currentCount,maxCount:this.maxCount,holders:[...this.holders],waitingCount:this.waitQueue.length,waitingPools:this.waitQueue.map(t=>t.poolName)}}isWaiting(t){return this.waitQueue.some(s=>s.poolName===t)}isHolding(t){return this.holders.includes(t)}reset(){this.currentCount=0,this.holders=[];for(const t of this.waitQueue)t.resolve();this.waitQueue=[]}}class It{queue=[];currentTask=null;isRunning=!1;isCancelled=!1;completedCount=0;nextPool;name;icon;lock;progressTracker;onTaskComplete;constructor(t,s,o,a,l,r){this.name=t,this.icon=s,this.nextPool=o,this.lock=a,this.progressTracker=l,this.onTaskComplete=r}getName(){return this.name}getIcon(){return this.icon}setNextPool(t){this.nextPool=t}enqueue(t){this.isCancelled||(this.queue.push(t),this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext())}enqueueBatch(t){if(!this.isCancelled){for(const s of t)this.queue.push(s);this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext()}}async tryProcessNext(){if(!(this.isRunning||this.isCancelled||this.queue.length===0)){this.isRunning=!0,this.currentTask=this.queue.shift(),this.progressTracker.updatePool(this.name,{waiting:this.queue.length,isProcessing:!0,currentPage:this.currentTask.imageIndex+1,isWaitingLock:!1});try{let t;this.lock?(this.progressTracker.updatePool(this.name,{isWaitingLock:!0}),t=await this.lock.withLock(this.name,async()=>(this.progressTracker.updatePool(this.name,{isWaitingLock:!1}),await this.process(this.currentTask)))):t=await this.process(this.currentTask),this.completedCount++,this.progressTracker.updatePool(this.name,{completed:this.completedCount}),this.nextPool&&t.status!=="failed"&&t.status!=="buffered"&&this.nextPool.enqueue(t),this.onTaskComplete?.(t)}catch(t){this.currentTask.status="failed",this.currentTask.error=t.message,console.error(`[${this.name}] å¤„ç†ä»»åŠ¡å¤±è´¥:`,t),this.onTaskComplete?.(this.currentTask)}finally{this.currentTask=null,this.isRunning=!1,this.progressTracker.updatePool(this.name,{isProcessing:!1,currentPage:void 0}),this.tryProcessNext()}}}getStatus(){return{name:this.name,icon:this.icon,waiting:this.queue.length,processing:this.isRunning,currentPage:this.currentTask?.imageIndex,completed:this.completedCount,isWaitingLock:this.lock?.isWaiting(this.name)??!1}}cancel(){this.isCancelled=!0,this.queue=[]}reset(){this.isCancelled=!1,this.queue=[],this.currentTask=null,this.isRunning=!1,this.completedCount=0}getCompletedCount(){return this.completedCount}getWaitingCount(){return this.queue.length}isProcessing(){return this.isRunning}}const Ui=[{name:"æ£€æµ‹",icon:"ğŸ“"},{name:"OCR",icon:"ğŸ“–"},{name:"é¢œè‰²",icon:"ğŸ¨"},{name:"ç¿»è¯‘",icon:"ğŸŒ"},{name:"ä¿®å¤",icon:"ğŸ–Œï¸"},{name:"æ¸²æŸ“",icon:"âœ¨"}];class Oi{poolStatuses=new Map;totalPages=0;startTime=0;progress=So({pools:[],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0});constructor(){this.initPools()}initPools(){for(const t of Ui){const s={name:t.name,icon:t.icon,waiting:0,processing:!1,completed:0,isWaitingLock:!1};this.poolStatuses.set(t.name,s)}this.syncToReactive()}init(t){this.totalPages=t,this.startTime=Date.now();for(const s of this.poolStatuses.values())s.waiting=0,s.processing=!1,s.currentPage=void 0,s.completed=0,s.isWaitingLock=!1;this.progress.totalCompleted=0,this.progress.totalFailed=0,this.progress.totalPages=t,this.progress.estimatedTimeRemaining=0,this.syncToReactive()}updatePool(t,s){const o=this.poolStatuses.get(t);o&&(s.waiting!==void 0&&(o.waiting=s.waiting),s.isProcessing!==void 0&&(o.processing=s.isProcessing),s.currentPage!==void 0&&(o.currentPage=s.currentPage),s.completed!==void 0&&(o.completed=s.completed),s.isWaitingLock!==void 0&&(o.isWaitingLock=s.isWaitingLock),this.syncToReactive(),this.updateEstimatedTime())}incrementCompleted(){this.progress.totalCompleted++,this.updateEstimatedTime()}incrementFailed(){this.progress.totalFailed++}updateEstimatedTime(){if(this.progress.totalCompleted===0){this.progress.estimatedTimeRemaining=0;return}const s=(Date.now()-this.startTime)/1e3/this.progress.totalCompleted,o=this.totalPages-this.progress.totalCompleted-this.progress.totalFailed;this.progress.estimatedTimeRemaining=Math.ceil(s*o)}syncToReactive(){this.progress.pools=Array.from(this.poolStatuses.values()).map(t=>({...t}))}getPoolStatus(t){return this.poolStatuses.get(t)}getAllPoolStatuses(){return Array.from(this.poolStatuses.values())}getProgress(){return{...this.progress}}reset(){this.totalPages=0,this.startTime=0,this.initPools()}formatRemainingTime(){const t=this.progress.estimatedTimeRemaining;if(t<=0)return"--";const s=Math.floor(t/60),o=t%60;return s>0?`${s}åˆ†${o}ç§’`:`${o}ç§’`}}class zi{results=new Map;totalExpected=0;completedCount=0;failedCount=0;resolveWaitAll=null;init(t){this.results.clear(),this.totalExpected=t,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}add(t){this.results.has(t.imageIndex)||(this.results.set(t.imageIndex,t),t.status==="completed"?this.completedCount++:t.status==="failed"&&this.failedCount++,this.completedCount+this.failedCount>=this.totalExpected&&this.resolveWaitAll&&(this.resolveWaitAll({success:this.completedCount,failed:this.failedCount}),this.resolveWaitAll=null))}waitForAll(t){return this.totalExpected=t,this.completedCount+this.failedCount>=t?Promise.resolve({success:this.completedCount,failed:this.failedCount}):new Promise(s=>{this.resolveWaitAll=s})}get(t){return this.results.get(t)}getAll(){return Array.from(this.results.values()).sort((t,s)=>t.imageIndex-s.imageIndex)}getSuccessful(){return this.getAll().filter(t=>t.status==="completed")}getFailed(){return this.getAll().filter(t=>t.status==="failed")}getStats(){return{total:this.totalExpected,completed:this.completedCount,failed:this.failedCount,pending:this.totalExpected-this.completedCount-this.failedCount}}reset(){this.results.clear(),this.totalExpected=0,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}}class Ni extends It{constructor(t,s,o,a){super("æ£€æµ‹","ğŸ“",t,s,o,a)}async process(t){const{imageData:s}=t,o=await zt({imageIndex:t.imageIndex,image:s,forceDetect:!1});return t.detectionResult={bubbleCoords:o.bubbleCoords,bubbleAngles:o.bubbleAngles,bubblePolygons:o.bubblePolygons,autoDirections:o.autoDirections,textMask:o.textMask,textlinesPerBubble:o.textlinesPerBubble},t.status="processing",t}}class Vi extends It{constructor(t,s,o,a){super("OCR","ğŸ“–",t,s,o,a)}async process(t){const{imageData:s,detectionResult:o}=t;if(!o||o.bubbleCoords.length===0)return t.ocrResult={originalTexts:[],textlinesPerBubble:[]},t.status="processing",t;const a=await Ro({imageIndex:t.imageIndex,image:s,bubbleCoords:o.bubbleCoords,textlinesPerBubble:o.textlinesPerBubble||[]});return t.ocrResult={originalTexts:a.originalTexts,textlinesPerBubble:o.textlinesPerBubble||[]},t.status="processing",t}}class Wi extends It{constructor(t,s,o,a){super("é¢œè‰²","ğŸ¨",t,s,o,a)}async process(t){const{imageData:s,detectionResult:o,ocrResult:a}=t;if(!o||o.bubbleCoords.length===0)return t.colorResult={colors:[]},t.status="processing",t;const l=await Do({imageIndex:t.imageIndex,image:s,bubbleCoords:o.bubbleCoords,textlinesPerBubble:a?.textlinesPerBubble||o.textlinesPerBubble||[]});return t.colorResult={colors:l.colors},t.status="processing",t}}class Ki extends It{mode="standard";batchBuffer=[];totalTasks=0;processedCount=0;constructor(t,s,o){super("ç¿»è¯‘","ğŸŒ",t,null,s,o)}setMode(t,s,o){this.mode=t,this.totalTasks=s,this.batchBuffer=[],this.processedCount=0,this.nextPool=o}async process(t){switch(this.mode){case"standard":return this.handleStandardTranslate(t);case"hq":return this.handleHqTranslate(t);case"proofread":return this.handleProofread(t);case"removeText":return this.handleRemoveTextOnly(t);default:return t}}async handleStandardTranslate(t){const o=Fe().settings;if(!t.ocrResult||t.ocrResult.originalTexts.length===0)return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t;const a=o.translation.translationMode||"batch",l=t.ocrResult.originalTexts;if(a==="single"){console.log(`[å¹¶è¡Œç¿»è¯‘æ± ] ä½¿ç”¨é€æ°”æ³¡ç¿»è¯‘æ¨¡å¼ï¼Œå›¾ç‰‡ ${t.imageIndex}ï¼Œå…± ${l.length} ä¸ªæ°”æ³¡`);const r=[],x=[];for(let g=0;g<l.length;g++){const i=l[g];if(!i||i.trim()===""){r.push(""),o.useTextboxPrompt&&x.push("");continue}try{const c=o.translation.isJsonMode?o.translation.singleJsonPrompt:o.translation.singleNormalPrompt,C=await Ft({original_text:i,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,target_language:o.targetLanguage,prompt_content:c,use_json_format:o.translation.isJsonMode,rpm_limit_translation:o.translation.rpmLimit,max_retries:o.translation.maxRetries});if(C.success&&C.data?r.push(C.data.translated_text||""):(console.warn(`[å¹¶è¡Œç¿»è¯‘æ± ] æ°”æ³¡ ${g+1} ç¿»è¯‘å¤±è´¥: ${C.error}`),r.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—")),o.useTextboxPrompt&&o.textboxPrompt){const $=await Ft({original_text:i,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,target_language:o.targetLanguage,prompt_content:o.textboxPrompt,rpm_limit_translation:o.translation.rpmLimit,max_retries:o.translation.maxRetries});$.success&&$.data?x.push($.data.translated_text||""):x.push("")}}catch(c){console.error(`[å¹¶è¡Œç¿»è¯‘æ± ] æ°”æ³¡ ${g+1} ç¿»è¯‘å‡ºé”™:`,c),r.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—"),o.useTextboxPrompt&&x.push("")}}t.translateResult={translatedTexts:r,textboxTexts:x}}else{console.log(`[å¹¶è¡Œç¿»è¯‘æ± ] ä½¿ç”¨æ•´é¡µæ‰¹é‡ç¿»è¯‘æ¨¡å¼ï¼Œå›¾ç‰‡ ${t.imageIndex}ï¼Œå…± ${l.length} ä¸ªæ°”æ³¡`);const r=await Vn({original_texts:l,target_language:o.targetLanguage,source_language:o.sourceLanguage,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,prompt_content:o.translatePrompt,textbox_prompt_content:o.textboxPrompt,use_textbox_prompt:o.useTextboxPrompt,rpm_limit:o.translation.rpmLimit,max_retries:o.translation.maxRetries,use_json_format:o.translation.isJsonMode});if(!r.success)throw new Error(r.error||"ç¿»è¯‘å¤±è´¥");t.translateResult={translatedTexts:r.translated_texts||[],textboxTexts:r.textbox_texts||[]}}return t.status="processing",t}async handleHqTranslate(t){this.batchBuffer.push(t),this.processedCount++;const s=Fe(),{hqTranslation:o}=s.settings,a=o.batchSize||3,l=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=a||l))return t.status="buffered",t;const x=[...this.batchBuffer];this.batchBuffer=[];const g=x.map($=>({imageIndex:$.imageIndex,bubbles:($.ocrResult?.originalTexts||[]).map((R,k)=>({bubbleIndex:k,original:R,translated:"",textDirection:$.detectionResult?.autoDirections[k]||"vertical"}))})),i=x.map($=>this.extractBase64($.imageData.originalDataURL)),c=await Ut({provider:o.provider,api_key:o.apiKey,model_name:o.modelName,custom_base_url:o.customBaseUrl,jsonData:g,imageBase64Array:i,prompt:o.prompt,systemPrompt:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",isProofreading:!1,enableDebugLogs:s.settings.enableVerboseLogs,low_reasoning:o.lowReasoning,force_json_output:o.forceJsonOutput,no_thinking_method:o.noThinkingMethod,use_stream:o.useStream,max_retries:o.maxRetries||2}),C=this.parseHqResponse(c,o.forceJsonOutput);for(const $ of x){const R=C?.find(k=>k.imageIndex===$.imageIndex);R?$.translateResult={translatedTexts:R.bubbles.map(k=>k.translated),textboxTexts:[]}:$.translateResult={translatedTexts:[],textboxTexts:[]},$.status="processing",this.nextPool&&this.nextPool.enqueue($)}return t.status="buffered",t}async handleProofread(t){this.batchBuffer.push(t),this.processedCount++;const s=Fe(),{proofreading:o,useTextboxPrompt:a}=s.settings,l=o.rounds[0]?.batchSize||3,r=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=l||r))return t.status="buffered",t;const g=[...this.batchBuffer];this.batchBuffer=[];const i=g.map($=>({imageIndex:$.imageIndex,bubbles:($.imageData.bubbleStates||[]).map((R,k)=>({bubbleIndex:k,original:R.originalText||"",translated:a?R.textboxText||R.translatedText||"":R.translatedText||"",textDirection:R.textDirection==="vertical"||R.textDirection==="horizontal"?R.textDirection:R.autoTextDirection==="vertical"||R.autoTextDirection==="horizontal"?R.autoTextDirection:"vertical"}))})),c=g.map($=>{const R=$.imageData.translatedDataURL||$.imageData.originalDataURL;return this.extractBase64(R)});let C=i;for(const $ of o.rounds){const R=await Ut({provider:$.provider,api_key:$.apiKey,model_name:$.modelName,custom_base_url:$.customBaseUrl,jsonData:C,imageBase64Array:c,prompt:$.prompt,systemPrompt:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚",isProofreading:!0,enableDebugLogs:s.settings.enableVerboseLogs,low_reasoning:$.lowReasoning,force_json_output:$.forceJsonOutput,no_thinking_method:$.noThinkingMethod,use_stream:$.useStream??!0,max_retries:$.maxRetries||o.maxRetries||2}),k=this.parseHqResponse(R,$.forceJsonOutput);k&&(C=k)}for(const $ of g){const R=C.find(k=>k.imageIndex===$.imageIndex);R?$.translateResult={translatedTexts:R.bubbles.map(k=>k.translated),textboxTexts:[]}:$.translateResult={translatedTexts:[],textboxTexts:[]},$.status="processing",this.nextPool&&this.nextPool.enqueue($)}return t.status="buffered",t}async handleRemoveTextOnly(t){return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}parseHqResponse(t,s){if(!t.success)return console.error("APIè°ƒç”¨å¤±è´¥:",t.error),null;if(t.results&&t.results.length>0){const a=t.results[0];if(a&&"imageIndex"in a&&"bubbles"in a)return t.results}const o=t.content;if(o){let a=null;if(s)try{a=JSON.parse(o)}catch(l){return console.error("è§£æAIå¼ºåˆ¶JSONè¿”å›çš„å†…å®¹å¤±è´¥:",l),null}else{const l=o.match(/```json\s*([\s\S]*?)\s*```/);if(l?.[1])try{a=JSON.parse(l[1])}catch(r){return console.error("è§£æAIè¿”å›çš„JSONå¤±è´¥:",r),null}}if(a){if(Array.isArray(a))return a;if(typeof a=="object"&&"imageIndex"in a&&"bubbles"in a)return console.log("[TranslatePool.parseHqResponse] æ£€æµ‹åˆ°å•å¼ å›¾ç‰‡æ ¼å¼ï¼Œè‡ªåŠ¨åŒ…è£…ä¸ºæ•°ç»„"),[a]}}return null}}class qi extends It{constructor(t,s,o,a){super("ä¿®å¤","ğŸ–Œï¸",t,s,o,a)}async process(t){const{imageData:s,detectionResult:o}=t;if(!o||o.bubbleCoords.length===0){const l=r=>r.includes("base64,")?r.split("base64,")[1]||"":r;return t.inpaintResult={cleanImage:l(s.originalDataURL)},t.status="processing",t}const a=await Mo({imageIndex:t.imageIndex,image:s,bubbleCoords:o.bubbleCoords,bubblePolygons:o.bubblePolygons,textMask:o.textMask,userMask:s.userMask||void 0});return t.inpaintResult={cleanImage:a.cleanImage},t.status="processing",t}}const mt=So({pools:[{name:"æ£€æµ‹",icon:"ğŸ“",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"OCR",icon:"ğŸ“–",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"é¢œè‰²",icon:"ğŸ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ç¿»è¯‘",icon:"ğŸŒ",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ä¿®å¤",icon:"ğŸ–Œï¸",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"æ¸²æŸ“",icon:"âœ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1}],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0,preSave:void 0,save:void 0}),Hi=w(!1);function Ao(){const n=Ze(),t=Fe(),s=Ms(null),o=J(()=>t.settings.parallel),a=J(()=>o.value?.enabled??!1),l=Hi,r=J(()=>mt);function x(){const $=t.settings;return $.proofreading?.enabled&&$.proofreading.rounds.length>0?"proofread":["gemini","openai","claude","deepseek"].includes($.hqTranslation?.provider||"")&&$.hqTranslation?.apiKey?"hq":"standard"}function g(){if(!s.value)return;const $=s.value.progress;$&&(mt.pools=$.pools.map(R=>({...R})),mt.totalCompleted=$.totalCompleted,mt.totalFailed=$.totalFailed,mt.totalPages=$.totalPages,mt.estimatedTimeRemaining=$.estimatedTimeRemaining)}async function i($,R,k=0){if(l.value)return{success:0,failed:0,errors:["ç¿»è¯‘æ­£åœ¨è¿›è¡Œä¸­"]};const D=R??n.images;if(D.length===0)return{success:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};l.value=!0,mt.totalPages=D.length,mt.totalCompleted=0,mt.totalFailed=0;const N=setInterval(g,200);try{s.value=Gi({enabled:!0,deepLearningLockSize:o.value?.deepLearningLockSize??1});const B=$??x();console.log(`ğŸš€ å¼€å§‹å¹¶è¡Œç¿»è¯‘ï¼Œæ¨¡å¼: ${B}ï¼Œå›¾ç‰‡æ•°: ${D.length}ï¼Œèµ·å§‹ç´¢å¼•: ${k}`);const A=await s.value.execute(D,B,k);return g(),console.log(`âœ… å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ: ${A.success}ï¼Œå¤±è´¥: ${A.failed}`),A}catch(B){return console.error("å¹¶è¡Œç¿»è¯‘å‡ºé”™:",B),{success:0,failed:D.length,errors:[B.message]}}finally{clearInterval(N),l.value=!1}}function c(){s.value&&s.value.cancel(),l.value=!1}function C(){s.value=null,l.value=!1}return{isEnabled:a,isRunning:l,progress:r,executeParallel:i,cancel:c,reset:C,determineMode:x}}class ji extends It{resultCollector;constructor(t,s,o){super("æ¸²æŸ“","âœ¨",null,null,t,o),this.resultCollector=s}async process(t){const s=Ze(),o=gt(),a=Fe(),l=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.translatedDataURL||t.imageData.originalDataURL),r=t.detectionResult?.bubbleCoords||[],x=t.translateResult?.translatedTexts||[],g=t.ocrResult?.originalTexts||[],i=t.colorResult?.colors||[],c=t.detectionResult?.bubbleAngles||[],C=t.detectionResult?.autoDirections||[],$=t.translateResult?.textboxTexts||[];if(r.length===0)return t.renderResult={finalImage:l,bubbleStates:[]},t.status="completed",this.updateImageToUI(t,s,o,a),this.resultCollector.add(t),t;if(!t.detectionResult&&t.imageData.bubbleStates&&t.imageData.bubbleStates.length>0){const k=t.imageData.bubbleStates,D=k.map(F=>F.coords),N=k.map(F=>F.rotationAngle||0),B=k.map(F=>F.autoTextDirection||"vertical"),A=k.map(F=>F.originalText||""),h=k.map((F,O)=>x[O]||F.translatedText||""),p=k.map(F=>F.textboxText||""),T=k.map(F=>({textColor:F.textColor||"#000000",bgColor:F.fillColor||"#FFFFFF",autoFgColor:F.autoFgColor||null,autoBgColor:F.autoBgColor||null})),S=await Qt({imageIndex:t.imageIndex,cleanImage:l,bubbleCoords:D,bubbleAngles:N,autoDirections:B,originalTexts:A,translatedTexts:h,textboxTexts:p,colors:T,savedTextStyles:null,currentMode:"proofread"});return t.renderResult={finalImage:S.finalImage,bubbleStates:S.bubbleStates},t.status="completed",this.updateImageToUI(t,s,o,a),this.resultCollector.add(t),t}if(t.detectionResult&&!t.translateResult){console.log(`[æ¸²æŸ“æ± ] å›¾ç‰‡ ${t.imageIndex+1}: æ£€æµ‹åˆ°æ¶ˆé™¤æ–‡å­—æ¨¡å¼ï¼ˆæ— ç¿»è¯‘ç»“æœï¼‰ï¼Œæ„å»ºåŸºæœ¬bubbleStates`);const{textStyle:k}=a.settings,D=r.map((N,B)=>{const A=C[B]||"vertical",h=A==="v"?"vertical":A==="h"?"horizontal":A==="vertical"||A==="horizontal"?A:"vertical";return{coords:N.length>=4?[N[0],N[1],N[2],N[3]]:[0,0,0,0],polygon:[],position:{x:0,y:0},rotationAngle:c[B]||0,originalText:g[B]||"",translatedText:"",textboxText:"",textDirection:h,autoTextDirection:h,fontSize:k.fontSize,fontFamily:k.fontFamily,autoFontSize:k.autoFontSize,textColor:k.textColor,fillColor:k.fillColor,strokeEnabled:k.strokeEnabled,strokeColor:k.strokeColor,strokeWidth:k.strokeWidth,inpaintMethod:k.inpaintMethod,autoFgColor:null,autoBgColor:null}});return t.renderResult={finalImage:l,bubbleStates:D},t.status="completed",this.updateImageToUI(t,s,o,a),this.resultCollector.add(t),t}const R=await Qt({imageIndex:t.imageIndex,cleanImage:l,bubbleCoords:r,bubbleAngles:c,autoDirections:C,originalTexts:g,translatedTexts:x,textboxTexts:$,colors:i,savedTextStyles:null,currentMode:"standard"});return t.renderResult={finalImage:R.finalImage,bubbleStates:R.bubbleStates},t.status="completed",this.updateImageToUI(t,s,o,a),this.resultCollector.add(t),t}updateImageToUI(t,s,o,a){const l=t.imageIndex,r=(t.detectionResult?.bubbleCoords||[]).map(x=>x.length>=4?[x[0],x[1],x[2],x[3]]:[0,0,0,0]);s.updateImageByIndex(l,{translatedDataURL:`data:image/png;base64,${t.renderResult.finalImage}`,cleanImageData:t.inpaintResult?.cleanImage||null,bubbleStates:t.renderResult.bubbleStates,bubbleCoords:r,bubbleAngles:t.detectionResult?.bubbleAngles||[],originalTexts:t.ocrResult?.originalTexts||[],bubbleTexts:t.translateResult?.translatedTexts||[],textboxTexts:t.translateResult?.textboxTexts||[],textMask:t.detectionResult?.textMask||null,userMask:t.imageData.userMask||null,translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,fontSize:t.imageData.fontSize??a.settings.textStyle.fontSize,autoFontSize:t.imageData.autoFontSize??a.settings.textStyle.autoFontSize,fontFamily:t.imageData.fontFamily??a.settings.textStyle.fontFamily,layoutDirection:t.imageData.layoutDirection??a.settings.textStyle.layoutDirection,textColor:t.imageData.textColor??a.settings.textStyle.textColor,fillColor:t.imageData.fillColor??a.settings.textStyle.fillColor,strokeEnabled:t.imageData.strokeEnabled??a.settings.textStyle.strokeEnabled,strokeColor:t.imageData.strokeColor??a.settings.textStyle.strokeColor,strokeWidth:t.imageData.strokeWidth??a.settings.textStyle.strokeWidth,inpaintMethod:t.imageData.inpaintMethod??a.settings.textStyle.inpaintMethod,useAutoTextColor:t.imageData.useAutoTextColor??a.settings.textStyle.useAutoTextColor}),l===s.currentImageIndex&&t.renderResult?.bubbleStates&&o.setBubbles(t.renderResult.bubbleStates),this.progressTracker.incrementCompleted(),Tt()&&jn(l).catch(x=>{console.error(`[RenderPool] è‡ªåŠ¨ä¿å­˜å›¾ç‰‡ ${l+1} å¤±è´¥:`,x)}).finally(()=>{const{progress:x}=Ao(),g=x.value;g.save&&(g.save.completed=(g.save.completed||0)+1)}),console.log(`âœ… å›¾ç‰‡ ${l+1} æ¸²æŸ“å®Œæˆ`)}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const kn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","translate","inpaint","render"],proofread:["translate","render"],removeText:["detection","inpaint","render"]};class Ji{lock;progressTracker;resultCollector;detectionPool;ocrPool;colorPool;translatePool;inpaintPool;renderPool;isCancelled=!1;config;constructor(t){this.config=t,this.lock=new Fi(t.deepLearningLockSize),this.progressTracker=new Oi,this.resultCollector=new zi,this.renderPool=new ji(this.progressTracker,this.resultCollector),this.inpaintPool=new qi(this.renderPool,this.lock,this.progressTracker),this.translatePool=new Ki(this.inpaintPool,this.progressTracker),this.colorPool=new Wi(this.translatePool,this.lock,this.progressTracker),this.ocrPool=new Vi(this.colorPool,this.lock,this.progressTracker),this.detectionPool=new Ni(this.ocrPool,this.lock,this.progressTracker)}updateConfig(t){t.deepLearningLockSize!==void 0&&(this.lock.setSize(t.deepLearningLockSize),this.config.deepLearningLockSize=t.deepLearningLockSize),t.enabled!==void 0&&(this.config.enabled=t.enabled)}async execute(t,s,o=0){this.reset(),this.progressTracker.init(t.length),this.resultCollector.init(t.length),this.setupPoolChain(s,t.length);const a=t.map((x,g)=>({id:`task-${o+g}`,imageIndex:o+g,imageData:x,status:"pending"})),l=this.getEntryPool(s);for(const x of a)l.enqueue(x);const r=await this.resultCollector.waitForAll(t.length);return{success:r.success,failed:r.failed,errors:this.resultCollector.getFailed().map(x=>x.error||"æœªçŸ¥é”™è¯¯")}}setupPoolChain(t,s){let o=[...kn[t]];if(t==="removeText")try{if(Fe().settings.removeTextWithOcr){const i=o.indexOf("detection");i!==-1&&!o.includes("ocr")&&o.splice(i+1,0,"ocr")}}catch{}const a=this.getPoolMap();for(let g=0;g<o.length-1;g++){const i=o[g],c=o[g+1],C=a[i],$=a[c];C&&$&&C.setNextPool($)}const l=o[o.length-1],r=a[l];r&&r.setNextPool(null);const x=o.indexOf("translate");if(x>=0&&x<o.length-1){const g=o[x+1];this.translatePool.setMode(t,s,a[g]||null)}else x===o.length-1&&this.translatePool.setMode(t,s,null)}getPoolMap(){return{detection:this.detectionPool,ocr:this.ocrPool,color:this.colorPool,translate:this.translatePool,inpaint:this.inpaintPool,render:this.renderPool}}getEntryPool(t){const o=kn[t][0];return this.getPoolMap()[o]||this.detectionPool}cancel(){this.isCancelled=!0,this.detectionPool.cancel(),this.ocrPool.cancel(),this.colorPool.cancel(),this.translatePool.cancel(),this.inpaintPool.cancel(),this.renderPool.cancel(),this.lock.reset()}reset(){this.isCancelled=!1,this.detectionPool.reset(),this.ocrPool.reset(),this.colorPool.reset(),this.translatePool.reset(),this.inpaintPool.reset(),this.renderPool.reset(),this.resultCollector.reset(),this.progressTracker.reset()}get progress(){return this.progressTracker.progress}getProgressTracker(){return this.progressTracker}getLockStatus(){return this.lock.getStatus()}get cancelled(){return this.isCancelled}}function Gi(n){return new Ji(n)}function Yi(){const n=Ze(),t=Fe(),s=ct(),o=Li(),a=Ao(),l=J(()=>o.isTranslating.value||n.isBatchTranslationInProgress),r=J(()=>o.progressPercent.value);async function x(c){if(n.images.length===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};const C=t.settings.parallel,$=c.scope==="all"||c.scope==="range";return C?.enabled&&$?(console.log(`ğŸš€ ä½¿ç”¨å¹¶è¡Œç®¡çº¿ï¼Œæ¨¡å¼: ${c.mode}, èŒƒå›´: ${c.scope}`),g(c)):(console.log(`ğŸš€ ä½¿ç”¨é¡ºåºç®¡çº¿ï¼Œæ¨¡å¼: ${c.mode}`),o.execute(c))}async function g(c){let C=n.images,$=0;if(c.scope==="range"&&c.pageRange){$=Math.max(0,c.pageRange.startPage-1);const k=Math.min(n.images.length-1,c.pageRange.endPage-1);if($<=k&&$<n.images.length)C=n.images.slice($,k+1),console.log(`ğŸ¯ å¹¶è¡Œç¿»è¯‘èŒƒå›´: ç¬¬ ${c.pageRange.startPage} è‡³ ${c.pageRange.endPage} é¡µï¼Œå…± ${C.length} å¼ ï¼Œèµ·å§‹ç´¢å¼• ${$}`);else return s.error("æ— æ•ˆçš„é¡µé¢èŒƒå›´"),{success:!1,completed:0,failed:0,errors:["æ— æ•ˆçš„é¡µé¢èŒƒå›´"]}}if(C.length>1){const{textStyle:k}=t.settings;console.log(`ğŸ“ [å¹¶è¡Œæ¨¡å¼] é¢„åˆ†å‘æ–‡å­—è®¾ç½®åˆ° ${C.length} å¼ å¾…ç¿»è¯‘å›¾ç‰‡...`);for(let D=0;D<C.length;D++){const N=$+D;n.updateImageByIndex(N,{fontSize:k.fontSize,autoFontSize:k.autoFontSize,fontFamily:k.fontFamily,layoutDirection:k.layoutDirection,textColor:k.textColor,fillColor:k.fillColor,strokeEnabled:k.strokeEnabled,strokeColor:k.strokeColor,strokeWidth:k.strokeWidth,inpaintMethod:k.inpaintMethod,useAutoTextColor:k.useAutoTextColor})}}const R=Tt();try{if(a.progress.value.totalPages=C.length,a.progress.value.totalCompleted=0,a.progress.value.totalFailed=0,R&&(console.log("[ParallelPipeline] æ‰§è¡Œé¢„ä¿å­˜..."),s.info("å¼€å§‹é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),!await Hn({onStart:B=>{const A=a.progress.value;A.preSave={isRunning:!0,current:0,total:B}},onProgress:(B,A)=>{const h=a.progress.value;h.preSave&&(h.preSave.current=B,h.preSave.total=A)},onComplete:()=>{const B=a.progress.value;B.preSave&&(B.preSave.isRunning=!1),s.success("é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:B=>{const A=a.progress.value;A.preSave=void 0,s.warning(`é¢„ä¿å­˜å¤±è´¥ï¼š${B}ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜`)}}))){const B=a.progress.value;B.preSave=void 0}const k=c.mode;if(console.log(`ğŸš€ å¯åŠ¨å¹¶è¡Œç¿»è¯‘æ¨¡å¼: ${k}`),console.log(`   å›¾ç‰‡æ•°é‡: ${C.length}`),console.log(`   èµ·å§‹ç´¢å¼•: ${$}`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${R?"å¯ç”¨":"ç¦ç”¨"}`),R){const N=a.progress.value;N.save={completed:0,total:C.length}}const D=await a.executeParallel(k,C,$);return D.success>0&&D.failed===0?s.success(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸå¤„ç† ${D.success} å¼ å›¾ç‰‡`):D.success>0&&D.failed>0?s.warning(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${D.success} å¼ ï¼Œå¤±è´¥ ${D.failed} å¼ `):s.error("å¹¶è¡Œç¿»è¯‘å¤±è´¥"),{success:D.failed===0,completed:D.success,failed:D.failed,errors:D.errors}}catch(k){const D=k instanceof Error?k.message:"å¹¶è¡Œç¿»è¯‘å‡ºé”™";return s.error(D),{success:!1,completed:0,failed:C.length,errors:[D]}}finally{const k=a.progress.value;k.preSave=void 0,k.save=void 0,R&&(console.log("[ParallelPipeline] å®Œæˆä¿å­˜..."),await Jn())}}function i(){o.cancel(),a.cancel(),Gn()}return{progress:o.progress,isExecuting:o.isExecuting,isTranslating:l,progressPercent:r,execute:x,cancel:i,STEP_CHAIN_CONFIGS:o.STEP_CHAIN_CONFIGS}}function Sn(n="current",t){return{mode:"standard",scope:n,pageRange:t?.pageRange}}function Xi(n="all",t){return{mode:"hq",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Zi(n="all",t){return{mode:"proofread",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Qi(n="current",t){return{mode:"removeText",scope:n,pageRange:t?.pageRange}}function er(n){if(n.length===0)return{startPage:1,endPage:0};const t=[...n].sort((a,l)=>a-l),s=t[0],o=t[t.length-1];return{startPage:(s??0)+1,endPage:(o??0)+1}}function vt(n,t){const s=[];for(let o=n;o<t;o++)s.push(o);return s}function Eo(){const n=Ze(),t=gt(),s=ct(),o=Yi(),a=o.progress,l=o.isExecuting,r=o.isTranslating,x=o.progressPercent,g=J(()=>o.isExecuting.value),i=J(()=>o.isExecuting.value);async function c(O,te){if(O.length===0)return s.error("æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"]};const j=n.images.length;if(j===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["è¯·å…ˆä¸Šä¼ å›¾ç‰‡"]};for(const Y of O)if(Y<0||Y>=j)return s.error(`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${Y}`),{success:!1,completed:0,failed:0,errors:[`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${Y}`]};const se=O.length===1,U=O.length===j;let Z;if(se){const Y=n.currentImageIndex,v=O[0];v!==void 0&&n.setCurrentImageIndex(v),Z=C(te,"current");const m=await o.execute(Z);return n.setCurrentImageIndex(Y),{success:m.success,completed:m.completed,failed:m.failed,errors:m.errors??[]}}else if(U)Z=C(te,"all");else{const Y=er(O);Z=C(te,"range",Y)}const ae=await o.execute(Z);return{success:ae.success,completed:ae.completed,failed:ae.failed,errors:ae.errors??[]}}function C(O,te,j){switch(O){case"standard":return Sn(te,j?{pageRange:j}:void 0);case"hq":return Xi(te,j?{pageRange:j}:void 0);case"proofread":return Zi(te,j?{pageRange:j}:void 0);case"removeText":return Qi(te,j?{pageRange:j}:void 0);default:return Sn(te,j?{pageRange:j}:void 0)}}async function $(){return(await c([n.currentImageIndex],"standard")).success}async function R(O){return(await c([O],"standard")).success}async function k(){return(await c(vt(0,n.images.length),"standard")).success}async function D(O){const te=vt(O.startPage-1,O.endPage);return(await c(te,"standard")).success}function N(){o.cancel()}async function B(){return(await c([n.currentImageIndex],"removeText")).success}async function A(){return(await c(vt(0,n.images.length),"removeText")).success}async function h(O){const te=vt(O.startPage-1,O.endPage);return(await c(te,"removeText")).success}async function p(){const O=n.getFailedImageIndices();return O.length===0?(s.info("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘"),!0):(await c(O,"standard")).success}async function T(O){const te=O?vt(O.startPage-1,O.endPage):vt(0,n.images.length);return(await c(te,"hq")).success}async function S(O){const te=O?vt(O.startPage-1,O.endPage):vt(0,n.images.length);return(await c(te,"proofread")).success}async function F(){if(!n.currentImage)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),!1;const te=t.bubbles;return!te||te.length===0?(s.error("å½“å‰å›¾ç‰‡æ²¡æœ‰æ°”æ³¡æ¡†ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ‰‹åŠ¨æ·»åŠ "),!1):(n.setManuallyAnnotated(!0),$())}return{progress:a,isTranslatingSingle:l,isHqTranslating:g,isProofreading:i,isTranslating:r,progressPercent:x,translatePages:c,range:vt,translateCurrentImage:$,translateImageByIndex:R,translateAllImages:k,translateImageRange:D,cancelBatchTranslation:N,removeTextOnly:B,removeAllTexts:A,removeTextRange:h,retryFailedImages:p,executeHqTranslation:T,executeProofreading:S,translateWithCurrentBubbles:F}}function tr(){const n=gt(),t=Ze(),s=w(!1);function o(){if(!s.value)return;const a=t.currentImage;n.bubbleCount>0?t.updateCurrentBubbleStates([...n.bubbles]):a&&Array.isArray(a.bubbleStates)&&a.bubbleStates.length>0&&(t.updateCurrentBubbleStates([]),console.log("é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰ï¼Œç”¨æˆ·å·²åˆ é™¤æ‰€æœ‰æ°”æ³¡")),s.value=!1,n.clearSelection(),console.log("å·²é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰")}return{isActive:s,exitEditModeWithoutRender:o}}function or(){const n=Rn(),t=Fe(),s=Ze(),o=$t(),a=gt(),l=tr(),r=w(!1),x=w(!1),g=w(null),i=w([]),c=w([]),C=w([]),$=w(null),R=w(null),k=w(null),D=w(null),N=w(!1);async function B(U=!1){if(!U&&(r.value||x.value)){console.log("[TranslateInit] å·²ç»åˆå§‹åŒ–ï¼Œä»…é‡æ–°åŠ è½½ä¸Šä¸‹æ–‡"),await F();return}console.log("[TranslateInit] å¼€å§‹åˆå§‹åŒ–åº”ç”¨..."),r.value=!0,g.value=null;try{await A(),await h(),await p(),await T(),await S(),await F(),console.log("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å®Œæˆ"),x.value=!0}catch(Z){console.error("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å¤±è´¥:",Z),g.value=Z instanceof Error?Z.message:"åˆå§‹åŒ–å¤±è´¥"}finally{r.value=!1}}async function A(){console.log("[TranslateInit] åˆå§‹åŒ–è®¾ç½®..."),t.initSettings();try{const U=await t.loadFromBackend();console.log(U?"[TranslateInit] å·²ä»åç«¯åŠ è½½è®¾ç½®":"[TranslateInit] åç«¯æ— è®¾ç½®ï¼Œä½¿ç”¨ localStorage æ•°æ®")}catch(U){console.warn("[TranslateInit] ä»åç«¯åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨ localStorage æ•°æ®:",U)}console.log("[TranslateInit] è®¾ç½®åˆå§‹åŒ–å®Œæˆ")}async function h(){console.log("[TranslateInit] åˆå§‹åŒ–å­—ä½“åˆ—è¡¨...");try{const U=await An();U.fonts&&U.fonts.length>0?(i.value=U.fonts,console.log(`[TranslateInit] å·²åŠ è½½ ${U.fonts.length} ä¸ªå­—ä½“`)):U.error?console.warn("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",U.error):console.warn("[TranslateInit] å­—ä½“åˆ—è¡¨ä¸ºç©º")}catch(U){console.error("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",U)}}async function p(){console.log("[TranslateInit] åˆå§‹åŒ–ç¿»è¯‘æç¤ºè¯è®¾ç½®...");try{const U=await Gs();U.prompt_names!==void 0?(c.value=U.prompt_names||[],!t.settings.translatePrompt&&U.default_prompt_content&&t.setTranslatePrompt(U.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${c.value.length} ä¸ªç¿»è¯‘æç¤ºè¯`)):U.error&&console.warn("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",U.error)}catch(U){console.error("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",U)}}async function T(){console.log("[TranslateInit] åˆå§‹åŒ–æ–‡æœ¬æ¡†æç¤ºè¯è®¾ç½®...");try{const U=await Js();U.prompt_names!==void 0?(C.value=U.prompt_names||[],!t.settings.textboxPrompt&&U.default_prompt_content&&t.setTextboxPrompt(U.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${C.value.length} ä¸ªæ–‡æœ¬æ¡†æç¤ºè¯`)):U.error&&console.warn("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",U.error)}catch(U){console.error("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",U)}}async function S(){console.log("[TranslateInit] æ¸…ç† GPU èµ„æº...");try{const U=await Hs();if(U.success){const Z=U.unloaded_models||[];Z.length>0&&console.log(`[TranslateInit] å·²å¸è½½æ¨¡å‹: ${Z.join(", ")}`),console.log(`[TranslateInit] GPU æ¸…ç†å®Œæˆ - å·²åˆ†é…: ${U.memory_allocated_mb}MB, å·²é¢„ç•™: ${U.memory_reserved_mb}MB`)}else console.warn("[TranslateInit] GPU æ¸…ç†å¤±è´¥:",U.error)}catch(U){console.warn("[TranslateInit] GPU æ¸…ç†å¤±è´¥:",U)}}async function F(){const U=n.query.book,Z=n.query.chapter;if(!U||!Z){console.log("[TranslateInit] æœªæŒ‡å®šä¹¦ç±/ç« èŠ‚å‚æ•°ï¼Œä½¿ç”¨ç‹¬ç«‹æ¨¡å¼"),N.value=!1,$.value=null,R.value=null,k.value=null,D.value=null,o.clearContext();return}console.log(`[TranslateInit] æ£€æµ‹åˆ°ä¹¦ç±/ç« èŠ‚å‚æ•°: book=${U}, chapter=${Z}`),N.value=!0,$.value=U,R.value=Z;try{const ae=await Xs(U);if(!ae.success||!ae.book){console.warn("[TranslateInit] ä¹¦ç±ä¸å­˜åœ¨:",U),ye("ä¹¦ç±ä¸å­˜åœ¨","warning");return}const Y=ae.book,v=Y.chapters?.find(b=>b.id===Z);if(!v){console.warn("[TranslateInit] ç« èŠ‚ä¸å­˜åœ¨:",Z),ye("ç« èŠ‚ä¸å­˜åœ¨","warning");return}k.value=Y.title,D.value=v.title,o.setBookChapterContext(U,Z,Y.title,v.title),typeof document<"u"&&(document.title=`${v.title} - ${Y.title} - Saber-Translator`);const m=v.page_count&&v.page_count>0;if(v.session_path&&m){console.log(`[TranslateInit] å°è¯•åŠ è½½ç« èŠ‚ä¼šè¯: ${v.session_path}`);try{await o.loadSessionByPath(v.session_path),ye(`å·²åŠ è½½ç« èŠ‚: ${v.title}`,"success")}catch{console.log("[TranslateInit] ç« èŠ‚ä¼šè¯æ•°æ®ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°ä¼šè¯")}}else m||console.log("[TranslateInit] æ–°ç« èŠ‚ï¼Œæ— éœ€åŠ è½½ä¼šè¯æ•°æ®")}catch(ae){console.error("[TranslateInit] åŠ è½½ä¹¦ç±/ç« èŠ‚ä¿¡æ¯å¤±è´¥:",ae),ye("åŠ è½½ä¹¦ç±ä¿¡æ¯å¤±è´¥","error")}}function O(U){if(U<0||U>=s.imageCount){console.warn(`[TranslateInit] æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${U}`);return}window._isChangingFromSwitchImage=!0,l.isActive.value&&l.exitEditModeWithoutRender(),s.currentImage&&a.bubbles.length>0&&s.updateCurrentImageProperty("bubbleStates",a.bubbles),s.setCurrentImageIndex(U);const ae=s.currentImage;if(!ae){console.warn("[TranslateInit] åˆ‡æ¢åˆ°çš„å›¾ç‰‡ä¸å­˜åœ¨"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] åˆ‡æ¢åˆ°å›¾ç‰‡: ${U}, ${ae.fileName}`),ae.bubbleStates&&ae.bubbleStates.length>0?a.setBubbles(ae.bubbleStates,!0):a.clearBubblesLocal(),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] å·²é‡ç½®åˆ‡æ¢å›¾ç‰‡æ“ä½œæ ‡è®°")},100)}function te(){s.canGoPrevious&&O(s.currentImageIndex-1)}function j(){s.canGoNext&&O(s.currentImageIndex+1)}function se(){dt(async()=>{await B()})}return{isInitializing:r,isInitialized:x,initError:g,fontList:i,promptNames:c,textboxPromptNames:C,currentBookId:$,currentChapterId:R,currentBookTitle:k,currentChapterTitle:D,isBookshelfMode:N,initializeApp:B,initializeSettings:A,initializeFontList:h,initializePromptSettings:p,initializeTextboxPromptSettings:T,initializeBookChapterContext:F,switchImage:O,goToPrevious:te,goToNext:j,editMode:l,setupAutoInit:se}}const nr={key:0,id:"translationProgressBar",class:"translation-progress-bar"},sr={class:"parallel-header"},ar={class:"header-title"},lr={key:0,class:"presave-section"},ir={class:"presave-label"},rr={class:"presave-progress-bar"},ur={class:"pools-list"},cr={class:"pool-label"},dr={class:"pool-icon"},gr={class:"pool-name"},pr={class:"pool-progress-bar"},mr={class:"pool-stats"},vr={class:"completed-count"},fr={class:"total-count"},br={key:0,class:"waiting-badge"},hr={key:1,class:"lock-indicator",title:"ç­‰å¾…æ·±åº¦å­¦ä¹ é”"},xr={key:0,class:"pool-row save-row"},yr={class:"pool-progress-bar"},Cr={class:"pool-stats"},_r={class:"completed-count"},kr={class:"total-count"},Sr={class:"overall-section"},wr={class:"overall-label"},$r={key:0,class:"failed-text"},Tr={class:"overall-progress-bar"},Ir={class:"progress-bar-label"},Pr={key:0,class:"failed-count"},Rr={class:"progress-bar"},Dr=Ge({__name:"TranslationProgress",props:{progress:{}},setup(n){const t=n,s=Ze(),o=Fe(),a=Eo(),l=Ao(),r=J(()=>{const p=l.progress.value?.preSave?.isRunning;return o.settings.parallel?.enabled&&(l.isRunning.value||p)}),x=J(()=>l.progress.value),g=J(()=>{const p=x.value;return!p||p.totalPages===0?0:Math.round(p.totalCompleted/p.totalPages*100)});function i(p){const T=x.value?.totalPages||0;return T===0?0:Math.round(p.completed/T*100)}function c(){const p=x.value?.totalPages||0;return p===0?0:Math.max(3,Math.round(1/p*100))}function C(){const p=x.value?.preSave;return!p||p.total===0?0:Math.round(p.current/p.total*100)}function $(){const p=x.value?.save;return!p||p.total===0?0:Math.round(p.completed/p.total*100)}const R=J(()=>t.progress||a.progress.value),k=J(()=>R.value.isInProgress||s.isBatchTranslationInProgress||r.value),D=J(()=>R.value.current),N=J(()=>R.value.total),B=J(()=>R.value.failed),A=J(()=>R.value.percentage!==void 0?R.value.percentage:N.value===0?0:Math.round(D.value/N.value*100)),h=J(()=>R.value.label?R.value.label:`ç¿»è¯‘ä¸­ï¼š${D.value} / ${N.value}`);return(p,T)=>k.value?(E(),L("div",nr,[r.value&&x.value?(E(),L(ze,{key:0},[e("div",sr,[e("span",ar,"ğŸš€ å¹¶è¡Œç¿»è¯‘ä¸­ï¼š"+ee(x.value.totalCompleted)+"/"+ee(x.value.totalPages),1)]),x.value.preSave?.isRunning?(E(),L("div",lr,[e("div",ir," ğŸ“¥ é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ï¼š"+ee(x.value.preSave.current)+"/"+ee(x.value.preSave.total),1),e("div",rr,[e("div",{class:"presave-progress-fill",style:ot({width:C()+"%"})},null,4)])])):ce("",!0),e("div",ur,[(E(!0),L(ze,null,Ye(x.value.pools,S=>(E(),L("div",{key:S.name,class:Re(["pool-row",{"pool-processing":S.processing,"pool-waiting-lock":S.isWaitingLock}])},[e("div",cr,[e("span",dr,ee(S.icon),1),e("span",gr,ee(S.name),1)]),e("div",pr,[e("div",{class:"progress-completed",style:ot({width:i(S)+"%"})},null,4),S.processing?(E(),L("div",{key:0,class:"progress-processing",style:ot({left:i(S)+"%",width:c()+"%"})},null,4)):ce("",!0)]),e("div",mr,[e("span",vr,ee(S.completed),1),e("span",fr,"/ "+ee(x.value.totalPages),1),S.waiting>0?(E(),L("span",br,"+"+ee(S.waiting),1)):ce("",!0),S.isWaitingLock?(E(),L("span",hr,"ğŸ”’")):ce("",!0)])],2))),128)),x.value.save?(E(),L("div",xr,[T[0]||(T[0]=e("div",{class:"pool-label"},[e("span",{class:"pool-icon"},"ğŸ’¾"),e("span",{class:"pool-name"},"ä¿å­˜")],-1)),e("div",yr,[e("div",{class:"progress-completed save-progress",style:ot({width:$()+"%"})},null,4)]),e("div",Cr,[e("span",_r,ee(x.value.save.completed),1),e("span",kr,"/ "+ee(x.value.save.total),1)])])):ce("",!0)]),T[1]||(T[1]=e("div",{class:"divider"},null,-1)),e("div",Sr,[e("div",wr,[ge(" æ€»è¿›åº¦ï¼š"+ee(g.value)+"% ",1),x.value.totalFailed>0?(E(),L("span",$r," ï¼ˆ"+ee(x.value.totalFailed)+" å¤±è´¥ï¼‰ ",1)):ce("",!0)]),e("div",Tr,[e("div",{class:"overall-progress-fill progress-stripe",style:ot({width:g.value+"%"})},null,4)])])],64)):(E(),L(ze,{key:1},[e("div",Ir,[ge(ee(h.value)+" ",1),B.value>0?(E(),L("span",Pr,"ï¼ˆ"+ee(B.value)+" å¼ å¤±è´¥ï¼‰",1)):ce("",!0)]),e("div",Rr,[e("div",{class:"progress progress-stripe",style:ot({width:`${A.value}%`})},null,4)])],64))])):ce("",!0)}}),Mr=Je(Dr,[["__scopeId","data-v-532ece5f"]]),Br=Ge({__name:"SponsorModal",emits:["close"],setup(n,{emit:t}){const s=t;return(o,a)=>(E(),ut(En,{title:"æ”¯æŒä½œè€…",onClose:a[1]||(a[1]=l=>s("close"))},{footer:xt(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:a[0]||(a[0]=l=>s("close"))},"å…³é—­")]),default:xt(()=>[a[2]||(a[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·ä½œè€…å–æ¯å’–å•¡ â˜• "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"å¾®ä¿¡æ”¯ä»˜"})]),e("span",{class:"qr-label"},"å¾®ä¿¡æ”¯ä»˜")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"æ”¯ä»˜å®"})]),e("span",{class:"qr-label"},"æ”¯ä»˜å®")])]),e("p",{class:"sponsor-thanks"},"æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ğŸ™")],-1))]),_:1}))}}),Ar=Je(Br,[["__scopeId","data-v-02b6948e"]]);function Er(n){const t=w(""),s=J(()=>n.value.some(R=>R.folderPath)),o=J(()=>{if(!s.value)return null;const R={name:"æ ¹ç›®å½•",path:"",images:[],subfolders:[]},k=new Map;k.set("",R);for(const D of n.value){const N=D.folderPath||"";if(N&&!k.has(N)){const B=N.split("/");let A="";for(const h of B){const p=A;if(A=A?`${A}/${h}`:h,!k.has(A)){const T={name:h,path:A,images:[],subfolders:[]};k.set(A,T),k.has(p)&&k.get(p).subfolders.push(T)}}}k.has(N)&&k.get(N).images.push(D)}return R}),a=J(()=>{if(!t.value)return[{name:"æ ¹ç›®å½•",path:""}];const R=t.value.split("/"),k=[{name:"æ ¹ç›®å½•",path:""}];let D="";for(const N of R)D=D?`${D}/${N}`:N,k.push({name:N,path:D});return k}),l=J(()=>{if(!o.value)return null;if(!t.value)return o.value;const R=(k,D)=>{if(k.path===D)return k;for(const N of k.subfolders){const B=R(N,D);if(B)return B}return null};return R(o.value,t.value)}),r=J(()=>l.value?.subfolders||[]),x=J(()=>l.value?.images||[]);function g(R){t.value=R}function i(){if(!t.value)return;const R=t.value.lastIndexOf("/");t.value=R>0?t.value.substring(0,R):""}function c(R){t.value=R}function C(R){let k=R.images.length;for(const D of R.subfolders)k+=C(D);return k}function $(){t.value=""}return{currentFolderPath:t,useTreeMode:s,folderTree:o,breadcrumbs:a,currentFolder:l,currentSubfolders:r,currentImages:x,enterFolder:g,goUp:i,navigateTo:c,getFolderImageCount:C,resetToRoot:$}}const Lr={class:"card thumbnail-card"},Fr={class:"breadcrumb-nav"},Ur=["onClick"],Or={key:0,class:"breadcrumb-sep"},zr=["onClick"],Nr={class:"folder-info"},Vr=["title"],Wr={class:"folder-count"},Kr=["title","onClick"],qr=["src","alt"],Hr={class:"page-number-indicator"},jr={key:1,class:"translated-indicator"},Jr={key:2,class:"translation-failed-indicator"},Gr={key:3,class:"labeled-indicator"},Yr={key:4,class:"thumbnail-processing-indicator"},Xr={key:0,class:"empty-folder"},Zr=["title","data-index","onClick"],Qr=["src","alt"],eu={class:"page-number-indicator"},tu={key:1,class:"translated-indicator"},ou={key:2,class:"translation-failed-indicator"},nu={key:3,class:"labeled-indicator"},su={key:4,class:"thumbnail-processing-indicator"},au={key:2,class:"empty-state"},lu=Ge({__name:"ThumbnailSidebar",props:{isVisible:{type:Boolean}},emits:["select"],setup(n,{emit:t}){const s=n,o=t,a=Ze(),l=w(null),r=w(null),x=w([]),g=J(()=>a.images),i=J(()=>a.currentImageIndex),c=J(()=>a.hasImages),{useTreeMode:C,breadcrumbs:$,currentSubfolders:R,currentImages:k,currentFolderPath:D,enterFolder:N,goUp:B,navigateTo:A,getFolderImageCount:h,folderTree:p,resetToRoot:T}=Er(g);Se(()=>g.value.length,(Y,v)=>{(Y===0||v===0&&Y>0)&&T()});function S(Y){return g.value.findIndex(v=>v.id===Y.id)}function F(Y){return Y.translationFailed?"failed":Y.isManuallyAnnotated?"labeled":Y.translationStatus==="processing"?"processing":null}function O(Y){return Y.translationStatus==="completed"}function te(Y){o("select",Y)}function j(Y){N(Y.path)}function se(Y){A(Y)}function U(){pt(()=>{const Y=x.value[i.value],v=C.value&&r.value?r.value:l.value;if(Y&&v){const m=Y.getBoundingClientRect(),b=v.getBoundingClientRect(),f=m.top+m.height/2,u=b.top+b.height/2,y=f-u;v.scrollTo({top:v.scrollTop+y,behavior:"smooth"})}})}function Z(Y,v){x.value[v]=Y}function ae(Y){return Y.translationFailed?"ç¿»è¯‘å¤±è´¥ï¼Œç‚¹å‡»å¯é‡è¯•":Y.isManuallyAnnotated?"åŒ…å«æ‰‹åŠ¨æ ‡æ³¨":Y.translationStatus==="completed"?"å·²å®Œæˆç¿»è¯‘":Y.fileName||""}return Se(i,()=>{U()}),Se(()=>s.isVisible,(Y,v)=>{Y&&!v&&U()}),dt(()=>{c.value&&U()}),(Y,v)=>(E(),L("aside",{ref_key:"sidebarRef",ref:l,id:"thumbnail-sidebar",class:"thumbnail-sidebar"},[e("div",Lr,[v[5]||(v[5]=e("h2",null,"å›¾ç‰‡æ¦‚è§ˆ",-1)),c.value&&H(C)&&H(p)?(E(),L(ze,{key:0},[e("div",Fr,[(E(!0),L(ze,null,Ye(H($),(m,b)=>(E(),L(ze,{key:m.path},[e("span",{class:Re(["breadcrumb-item",{active:b===H($).length-1}]),onClick:f=>b<H($).length-1&&se(m.path)},ee(b===0?"ğŸ“":"")+ee(m.name),11,Ur),b<H($).length-1?(E(),L("span",Or,"/")):ce("",!0)],64))),128))]),H(D)?(E(),L("div",{key:0,class:"folder-back-btn",onClick:v[0]||(v[0]=(...m)=>H(B)&&H(B)(...m))},[...v[1]||(v[1]=[e("span",{class:"back-icon"},"â¬…ï¸",-1),e("span",null,"è¿”å›ä¸Šçº§",-1)])])):ce("",!0),e("div",{ref_key:"containerRef",ref:r,class:"folder-content-list"},[(E(!0),L(ze,null,Ye(H(R),m=>(E(),L("div",{key:m.path,class:"folder-item",onClick:b=>j(m)},[v[2]||(v[2]=e("span",{class:"folder-icon"},"ğŸ“",-1)),e("div",Nr,[e("span",{class:"folder-name",title:m.name},ee(m.name),9,Vr),e("span",Wr,"("+ee(H(h)(m))+")",1)])],8,zr))),128)),(E(!0),L(ze,null,Ye(H(k),m=>(E(),L("div",{key:m.id,ref_for:!0,ref:b=>Z(b,S(m)),class:Re(["thumbnail-item",{active:S(m)===i.value}]),title:ae(m),onClick:b=>te(S(m))},[m.originalDataURL?(E(),L("img",{key:0,src:m.originalDataURL,alt:m.fileName,class:"thumbnail-image"},null,8,qr)):ce("",!0),e("span",Hr,ee(S(m)+1),1),O(m)?(E(),L("span",jr,"âœ“")):ce("",!0),F(m)==="failed"?(E(),L("span",Jr,"!")):F(m)==="labeled"?(E(),L("span",Gr,"âœï¸")):ce("",!0),F(m)==="processing"?(E(),L("div",Yr,"âŸ³")):ce("",!0)],10,Kr))),128)),H(R).length===0&&H(k).length===0?(E(),L("div",Xr,[...v[3]||(v[3]=[e("p",null,"æ­¤æ–‡ä»¶å¤¹ä¸ºç©º",-1)])])):ce("",!0)],512)],64)):c.value?(E(),L("ul",{key:1,ref_key:"containerRef",ref:r,id:"thumbnailList",class:"thumbnail-list"},[(E(!0),L(ze,null,Ye(g.value,(m,b)=>(E(),L("li",{key:m.id,ref_for:!0,ref:f=>Z(f,b),class:Re(["thumbnail-item",{active:b===i.value}]),title:ae(m),"data-index":b,onClick:f=>te(b)},[m.originalDataURL?(E(),L("img",{key:0,src:m.originalDataURL,alt:m.fileName,class:"thumbnail-image"},null,8,Qr)):ce("",!0),e("span",eu,ee(b+1),1),O(m)?(E(),L("span",tu,"âœ“")):ce("",!0),F(m)==="failed"?(E(),L("span",ou,"!")):F(m)==="labeled"?(E(),L("span",nu,"âœï¸")):ce("",!0),F(m)==="processing"?(E(),L("div",su," âŸ³ ")):ce("",!0)],10,Zr))),128))],512)):(E(),L("div",au,[...v[4]||(v[4]=[e("p",null,"æš‚æ— å›¾ç‰‡",-1)])]))])],512))}}),iu=Je(lu,[["__scopeId","data-v-fe7c0b49"]]),ru={class:"saved-prompts-picker"},uu={class:"prompts-chips-container"},cu={key:0,class:"empty-hint"},du={key:1,class:"empty-hint"},gu=["title","onClick"],pu=Ge({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(n,{expose:t,emit:s}){const o=n,a=s,l=w([]),r=w(!1);async function x(){r.value=!0;try{let i;o.promptType==="textbox"?i=await He.getTextboxPrompts():i=await He.getPrompts(o.promptType);const c=i.prompt_names||[];l.value=c.map(C=>({name:C}))}catch(i){console.error("åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥:",i),l.value=[]}finally{r.value=!1}}async function g(i){try{let c;o.promptType==="textbox"?c=await He.getTextboxPromptContent(i):c=await He.getPromptContent(o.promptType,i),c.prompt_content&&a("select",c.prompt_content,i)}catch(c){console.error("åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥:",c)}}return Se(()=>o.promptType,()=>{x()}),dt(()=>{x()}),t({refresh:x}),(i,c)=>(E(),L("div",ru,[c[1]||(c[1]=e("span",{class:"picker-label"},"ğŸ“‘ å¿«é€Ÿé€‰æ‹©:",-1)),e("div",uu,[r.value?(E(),L("span",cu,"åŠ è½½ä¸­...")):l.value.length===0?(E(),L("span",du,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(E(!0),L(ze,{key:2},Ye(l.value,C=>(E(),L("button",{key:C.name,type:"button",class:"prompt-chip",title:C.name,onClick:$=>g(C.name)},[c[0]||(c[0]=e("span",{class:"chip-icon"},"ğŸ“",-1)),ge(" "+ee(C.name),1)],8,gu))),128))])]))}}),Vt=Je(pu,[["__scopeId","data-v-2ebbb8b3"]]),mu={class:"ocr-settings"},vu={class:"settings-group"},fu={class:"settings-item"},bu={class:"settings-item"},hu={class:"input-hint"},xu={class:"settings-group"},yu={class:"settings-item"},Cu={class:"settings-group"},_u={class:"settings-row"},ku={class:"settings-item"},Su={class:"password-input-wrapper"},wu=["type"],$u={key:0,class:"eye-icon"},Tu={key:1,class:"eye-off-icon"},Iu={class:"settings-item"},Pu={class:"password-input-wrapper"},Ru=["type"],Du={key:0,class:"eye-icon"},Mu={key:1,class:"eye-off-icon"},Bu={class:"settings-row"},Au={class:"settings-item"},Eu={class:"settings-item"},Lu=["disabled"],Fu={class:"settings-group"},Uu={class:"settings-row"},Ou={class:"settings-item"},zu={class:"settings-item"},Nu={class:"password-input-wrapper"},Vu=["type"],Wu={key:0,class:"eye-icon"},Ku={key:1,class:"eye-off-icon"},qu={class:"settings-item"},Hu={class:"settings-item"},ju={class:"model-input-with-fetch"},Ju=["disabled"],Gu={class:"fetch-text"},Yu={key:0,class:"model-select-container"},Xu={class:"model-count"},Zu={class:"settings-item"},Qu={class:"prompt-format-selector"},ec={class:"input-hint"},tc={key:0,class:"paddleocr-vl-lang-selector"},oc={class:"settings-item"},nc={class:"settings-item"},sc=["disabled"],ac=Ge({__name:"OcrSettings",setup(n){const t=[{label:"MangaOCR (æ—¥è¯­ä¸“ç”¨)",value:"manga_ocr"},{label:"PaddleOCR (å¤šè¯­è¨€)",value:"paddle_ocr"},{label:"PaddleOCR-VL",value:"paddleocr_vl"},{label:"ç™¾åº¦OCR",value:"baidu_ocr"},{label:"48px OCR",value:"48px_ocr"},{label:"AIè§†è§‰OCR",value:"ai_vision"}],s=[{label:"æ ‡å‡†ç‰ˆ",value:"standard"},{label:"é«˜ç²¾åº¦ç‰ˆ",value:"high_precision"}],o=[{label:"è‡ªåŠ¨æ£€æµ‹",value:"auto_detect"},{label:"ä¸­è‹±æ–‡æ··åˆ",value:"CHN_ENG"},{label:"è‹±æ–‡",value:"ENG"},{label:"æ—¥è¯­",value:"JAP"},{label:"éŸ©è¯­",value:"KOR"},{label:"æ³•è¯­",value:"FRE"},{label:"å¾·è¯­",value:"GER"},{label:"ä¿„è¯­",value:"RUS"}],a=[{label:"SiliconFlow (ç¡…åŸºæµåŠ¨)",value:"siliconflow"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai_vision"}],l=[{label:"ğŸŒ ä¸œäºšè¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"è‹±è¯­",value:"english"},{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"},{label:"è·å…°è¯­",value:"dutch"},{label:"æ³¢å…°è¯­",value:"polish"}]},{label:"ğŸŒ ä¸œå—äºšè¯­è¨€",options:[{label:"æ³°è¯­",value:"thai"},{label:"è¶Šå—è¯­",value:"vietnamese"},{label:"å°å°¼è¯­",value:"indonesian"},{label:"é©¬æ¥è¯­",value:"malay"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"},{label:"é˜¿æ‹‰ä¼¯è¯­",value:"arabic"},{label:"å°åœ°è¯­",value:"hindi"},{label:"åœŸè€³å…¶è¯­",value:"turkish"},{label:"å¸Œè…Šè¯­",value:"greek"},{label:"å¸Œä¼¯æ¥è¯­",value:"hebrew"}]}],r=[{label:"æ™®é€šæç¤ºè¯",value:"normal"},{label:"JSONæç¤ºè¯",value:"json"},{label:"OCRæ¨¡å‹æç¤ºè¯",value:"paddleocr_vl"}],x=[{label:"ğŸš€ å¸¸ç”¨è¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"è‹±è¯­",value:"en"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"}]}],g=Fe(),i=ct(),c=w({apiKey:g.settings.baiduOcr.apiKey,secretKey:g.settings.baiduOcr.secretKey,version:g.settings.baiduOcr.version,sourceLanguage:g.settings.baiduOcr.sourceLanguage}),C=w({apiKey:g.settings.aiVisionOcr.apiKey,modelName:g.settings.aiVisionOcr.modelName,customBaseUrl:g.settings.aiVisionOcr.customBaseUrl,prompt:g.settings.aiVisionOcr.prompt,rpmLimit:g.settings.aiVisionOcr.rpmLimit,minImageSize:g.settings.aiVisionOcr.minImageSize}),$=J(()=>g.settings);Se(()=>c.value.apiKey,f=>{g.updateBaiduOcr({apiKey:f})}),Se(()=>c.value.secretKey,f=>{g.updateBaiduOcr({secretKey:f})}),Se(()=>c.value.version,f=>{g.updateBaiduOcr({version:f})}),Se(()=>c.value.sourceLanguage,f=>{g.updateBaiduOcr({sourceLanguage:f})}),Se(()=>C.value.apiKey,f=>{g.updateAiVisionOcr({apiKey:f})}),Se(()=>C.value.modelName,f=>{g.updateAiVisionOcr({modelName:f})}),Se(()=>C.value.customBaseUrl,f=>{g.updateAiVisionOcr({customBaseUrl:f})}),Se(()=>C.value.prompt,f=>{g.updateAiVisionOcr({prompt:f})}),Se(()=>C.value.rpmLimit,f=>{g.updateAiVisionOcr({rpmLimit:f})}),Se(()=>C.value.minImageSize,f=>{g.updateAiVisionOcr({minImageSize:f})});const R=w(!1),k=w(!1),D=w(!1),N=w(!1),B=w(!1),A=w([]),h=J(()=>{const f=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return A.value.forEach(u=>{f.push({label:u,value:u})}),f});function p(){g.saveToStorage()}function T(){g.saveToStorage()}function S(f){g.updatePaddleOcrVl({sourceLanguage:f})}function F(){switch(g.settings.ocrEngine){case"manga_ocr":return"MangaOCR ä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";case"paddle_ocr":return"PaddleOCR ä¼šæ ¹æ®æºè¯­è¨€åŠ è½½å¯¹åº”çš„è¯†åˆ«æ¨¡å‹";case"paddleocr_vl":return"PaddleOCR-VL åŸºäº VLM å¾®è°ƒï¼Œä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œå‡†ç¡®ç‡é«˜è¾¾ 70%";case"baidu_ocr":return"ç™¾åº¦OCR ä½¿ç”¨ç‹¬ç«‹çš„æºè¯­è¨€è®¾ç½®ï¼ˆè§ä¸‹æ–¹ï¼‰";case"ai_vision":return"AIè§†è§‰OCR é€šè¿‡æç¤ºè¯æŒ‡å®šè¯†åˆ«è¯­è¨€";case"48px_ocr":return"48px OCR æ”¯æŒæ—¥ä¸­è‹±éŸ©ç­‰å¤šè¯­è¨€ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";default:return"é€‰æ‹©è¦è¯†åˆ«çš„åŸæ–‡è¯­è¨€"}}function O(f){g.setAiVisionOcrProvider(f),A.value=[],te()}function te(){C.value.apiKey=g.settings.aiVisionOcr.apiKey,C.value.modelName=g.settings.aiVisionOcr.modelName,C.value.customBaseUrl=g.settings.aiVisionOcr.customBaseUrl,C.value.prompt=g.settings.aiVisionOcr.prompt,C.value.rpmLimit=g.settings.aiVisionOcr.rpmLimit,C.value.minImageSize=g.settings.aiVisionOcr.minImageSize}const j=J(()=>{const f=g.settings.aiVisionOcr.prompt;return f&&f.includes("è¿›è¡ŒOCR:")&&!f.includes("åŠ©æ‰‹")?"paddleocr_vl":g.settings.aiVisionOcr.isJsonMode?"json":"normal"});function se(){switch(j.value){case"paddleocr_vl":return"PaddleOCR-VLã€GLM-OCR ç­‰ä¸“ç”¨ OCR æ¨¡å‹ä¸“ç”¨æç¤ºè¯";case"json":return"JSON æ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–";default:return"é€šç”¨ VLM æç¤ºè¯ï¼Œè‹¥ä½¿ç”¨ PaddleOCR-VLã€GLM-OCR ç­‰ä¸“ç”¨æ¨¡å‹ï¼Œè¯·é€‰æ‹©ã€ŒOCRæ¨¡å‹æç¤ºè¯ã€"}}function U(f){let u,y=!1;switch(f){case"json":u=Ss,y=!0;break;case"paddleocr_vl":const I=tn[Z.value]||"æ—¥è¯­";u=on(I),y=!1;break;default:u=ks,y=!1;break}g.updateAiVisionOcr({prompt:u,isJsonMode:y}),C.value.prompt=u}const Z=w("japanese");function ae(f){Z.value=f;const u=tn[f]||"æ—¥è¯­",y=on(u);g.updateAiVisionOcr({prompt:y}),C.value.prompt=y}async function Y(){const f=c.value.apiKey?.trim(),u=c.value.secretKey?.trim();if(!f||!u){i.warning("è¯·å¡«å†™ç™¾åº¦OCRçš„API Keyå’ŒSecret Key");return}N.value=!0,i.info("æ­£åœ¨æµ‹è¯•ç™¾åº¦OCRè¿æ¥...");try{const y=await He.testBaiduOcrConnection(f,u);y.success?i.success(y.message||"ç™¾åº¦OCRè¿æ¥æˆåŠŸ!"):i.error(y.message||y.error||"ç™¾åº¦OCRè¿æ¥å¤±è´¥")}catch(y){const I=y instanceof Error?y.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(I)}finally{N.value=!1}}async function v(){N.value=!0;try{const f=await He.testAiVisionOcrConnection({provider:g.settings.aiVisionOcr.provider,apiKey:C.value.apiKey,modelName:C.value.modelName,customBaseUrl:C.value.customBaseUrl,prompt:C.value.prompt});f.success?i.success("AIè§†è§‰OCRè¿æ¥æˆåŠŸ"):i.error(`AIè§†è§‰OCRè¿æ¥å¤±è´¥: ${f.error||"æœªçŸ¥é”™è¯¯"}`)}catch(f){const u=f instanceof Error?f.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(u)}finally{N.value=!1}}async function m(){const f=g.settings.aiVisionOcr.provider,u=C.value.apiKey?.trim(),y=C.value.customBaseUrl?.trim();if(!u){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(f)){i.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨");return}if(f==="custom_openai_vision"&&!y){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}B.value=!0;try{const M=await He.fetchModels(f,u,y);M.success&&M.models&&M.models.length>0?(A.value=M.models.map(V=>V.id),i.success(`è·å–åˆ° ${M.models.length} ä¸ªæ¨¡å‹`)):i.warning(M.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(M){const V=M instanceof Error?M.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(V)}finally{B.value=!1}}function b(f,u){g.updateAiVisionOcr({prompt:f}),C.value.prompt=f,i.success(`å·²åº”ç”¨æç¤ºè¯: ${u}`)}return(f,u)=>(E(),L("div",mu,[e("div",vu,[u[22]||(u[22]=e("div",{class:"settings-group-title"},"OCRå¼•æ“é€‰æ‹©",-1)),e("div",fu,[u[20]||(u[20]=e("label",{for:"settingsOcrEngine"},"OCRå¼•æ“:",-1)),_e(We,{"model-value":$.value.ocrEngine,options:t,onChange:u[0]||(u[0]=y=>{$.value.ocrEngine=y,p()})},null,8,["model-value"])]),oe(e("div",bu,[u[21]||(u[21]=e("label",{for:"settingsSourceLanguage"},"æºè¯­è¨€:",-1)),_e(We,{"model-value":$.value.sourceLanguage,groups:x,onChange:u[1]||(u[1]=y=>{$.value.sourceLanguage=y,T()})},null,8,["model-value"]),e("div",hu,ee(F()),1)],512),[[Oe,$.value.ocrEngine==="paddle_ocr"]])]),oe(e("div",xu,[u[25]||(u[25]=e("div",{class:"settings-group-title"},"PaddleOCR-VL è®¾ç½®",-1)),e("div",yu,[u[23]||(u[23]=e("label",{for:"settingsPaddleOcrVlSourceLanguage"},"æºè¯­è¨€:",-1)),_e(We,{"model-value":$.value.paddleOcrVl.sourceLanguage,groups:l,onChange:u[2]||(u[2]=y=>S(y))},null,8,["model-value"]),u[24]||(u[24]=e("div",{class:"input-hint"}," é€‰æ‹©å›¾åƒä¸­çš„æºè¯­è¨€ï¼Œç”¨äºä¼˜åŒ– OCR è¯†åˆ«æ•ˆæœ ",-1))])],512),[[Oe,$.value.ocrEngine==="paddleocr_vl"]]),oe(e("div",Cu,[u[30]||(u[30]=e("div",{class:"settings-group-title"},"ç™¾åº¦OCR è®¾ç½®",-1)),e("div",_u,[e("div",ku,[u[26]||(u[26]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",Su,[oe(e("input",{type:R.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":u[3]||(u[3]=y=>c.value.apiKey=y),class:"secure-input",placeholder:"è¯·è¾“å…¥ç™¾åº¦OCR API Key",autocomplete:"off"},null,8,wu),[[St,c.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:u[4]||(u[4]=y=>R.value=!R.value)},[R.value?(E(),L("span",Tu,"ğŸ‘â€ğŸ—¨")):(E(),L("span",$u,"ğŸ‘"))])])]),e("div",Iu,[u[27]||(u[27]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",Pu,[oe(e("input",{type:k.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":u[5]||(u[5]=y=>c.value.secretKey=y),class:"secure-input",placeholder:"è¯·è¾“å…¥Secret Key",autocomplete:"off"},null,8,Ru),[[St,c.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:u[6]||(u[6]=y=>k.value=!k.value)},[k.value?(E(),L("span",Mu,"ğŸ‘â€ğŸ—¨")):(E(),L("span",Du,"ğŸ‘"))])])])]),e("div",Bu,[e("div",Au,[u[28]||(u[28]=e("label",{for:"settingsBaiduVersion"},"è¯†åˆ«ç‰ˆæœ¬:",-1)),_e(We,{modelValue:c.value.version,"onUpdate:modelValue":u[7]||(u[7]=y=>c.value.version=y),options:s},null,8,["modelValue"])]),e("div",Eu,[u[29]||(u[29]=e("label",{for:"settingsBaiduSourceLanguage"},"æºè¯­è¨€:",-1)),_e(We,{modelValue:c.value.sourceLanguage,"onUpdate:modelValue":u[8]||(u[8]=y=>c.value.sourceLanguage=y),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:Y,disabled:N.value},ee(N.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Lu)],512),[[Oe,$.value.ocrEngine==="baidu_ocr"]]),oe(e("div",Fu,[u[42]||(u[42]=e("div",{class:"settings-group-title"},"AIè§†è§‰OCR è®¾ç½®",-1)),e("div",Uu,[e("div",Ou,[u[31]||(u[31]=e("label",{for:"settingsAiVisionProvider"},"æœåŠ¡å•†:",-1)),_e(We,{"model-value":$.value.aiVisionOcr.provider,options:a,onChange:u[9]||(u[9]=y=>O(y))},null,8,["model-value"])]),e("div",zu,[u[32]||(u[32]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",Nu,[oe(e("input",{type:D.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":u[10]||(u[10]=y=>C.value.apiKey=y),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Vu),[[St,C.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:u[11]||(u[11]=y=>D.value=!D.value)},[D.value?(E(),L("span",Ku,"ğŸ‘â€ğŸ—¨")):(E(),L("span",Wu,"ğŸ‘"))])])])]),oe(e("div",qu,[u[33]||(u[33]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),oe(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":u[12]||(u[12]=y=>C.value.customBaseUrl=y),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Pe,C.value.customBaseUrl]])],512),[[Oe,$.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",Hu,[u[35]||(u[35]=e("label",{for:"settingsAiVisionModelName"},"æ¨¡å‹åç§°:",-1)),e("div",ju,[oe(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":u[13]||(u[13]=y=>C.value.modelName=y),placeholder:"å¦‚: silicon-llava2-34b"},null,512),[[Pe,C.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:m,disabled:B.value},[u[34]||(u[34]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Gu,ee(B.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Ju)]),A.value.length>0?(E(),L("div",Yu,[_e(We,{modelValue:C.value.modelName,"onUpdate:modelValue":u[14]||(u[14]=y=>C.value.modelName=y),options:h.value},null,8,["modelValue","options"]),e("span",Xu,"å…± "+ee(A.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)]),e("div",Zu,[u[37]||(u[37]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCRæç¤ºè¯:",-1)),oe(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":u[15]||(u[15]=y=>C.value.prompt=y),rows:"3",placeholder:"AIè§†è§‰OCRæç¤ºè¯"},null,512),[[Pe,C.value.prompt]]),_e(Vt,{"prompt-type":"ai_vision_ocr",onSelect:b}),e("div",Qu,[_e(We,{"model-value":j.value,options:r,onChange:u[16]||(u[16]=y=>U(String(y)))},null,8,["model-value"]),e("span",ec,ee(se()),1)]),j.value==="paddleocr_vl"?(E(),L("div",tc,[u[36]||(u[36]=e("label",null,"æºè¯­è¨€:",-1)),_e(We,{"model-value":Z.value,groups:l,onChange:u[17]||(u[17]=y=>ae(String(y)))},null,8,["model-value"])])):ce("",!0)]),e("div",oc,[u[38]||(u[38]=e("label",{for:"settingsRpmAiVisionOcr"},"RPMé™åˆ¶ (æ¯åˆ†é’Ÿè¯·æ±‚æ•°):",-1)),oe(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":u[18]||(u[18]=y=>C.value.rpmLimit=y),min:"0",step:"1"},null,512),[[Pe,C.value.rpmLimit,void 0,{number:!0}]]),u[39]||(u[39]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",nc,[u[40]||(u[40]=e("label",{for:"settingsMinImageSize"},"æœ€å°å›¾ç‰‡å°ºå¯¸ (åƒç´ ):",-1)),oe(e("input",{type:"number",id:"settingsMinImageSize","onUpdate:modelValue":u[19]||(u[19]=y=>C.value.minImageSize=y),min:"0",step:"1"},null,512),[[Pe,C.value.minImageSize,void 0,{number:!0}]]),u[41]||(u[41]=e("div",{class:"input-hint"},"VLMæ¨¡å‹é€šå¸¸è¦æ±‚å›¾ç‰‡å°ºå¯¸ â‰¥28pxï¼Œè®¾ä¸º0åˆ™ä¸è‡ªåŠ¨æ”¾å¤§å°å›¾",-1))]),e("button",{class:"settings-test-btn",onClick:v,disabled:N.value},ee(N.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,sc)],512),[[Oe,$.value.ocrEngine==="ai_vision"]])]))}}),lc=Je(ac,[["__scopeId","data-v-dc2069d7"]]),ic={class:"translation-settings"},rc={class:"settings-group"},uc={class:"settings-row"},cc={class:"settings-item"},dc={class:"settings-item"},gc={for:"settingsApiKey"},pc={class:"password-input-wrapper"},mc=["type","placeholder"],vc={key:0,class:"eye-icon"},fc={key:1,class:"eye-off-icon"},bc={class:"settings-item"},hc={class:"settings-item"},xc={for:"settingsModelName"},yc={class:"model-input-with-fetch"},Cc=["placeholder"],_c=["disabled"],kc={class:"fetch-text"},Sc={key:0,class:"model-select-container"},wc={class:"model-count"},$c={class:"settings-item"},Tc={class:"model-input-with-fetch"},Ic=["placeholder"],Pc=["disabled"],Rc={class:"fetch-text"},Dc={key:0,class:"model-select-container"},Mc={class:"model-count"},Bc={class:"settings-row"},Ac={class:"settings-item"},Ec={class:"settings-item"},Lc={class:"settings-item"},Fc={class:"input-hint translation-mode-hint"},Uc={key:0},Oc={key:1},zc={key:0,class:"input-hint sakura-suggestion"},Nc={class:"settings-item"},Vc=["disabled"],Wc={class:"settings-item"},Kc=["disabled"],qc={class:"settings-group"},Hc={class:"settings-item"},jc={class:"prompt-format-selector"},Jc={class:"settings-item"},Gc={class:"checkbox-label"},Yc={class:"settings-item"},Xc=Ge({__name:"TranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"å½©äº‘å°è¯‘",value:"caiyun"},{label:"ç™¾åº¦ç¿»è¯‘",value:"baidu_translate"},{label:"æœ‰é“ç¿»è¯‘",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (æœ¬åœ°)",value:"ollama"},{label:"Sakura (æœ¬åœ°)",value:"sakura"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"æ™®é€šæç¤ºè¯",value:"normal"},{label:"JSONæç¤ºè¯",value:"json"}],o=[{label:"æ•´é¡µæ‰¹é‡ç¿»è¯‘ (æ¨è)",value:"batch"},{label:"é€æ°”æ³¡ç¿»è¯‘ (é€‚åˆå°æ¨¡å‹)",value:"single"}],a=Fe(),l=ct(),r=a.settings.translation.translationMode||"batch",x=a.settings.translation.isJsonMode||!1,g=()=>{const f=a.settings.translation;return r==="single"?x?f.singleJsonPrompt:f.singleNormalPrompt:x?f.batchJsonPrompt:f.batchNormalPrompt},i=w({modelProvider:a.settings.translation.provider,apiKey:a.settings.translation.apiKey,modelName:a.settings.translation.modelName,customBaseUrl:a.settings.translation.customBaseUrl,rpmTranslation:a.settings.translation.rpmLimit,translationMaxRetries:a.settings.translation.maxRetries,translationMode:r,promptContent:g(),translatePromptMode:x?"json":"normal",enableTextboxPrompt:a.settings.useTextboxPrompt,textboxPromptContent:a.settings.textboxPrompt}),c=w(!1),C=w(!1),$=w(!1),R=w([]),k=w([]),D=J(()=>{const f=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return R.value.forEach(u=>f.push({label:u,value:u})),f}),N=J(()=>{const f=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return k.value.forEach(u=>f.push({label:u,value:u})),f}),B=J(()=>["ollama","sakura"].includes(i.value.modelProvider)),A=J(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(i.value.modelProvider)),h=J(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(i.value.modelProvider)),p=J(()=>{switch(i.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),T=J(()=>{switch(i.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App ID";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨ID";case"caiyun":return"è¯·è¾“å…¥å½©äº‘å°è¯‘Token";default:return"è¯·è¾“å…¥API Key"}}),S=J(()=>{switch(i.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"æºè¯­è¨€ (å¯é€‰)";default:return"æ¨¡å‹åç§°"}}),F=J(()=>{switch(i.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App Key";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨å¯†é’¥";case"caiyun":return"å¯é€‰: auto/æ—¥è¯­/è‹±è¯­";default:return"è¯·è¾“å…¥æ¨¡å‹åç§°"}});function O(){const f=i.value.modelProvider;a.setTranslationProvider(f),i.value.apiKey=a.settings.translation.apiKey,i.value.modelName=a.settings.translation.modelName,i.value.customBaseUrl=a.settings.translation.customBaseUrl,i.value.rpmTranslation=a.settings.translation.rpmLimit,i.value.translationMaxRetries=a.settings.translation.maxRetries,i.value.translationMode=a.settings.translation.translationMode||"batch",R.value=[],k.value=[]}function te(){const f=i.value.translatePromptMode==="json",u=!f,y=i.value.translationMode==="single";y?u?a.updateTranslationService({singleJsonPrompt:i.value.promptContent}):a.updateTranslationService({singleNormalPrompt:i.value.promptContent}):u?a.updateTranslationService({batchJsonPrompt:i.value.promptContent}):a.updateTranslationService({batchNormalPrompt:i.value.promptContent});const I=a.settings.translation;let M;y?M=f?I.singleJsonPrompt:I.singleNormalPrompt:M=f?I.batchJsonPrompt:I.batchNormalPrompt,i.value.promptContent=M,a.updateTranslationService({isJsonMode:f}),a.setTranslatePrompt(M)}function j(f){const u=String(f),y=i.value.translationMode,I=i.value.translatePromptMode==="json";if(u===y)return;y==="batch"?I?a.updateTranslationService({batchJsonPrompt:i.value.promptContent}):a.updateTranslationService({batchNormalPrompt:i.value.promptContent}):I?a.updateTranslationService({singleJsonPrompt:i.value.promptContent}):a.updateTranslationService({singleNormalPrompt:i.value.promptContent}),i.value.translationMode=u,a.updateTranslationService({translationMode:u});const M=a.settings.translation;let V;u==="single"?V=I?M.singleJsonPrompt:M.singleNormalPrompt:V=I?M.batchJsonPrompt:M.batchNormalPrompt,i.value.promptContent=V,a.setTranslatePrompt(V),console.log(`ç¿»è¯‘æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${u==="batch"?"æ•´é¡µæ‰¹é‡ç¿»è¯‘":"é€æ°”æ³¡ç¿»è¯‘"}`)}Se(()=>i.value.apiKey,f=>{a.updateTranslationService({apiKey:f})}),Se(()=>i.value.modelName,f=>{a.updateTranslationService({modelName:f})}),Se(()=>i.value.customBaseUrl,f=>{a.updateTranslationService({customBaseUrl:f})}),Se(()=>i.value.rpmTranslation,f=>{a.updateTranslationService({rpmLimit:f})}),Se(()=>i.value.translationMaxRetries,f=>{a.updateTranslationService({maxRetries:f})}),Se(()=>i.value.promptContent,f=>{a.setTranslatePrompt(f);const u=i.value.translationMode==="batch",y=i.value.translatePromptMode==="json";u?y?a.updateTranslationService({batchJsonPrompt:f}):a.updateTranslationService({batchNormalPrompt:f}):y?a.updateTranslationService({singleJsonPrompt:f}):a.updateTranslationService({singleNormalPrompt:f})}),Se(()=>i.value.enableTextboxPrompt,f=>{a.setUseTextboxPrompt(f)}),Se(()=>i.value.textboxPromptContent,f=>{a.setTextboxPrompt(f)});async function se(){const f=i.value.modelProvider,u=i.value.apiKey?.trim(),y=i.value.customBaseUrl?.trim();if(!u){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(f)){l.warning(`${U(f)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(f==="custom_openai"&&!y){l.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}$.value=!0;try{const M=await He.fetchModels(f,u,y);M.success&&M.models&&M.models.length>0?(R.value=M.models.map(V=>V.id),l.success(`è·å–åˆ° ${M.models.length} ä¸ªæ¨¡å‹`)):l.warning(M.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(M){const V=M instanceof Error?M.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";l.error(V)}finally{$.value=!1}}function U(f){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘"}[f]||f}async function Z(){const f=i.value.modelProvider;$.value=!0;try{let u;if(f==="ollama")u=await He.testOllamaConnection();else if(f==="sakura")u=await He.testSakuraConnection();else{l.error("æœªé€‰æ‹©æœ¬åœ°æœåŠ¡å•†");return}u.success&&u.models?(k.value=u.models,l.success(`è·å–åˆ° ${u.models.length} ä¸ª${f==="ollama"?"Ollama":"Sakura"}æ¨¡å‹`)):l.error(u.error||`${f==="ollama"?"Ollama":"Sakura"}è¿æ¥å¤±è´¥`)}catch(u){const y=u instanceof Error?u.message:"è·å–æœ¬åœ°æ¨¡å‹å¤±è´¥";l.error(y)}finally{$.value=!1}}async function ae(){C.value=!0;try{let f;i.value.modelProvider==="ollama"?f=await He.testOllamaConnection():f=await He.testSakuraConnection(),f.success?l.success(`${i.value.modelProvider==="ollama"?"Ollama":"Sakura"} è¿æ¥æˆåŠŸ`):l.error(f.error||"è¿æ¥å¤±è´¥")}catch(f){const u=f instanceof Error?f.message:"è¿æ¥æµ‹è¯•å¤±è´¥";l.error(u)}finally{C.value=!1}}async function Y(){const f=i.value.modelProvider,u=i.value.apiKey?.trim(),y=i.value.modelName?.trim(),I=i.value.customBaseUrl?.trim();if(!u){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(f!=="caiyun"&&!y){l.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(f==="custom_openai"&&!I){l.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}C.value=!0,l.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{let M;switch(f){case"baidu_translate":M=await He.testBaiduTranslateConnection(u,y);break;case"youdao_translate":M=await He.testYoudaoTranslateConnection(u,y);break;default:M=await He.testAiTranslateConnection({provider:f,apiKey:u,modelName:y,baseUrl:I})}M.success?l.success(M.message||`${U(f)} è¿æ¥æˆåŠŸ!`):l.error(M.message||M.error||"è¿æ¥å¤±è´¥")}catch(M){const V=M instanceof Error?M.message:"è¿æ¥æµ‹è¯•å¤±è´¥";l.error(V)}finally{C.value=!1}}function v(f,u){i.value.promptContent=f,l.success(`å·²åº”ç”¨æç¤ºè¯: ${u}`)}function m(f,u){i.value.textboxPromptContent=f,l.success(`å·²åº”ç”¨æç¤ºè¯: ${u}`)}function b(){const f=i.value.translatePromptMode==="json";i.value.translationMode==="single"?i.value.promptContent=f?ws:$s:i.value.promptContent=f?Ts:Is,l.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}return(f,u)=>(E(),L("div",ic,[e("div",rc,[u[23]||(u[23]=e("div",{class:"settings-group-title"},"ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",uc,[e("div",cc,[u[14]||(u[14]=e("label",{for:"settingsModelProvider"},"ç¿»è¯‘æœåŠ¡å•†:",-1)),_e(We,{"model-value":i.value.modelProvider,options:t,onChange:u[0]||(u[0]=y=>{i.value.modelProvider=y,O()})},null,8,["model-value"])]),oe(e("div",dc,[e("label",gc,ee(p.value)+":",1),e("div",pc,[oe(e("input",{type:c.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":u[1]||(u[1]=y=>i.value.apiKey=y),class:"secure-input",placeholder:T.value,autocomplete:"off"},null,8,mc),[[St,i.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:u[2]||(u[2]=y=>c.value=!c.value)},[c.value?(E(),L("span",fc,"ğŸ‘â€ğŸ—¨")):(E(),L("span",vc,"ğŸ‘"))])])],512),[[Oe,!B.value]])]),oe(e("div",bc,[u[15]||(u[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),oe(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":u[3]||(u[3]=y=>i.value.customBaseUrl=y),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Pe,i.value.customBaseUrl]])],512),[[Oe,i.value.modelProvider==="custom_openai"]]),oe(e("div",hc,[e("label",xc,ee(S.value)+":",1),e("div",yc,[oe(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":u[4]||(u[4]=y=>i.value.modelName=y),placeholder:F.value},null,8,Cc),[[Pe,i.value.modelName]]),oe(e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:se,disabled:$.value},[u[16]||(u[16]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",kc,ee($.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,_c),[[Oe,h.value]])]),R.value.length>0?(E(),L("div",Sc,[_e(We,{"model-value":i.value.modelName,options:D.value,onChange:u[5]||(u[5]=y=>{i.value.modelName=y})},null,8,["model-value","options"]),e("span",wc,"å…± "+ee(R.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)],512),[[Oe,!B.value]]),oe(e("div",$c,[u[18]||(u[18]=e("label",{for:"settingsLocalModelName"},"æ¨¡å‹åç§°:",-1)),e("div",Tc,[oe(e("input",{type:"text",id:"settingsLocalModelName","onUpdate:modelValue":u[6]||(u[6]=y=>i.value.modelName=y),placeholder:i.value.modelProvider==="ollama"?"ä¾‹å¦‚: qwen2.5:7b":"ä¾‹å¦‚: sakura-14b-qwen2.5-v1.0"},null,8,Ic),[[Pe,i.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–æœ¬åœ°å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:Z,disabled:$.value},[u[17]||(u[17]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Rc,ee($.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Pc)]),k.value.length>0?(E(),L("div",Dc,[_e(We,{"model-value":i.value.modelName,options:N.value,onChange:u[7]||(u[7]=y=>i.value.modelName=y)},null,8,["model-value","options"]),e("span",Mc,"å…± "+ee(k.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)],512),[[Oe,B.value]]),oe(e("div",Bc,[e("div",Ac,[u[19]||(u[19]=e("label",{for:"settingsRpmTranslation"},"RPMé™åˆ¶:",-1)),oe(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":u[8]||(u[8]=y=>i.value.rpmTranslation=y),min:"0",step:"1"},null,512),[[Pe,i.value.rpmTranslation,void 0,{number:!0}]]),u[20]||(u[20]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Ec,[u[21]||(u[21]=e("label",{for:"settingsTranslationMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),oe(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":u[9]||(u[9]=y=>i.value.translationMaxRetries=y),min:"0",max:"10",step:"1"},null,512),[[Pe,i.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Oe,A.value]]),e("div",Lc,[u[22]||(u[22]=e("label",{for:"settingsTranslationMode"},"ç¿»è¯‘æ¨¡å¼:",-1)),_e(We,{"model-value":i.value.translationMode,options:o,onChange:j},null,8,["model-value"]),e("div",Fc,[i.value.translationMode==="batch"?(E(),L("span",Uc," ğŸ’¡ æ•´é¡µæ‰¹é‡ç¿»è¯‘ï¼šä¸€æ¬¡å‘é€å…¨éƒ¨æ°”æ³¡ï¼Œæ•ˆç‡é«˜ï¼Œéœ€è¦æ¨¡å‹æ”¯æŒå¤æ‚æŒ‡ä»¤ ")):(E(),L("span",Oc," ğŸ’¡ é€æ°”æ³¡ç¿»è¯‘ï¼šæ¯ä¸ªæ°”æ³¡å•ç‹¬ç¿»è¯‘ï¼Œæ›´ç¨³å®šï¼Œé€‚åˆå°æ¨¡å‹æˆ–æ ¼å¼æ•æ„Ÿåœºæ™¯ "))]),i.value.modelProvider==="sakura"?(E(),L("div",zc,' âš ï¸ å»ºè®® Sakura æœåŠ¡ä½¿ç”¨"é€æ°”æ³¡ç¿»è¯‘"æ¨¡å¼ï¼Œå¯è·å¾—æ›´ç¨³å®šçš„ç¿»è¯‘æ•ˆæœ ')):ce("",!0)]),oe(e("div",Nc,[e("button",{class:"settings-test-btn",onClick:ae,disabled:C.value},ee(C.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Vc)],512),[[Oe,B.value]]),oe(e("div",Wc,[e("button",{class:"settings-test-btn",onClick:Y,disabled:C.value},ee(C.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Kc)],512),[[Oe,!B.value]])]),e("div",qc,[u[28]||(u[28]=e("div",{class:"settings-group-title"},"æç¤ºè¯è®¾ç½®",-1)),e("div",Hc,[u[25]||(u[25]=e("label",{for:"settingsPromptContent"},"ç¿»è¯‘æç¤ºè¯:",-1)),oe(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":u[10]||(u[10]=y=>i.value.promptContent=y),rows:"4",placeholder:"ç¿»è¯‘æç¤ºè¯"},null,512),[[Pe,i.value.promptContent]]),e("div",jc,[_e(We,{"model-value":i.value.translatePromptMode,options:s,onChange:u[11]||(u[11]=y=>{i.value.translatePromptMode=y,te()})},null,8,["model-value"]),u[24]||(u[24]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))]),_e(Vt,{"prompt-type":"translate",onSelect:v}),e("button",{type:"button",class:"reset-btn",onClick:b}," é‡ç½®ä¸ºé»˜è®¤ ")]),e("div",Jc,[e("label",Gc,[oe(e("input",{type:"checkbox","onUpdate:modelValue":u[12]||(u[12]=y=>i.value.enableTextboxPrompt=y)},null,512),[[Xe,i.value.enableTextboxPrompt]]),u[26]||(u[26]=ge(" å¯ç”¨æ–‡æœ¬æ¡†æç¤ºè¯ ",-1))])]),oe(e("div",Yc,[u[27]||(u[27]=e("label",{for:"settingsTextboxPromptContent"},"æ–‡æœ¬æ¡†æç¤ºè¯:",-1)),oe(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":u[13]||(u[13]=y=>i.value.textboxPromptContent=y),rows:"3",placeholder:"æ–‡æœ¬æ¡†æç¤ºè¯"},null,512),[[Pe,i.value.textboxPromptContent]]),_e(Vt,{"prompt-type":"textbox",onSelect:m})],512),[[Oe,i.value.enableTextboxPrompt]])])]))}}),Zc=Je(Xc,[["__scopeId","data-v-7c76de5c"]]),Qc={class:"detection-settings"},ed={class:"settings-group"},td={class:"settings-item"},od={class:"settings-group"},nd={class:"settings-item"},sd={class:"settings-row"},ad={class:"settings-item"},ld={class:"settings-item"},id={class:"settings-row"},rd={class:"settings-item"},ud={class:"settings-item"},cd={class:"settings-group"},dd={class:"settings-row"},gd={class:"settings-item"},pd={class:"settings-item"},md={class:"settings-group"},vd={class:"settings-item"},fd={class:"checkbox-label"},bd=Ge({__name:"DetectionSettings",setup(n){const t=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],s=Fe(),o=So({textDetector:s.settings.textDetector,boxExpandRatio:s.settings.boxExpand.ratio,boxExpandTop:s.settings.boxExpand.top,boxExpandBottom:s.settings.boxExpand.bottom,boxExpandLeft:s.settings.boxExpand.left,boxExpandRight:s.settings.boxExpand.right,maskDilateSize:s.settings.preciseMask.dilateSize,maskBoxExpandRatio:s.settings.preciseMask.boxExpandRatio,showDetectionDebug:s.settings.showDetectionDebug});return Se(()=>o.textDetector,a=>{s.setTextDetector(a)}),Se(()=>o.boxExpandRatio,a=>{s.updateBoxExpand({ratio:a})}),Se(()=>o.boxExpandTop,a=>{s.updateBoxExpand({top:a})}),Se(()=>o.boxExpandBottom,a=>{s.updateBoxExpand({bottom:a})}),Se(()=>o.boxExpandLeft,a=>{s.updateBoxExpand({left:a})}),Se(()=>o.boxExpandRight,a=>{s.updateBoxExpand({right:a})}),Se(()=>o.maskDilateSize,a=>{s.updatePreciseMask({dilateSize:a})}),Se(()=>o.maskBoxExpandRatio,a=>{s.updatePreciseMask({boxExpandRatio:a})}),Se(()=>o.showDetectionDebug,a=>{s.setShowDetectionDebug(a)}),(a,l)=>(E(),L("div",Qc,[e("div",ed,[l[10]||(l[10]=e("div",{class:"settings-group-title"},"æ–‡å­—æ£€æµ‹å™¨",-1)),e("div",td,[l[9]||(l[9]=e("label",{for:"settingsTextDetector"},"æ£€æµ‹å™¨ç±»å‹:",-1)),_e(We,{modelValue:o.textDetector,"onUpdate:modelValue":l[0]||(l[0]=r=>o.textDetector=r),options:t},null,8,["modelValue"])])]),e("div",od,[l[17]||(l[17]=e("div",{class:"settings-group-title"},"æ–‡æœ¬æ¡†æ‰©å±•å‚æ•°",-1)),e("div",nd,[l[11]||(l[11]=e("label",{for:"settingsBoxExpandRatio"},"æ•´ä½“æ‰©å±• (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":l[1]||(l[1]=r=>o.boxExpandRatio=r),min:"0",max:"50",step:"1"},null,512),[[Pe,o.boxExpandRatio,void 0,{number:!0}]]),l[12]||(l[12]=e("div",{class:"input-hint"},"å‘å››å‘¨å‡åŒ€æ‰©å±•çš„ç™¾åˆ†æ¯” (0-50%)",-1))]),e("div",sd,[e("div",ad,[l[13]||(l[13]=e("label",{for:"settingsBoxExpandTop"},"ä¸Šæ–¹æ‰©å±• (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":l[2]||(l[2]=r=>o.boxExpandTop=r),min:"0",max:"50",step:"1"},null,512),[[Pe,o.boxExpandTop,void 0,{number:!0}]])]),e("div",ld,[l[14]||(l[14]=e("label",{for:"settingsBoxExpandBottom"},"ä¸‹æ–¹æ‰©å±• (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":l[3]||(l[3]=r=>o.boxExpandBottom=r),min:"0",max:"50",step:"1"},null,512),[[Pe,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",id,[e("div",rd,[l[15]||(l[15]=e("label",{for:"settingsBoxExpandLeft"},"å·¦ä¾§æ‰©å±• (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":l[4]||(l[4]=r=>o.boxExpandLeft=r),min:"0",max:"50",step:"1"},null,512),[[Pe,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",ud,[l[16]||(l[16]=e("label",{for:"settingsBoxExpandRight"},"å³ä¾§æ‰©å±• (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":l[5]||(l[5]=r=>o.boxExpandRight=r),min:"0",max:"50",step:"1"},null,512),[[Pe,o.boxExpandRight,void 0,{number:!0}]])])])]),e("div",cd,[l[22]||(l[22]=e("div",{class:"settings-group-title"},"ç²¾ç¡®æ–‡å­—æ©è†œ",-1)),e("div",dd,[e("div",gd,[l[18]||(l[18]=e("label",{for:"settingsMaskDilateSize"},"è†¨èƒ€å¤§å°:",-1)),oe(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":l[6]||(l[6]=r=>o.maskDilateSize=r),min:"0",step:"1"},null,512),[[Pe,o.maskDilateSize,void 0,{number:!0}]]),l[19]||(l[19]=e("div",{class:"input-hint"},"æ©è†œè†¨èƒ€åƒç´ æ•°",-1))]),e("div",pd,[l[20]||(l[20]=e("label",{for:"settingsMaskBoxExpandRatio"},"æ ‡æ³¨æ¡†æ‰©å¤§æ¯”ä¾‹ (%):",-1)),oe(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":l[7]||(l[7]=r=>o.maskBoxExpandRatio=r),min:"0",max:"100",step:"1"},null,512),[[Pe,o.maskBoxExpandRatio,void 0,{number:!0}]]),l[21]||(l[21]=e("div",{class:"input-hint"},"æ ‡æ³¨æ¡†åŒºåŸŸæ‰©å¤§ç™¾åˆ†æ¯”",-1))])])]),e("div",md,[l[25]||(l[25]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",vd,[e("label",fd,[oe(e("input",{type:"checkbox","onUpdate:modelValue":l[8]||(l[8]=r=>o.showDetectionDebug=r)},null,512),[[Xe,o.showDetectionDebug]]),l[23]||(l[23]=ge(" æ˜¾ç¤ºæ£€æµ‹æ¡†è°ƒè¯•ä¿¡æ¯ ",-1))]),l[24]||(l[24]=e("div",{class:"input-hint"},"åœ¨ç¿»è¯‘ç»“æœä¸­æ˜¾ç¤ºæ°”æ³¡æ£€æµ‹æ¡†ï¼Œç”¨äºè°ƒè¯•",-1))])])]))}}),hd=Je(bd,[["__scopeId","data-v-501af8bb"]]),xd={class:"hq-translation-settings"},yd={class:"settings-group"},Cd={class:"settings-row"},_d={class:"settings-item"},kd={class:"settings-item"},Sd={class:"password-input-wrapper"},wd=["type"],$d={key:0,class:"eye-icon"},Td={key:1,class:"eye-off-icon"},Id={class:"settings-item"},Pd={class:"settings-item"},Rd={class:"model-input-with-fetch"},Dd=["disabled"],Md={class:"fetch-text"},Bd={key:0,class:"model-select-container"},Ad={class:"model-count"},Ed={class:"settings-item"},Ld=["disabled"],Fd={class:"settings-group"},Ud={class:"settings-row"},Od={class:"settings-item"},zd={class:"settings-item"},Nd={class:"settings-row"},Vd={class:"settings-item"},Wd={class:"settings-item"},Kd={class:"settings-group"},qd={class:"settings-row"},Hd={class:"settings-item"},jd={class:"checkbox-label"},Jd={class:"settings-item"},Gd={class:"settings-row"},Yd={class:"settings-item"},Xd={class:"checkbox-label"},Zd={class:"settings-item"},Qd={class:"checkbox-label"},eg={class:"settings-group"},tg={class:"settings-item"},og=Ge({__name:"HqTranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼ (reasoning_effort=low)",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼ (thinking=null)",value:"volcano"}],o=Fe(),a=ct(),l=J(()=>o.settings.hqTranslation),r=w({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});Se(()=>r.value.apiKey,h=>{o.updateHqTranslation({apiKey:h})}),Se(()=>r.value.modelName,h=>{o.updateHqTranslation({modelName:h})}),Se(()=>r.value.customBaseUrl,h=>{o.updateHqTranslation({customBaseUrl:h})}),Se(()=>r.value.batchSize,h=>{o.updateHqTranslation({batchSize:h})}),Se(()=>r.value.sessionReset,h=>{o.updateHqTranslation({sessionReset:h})}),Se(()=>r.value.rpmLimit,h=>{o.updateHqTranslation({rpmLimit:h})}),Se(()=>r.value.maxRetries,h=>{o.updateHqTranslation({maxRetries:h})}),Se(()=>r.value.lowReasoning,h=>{o.updateHqTranslation({lowReasoning:h})}),Se(()=>r.value.noThinkingMethod,h=>{o.updateHqTranslation({noThinkingMethod:h})}),Se(()=>r.value.forceJsonOutput,h=>{o.updateHqTranslation({forceJsonOutput:h})}),Se(()=>r.value.useStream,h=>{o.updateHqTranslation({useStream:h})}),Se(()=>r.value.prompt,h=>{o.updateHqTranslation({prompt:h})});const x=w(!1),g=w(!1),i=w([]),c=w(!1),C=J(()=>{const h=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return i.value.forEach(p=>h.push({label:p,value:p})),h});function $(h){o.setHqProvider(h),i.value=[],R()}function R(){const h=o.settings.hqTranslation;r.value.apiKey=h.apiKey,r.value.modelName=h.modelName,r.value.customBaseUrl=h.customBaseUrl,r.value.batchSize=h.batchSize,r.value.sessionReset=h.sessionReset,r.value.rpmLimit=h.rpmLimit,r.value.maxRetries=h.maxRetries,r.value.lowReasoning=h.lowReasoning,r.value.noThinkingMethod=h.noThinkingMethod,r.value.forceJsonOutput=h.forceJsonOutput,r.value.useStream=h.useStream,r.value.prompt=h.prompt}function k(h){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI"}[h]||h}async function D(){const h=l.value.provider,p=r.value.apiKey?.trim(),T=r.value.customBaseUrl?.trim();if(!p){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(h)){a.warning(`${k(h)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(h==="custom_openai"&&!T){a.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}g.value=!0;try{const F=await He.fetchModels(h,p,T);F.success&&F.models&&F.models.length>0?(i.value=F.models.map(O=>O.id),a.success(`è·å–åˆ° ${F.models.length} ä¸ªæ¨¡å‹`)):a.warning(F.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(F){const O=F instanceof Error?F.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";a.error(O)}finally{g.value=!1}}async function N(){const h=l.value.provider,p=r.value.apiKey?.trim(),T=r.value.modelName?.trim(),S=r.value.customBaseUrl?.trim();if(!p){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!T){a.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(h==="custom_openai"&&!S){a.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}c.value=!0,a.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{const F=await He.testAiTranslateConnection({provider:h,apiKey:p,modelName:T,baseUrl:S});F.success?a.success(F.message||`${k(h)} è¿æ¥æˆåŠŸ!`):a.error(F.message||F.error||"è¿æ¥å¤±è´¥")}catch(F){const O=F instanceof Error?F.message:"è¿æ¥æµ‹è¯•å¤±è´¥";a.error(O)}finally{c.value=!1}}function B(){o.updateHqTranslation({prompt:nn}),r.value.prompt=nn,a.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function A(h,p){o.updateHqTranslation({prompt:h}),r.value.prompt=h,a.success(`å·²åº”ç”¨æç¤ºè¯: ${p}`)}return(h,p)=>(E(),L("div",xd,[e("div",yd,[p[20]||(p[20]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",Cd,[e("div",_d,[p[15]||(p[15]=e("label",{for:"settingsHqTranslateProvider"},"æœåŠ¡å•†:",-1)),_e(We,{"model-value":l.value.provider,options:t,onChange:p[0]||(p[0]=T=>$(T))},null,8,["model-value"])]),e("div",kd,[p[16]||(p[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",Sd,[oe(e("input",{type:x.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":p[1]||(p[1]=T=>r.value.apiKey=T),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,wd),[[St,r.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:p[2]||(p[2]=T=>x.value=!x.value)},[x.value?(E(),L("span",Td,"ğŸ‘â€ğŸ—¨")):(E(),L("span",$d,"ğŸ‘"))])])])]),oe(e("div",Id,[p[17]||(p[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),oe(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":p[3]||(p[3]=T=>r.value.customBaseUrl=T),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Pe,r.value.customBaseUrl]])],512),[[Oe,l.value.provider==="custom_openai"]]),e("div",Pd,[p[19]||(p[19]=e("label",{for:"settingsHqModelName"},"æ¨¡å‹åç§°:",-1)),e("div",Rd,[oe(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":p[4]||(p[4]=T=>r.value.modelName=T),placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,512),[[Pe,r.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:D,disabled:g.value},[p[18]||(p[18]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Md,ee(g.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Dd)]),i.value.length>0?(E(),L("div",Bd,[_e(We,{modelValue:r.value.modelName,"onUpdate:modelValue":p[5]||(p[5]=T=>r.value.modelName=T),options:C.value},null,8,["modelValue","options"]),e("span",Ad,"å…± "+ee(i.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)]),e("div",Ed,[e("button",{class:"settings-test-btn",onClick:N,disabled:c.value},ee(c.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Ld)])]),e("div",Fd,[p[28]||(p[28]=e("div",{class:"settings-group-title"},"æ‰¹å¤„ç†è®¾ç½®",-1)),e("div",Ud,[e("div",Od,[p[21]||(p[21]=e("label",{for:"settingsHqBatchSize"},"æ‰¹æ¬¡å¤§å°:",-1)),oe(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":p[6]||(p[6]=T=>r.value.batchSize=T),min:"1",max:"10",step:"1"},null,512),[[Pe,r.value.batchSize,void 0,{number:!0}]]),p[22]||(p[22]=e("div",{class:"input-hint"},"æ¯æ‰¹å¤„ç†çš„å›¾ç‰‡æ•°é‡ (æ¨è3-5å¼ )",-1))]),e("div",zd,[p[23]||(p[23]=e("label",{for:"settingsHqSessionReset"},"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),oe(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":p[7]||(p[7]=T=>r.value.sessionReset=T),min:"1",step:"1"},null,512),[[Pe,r.value.sessionReset,void 0,{number:!0}]]),p[24]||(p[24]=e("div",{class:"input-hint"},"å¤šå°‘æ‰¹æ¬¡åé‡ç½®ä¸Šä¸‹æ–‡",-1))])]),e("div",Nd,[e("div",Vd,[p[25]||(p[25]=e("label",{for:"settingsHqRpmLimit"},"RPMé™åˆ¶:",-1)),oe(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":p[8]||(p[8]=T=>r.value.rpmLimit=T),min:"0",step:"1"},null,512),[[Pe,r.value.rpmLimit,void 0,{number:!0}]]),p[26]||(p[26]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Wd,[p[27]||(p[27]=e("label",{for:"settingsHqMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),oe(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":p[9]||(p[9]=T=>r.value.maxRetries=T),min:"0",max:"10",step:"1"},null,512),[[Pe,r.value.maxRetries,void 0,{number:!0}]])])])]),e("div",Kd,[p[36]||(p[36]=e("div",{class:"settings-group-title"},"é«˜çº§é€‰é¡¹",-1)),e("div",qd,[e("div",Hd,[e("label",jd,[oe(e("input",{type:"checkbox","onUpdate:modelValue":p[10]||(p[10]=T=>r.value.lowReasoning=T)},null,512),[[Xe,r.value.lowReasoning]]),p[29]||(p[29]=ge(" ä½æ¨ç†æ¨¡å¼ ",-1))]),p[30]||(p[30]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",Jd,[p[31]||(p[31]=e("label",{for:"settingsHqNoThinkingMethod"},"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),_e(We,{modelValue:r.value.noThinkingMethod,"onUpdate:modelValue":p[11]||(p[11]=T=>r.value.noThinkingMethod=T),options:s},null,8,["modelValue"])])]),e("div",Gd,[e("div",Yd,[e("label",Xd,[oe(e("input",{type:"checkbox","onUpdate:modelValue":p[12]||(p[12]=T=>r.value.forceJsonOutput=T)},null,512),[[Xe,r.value.forceJsonOutput]]),p[32]||(p[32]=ge(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),p[33]||(p[33]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",Zd,[e("label",Qd,[oe(e("input",{type:"checkbox","onUpdate:modelValue":p[13]||(p[13]=T=>r.value.useStream=T)},null,512),[[Xe,r.value.useStream]]),p[34]||(p[34]=ge(" æµå¼è°ƒç”¨ ",-1))]),p[35]||(p[35]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨",-1))])])]),e("div",eg,[p[37]||(p[37]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",-1)),e("div",tg,[oe(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":p[14]||(p[14]=T=>r.value.prompt=T),rows:"6",placeholder:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯"},null,512),[[Pe,r.value.prompt]]),_e(Vt,{"prompt-type":"hq_translate",onSelect:A}),e("button",{class:"btn btn-secondary btn-sm",onClick:B},"é‡ç½®ä¸ºé»˜è®¤")])])]))}}),ng=Je(og,[["__scopeId","data-v-23f4a3f7"]]),sg={class:"proofreading-settings"},ag={class:"settings-group"},lg={class:"settings-item"},ig={class:"checkbox-label"},rg={class:"settings-item"},ug={class:"settings-group"},cg={class:"round-header"},dg={class:"round-title"},gg=["onClick","disabled"],pg={class:"round-content"},mg={class:"settings-item"},vg=["onUpdate:modelValue"],fg={class:"settings-row"},bg={class:"settings-item"},hg={class:"settings-item"},xg={class:"password-input-wrapper"},yg=["type","onUpdate:modelValue"],Cg=["onClick"],_g={key:0,class:"eye-icon"},kg={key:1,class:"eye-off-icon"},Sg={class:"settings-item"},wg=["onUpdate:modelValue"],$g={class:"settings-item"},Tg={class:"model-input-with-fetch"},Ig=["onUpdate:modelValue"],Pg=["onClick","disabled"],Rg={class:"fetch-text"},Dg={key:0,class:"model-select-container"},Mg={class:"model-count"},Bg={class:"settings-item"},Ag=["onClick","disabled"],Eg={class:"settings-row"},Lg={class:"settings-item"},Fg=["onUpdate:modelValue"],Ug={class:"settings-item"},Og=["onUpdate:modelValue"],zg={class:"settings-item"},Ng=["onUpdate:modelValue"],Vg={class:"settings-row"},Wg={class:"settings-item"},Kg={class:"checkbox-label"},qg=["onUpdate:modelValue"],Hg={class:"settings-item"},jg={class:"settings-row"},Jg={class:"settings-item"},Gg={class:"checkbox-label"},Yg=["onUpdate:modelValue"],Xg={class:"settings-item"},Zg={class:"checkbox-label"},Qg=["onUpdate:modelValue"],ep={class:"settings-item"},tp=["onUpdate:modelValue"],op=["onClick"],np=Ge({__name:"ProofreadingSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼",value:"volcano"}],o=Fe(),a=ct(),l=w({}),r=w({}),x=w({}),g=J(()=>o.settings.proofreading.rounds),i=J({get:()=>o.settings.proofreading.maxRetries,set:A=>o.setProofreadingMaxRetries(A)}),c=J({get:()=>o.settings.proofreading.enabled,set:A=>o.setProofreadingEnabled(A)});Se(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function C(A){const h=x.value[A]||[],p=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return h.forEach(T=>p.push({label:T,value:T})),p}async function $(A){const h=g.value[A];if(!h)return;const p=h.provider,T=h.apiKey?.trim(),S=h.customBaseUrl?.trim();if(!T){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(p)){a.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨");return}l.value[A]=!0;try{const O=await He.fetchModels(p,T,S);O.success&&O.models&&O.models.length>0?(x.value[A]=O.models.map(te=>te.id),a.success(`è½®æ¬¡ ${A+1}: è·å–åˆ° ${O.models.length} ä¸ªæ¨¡å‹`)):a.warning(O.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(O){const te=O instanceof Error?O.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";a.error(te)}finally{l.value[A]=!1}}async function R(A){const h=g.value[A];if(!h)return;const p=h.provider,T=h.apiKey?.trim(),S=h.modelName?.trim(),F=h.customBaseUrl?.trim();if(!T){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!S){a.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}r.value[A]=!0,a.info(`æ­£åœ¨æµ‹è¯•è½®æ¬¡ ${A+1} çš„è¿æ¥...`);try{const O=await He.testAiTranslateConnection({provider:p,apiKey:T,modelName:S,baseUrl:F});O.success?a.success(O.message||"è¿æ¥æˆåŠŸ!"):a.error(O.message||O.error||"è¿æ¥å¤±è´¥")}catch(O){const te=O instanceof Error?O.message:"è¿æ¥æµ‹è¯•å¤±è´¥";a.error(te)}finally{r.value[A]=!1}}function k(){const A={name:`ç¬¬${g.value.length+1}è½®æ ¡å¯¹`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:3,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!1,useStream:!0,prompt:sn,showApiKey:!1};o.addProofreadingRound(A),a.success("å·²æ·»åŠ æ–°çš„æ ¡å¯¹è½®æ¬¡")}function D(A){if(g.value.length<=1){a.warning("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡");return}o.removeProofreadingRound(A),a.success("å·²åˆ é™¤æ ¡å¯¹è½®æ¬¡")}function N(A){o.updateProofreadingRound(A,{prompt:sn}),a.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function B(A,h,p){o.updateProofreadingRound(A,{prompt:h}),a.success(`å·²åº”ç”¨æç¤ºè¯: ${p}`)}return(A,h)=>(E(),L("div",sg,[e("div",ag,[h[5]||(h[5]=e("div",{class:"settings-group-title"},"AIæ ¡å¯¹è®¾ç½®",-1)),e("div",lg,[e("label",ig,[oe(e("input",{type:"checkbox","onUpdate:modelValue":h[0]||(h[0]=p=>c.value=p)},null,512),[[Xe,c.value]]),h[2]||(h[2]=ge(" å¯ç”¨AIæ ¡å¯¹ ",-1))]),h[3]||(h[3]=e("div",{class:"input-hint"},"ç¿»è¯‘å®Œæˆåè‡ªåŠ¨è¿›è¡ŒAIæ ¡å¯¹",-1))]),e("div",rg,[h[4]||(h[4]=e("label",{for:"settingsProofreadingMaxRetries"},"å…¨å±€é‡è¯•æ¬¡æ•°:",-1)),oe(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":h[1]||(h[1]=p=>i.value=p),min:"0",max:"10",step:"1"},null,512),[[Pe,i.value,void 0,{number:!0}]])])]),oe(e("div",ug,[e("div",{class:"settings-group-title"},[h[6]||(h[6]=ge(" æ ¡å¯¹è½®æ¬¡é…ç½® ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:k},"+ æ·»åŠ è½®æ¬¡")]),(E(!0),L(ze,null,Ye(g.value,(p,T)=>(E(),L("div",{key:T,class:"proofreading-round"},[e("div",cg,[e("span",dg,"è½®æ¬¡ "+ee(T+1)+": "+ee(p.name||"æœªå‘½å"),1),e("button",{class:"btn btn-danger btn-sm",onClick:S=>D(T),disabled:g.value.length<=1}," åˆ é™¤ ",8,gg)]),e("div",pg,[e("div",mg,[h[7]||(h[7]=e("label",null,"è½®æ¬¡åç§°:",-1)),oe(e("input",{type:"text","onUpdate:modelValue":S=>p.name=S,placeholder:"å¦‚: ç¬¬ä¸€è½®æ ¡å¯¹"},null,8,vg),[[Pe,p.name]])]),e("div",fg,[e("div",bg,[h[8]||(h[8]=e("label",null,"æœåŠ¡å•†:",-1)),_e(We,{modelValue:p.provider,"onUpdate:modelValue":S=>p.provider=S,options:t},null,8,["modelValue","onUpdate:modelValue"])]),e("div",hg,[h[9]||(h[9]=e("label",null,"API Key:",-1)),e("div",xg,[oe(e("input",{type:p.showApiKey?"text":"password","onUpdate:modelValue":S=>p.apiKey=S,class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,yg),[[St,p.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:S=>p.showApiKey=!p.showApiKey},[p.showApiKey?(E(),L("span",kg,"ğŸ‘â€ğŸ—¨")):(E(),L("span",_g,"ğŸ‘"))],8,Cg)])])]),oe(e("div",Sg,[h[10]||(h[10]=e("label",null,"Base URL:",-1)),oe(e("input",{type:"text","onUpdate:modelValue":S=>p.customBaseUrl=S,placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,8,wg),[[Pe,p.customBaseUrl]])],512),[[Oe,p.provider==="custom_openai"]]),e("div",$g,[h[12]||(h[12]=e("label",null,"æ¨¡å‹åç§°:",-1)),e("div",Tg,[oe(e("input",{type:"text","onUpdate:modelValue":S=>p.modelName=S,placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,8,Ig),[[Pe,p.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:S=>$(T),disabled:l.value[T]},[h[11]||(h[11]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Rg,ee(l.value[T]?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Pg)]),x.value[T]&&x.value[T].length>0?(E(),L("div",Dg,[_e(We,{modelValue:p.modelName,"onUpdate:modelValue":S=>p.modelName=S,options:C(T)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",Mg,"å…± "+ee(x.value[T].length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)]),e("div",Bg,[e("button",{class:"settings-test-btn",onClick:S=>R(T),disabled:r.value[T]},ee(r.value[T]?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Ag)]),e("div",Eg,[e("div",Lg,[h[13]||(h[13]=e("label",null,"æ‰¹æ¬¡å¤§å°:",-1)),oe(e("input",{type:"number","onUpdate:modelValue":S=>p.batchSize=S,min:"1",max:"10",step:"1"},null,8,Fg),[[Pe,p.batchSize,void 0,{number:!0}]])]),e("div",Ug,[h[14]||(h[14]=e("label",null,"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),oe(e("input",{type:"number","onUpdate:modelValue":S=>p.sessionReset=S,min:"1",step:"1"},null,8,Og),[[Pe,p.sessionReset,void 0,{number:!0}]])]),e("div",zg,[h[15]||(h[15]=e("label",null,"RPMé™åˆ¶:",-1)),oe(e("input",{type:"number","onUpdate:modelValue":S=>p.rpmLimit=S,min:"0",step:"1"},null,8,Ng),[[Pe,p.rpmLimit,void 0,{number:!0}]])])]),e("div",Vg,[e("div",Wg,[e("label",Kg,[oe(e("input",{type:"checkbox","onUpdate:modelValue":S=>p.lowReasoning=S},null,8,qg),[[Xe,p.lowReasoning]]),h[16]||(h[16]=ge(" ä½æ¨ç†æ¨¡å¼ ",-1))]),h[17]||(h[17]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",Hg,[h[18]||(h[18]=e("label",null,"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),_e(We,{modelValue:p.noThinkingMethod,"onUpdate:modelValue":S=>p.noThinkingMethod=S,options:s},null,8,["modelValue","onUpdate:modelValue"])])]),e("div",jg,[e("div",Jg,[e("label",Gg,[oe(e("input",{type:"checkbox","onUpdate:modelValue":S=>p.forceJsonOutput=S},null,8,Yg),[[Xe,p.forceJsonOutput]]),h[19]||(h[19]=ge(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),h[20]||(h[20]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",Xg,[e("label",Zg,[oe(e("input",{type:"checkbox","onUpdate:modelValue":S=>p.useStream=S},null,8,Qg),[[Xe,p.useStream]]),h[21]||(h[21]=ge(" æµå¼è°ƒç”¨ ",-1))]),h[22]||(h[22]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨ï¼Œé¿å…è¶…æ—¶",-1))])]),e("div",ep,[h[23]||(h[23]=e("label",null,"æ ¡å¯¹æç¤ºè¯:",-1)),oe(e("textarea",{"onUpdate:modelValue":S=>p.prompt=S,rows:"4",placeholder:"æ ¡å¯¹æç¤ºè¯"},null,8,tp),[[Pe,p.prompt]]),_e(Vt,{"prompt-type":"proofreading",onSelect:(S,F)=>B(T,S,F)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:S=>N(T)},"é‡ç½®ä¸ºé»˜è®¤",8,op)])])]))),128))],512),[[Oe,c.value]])]))}}),sp=Je(np,[["__scopeId","data-v-7e4f95fe"]]),ap={class:"prompt-library"},lp={class:"settings-group"},ip={class:"settings-item"},rp={key:0,class:"settings-item"},up={class:"mode-hint"},cp={class:"settings-group"},dp={key:0,class:"loading-hint"},gp={key:1,class:"empty-hint"},pp={key:2,class:"prompt-list"},mp=["onClick"],vp={class:"prompt-name"},fp={class:"prompt-actions"},bp=["onClick"],hp=["onClick","disabled"],xp={class:"settings-group"},yp={class:"settings-item"},Cp={class:"settings-item"},_p={class:"prompt-editor-actions"},kp=["disabled"],Sp=Ge({__name:"PromptLibrary",setup(n){const t=[{label:"ç¿»è¯‘æç¤ºè¯",value:"translate"},{label:"æ–‡æœ¬æ¡†æç¤ºè¯",value:"textbox"},{label:"AIè§†è§‰OCRæç¤ºè¯",value:"ai_vision_ocr"},{label:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",value:"hq_translate"},{label:"æ ¡å¯¹æç¤ºè¯",value:"proofreading"}],s=[{label:"æ™®é€šæ¨¡å¼",value:"false"},{label:"JSONæ ¼å¼æ¨¡å¼",value:"true"}],o=ct(),a=Fe(),l=w("translate"),r=w([]),x=w(""),g=w(""),i=w(""),c=w(!1),C=w(!1),$=J(()=>l.value==="translate"||l.value==="ai_vision_ocr"),R=J(()=>C.value?"é€‚ç”¨äºéœ€è¦ç»“æ„åŒ–è¾“å‡ºçš„åœºæ™¯":"é€‚ç”¨äºæ™®é€šç¿»è¯‘åœºæ™¯");async function k(){c.value=!0;try{let T;l.value==="textbox"?T=await He.getTextboxPrompts():T=await He.getPrompts(l.value);const S=T.prompt_names||[];r.value=S.map(F=>({name:F}))}catch(T){const S=T instanceof Error?T.message:"åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥";o.error(S)}finally{c.value=!1}}async function D(T){x.value=T,g.value=T,await N(T)}async function N(T){try{let S;l.value==="textbox"?S=await He.getTextboxPromptContent(T):S=await He.getPromptContent(l.value,T),g.value=T,i.value=S.prompt_content||"",x.value=T,o.success("å·²åŠ è½½æç¤ºè¯")}catch(S){const F=S instanceof Error?S.message:"åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥";o.error(F)}}async function B(){if(!g.value||!i.value){o.warning("è¯·è¾“å…¥æç¤ºè¯åç§°å’Œå†…å®¹");return}try{l.value==="textbox"?await He.saveTextboxPrompt(g.value,i.value):await He.savePrompt(l.value,g.value,i.value),o.success("æç¤ºè¯ä¿å­˜æˆåŠŸ"),g.value="",i.value="",await k()}catch(T){const S=T instanceof Error?T.message:"ä¿å­˜æç¤ºè¯å¤±è´¥";o.error(S)}}async function A(T){if(T==="default"){o.warning("é»˜è®¤æç¤ºè¯ä¸èƒ½åˆ é™¤");return}try{l.value==="textbox"?await He.deleteTextboxPrompt(T):await He.deletePrompt(l.value,T),o.success("æç¤ºè¯åˆ é™¤æˆåŠŸ"),x.value===T&&(x.value="",g.value="",i.value=""),await k()}catch(S){const F=S instanceof Error?S.message:"åˆ é™¤æç¤ºè¯å¤±è´¥";o.error(F)}}function h(){x.value="",g.value="",i.value="",l.value==="translate"?C.value=a.settings.translation.isJsonMode:l.value==="ai_vision_ocr"?C.value=a.settings.aiVisionOcr.isJsonMode:C.value=!1,k()}function p(){l.value==="translate"?a.updateTranslationService({isJsonMode:C.value}):l.value==="ai_vision_ocr"&&a.updateAiVisionOcr({isJsonMode:C.value}),o.info(`å·²åˆ‡æ¢åˆ°${C.value?"JSONæ ¼å¼":"æ™®é€š"}æ¨¡å¼`)}return dt(()=>{C.value=a.settings.translation.isJsonMode,k()}),(T,S)=>(E(),L("div",ap,[e("div",lp,[S[6]||(S[6]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç®¡ç†",-1)),e("div",ip,[S[4]||(S[4]=e("label",{for:"promptType"},"æç¤ºè¯ç±»å‹:",-1)),_e(We,{modelValue:l.value,"onUpdate:modelValue":S[0]||(S[0]=F=>l.value=F),options:t,onChange:h},null,8,["modelValue"])]),$.value?(E(),L("div",rp,[S[5]||(S[5]=e("label",{for:"promptMode"},"æç¤ºè¯æ¨¡å¼:",-1)),_e(We,{"model-value":C.value?"true":"false",options:s,onChange:S[1]||(S[1]=F=>{C.value=F==="true",p()})},null,8,["model-value"]),e("span",up,ee(R.value),1)])):ce("",!0)]),e("div",cp,[S[7]||(S[7]=e("div",{class:"settings-group-title"},"å·²ä¿å­˜çš„æç¤ºè¯",-1)),c.value?(E(),L("div",dp,"åŠ è½½ä¸­...")):r.value.length===0?(E(),L("div",gp,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(E(),L("div",pp,[(E(!0),L(ze,null,Ye(r.value,F=>(E(),L("div",{key:F.name,class:Re(["prompt-item",{active:x.value===F.name}]),onClick:O=>D(F.name)},[e("span",vp,ee(F.name),1),e("div",fp,[e("button",{class:"btn btn-sm",onClick:nt(O=>N(F.name),["stop"]),title:"åŠ è½½åˆ°ç¼–è¾‘å™¨"},"ğŸ“¥",8,bp),e("button",{class:"btn btn-sm btn-danger",onClick:nt(O=>A(F.name),["stop"]),title:"åˆ é™¤",disabled:F.name==="default"}," ğŸ—‘ï¸ ",8,hp)])],10,mp))),128))]))]),e("div",xp,[S[10]||(S[10]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç¼–è¾‘",-1)),e("div",yp,[S[8]||(S[8]=e("label",{for:"promptName"},"æç¤ºè¯åç§°:",-1)),oe(e("input",{type:"text",id:"promptName","onUpdate:modelValue":S[2]||(S[2]=F=>g.value=F),placeholder:"è¯·è¾“å…¥æç¤ºè¯åç§°"},null,512),[[Pe,g.value]])]),e("div",Cp,[S[9]||(S[9]=e("label",{for:"promptContent"},"æç¤ºè¯å†…å®¹:",-1)),oe(e("textarea",{id:"promptContent","onUpdate:modelValue":S[3]||(S[3]=F=>i.value=F),rows:"8",placeholder:"è¯·è¾“å…¥æç¤ºè¯å†…å®¹"},null,512),[[Pe,i.value]])]),e("div",_p,[e("button",{class:"btn btn-primary",onClick:B,disabled:!g.value||!i.value},"ä¿å­˜æç¤ºè¯",8,kp)])])]))}}),wp=Je(Sp,[["__scopeId","data-v-70f0ec19"]]),$p={class:"plugin-manager"},Tp={class:"settings-group"},Ip={key:0,class:"loading-hint"},Pp={key:1,class:"empty-hint"},Rp={key:2,class:"plugin-list"},Dp={class:"plugin-info"},Mp={class:"plugin-header"},Bp={class:"plugin-name"},Ap={class:"plugin-version"},Ep={class:"plugin-description"},Lp={class:"plugin-controls"},Fp={class:"switch"},Up=["checked","onChange"],Op=["onClick"],zp=["onClick"],Np={class:"settings-group"},Vp={class:"plugin-name"},Wp={class:"switch"},Kp=["checked","onChange"],qp={class:"plugin-config-content"},Hp={class:"plugin-config-header"},jp={class:"plugin-config-body"},Jp=["for"],Gp=["id","onUpdate:modelValue"],Yp=["id","onUpdate:modelValue","min","max"],Xp=["id","onUpdate:modelValue","placeholder"],Zp={key:4,class:"field-description"},Qp=Ge({__name:"PluginManager",setup(n){const t=ct(),s=w([]),o=w({}),a=w(!1),l=w(!1),r=w(null),x=w({}),g=w({});async function i(){a.value=!0;try{const B=await ta();s.value=B.plugins||[]}catch(B){const A=B instanceof Error?B.message:"åŠ è½½æ’ä»¶åˆ—è¡¨å¤±è´¥";t.error(A)}finally{a.value=!1}}async function c(){try{const B=await ca();o.value=B.states||{}}catch(B){console.error("åŠ è½½é»˜è®¤çŠ¶æ€å¤±è´¥:",B)}}async function C(B){try{B.enabled?(await na(B.name),B.enabled=!1,t.success(`å·²ç¦ç”¨ ${B.display_name||B.name}`)):(await oa(B.name),B.enabled=!0,t.success(`å·²å¯ç”¨ ${B.display_name||B.name}`))}catch(A){const h=A instanceof Error?A.message:"æ“ä½œå¤±è´¥";t.error(h)}}async function $(B,A){const h=A.target,p=h.checked;try{await da(B,p),o.value[B]=p,t.success("é»˜è®¤çŠ¶æ€å·²æ›´æ–°")}catch(T){const S=T instanceof Error?T.message:"è®¾ç½®å¤±è´¥";t.error(S),h.checked=!p}}async function R(B){r.value=B;try{const A=await ga(B.name);x.value=A.schema||{};const h=await pa(B.name);g.value=h.config||{},l.value=!0}catch(A){const h=A instanceof Error?A.message:"åŠ è½½é…ç½®å¤±è´¥";t.error(h)}}function k(){l.value=!1,r.value=null,x.value={},g.value={}}async function D(){if(r.value)try{await ma(r.value.name,g.value),t.success("é…ç½®ä¿å­˜æˆåŠŸ"),k()}catch(B){const A=B instanceof Error?B.message:"ä¿å­˜é…ç½®å¤±è´¥";t.error(A)}}async function N(B){if(confirm(`ç¡®å®šè¦åˆ é™¤æ’ä»¶ "${B.display_name||B.name}" å—ï¼Ÿ`))try{await sa(B.name),t.success("æ’ä»¶åˆ é™¤æˆåŠŸ"),await i()}catch(A){const h=A instanceof Error?A.message:"åˆ é™¤æ’ä»¶å¤±è´¥";t.error(h)}}return dt(()=>{i(),c()}),(B,A)=>(E(),L("div",$p,[e("div",Tp,[A[1]||(A[1]=e("div",{class:"settings-group-title"},"å·²å®‰è£…æ’ä»¶",-1)),a.value?(E(),L("div",Ip,"åŠ è½½ä¸­...")):s.value.length===0?(E(),L("div",Pp,"æš‚æ— å·²å®‰è£…çš„æ’ä»¶")):(E(),L("div",Rp,[(E(!0),L(ze,null,Ye(s.value,h=>(E(),L("div",{key:h.name,class:"plugin-item"},[e("div",Dp,[e("div",Mp,[e("span",Bp,ee(h.display_name||h.name),1),e("span",Ap,"v"+ee(h.version||"1.0.0"),1)]),e("p",Ep,ee(h.description||"æš‚æ— æè¿°"),1)]),e("div",Lp,[e("label",Fp,[e("input",{type:"checkbox",checked:h.enabled,onChange:p=>C(h)},null,40,Up),A[0]||(A[0]=e("span",{class:"slider"},null,-1))]),h.has_config?(E(),L("button",{key:0,class:"btn btn-sm",onClick:p=>R(h),title:"é…ç½®"},"âš™ï¸",8,Op)):ce("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:p=>N(h),title:"åˆ é™¤"},"ğŸ—‘ï¸",8,zp)])]))),128))]))]),e("div",Np,[A[3]||(A[3]=e("div",{class:"settings-group-title"},"é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),A[4]||(A[4]=e("p",{class:"settings-hint"},"è®¾ç½®æ’ä»¶åœ¨æ–°ä¼šè¯ä¸­çš„é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),(E(!0),L(ze,null,Ye(s.value,h=>(E(),L("div",{key:"default-"+h.name,class:"default-state-item"},[e("span",Vp,ee(h.display_name||h.name),1),e("label",Wp,[e("input",{type:"checkbox",checked:o.value[h.name],onChange:p=>$(h.name,p)},null,40,Kp),A[2]||(A[2]=e("span",{class:"slider"},null,-1))])]))),128))]),l.value?(E(),L("div",{key:0,class:"plugin-config-modal",onClick:nt(k,["self"])},[e("div",qp,[e("div",Hp,[e("h4",null,ee(r.value?.display_name||r.value?.name)+" é…ç½®",1),e("span",{class:"close-btn",onClick:k},"Ã—")]),e("div",jp,[(E(!0),L(ze,null,Ye(x.value,(h,p)=>(E(),L("div",{key:p,class:"config-field"},[e("label",{for:"config-"+p},ee(h.label||p)+":",9,Jp),h.type==="boolean"?oe((E(),L("input",{key:0,type:"checkbox",id:"config-"+p,"onUpdate:modelValue":T=>g.value[p]=T},null,8,Gp)),[[Xe,g.value[p]]]):h.type==="select"?(E(),ut(We,{key:1,"model-value":String(g.value[p]??""),options:h.options||[],onChange:T=>{g.value[p]=T}},null,8,["model-value","options","onChange"])):h.type==="number"?oe((E(),L("input",{key:2,type:"number",id:"config-"+p,"onUpdate:modelValue":T=>g.value[p]=T,min:h.min,max:h.max},null,8,Yp)),[[Pe,g.value[p],void 0,{number:!0}]]):oe((E(),L("input",{key:3,type:"text",id:"config-"+p,"onUpdate:modelValue":T=>g.value[p]=T,placeholder:h.placeholder},null,8,Xp)),[[Pe,g.value[p]]]),h.description?(E(),L("p",Zp,ee(h.description),1)):ce("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:k},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:D},"ä¿å­˜")])])])):ce("",!0)]))}}),em=Je(Qp,[["__scopeId","data-v-a62393a7"]]),tm={class:"parallel-settings"},om={class:"settings-group"},nm={class:"settings-item"},sm={class:"toggle-switch"},am={class:"number-control"},lm=["disabled"],im=["disabled"],rm=["disabled"],um={key:0,class:"settings-note"},cm=Ge({__name:"ParallelSettings",setup(n){const t=Fe(),s=J({get:()=>t.settings.parallel.enabled,set:a=>{t.updateSettings({parallel:{...t.settings.parallel,enabled:a}})}}),o=J({get:()=>t.settings.parallel.deepLearningLockSize,set:a=>{t.updateSettings({parallel:{...t.settings.parallel,deepLearningLockSize:Math.max(1,Math.min(4,a))}})}});return(a,l)=>(E(),L("div",tm,[e("div",om,[l[10]||(l[10]=e("div",{class:"settings-group-title"},"ğŸš€ å¹¶è¡Œç¿»è¯‘",-1)),e("div",nm,[l[5]||(l[5]=e("label",null,"å¯ç”¨å¹¶è¡Œæ¨¡å¼:",-1)),e("label",sm,[oe(e("input",{type:"checkbox","onUpdate:modelValue":l[0]||(l[0]=r=>s.value=r)},null,512),[[Xe,s.value]]),l[4]||(l[4]=e("span",{class:"toggle-slider"},null,-1))]),l[6]||(l[6]=e("div",{class:"input-hint"},"ä½¿ç”¨æµæ°´çº¿å¹¶è¡Œå¤„ç†ï¼Œå¯èƒ½æå‡æ‰¹é‡ç¿»è¯‘é€Ÿåº¦",-1))]),e("div",{class:Re(["settings-item",{"item-disabled":!s.value}])},[l[7]||(l[7]=e("label",null,"æ·±åº¦å­¦ä¹ å¹¶å‘æ•°:",-1)),e("div",am,[e("button",{class:"btn btn-sm",onClick:l[1]||(l[1]=r=>o.value=Math.max(1,o.value-1)),disabled:!s.value},"-",8,lm),oe(e("input",{type:"number","onUpdate:modelValue":l[2]||(l[2]=r=>o.value=r),min:"1",max:"4",disabled:!s.value,class:"number-input"},null,8,im),[[Pe,o.value,void 0,{number:!0}]]),e("button",{class:"btn btn-sm",onClick:l[3]||(l[3]=r=>o.value=Math.min(4,o.value+1)),disabled:!s.value},"+",8,rm)]),l[8]||(l[8]=e("div",{class:"input-hint"},"æ§åˆ¶æ£€æµ‹/OCR/é¢œè‰²/ä¿®å¤çš„æœ€å¤§å¹¶å‘æ•°ï¼ˆå»ºè®®1-2ï¼‰",-1))],2),s.value?(E(),L("div",um,[...l[9]||(l[9]=[e("div",{class:"note-title"},"âš ï¸ æ³¨æ„äº‹é¡¹ï¼š",-1),e("ul",null,[e("li",null,"å¹¶å‘æ•°è®¾ä¸º1æ—¶ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œæœ€ç¨³å®š"),e("li",null,"å¢å¤§å¹¶å‘æ•°å¯èƒ½åŠ é€Ÿå¤„ç†ï¼Œä½†ä¼šå ç”¨æ›´å¤šGPU/CPUèµ„æº"),e("li",null,"å¦‚æœé‡åˆ°æ˜¾å­˜ä¸è¶³ï¼Œè¯·å°†å¹¶å‘æ•°è®¾ä¸º1")],-1)])])):ce("",!0)])]))}}),dm=Je(cm,[["__scopeId","data-v-4a6e42d5"]]),gm={class:"more-settings"},pm={class:"settings-group"},mm={class:"settings-item checkbox-item"},vm={class:"checkbox-label"},fm={class:"settings-group"},bm={class:"settings-item checkbox-item"},hm={class:"checkbox-label"},xm={class:"settings-group"},ym={class:"settings-item checkbox-item"},Cm={class:"checkbox-label"},_m={class:"settings-group"},km={class:"settings-item checkbox-item"},Sm={class:"checkbox-label"},wm={class:"settings-group"},$m={class:"settings-item"},Tm={class:"settings-group"},Im={class:"settings-item"},Pm=["disabled"],Rm={key:0,class:"font-count"},Dm={class:"settings-item"},Mm={class:"settings-group"},Bm={class:"settings-row"},Am={class:"settings-item"},Em=["disabled"],Lm={class:"settings-item"},Fm=["disabled"],Um=Ge({__name:"MoreSettings",setup(n){const t=[{label:"å‰ç«¯ pdf.js (æ¨è)",value:"frontend"},{label:"åç«¯ PyMuPDF",value:"backend"}],s=Fe(),o=ct(),a=w(!1),l=w([]),r=w(!1),x=w(null),g=w({pdfProcessingMethod:s.settings.pdfProcessingMethod||"frontend",autoSaveInBookshelfMode:s.settings.autoSaveInBookshelfMode||!1,removeTextWithOcr:s.settings.removeTextWithOcr||!1,enableVerboseLogs:s.settings.enableVerboseLogs||!1,lamaDisableResize:s.settings.lamaDisableResize||!1});Se(()=>g.value.pdfProcessingMethod,R=>{s.setPdfProcessingMethod(R)}),Se(()=>g.value.autoSaveInBookshelfMode,R=>{s.setAutoSaveInBookshelfMode(R)}),Se(()=>g.value.removeTextWithOcr,R=>{s.setRemoveTextWithOcr(R)}),Se(()=>g.value.enableVerboseLogs,R=>{s.setEnableVerboseLogs(R)}),Se(()=>g.value.lamaDisableResize,R=>{s.setLamaDisableResize(R)});async function i(){a.value=!0;try{const R=await He.getFontList();l.value=R.fonts||[],o.success(`è·å–åˆ° ${l.value.length} ä¸ªå­—ä½“`)}catch(R){const k=R instanceof Error?R.message:"è·å–å­—ä½“åˆ—è¡¨å¤±è´¥";o.error(k)}finally{a.value=!1}}async function c(R){const D=R.target.files?.[0];if(!D)return;const N=[".ttf",".ttc",".otf"],B=D.name.toLowerCase().slice(D.name.lastIndexOf("."));if(!N.includes(B)){o.error("ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä¸Šä¼  .ttf, .ttc æˆ– .otf æ–‡ä»¶");return}try{const A=await He.uploadFont(D);A.success?(o.success(`å­—ä½“ "${A.fontPath||D.name}" ä¸Šä¼ æˆåŠŸ`),await i()):o.error(A.error||"å­—ä½“ä¸Šä¼ å¤±è´¥")}catch(A){const h=A instanceof Error?A.message:"å­—ä½“ä¸Šä¼ å¤±è´¥";o.error(h)}finally{x.value&&(x.value.value="")}}async function C(){r.value=!0;try{const R=await Bn();R.success?o.success(`å·²æ¸…ç† ${R.deleted_count||0} ä¸ªè°ƒè¯•æ–‡ä»¶`):o.error(R.error||"æ¸…ç†å¤±è´¥")}catch(R){const k=R instanceof Error?R.message:"æ¸…ç†å¤±è´¥";o.error(k)}finally{r.value=!1}}async function $(){r.value=!0;try{const R=await wo();R.success?o.success(`å·²æ¸…ç† ${R.deleted_count||0} ä¸ªä¸´æ—¶æ–‡ä»¶`):o.error(R.error||"æ¸…ç†å¤±è´¥")}catch(R){const k=R instanceof Error?R.message:"æ¸…ç†å¤±è´¥";o.error(k)}finally{r.value=!1}}return(R,k)=>(E(),L("div",gm,[_e(dm),e("div",pm,[k[7]||(k[7]=e("div",{class:"settings-group-title"},"è‡ªåŠ¨ä¿å­˜è®¾ç½®",-1)),e("div",mm,[e("label",vm,[oe(e("input",{type:"checkbox","onUpdate:modelValue":k[0]||(k[0]=D=>g.value.autoSaveInBookshelfMode=D)},null,512),[[Xe,g.value.autoSaveInBookshelfMode]]),k[5]||(k[5]=e("span",{class:"checkbox-text"},"ä¹¦æ¶æ¨¡å¼è‡ªåŠ¨ä¿å­˜",-1))]),k[6]||(k[6]=e("div",{class:"input-hint"},[ge(" å¼€å¯åï¼Œåœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç¿»è¯‘æ—¶ä¼šè‡ªåŠ¨ä¿å­˜è¿›åº¦ï¼ˆç¿»è¯‘ä¸€å¼ ä¿å­˜ä¸€å¼ ï¼‰ï¼Œé˜²æ­¢æ„å¤–å…³é—­å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ "),e("br"),e("span",{class:"hint-note"},"æ³¨æ„ï¼šæ­¤åŠŸèƒ½ä»…åœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼Œå¿«é€Ÿç¿»è¯‘æ¨¡å¼ä¸æ”¯æŒã€‚")],-1))])]),e("div",fm,[k[10]||(k[10]=e("div",{class:"settings-group-title"},"æ¶ˆé™¤æ–‡å­—æ¨¡å¼",-1)),e("div",bm,[e("label",hm,[oe(e("input",{type:"checkbox","onUpdate:modelValue":k[1]||(k[1]=D=>g.value.removeTextWithOcr=D)},null,512),[[Xe,g.value.removeTextWithOcr]]),k[8]||(k[8]=e("span",{class:"checkbox-text"},"åŒæ—¶æ‰§è¡ŒOCRè¯†åˆ«",-1))]),k[9]||(k[9]=e("div",{class:"input-hint"},[ge(" å¼€å¯åï¼Œæ¶ˆé™¤æ–‡å­—æ¨¡å¼ä¼šåŒæ—¶æ‰§è¡ŒOCRè¯†åˆ«ï¼Œè·å–å¸¦æœ‰åŸæ–‡çš„å¹²å‡€èƒŒæ™¯å›¾ã€‚ "),e("br"),e("span",{class:"hint-note"},"é€‚ç”¨äºéœ€è¦ä¿ç•™åŸæ–‡ä¿¡æ¯ä»¥ä¾¿åç»­ç¿»è¯‘æˆ–å‚è€ƒçš„åœºæ™¯ã€‚")],-1))])]),e("div",xm,[k[13]||(k[13]=e("div",{class:"settings-group-title"},"LAMA ä¿®å¤è®¾ç½®",-1)),e("div",ym,[e("label",Cm,[oe(e("input",{type:"checkbox","onUpdate:modelValue":k[2]||(k[2]=D=>g.value.lamaDisableResize=D)},null,512),[[Xe,g.value.lamaDisableResize]]),k[11]||(k[11]=e("span",{class:"checkbox-text"},"ç¦ç”¨è‡ªåŠ¨ç¼©æ”¾",-1))]),k[12]||(k[12]=e("div",{class:"input-hint"},[ge(" å¼€å¯åï¼ŒLAMA ä¿®å¤å°†ä½¿ç”¨åŸå›¾å°ºå¯¸è¿›è¡Œå¤„ç†ï¼ˆä¸ç¼©æ”¾åˆ°1024pxï¼‰ï¼Œå¯è·å¾—æ›´é«˜ç”»è´¨ã€‚ "),e("br"),e("span",{class:"hint-note"},"âš ï¸ éœ€è¦æ›´å¼ºçš„ GPU å’Œæ›´å¤šæ˜¾å­˜ï¼Œå¤„ç†é€Ÿåº¦ä¼šå˜æ…¢ã€‚æ¨è RTX 4060 æˆ–æ›´é«˜é…ç½®ä½¿ç”¨ã€‚"),e("br"),e("span",{class:"hint-note"},"é€‚ç”¨äºä¸¤ç§LAMAä¿®å¤æ–¹æ³•ï¼ˆé€Ÿåº¦ä¼˜åŒ–å’Œé€šç”¨ï¼‰ã€‚")],-1))])]),e("div",_m,[k[16]||(k[16]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",km,[e("label",Sm,[oe(e("input",{type:"checkbox","onUpdate:modelValue":k[3]||(k[3]=D=>g.value.enableVerboseLogs=D)},null,512),[[Xe,g.value.enableVerboseLogs]]),k[14]||(k[14]=e("span",{class:"checkbox-text"},"è¯¦ç»†æ—¥å¿—",-1))]),k[15]||(k[15]=e("div",{class:"input-hint"},[ge(" å¼€å¯åï¼Œåç«¯ç»ˆç«¯ä¼šæ‰“å°è¯¦ç»†çš„è¯Šæ–­æ—¥å¿—ï¼ˆåŒ…æ‹¬å®Œæ•´çš„æ¶ˆæ¯ç»“æ„ã€æ¨¡å‹å“åº”ç­‰ï¼‰ï¼Œä¾¿äºè°ƒè¯•é—®é¢˜ã€‚ "),e("br"),e("span",{class:"hint-note"},"å½±å“æ‰€æœ‰ç¿»è¯‘æ¨¡å¼ï¼Œé»˜è®¤å…³é—­ä»¥ä¿æŒæ—¥å¿—ç®€æ´ã€‚")],-1))])]),e("div",wm,[k[19]||(k[19]=e("div",{class:"settings-group-title"},"PDFå¤„ç†è®¾ç½®",-1)),e("div",$m,[k[17]||(k[17]=e("label",{for:"settingsPdfProcessingMethod"},"PDFå¤„ç†æ–¹å¼:",-1)),_e(We,{modelValue:g.value.pdfProcessingMethod,"onUpdate:modelValue":k[4]||(k[4]=D=>g.value.pdfProcessingMethod=D),options:t},null,8,["modelValue"]),k[18]||(k[18]=e("div",{class:"input-hint"},"å‰ç«¯å¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œåç«¯å¤„ç†å…¼å®¹æ€§æ›´å¥½",-1))])]),e("div",Tm,[k[23]||(k[23]=e("div",{class:"settings-group-title"},"å­—ä½“è®¾ç½®",-1)),e("div",Im,[k[20]||(k[20]=e("label",null,"ç³»ç»Ÿå­—ä½“åˆ—è¡¨:",-1)),e("button",{class:"btn btn-secondary",onClick:i,disabled:a.value},ee(a.value?"åŠ è½½ä¸­...":"ğŸ”„ åˆ·æ–°å­—ä½“åˆ—è¡¨"),9,Pm),l.value.length>0?(E(),L("div",Rm,"å…± "+ee(l.value.length)+" ä¸ªå­—ä½“",1)):ce("",!0)]),e("div",Dm,[k[21]||(k[21]=e("label",null,"ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:c,ref_key:"fontInput",ref:x},null,544),k[22]||(k[22]=e("div",{class:"input-hint"},"æ”¯æŒ .ttf, .ttc, .otf æ ¼å¼",-1))])]),e("div",Mm,[k[26]||(k[26]=e("div",{class:"settings-group-title"},"ç¼“å­˜æ¸…ç†",-1)),e("div",Bm,[e("div",Am,[e("button",{class:"btn btn-secondary",onClick:C,disabled:r.value},ee(r.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†è°ƒè¯•æ–‡ä»¶"),9,Em),k[24]||(k[24]=e("div",{class:"input-hint"},"æ¸…ç†è°ƒè¯•è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶",-1))]),e("div",Lm,[e("button",{class:"btn btn-secondary",onClick:$,disabled:r.value},ee(r.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"),9,Fm),k[25]||(k[25]=e("div",{class:"input-hint"},"æ¸…ç†ä¸‹è½½å’Œå¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶",-1))])])]),k[27]||(k[27]=ho('<div class="settings-group" data-v-06334835><div class="settings-group-title" data-v-06334835>å…³äº</div><div class="about-info" data-v-06334835><p data-v-06334835><strong data-v-06334835>Saber-Translator</strong></p><p data-v-06334835>AIé©±åŠ¨çš„æ¼«ç”»ç¿»è¯‘å·¥å…·</p><p class="links" data-v-06334835><a href="http://www.mashirosaber.top" target="_blank" data-v-06334835>ğŸ“– ä½¿ç”¨æ•™ç¨‹</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-06334835>ğŸ™ GitHub</a></p><p class="disclaimer" data-v-06334835>æœ¬é¡¹ç›®å®Œå…¨å¼€æºå…è´¹ï¼Œè¯·å‹¿ä¸Šå½“å—éª—</p></div></div>',1))]))}}),Om=Je(Um,[["__scopeId","data-v-06334835"]]),zm={class:"settings-modal-content"},Nm={class:"settings-tabs"},Vm=["onClick"],Wm={class:"settings-tab-content"},Km={class:"settings-tab-pane active"},qm={class:"settings-tab-pane"},Hm={class:"settings-tab-pane"},jm={class:"settings-tab-pane"},Jm={class:"settings-tab-pane"},Gm={class:"settings-tab-pane"},Ym={class:"settings-tab-pane"},Xm={class:"settings-tab-pane"},Zm=Ge({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(n,{emit:t}){const s=n,o=t,a=Fe(),l=w(s.modelValue),r=w("ocr"),x=[{id:"ocr",label:"OCRè¯†åˆ«"},{id:"translate",label:"ç¿»è¯‘æœåŠ¡"},{id:"detection",label:"æ£€æµ‹è®¾ç½®"},{id:"hq",label:"é«˜è´¨é‡ç¿»è¯‘"},{id:"proofreading",label:"AIæ ¡å¯¹"},{id:"prompt-library",label:"æç¤ºè¯ç®¡ç†"},{id:"plugins",label:"æ’ä»¶ç®¡ç†"},{id:"more",label:"æ›´å¤š"}];Se(()=>s.modelValue,C=>{l.value=C,C?(document.body.style.overflow="hidden",s.initialTab&&x.some($=>$.id===s.initialTab)&&(r.value=s.initialTab)):(document.body.style.overflow="",r.value="ocr")});function g(){l.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function i(){a.saveToStorage();try{await a.saveToBackend(),console.log("[SettingsModal] è®¾ç½®å·²ä¿å­˜åˆ°åç«¯")}catch(C){console.warn("[SettingsModal] ä¿å­˜åˆ°åç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ° localStorage:",C)}o("save"),g()}function c(C){C.key==="Escape"&&l.value&&g()}return dt(()=>{document.addEventListener("keydown",c)}),Wt(()=>{document.removeEventListener("keydown",c),document.body.style.overflow=""}),(C,$)=>l.value?(E(),L("div",{key:0,class:"settings-modal",onClick:nt(g,["self"])},[e("div",zm,[e("div",{class:"settings-modal-header"},[$[0]||($[0]=e("h3",null,"âš™ï¸ è®¾ç½®",-1)),e("span",{class:"settings-modal-close",onClick:g},"Ã—")]),e("div",Nm,[(E(),L(ze,null,Ye(x,R=>e("button",{key:R.id,class:Re(["settings-tab",{active:r.value===R.id}]),onClick:k=>r.value=R.id},ee(R.label),11,Vm)),64))]),e("div",Wm,[oe(e("div",Km,[_e(lc)],512),[[Oe,r.value==="ocr"]]),oe(e("div",qm,[_e(Zc)],512),[[Oe,r.value==="translate"]]),oe(e("div",Hm,[_e(hd)],512),[[Oe,r.value==="detection"]]),oe(e("div",jm,[_e(ng)],512),[[Oe,r.value==="hq"]]),oe(e("div",Jm,[_e(sp)],512),[[Oe,r.value==="proofreading"]]),oe(e("div",Gm,[_e(wp)],512),[[Oe,r.value==="prompt-library"]]),oe(e("div",Ym,[_e(em)],512),[[Oe,r.value==="plugins"]]),oe(e("div",Xm,[_e(Om)],512),[[Oe,r.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:g},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:i},"ä¿å­˜è®¾ç½®")])])])):ce("",!0)}}),Yn=Je(Zm,[["__scopeId","data-v-e1ec20ab"]]),Qm={minScale:.1,maxScale:5,zoomSpeed:.1};function wn(n={}){const t={...Qm,...n},s=w(1),o=w(0),a=w(0),l=w(!1),r=w(0),x=w(0),g=J(()=>({transform:`translate(${o.value}px, ${a.value}px) scale(${s.value})`}));function i(j,se,U){const Z=Math.min(Math.max(s.value*U,t.minScale),t.maxScale),ae=Z/s.value;o.value=j-(j-o.value)*ae,a.value=se-(se-a.value)*ae,s.value=Z,n.onScaleChange?.(s.value),n.onTransformChange?.(S())}function c(j,se=800,U=600){i(se/2,U/2,j)}function C(){c(1.2)}function $(){c(.8)}function R(j,se=800,U=600){const Z=j/s.value;i(se/2,U/2,Z)}function k(j,se){l.value=!0,r.value=j,x.value=se}function D(j,se){if(!l.value)return;const U=j-r.value,Z=se-x.value;o.value+=U,a.value+=Z,r.value=j,x.value=se,n.onTransformChange?.(S())}function N(){l.value=!1}function B(j,se){o.value+=j,a.value+=se,n.onTransformChange?.(S())}function A(){s.value=1,o.value=0,a.value=0,n.onScaleChange?.(s.value),n.onTransformChange?.(S())}function h(){A()}function p(){s.value=1,o.value=0,a.value=0}function T(j,se,U,Z){if(!j||!se)return;const ae=U/j,Y=Z/se;s.value=Math.min(ae,Y)*.95,o.value=(U-j*s.value)/2,a.value=(Z-se*s.value)/2,n.onScaleChange?.(s.value),n.onTransformChange?.(S())}function S(){return{scale:s.value,translateX:o.value,translateY:a.value}}function F(j){j.scale!==void 0&&(s.value=j.scale),j.translateX!==void 0&&(o.value=j.translateX),j.translateY!==void 0&&(a.value=j.translateY),n.onTransformChange?.(S())}function O(j){s.value=j.scale,o.value=j.translateX,a.value=j.translateY}function te(j,se,U){if(!j||j.length<4)return;const[Z,ae,Y,v]=j,m=(Z+Y)/2,b=(ae+v)/2,f=se/2,u=U/2;o.value=f-m*s.value,a.value=u-b*s.value,n.onTransformChange?.(S())}return{scale:s,translateX:o,translateY:a,isDragging:l,transformStyle:g,zoomAt:i,zoom:c,zoomIn:C,zoomOut:$,setScale:R,startDrag:k,drag:D,endDrag:N,pan:B,reset:A,resetZoom:h,resetTransform:p,fitToScreen:T,getTransform:S,setTransform:F,syncWith:O,scrollToBubble:te}}function Xn(n,t){const s=document.createElement("canvas");s.width=n,s.height=t;const o=s.getContext("2d");return o.fillStyle="rgb(127, 127, 127)",o.fillRect(0,0,n,t),s.toDataURL("image/png").split(",")[1]||""}async function $n(n,t,s,o,a){return n||(n=Xn(t,s)),new Promise((l,r)=>{const x=document.createElement("canvas");x.width=t,x.height=s;const g=x.getContext("2d"),i=new Image;i.onload=()=>{g.drawImage(i,0,0,t,s),g.fillStyle="white";for(const $ of o)g.beginPath(),g.arc($.x,$.y,a,0,Math.PI*2),g.fill();const C=x.toDataURL("image/png").split(",")[1]||"";l(C)},i.onerror=r,i.src="data:image/png;base64,"+n})}async function ev(n,t,s,o,a){return n||(n=Xn(t,s)),new Promise((l,r)=>{const x=document.createElement("canvas");x.width=t,x.height=s;const g=x.getContext("2d"),i=new Image;i.onload=()=>{g.drawImage(i,0,0,t,s),g.fillStyle="black";for(const $ of o)g.beginPath(),g.arc($.x,$.y,a,0,Math.PI*2),g.fill();const C=x.toDataURL("image/png").split(",")[1]||"";l(C)},i.onerror=r,i.src="data:image/png;base64,"+n})}function tv(n){const t=Ze(),s=Fe(),o=w(null),a=w(Ps),l=w(!1),r=w(!1),x=w([]),g=w(0),i=w(0);let c=null,C=null,$=null;const R=J(()=>o.value!==null),k=J(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function D(b){o.value!==b&&(o.value=b,l.value=!0,x.value=[],console.log(`è¿›å…¥${b==="repair"?"ä¿®å¤":"è¿˜åŸ"}ç¬”åˆ·æ¨¡å¼ï¼Œç¬”åˆ·å¤§å°: ${a.value}px`))}function N(){r.value&&F();const b=o.value!==null;o.value=null,l.value=!1,r.value=!1,x.value=[],se(),b&&console.log("é€€å‡ºç¬”åˆ·æ¨¡å¼")}function B(b){o.value===b?N():D(b)}function A(b){a.value=Math.max(ln,Math.min(an,b))}function h(b){A(a.value+b)}function p(b){if(!R.value)return;b.preventDefault(),b.stopPropagation();const f=b.deltaY>0?-5:5;h(f)}function T(b,f){if(!R.value||b.button!==0)return;b.preventDefault(),b.stopPropagation(),r.value=!0,c=f,x.value=[];const u=O(b,f);u&&(x.value.push(u),j(f),U(u)),console.log("å¼€å§‹ç¬”åˆ·æ¶‚æŠ¹")}function S(b){if(g.value=b.clientX,i.value=b.clientY,!r.value||!R.value)return;const f=O(b,c);f&&(x.value.push(f),U(f))}function F(){if(!r.value)return;r.value=!1;const b=t.currentImage;if(!b||x.value.length===0){se(),x.value=[];return}const f=te();if(!f){se(),x.value=[];return}const u=o.value;(async()=>{u==="restore"?await Z(b,f):u==="repair"&&await ae(b,f),n?.onBrushComplete?.()})(),se(),x.value=[]}function O(b,f){if(!f)return null;const u=f.querySelector(".image-canvas-wrapper"),y=u?.querySelector("img");if(!y||!y.naturalWidth)return null;const I=u.getBoundingClientRect(),M=window.getComputedStyle(u).transform;let V=1;M&&M!=="none"&&(V=new DOMMatrix(M).a);const G=(b.clientX-I.left)/V,d=(b.clientY-I.top)/V,_=y.naturalWidth,ie=y.naturalHeight;return G<0||d<0||G>_||d>ie?null:{x:G,y:d,scale:V}}function te(){if(x.value.length===0)return null;const f=x.value[0]?.scale||1,u=a.value/2/f;let y=1/0,I=1/0,M=-1/0,V=-1/0;for(const G of x.value)y=Math.min(y,G.x-u),I=Math.min(I,G.y-u),M=Math.max(M,G.x+u),V=Math.max(V,G.y+u);return{x1:Math.max(0,Math.floor(y)),y1:Math.max(0,Math.floor(I)),x2:Math.ceil(M),y2:Math.ceil(V),path:[...x.value],radius:u}}function j(b){se();const f=b.querySelector(".image-canvas-wrapper"),u=f?.querySelector("img");if(!u)return;const y=document.createElement("canvas");y.id="brushOverlayCanvas",y.width=u.naturalWidth,y.height=u.naturalHeight,y.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",f.appendChild(y),C=y,$=y.getContext("2d")}function se(){C&&C.parentNode&&C.parentNode.removeChild(C),C=null,$=null}function U(b){if(!$||!b)return;const f=k.value.fill,u=a.value/2/(b.scale||1);$.beginPath(),$.arc(b.x,b.y,u,0,Math.PI*2),$.fillStyle=f,$.fill()}async function Z(b,f){if(!b.originalDataURL)return;let u;return b.cleanImageData?u="data:image/png;base64,"+b.cleanImageData:u=b.originalDataURL,new Promise(y=>{const I=new Image,M=new Image;let V=0;const G=async()=>{if(V++,V<2)return;const d=document.createElement("canvas");d.width=I.naturalWidth,d.height=I.naturalHeight;const _=d.getContext("2d");if(!_){y();return}_.drawImage(I,0,0);const ie=document.createElement("canvas");ie.width=d.width,ie.height=d.height;const z=ie.getContext("2d");if(!z){y();return}z.fillStyle="white";for(const Ce of f.path)z.beginPath(),z.arc(Ce.x,Ce.y,f.radius,0,Math.PI*2),z.fill();_.globalCompositeOperation="destination-out",_.drawImage(ie,0,0),_.globalCompositeOperation="destination-over",_.drawImage(M,0,0),_.globalCompositeOperation="source-over";const X=await ev(b.userMask,d.width,d.height,f.path,f.radius),pe=d.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:pe,userMask:X}),console.log("è¿˜åŸç¬”åˆ·åŒºåŸŸå®Œæˆï¼ŒuserMask å·²æ›´æ–°"),y()};I.onload=G,I.onerror=()=>y(),M.onload=G,M.onerror=()=>y(),I.src=u,M.src=b.originalDataURL})}async function ae(b,f){const u=n?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},y=u.inpaintMethod;y==="lama_mpe"||y==="litelama"?await Y(b,f,y):await v(b,f,u.fillColor)}async function Y(b,f,u="lama_mpe"){let y,I;if(b.cleanImageData)y=b.cleanImageData,I="data:image/png;base64,"+b.cleanImageData;else if(b.originalDataURL)y=b.originalDataURL.split(",")[1],I=b.originalDataURL;else{console.error("æ— æ³•è·å–åŸºç¡€å›¾åƒç”¨äº LAMA ä¿®å¤");return}return new Promise(M=>{const V=new Image;V.onload=async()=>{const G=V.naturalWidth,d=V.naturalHeight,_=document.createElement("canvas");_.width=G,_.height=d;const ie=_.getContext("2d");if(!ie){console.error("æ— æ³•åˆ›å»ºæ©è†œç”»å¸ƒä¸Šä¸‹æ–‡"),M();return}ie.fillStyle="black",ie.fillRect(0,0,G,d),ie.fillStyle="white";for(const ke of f.path)ie.beginPath(),ie.arc(ke.x,ke.y,f.radius,0,Math.PI*2),ie.fill();const X=_.toDataURL("image/png").split(",")[1],pe=[f.x1,f.y1,f.x2,f.y2],Ce=u==="litelama"?"litelama":"lama_mpe";try{ye("LAMA ä¿®å¤ä¸­...","info");const ke=await To(y,pe,{method:"lama",lamaModel:Ce,maskData:X});if(ke.success&&ke.inpainted_image){const $e=await $n(b.userMask,G,d,f.path,f.radius);t.updateCurrentImage({cleanImageData:ke.inpainted_image,userMask:$e}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆLAMA ä¿®å¤ï¼Œç²¾ç¡®æ©è†œï¼‰ï¼ŒuserMask å·²æ›´æ–°"),ye("LAMA ä¿®å¤å®Œæˆ","success")}else throw new Error(ke.error||"LAMA ä¿®å¤è¿”å›æ— æ•ˆæ•°æ®")}catch(ke){console.error("LAMA ä¿®å¤å¤±è´¥ï¼Œå›é€€åˆ°çº¯è‰²å¡«å……:",ke),ye("LAMA ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨çº¯è‰²å¡«å……","warning");const $e=n?.getCurrentRepairSettings?.();await v(b,f,$e?.fillColor)}M()},V.onerror=()=>{console.error("åŠ è½½å›¾åƒå¤±è´¥ï¼Œæ— æ³•è¿›è¡Œ LAMA ä¿®å¤"),M()},V.src=I})}async function v(b,f,u){const y=u||s.settings.textStyle.fillColor||"#FFFFFF";let I;if(b.cleanImageData)I="data:image/png;base64,"+b.cleanImageData;else if(b.originalDataURL)I=b.originalDataURL;else return;return new Promise(M=>{const V=new Image;V.onload=async()=>{const G=document.createElement("canvas");G.width=V.naturalWidth,G.height=V.naturalHeight;const d=G.getContext("2d");if(!d){M();return}d.drawImage(V,0,0),d.fillStyle=y;for(const z of f.path)d.beginPath(),d.arc(z.x,z.y,f.radius,0,Math.PI*2),d.fill();const _=await $n(b.userMask,V.naturalWidth,V.naturalHeight,f.path,f.radius),ie=G.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:ie,userMask:_}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆçº¯è‰²å¡«å……ï¼‰ï¼ŒuserMask å·²æ›´æ–°"),M()},V.onerror=()=>M(),V.src=I})}async function m(){const b=t.currentImage;if(!b)return console.warn("ensureCleanBackground: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(b.cleanImageData)return console.log("ensureCleanBackground: å·²æœ‰å¹²å‡€èƒŒæ™¯"),!0;const f=n?.getCurrentRepairSettings?.();if((f?.inpaintMethod||s.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: éçº¯è‰²å¡«å……æ¨¡å¼ï¼Œè·³è¿‡"),!1;if(!b.bubbleStates||b.bubbleStates.length===0)return console.warn("ensureCleanBackground: æ²¡æœ‰æ°”æ³¡æ•°æ®"),!1;if(!b.translatedDataURL&&!b.originalDataURL)return console.warn("ensureCleanBackground: æ²¡æœ‰å›¾ç‰‡æ•°æ®"),!1;console.log("ensureCleanBackground: å°è¯•ä¸ºçº¯è‰²å¡«å……æ¨¡å¼åˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯");const y=b.translatedDataURL||b.originalDataURL,I=f?.fillColor||s.settings.textStyle.fillColor||"#FFFFFF";return new Promise(M=>{const V=new Image;V.onload=()=>{try{const G=document.createElement("canvas");G.width=V.naturalWidth,G.height=V.naturalHeight;const d=G.getContext("2d");if(!d){console.error("ensureCleanBackground: æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"),M(!1);return}d.drawImage(V,0,0),d.fillStyle=I;for(const ie of b.bubbleStates){const[z,X,pe,Ce]=ie.coords;d.fillRect(z,X,pe-z+1,Ce-X+1)}const _=G.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:_}),console.log("ensureCleanBackground: æˆåŠŸåˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯ï¼ˆçº¯è‰²å¡«å……ï¼‰"),M(!0)}catch(G){console.error("ensureCleanBackground: Canvas æ“ä½œå¤±è´¥:",G),M(!1)}},V.onerror=()=>{console.error("ensureCleanBackground: åŠ è½½å›¾åƒå¤±è´¥"),M(!1)},V.src=y})}return Wt(()=>{N()}),{brushMode:o,brushSize:a,isBrushKeyDown:l,isBrushPainting:r,mouseX:g,mouseY:i,isActive:R,brushColor:k,BRUSH_MIN_SIZE:ln,BRUSH_MAX_SIZE:an,enterBrushMode:D,exitBrushMode:N,toggleBrushMode:B,setBrushSize:A,adjustBrushSize:h,handleBrushWheel:p,startBrushPainting:T,continueBrushPainting:S,finishBrushPainting:F,getBrushPositionInImage:O,getBrushPathBounds:te,ensureCleanBackground:m}}function ov(n){return[Math.round(n[0]),Math.round(n[1]),Math.round(n[2]),Math.round(n[3])]}function nv(n){const t=gt(),s=Ze(),o=Fe(),{bubbles:a,selectedIndex:l,hasSelection:r}=yt(t),{currentImage:x}=yt(s),g=w(!1),i=w(!1),c=w(null),C=w(0),$=w(0),R=w(!1);function k(d){t.selectBubble(d)}function D(d){t.toggleMultiSelect(d)}function N(){t.clearMultiSelect()}function B(d,_){console.log(`å¼€å§‹æ‹–åŠ¨æ°”æ³¡ #${d+1}`)}function A(d,_){}function h(d,_){t.updateBubble(d,{coords:_}),console.log(`æ°”æ³¡ #${d+1} æ‹–åŠ¨å®Œæˆ:`,_),u()}function p(d,_,ie){console.log(`å¼€å§‹è°ƒæ•´æ°”æ³¡ #${d+1} å¤§å°ï¼Œæ‰‹æŸ„: ${_}`)}function T(d){}function S(d,_){t.updateBubble(d,{coords:_}),console.log(`æ°”æ³¡ #${d+1} è°ƒæ•´å¤§å°å®Œæˆ:`,_),u()}function F(d,_){console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${d+1}`)}function O(d){}function te(d,_){t.updateBubble(d,{rotationAngle:_}),console.log(`æ°”æ³¡ #${d+1} æ—‹è½¬å®Œæˆ: ${_}Â°`),u()}function j(){g.value=!g.value,g.value?console.log("è¿›å…¥ç»˜åˆ¶æ¨¡å¼"):console.log("é€€å‡ºç»˜åˆ¶æ¨¡å¼")}function se(d){t.addBubble(d),t.selectBubble(t.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",d),n?.onReRender?.()}function U(d,_){i.value=!0,C.value=d,$.value=_,c.value=[d,_,d,_]}function Z(d,_){i.value&&(c.value=[C.value,$.value,d,_])}function ae(){if(!i.value||!c.value)return i.value=!1,c.value=null,null;const[d,_,ie,z]=c.value,X=10;if(Math.abs(ie-d)<X||Math.abs(z-_)<X)return i.value=!1,c.value=null,null;const pe=[Math.min(d,ie),Math.min(_,z),Math.max(d,ie),Math.max(_,z)];return i.value=!1,c.value=null,pe}function Y(){i.value=!1,c.value=null,g.value=!1}function v(){if(!c.value)return{};const[d,_,ie,z]=c.value;return{position:"absolute",left:`${Math.min(d,ie)}px`,top:`${Math.min(_,z)}px`,width:`${Math.abs(ie-d)}px`,height:`${Math.abs(z-_)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let m=null,b=!1;const f=150;function u(){m&&clearTimeout(m),m=setTimeout(async()=>{if(b){console.log("è·³è¿‡æ¸²æŸ“ï¼Œä¸Šä¸€æ¬¡æ¸²æŸ“ä»åœ¨è¿›è¡Œä¸­");return}console.log("è§¦å‘å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆ"),b=!0;try{n?.onDelayedPreview?await n.onDelayedPreview():n?.onReRender&&await n.onReRender()}catch(d){console.error("å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆå¤±è´¥:",d)}finally{b=!1}},f)}function y(d){t.updateSelectedBubble(d),u()}function I(){r.value&&(t.deleteSelected(),console.log("å·²åˆ é™¤é€‰ä¸­çš„æ°”æ³¡"),n?.onReRender?.())}async function M(){const d=l.value;if(d<0){console.warn("è¯·å…ˆé€‰ä¸­è¦ä¿®å¤çš„æ°”æ³¡æ¡†");return}const _=a.value[d],ie=x.value;if(!_||!ie?.originalDataURL){console.warn("æ— æ³•ä¿®å¤èƒŒæ™¯ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}const z=_.inpaintMethod||"solid",X=_.fillColor||"#FFFFFF",pe=_.rotationAngle||0;try{console.log(`å¼€å§‹ä¿®å¤æ°”æ³¡ #${d+1} èƒŒæ™¯ï¼Œæ–¹æ³•: ${z}`);let Ce;if(ie.cleanImageData)Ce=ie.cleanImageData;else{const $e=ie.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(Ce=$e&&$e[1]?$e[1]:"",!Ce){console.error("æ— æ³•è§£æå›¾åƒæ•°æ®");return}}if(z==="lama_mpe"||z==="litelama"){const $e=z==="litelama"?"litelama":"lama_mpe",Me=ov(_.coords),re=await To(Ce,Me,{bubbleAngle:pe,method:"lama",lamaModel:$e});re.success&&re.inpainted_image?(s.updateCurrentImage({cleanImageData:re.inpainted_image}),console.log(`æ°”æ³¡ #${d+1} LAMAèƒŒæ™¯ä¿®å¤æˆåŠŸ`),u()):(console.error("LAMAä¿®å¤å¤±è´¥:",re.error||"æœªçŸ¥é”™è¯¯"),await V(_.coords,X,pe),u())}else await V(_.coords,X,pe),console.log(`æ°”æ³¡ #${d+1} çº¯è‰²å¡«å……ä¿®å¤æˆåŠŸ`),u()}catch(Ce){console.error("èƒŒæ™¯ä¿®å¤å‡ºé”™:",Ce);const ke=Ce instanceof Error?Ce.message:"èƒŒæ™¯ä¿®å¤å¤±è´¥";ye(ke,"error")}}async function V(d,_,ie=0){const z=x.value;if(!z)return;const[X,pe,Ce,ke]=d;let $e;if(z.cleanImageData)$e="data:image/png;base64,"+z.cleanImageData;else if(z.originalDataURL)$e=z.originalDataURL;else{console.error("æ— æ³•æ‰¾åˆ°åŸºç¡€å›¾åƒç”¨äºå¡«å……");return}return new Promise(Me=>{const re=new Image;re.onload=()=>{const P=document.createElement("canvas");P.width=re.naturalWidth,P.height=re.naturalHeight;const Q=P.getContext("2d");if(!Q){Me();return}if(Q.drawImage(re,0,0),Q.fillStyle=_,Math.abs(ie)<.1)Q.fillRect(X,pe,Ce-X,ke-pe);else{const me=(X+Ce)/2,xe=(pe+ke)/2,W=(Ce-X)/2,ne=(ke-pe)/2,ve=ie*Math.PI/180,fe=Math.cos(ve),Be=Math.sin(ve),Ne=[[-W,-ne],[W,-ne],[W,ne],[-W,ne]].map(([we,Le])=>[me+we*fe-Le*Be,xe+we*Be+Le*fe]);Q.beginPath();const Ue=Ne[0];if(Ue){Q.moveTo(Ue[0],Ue[1]);for(let we=1;we<Ne.length;we++){const Le=Ne[we];Le&&Q.lineTo(Le[0],Le[1])}}Q.closePath(),Q.fill()}const he=P.toDataURL("image/png").split(",")[1];s.updateCurrentImage({cleanImageData:he}),console.log("å·²å¯¹æ°”æ³¡åŒºåŸŸè¿›è¡Œçº¯è‰²å¡«å……:",d,_,"è§’åº¦:",ie),Me()},re.onerror=()=>{console.error("åŠ è½½åŸºç¡€å›¾åƒå¤±è´¥"),Me()},re.src=$e})}async function G(d){const _=a.value[d],ie=x.value;if(!_||!ie?.originalDataURL){console.warn("æ— æ³•è¿›è¡Œ OCR è¯†åˆ«ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}try{console.log(`å¼€å§‹ OCR è¯†åˆ«æ°”æ³¡ #${d+1}`);const z=ie.originalDataURL.split(",")[1]||"",X=o.settings,pe=X.ocrEngine==="paddleocr_vl"?X.paddleOcrVl?.sourceLanguage||"japanese":X.sourceLanguage,Ce=await Ln(z,_.coords,X.ocrEngine||"manga_ocr",{source_language:pe,baidu_ocr_api_key:X.baiduOcr.apiKey,baidu_ocr_secret_key:X.baiduOcr.secretKey,baidu_version:X.baiduOcr.version,baidu_source_language:X.baiduOcr.sourceLanguage,ai_vision_provider:X.aiVisionOcr.provider,ai_vision_api_key:X.aiVisionOcr.apiKey,ai_vision_model_name:X.aiVisionOcr.modelName,ai_vision_ocr_prompt:X.aiVisionOcr.prompt,custom_ai_vision_base_url:X.aiVisionOcr.customBaseUrl,ai_vision_min_image_size:X.aiVisionOcr.minImageSize});if(Ce.success&&Ce.text!==void 0)t.updateBubble(d,{originalText:Ce.text}),console.log(`OCR è¯†åˆ«æˆåŠŸ: "${Ce.text}"`);else{const ke=Ce.error||"è¯†åˆ«å¤±è´¥";console.error("OCR è¯†åˆ«å¤±è´¥:",ke),ye(ke,"error")}}catch(z){console.error("OCR è¯†åˆ«å‡ºé”™:",z);const X=z instanceof Error?z.message:"OCR è¯†åˆ«å‡ºé”™";ye(X,"error")}}return{isDrawingMode:g,isDrawingBox:i,currentDrawingRect:c,isMiddleButtonDown:R,handleBubbleSelect:k,handleBubbleMultiSelect:D,handleClearMultiSelect:N,handleBubbleDragStart:B,handleBubbleDragging:A,handleBubbleDragEnd:h,handleBubbleResizeStart:p,handleBubbleResizing:T,handleBubbleResizeEnd:S,handleBubbleRotateStart:F,handleBubbleRotating:O,handleBubbleRotateEnd:te,toggleDrawingMode:j,handleDrawBubble:se,startDrawingBox:U,updateDrawingBox:Z,finishDrawingBox:ae,cancelDrawing:Y,getDrawingRectStyle:v,handleBubbleUpdate:y,deleteSelectedBubbles:I,repairSelectedBubble:M,triggerDelayedPreview:u,handleOcrRecognize:G}}function sv(n){const t=gt(),s=Ze(),{bubbles:o}=yt(t),{currentImage:a}=yt(s),l=w(!1),r=w("");let x=null;function g(){const C=a.value;if(!C)return null;if(C.cleanImageData)return C.cleanImageData;if(C.originalDataURL){const $=C.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if($&&$[1])return $[1]}return null}async function i(C=!1){if(!a.value)return console.warn("reRenderFullImage: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(o.value.length===0){console.log("reRenderFullImage: æ²¡æœ‰æ°”æ³¡ï¼Œè·³è¿‡åç«¯æ¸²æŸ“");const D=g();if(D){const N=`data:image/png;base64,${D}`;s.updateCurrentImage({translatedDataURL:N}),C||n?.onRenderSuccess?.(N)}return!0}const R=g();if(!R)return console.error("reRenderFullImage: ç¼ºå°‘å›¾åƒæ•°æ®"),r.value="ç¼ºå°‘å›¾åƒæ•°æ®",C||n?.onRenderError?.("ç¼ºå°‘å›¾åƒæ•°æ®"),!1;const k=Symbol("render");x=k,l.value=!0,r.value="",C||n?.onRenderStart?.();try{console.log("reRenderFullImage: å¼€å§‹é‡æ–°æ¸²æŸ“ï¼Œæ°”æ³¡æ•°é‡:",o.value.length);const D=o.value,N=D.map(p=>p.translatedText||""),B=D.map(p=>p.coords.map(T=>Math.round(T))),A=D.map(p=>({translatedText:p.translatedText||"",coords:p.coords,fontSize:Number(p.fontSize)||24,fontFamily:p.fontFamily||ft,textDirection:Ot(p),textColor:p.textColor||"#231816",rotationAngle:Math.round(Number(p.rotationAngle)||0),position:p.position?{x:Math.round(p.position.x||0),y:Math.round(p.position.y||0)}:{x:0,y:0},strokeEnabled:p.strokeEnabled!==void 0?p.strokeEnabled:!0,strokeColor:p.strokeColor||"#FFFFFF",strokeWidth:Number(p.strokeWidth)||3})),h=await $o({clean_image:R,bubble_texts:N,bubble_coords:B,bubble_states:A,fontSize:Number(D[0]?.fontSize)||24,fontFamily:D[0]?.fontFamily||ft,textDirection:D[0]?Ot(D[0]):"vertical",textColor:D[0]?.textColor||"#231816",strokeEnabled:D[0]?.strokeEnabled!==void 0?D[0].strokeEnabled:!0,strokeColor:D[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(D[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(x!==k)return console.log("reRenderFullImage: æ¸²æŸ“ç»“æœå·²è¿‡æœŸï¼Œå¿½ç•¥"),!1;if(h.rendered_image){const p=`data:image/png;base64,${h.rendered_image}`;return s.updateCurrentImage({translatedDataURL:p}),console.log("reRenderFullImage: æ¸²æŸ“æˆåŠŸ"),C||n?.onRenderSuccess?.(p),!0}else{const p=h.error||"æ¸²æŸ“å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å¤±è´¥ -",p),r.value=p,C||n?.onRenderError?.(p),!1}}catch(D){if(x!==k)return!1;const N=D instanceof Error?D.message:"æ¸²æŸ“è¯·æ±‚å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å‡ºé”™ -",D),r.value=N,C||n?.onRenderError?.(N),!1}finally{x===k&&(l.value=!1,C||n?.onRenderEnd?.())}}function c(){x=null,l.value=!1}return{isRendering:l,renderError:r,reRenderFullImage:i,cancelRender:c}}const av=["data-index","data-coords","data-rotation","onClick","onMousedown"],lv={class:"bubble-index"},iv=["data-parent-index","onMousedown"],rv=["data-parent-index","onMousedown"],uv=["data-parent-index","onMousedown"],cv=["data-parent-index","onMousedown"],dv=["data-parent-index","onMousedown"],gv=["data-parent-index","onMousedown"],pv=["data-parent-index","onMousedown"],mv=["data-parent-index","onMousedown"],vv=["data-parent-index","onMousedown"],fv=Ge({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(n,{emit:t}){const s=gt(),{isDragging:o,draggingIndex:a,dragOffsetX:l,dragOffsetY:r,dragInitialX:x,dragInitialY:g,isResizing:i,resizingIndex:c,resizeCurrentCoords:C,isRotating:$,rotatingIndex:R,rotateCurrentAngle:k}=yt(s),D=n,N=t,B=w(null),A=w(0),h=w(0),p=w(""),T=w(0),S=w(0),F=w(null),O=w(0),te=w(0),j=w(0),se=w(0),U=w(!1),Z=w(0),ae=w(0),Y=w(null),v=w(!1);function m(P,Q){let he,me,xe,W,ne=P.rotationAngle||0;if(o.value&&a.value===Q){const[Ne,Ue,we,Le]=P.coords;he=x.value+l.value,me=g.value+r.value,xe=he+(we-Ne),W=me+(Le-Ue)}else i.value&&c.value===Q&&C.value?[he,me,xe,W]=C.value:$.value&&R.value===Q?([he,me,xe,W]=P.coords,ne=k.value):[he,me,xe,W]=P.coords;const ve=xe-he,fe=W-me,Be={left:`${he}px`,top:`${me}px`,width:`${ve}px`,height:`${fe}px`};return ne&&(Be.transformOrigin="center center",Be.transform=`rotate(${ne}deg)`),Be}function b(){if(!Y.value)return{};const[P,Q,he,me]=Y.value;return{left:`${Math.min(P,he)}px`,top:`${Math.min(Q,me)}px`,width:`${Math.abs(he-P)}px`,height:`${Math.abs(me-Q)}px`}}function f(P){if(!B.value)return null;const Q=B.value.getBoundingClientRect(),he=D.scale||1,me=(P.clientX-Q.left)/he,xe=(P.clientY-Q.top)/he;return{x:me,y:xe}}function u(P,Q){D.isBrushMode||Q.shiftKey||N("select",P)}function y(P){if(!D.isBrushMode){if(P.button===1){P.preventDefault(),v.value=!0,document.body.classList.add("middle-button-drawing"),Ce(P);return}P.button===0&&D.isDrawingMode&&Ce(P)}}function I(P,Q){if(!D.isBrushMode&&Q.button===0){if(Q.preventDefault(),Q.stopPropagation(),Q.shiftKey){N("multiSelect",P);return}if(P!==D.selectedIndex){N("select",P);return}M(P,Q)}}function M(P,Q){document.removeEventListener("mousemove",Me),document.removeEventListener("mouseup",re),o.value=!0,a.value=P,A.value=Q.clientX,h.value=Q.clientY,l.value=0,r.value=0;const he=D.bubbles[P];he&&(x.value=he.coords[0],g.value=he.coords[1]),N("dragStart",P,Q),document.addEventListener("mousemove",Me),document.addEventListener("mouseup",re)}function V(P){const Q=D.scale||1,he=(P.clientX-A.value)/Q,me=(P.clientY-h.value)/Q;l.value=he,r.value=me}function G(P){const Q=a.value;o.value=!1,a.value=-1,l.value=0,r.value=0;const he=D.scale||1,me=(P.clientX-A.value)/he,xe=(P.clientY-h.value)/he,W=D.bubbles[Q];if(!W)return;const[ne,ve,fe,Be]=W.coords,Ne=fe-ne,Ue=Be-ve;let we=Math.round(x.value+me),Le=Math.round(g.value+xe);const Ie=D.imageWidth||2e3,tt=D.imageHeight||2e3,qe=Math.min(Ne,Ie),lt=Math.min(Ue,tt);we=Math.max(0,Math.min(we,Ie-qe)),Le=Math.max(0,Math.min(Le,tt-lt));const Te=[we,Le,we+qe,Le+lt];N("dragEnd",Q,Te)}function d(P,Q,he){if(D.isBrushMode||he.button!==0)return;he.preventDefault(),he.stopPropagation(),document.removeEventListener("mousemove",Me),document.removeEventListener("mouseup",re),i.value=!0,c.value=Q,p.value=P,T.value=he.clientX,S.value=he.clientY;const me=D.bubbles[Q];me&&(F.value=[...me.coords],C.value=[...me.coords]),N("resizeStart",Q,P,he),document.addEventListener("mousemove",Me),document.addEventListener("mouseup",re)}function _(P){if(!F.value)return;const Q=D.scale||1,he=(P.clientX-T.value)/Q,me=(P.clientY-S.value)/Q;let[xe,W,ne,ve]=F.value;const fe=p.value;fe.includes("w")&&(xe+=he),fe.includes("e")&&(ne+=he),fe.includes("n")&&(W+=me),fe.includes("s")&&(ve+=me),xe>ne&&([xe,ne]=[ne,xe]),W>ve&&([W,ve]=[ve,W]);const Be=10;ne-xe<Be||ve-W<Be||(C.value=[xe,W,ne,ve])}function ie(P){if(!F.value)return;const Q=D.scale||1,he=(P.clientX-T.value)/Q,me=(P.clientY-S.value)/Q;let[xe,W,ne,ve]=F.value;const fe=p.value;fe.includes("w")&&(xe+=he),fe.includes("e")&&(ne+=he),fe.includes("n")&&(W+=me),fe.includes("s")&&(ve+=me),xe>ne&&([xe,ne]=[ne,xe]),W>ve&&([W,ve]=[ve,W]);const Be=D.imageWidth||2e3,Ne=D.imageHeight||2e3;xe=Math.max(0,Math.round(xe)),W=Math.max(0,Math.round(W)),ne=Math.min(Be,Math.round(ne)),ve=Math.min(Ne,Math.round(ve));const Ue=10;if(ne-xe<Ue||ve-W<Ue){console.warn("è°ƒæ•´åå°ºå¯¸è¿‡å°ï¼Œå·²æ’¤é”€"),i.value=!1,c.value=-1,F.value=null;return}N("resizeEnd",c.value,[xe,W,ne,ve]),i.value=!1,c.value=-1,F.value=null,C.value=null}function z(P,Q){if(D.isBrushMode||Q.button!==0)return;Q.preventDefault(),Q.stopPropagation(),document.removeEventListener("mousemove",Me),document.removeEventListener("mouseup",re),$.value=!0,R.value=P;const he=D.bubbles[P];if(!he||!B.value)return;const[me,xe,W,ne]=he.coords,ve=D.scale||1,fe=B.value.getBoundingClientRect();j.value=fe.left+(me+W)/2*ve,se.value=fe.top+(xe+ne)/2*ve;const Be=Q.clientX-j.value,Ne=Q.clientY-se.value;O.value=Math.atan2(Ne,Be)*180/Math.PI,te.value=he.rotationAngle||0,k.value=he.rotationAngle||0,N("rotateStart",P,Q),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",Me),document.addEventListener("mouseup",re),console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${P+1}ï¼Œåˆå§‹è§’åº¦: ${te.value}Â°`)}function X(P){const Q=P.clientX-j.value,he=P.clientY-se.value,xe=Math.atan2(he,Q)*180/Math.PI-O.value;let W=te.value+xe;for(;W>180;)W-=360;for(;W<-180;)W+=360;P.shiftKey&&(W=Math.round(W/15)*15),k.value=W}function pe(P){document.body.classList.remove("rotating-box");const Q=R.value,he=k.value;N("rotateEnd",Q,he),$.value=!1,R.value=-1,console.log(`æ°”æ³¡ #${Q+1} æ—‹è½¬å®Œæˆï¼Œè§’åº¦: ${he}Â°`)}function Ce(P){const Q=f(P);if(!Q)return;const he=D.imageWidth||2e3,me=D.imageHeight||2e3;Q.x<0||Q.x>he||Q.y<0||Q.y>me||(U.value=!0,Z.value=Q.x,ae.value=Q.y,Y.value=[Q.x,Q.y,Q.x,Q.y],document.addEventListener("mousemove",Me),document.addEventListener("mouseup",re),console.log("å¼€å§‹ç»˜åˆ¶æ–°æ¡†:",Q.x.toFixed(1),Q.y.toFixed(1)))}function ke(P){const Q=f(P);!Q||!Y.value||(Y.value=[Z.value,ae.value,Q.x,Q.y])}function $e(P){const Q=f(P);if(v.value&&(v.value=!1,document.body.classList.remove("middle-button-drawing")),!Q||!Y.value){U.value=!1,Y.value=null;return}const he=D.imageWidth||2e3,me=D.imageHeight||2e3,xe=Math.max(0,Math.round(Math.min(Z.value,Q.x))),W=Math.max(0,Math.round(Math.min(ae.value,Q.y))),ne=Math.min(he,Math.round(Math.max(Z.value,Q.x))),ve=Math.min(me,Math.round(Math.max(ae.value,Q.y))),fe=10;if(ne-xe<fe||ve-W<fe){console.log("ç»˜åˆ¶çš„æ¡†å¤ªå°ï¼Œå·²å¿½ç•¥"),U.value=!1,Y.value=null;return}console.log("å®Œæˆç»˜åˆ¶æ–°æ¡†:",[xe,W,ne,ve]),N("drawBubble",[xe,W,ne,ve]),U.value=!1,Y.value=null}function Me(P){o.value?V(P):i.value?_(P):$.value?X(P):U.value&&ke(P)}function re(P){document.removeEventListener("mousemove",Me),document.removeEventListener("mouseup",re),(P.button===1||v.value)&&(v.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?G(P):i.value?ie(P):$.value?pe():U.value&&$e(P)}return dt(()=>{}),Wt(()=>{document.removeEventListener("mousemove",Me),document.removeEventListener("mouseup",re),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(P,Q)=>(E(),L("div",{class:Re(["bubble-overlay",{"brush-mode":n.isBrushMode}]),style:ot({"--scale":n.scale||1}),ref_key:"overlayRef",ref:B,onMousedown:y},[(E(!0),L(ze,null,Ye(n.bubbles,(he,me)=>(E(),L("div",{key:me,class:Re(["bubble-highlight-box",{selected:me===n.selectedIndex,"multi-selected":n.selectedIndices.length>1&&n.selectedIndices.includes(me)&&me!==n.selectedIndex}]),style:ot(m(he,me)),"data-index":me,"data-coords":JSON.stringify(he.coords),"data-rotation":he.rotationAngle||0,onClick:nt(xe=>u(me,xe),["stop"]),onMousedown:nt(xe=>I(me,xe),["stop"])},[e("span",lv,ee(me+1),1),me===n.selectedIndex?(E(),L(ze,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":me,onMousedown:nt(xe=>d("nw",me,xe),["stop"])},null,40,iv),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":me,onMousedown:nt(xe=>d("n",me,xe),["stop"])},null,40,rv),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":me,onMousedown:nt(xe=>d("ne",me,xe),["stop"])},null,40,uv),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":me,onMousedown:nt(xe=>d("e",me,xe),["stop"])},null,40,cv),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":me,onMousedown:nt(xe=>d("se",me,xe),["stop"])},null,40,dv),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":me,onMousedown:nt(xe=>d("s",me,xe),["stop"])},null,40,gv),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":me,onMousedown:nt(xe=>d("sw",me,xe),["stop"])},null,40,pv),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":me,onMousedown:nt(xe=>d("w",me,xe),["stop"])},null,40,mv),Q[0]||(Q[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"æ‹–æ‹½æ—‹è½¬","data-parent-index":me,onMousedown:nt(xe=>z(me,xe),["stop"])},null,40,vv)],64)):ce("",!0)],46,av))),128)),Y.value?(E(),L("div",{key:0,class:"drawing-rect",style:ot(b())},null,4)):ce("",!0)],38))}}),Tn=Je(fv,[["__scopeId","data-v-b251bb68"]]),bv={key:0,class:"kana-keyboard"},hv={class:"kana-keyboard-header"},xv={class:"kana-keyboard-tabs"},yv=["onClick"],Cv={class:"kana-keyboard-options"},_v={class:"kana-mode-select"},kv={class:"kana-target-select"},Sv={class:"kana-table"},wv={class:"row-label"},$v=["onClick"],Tv={class:"kana-hiragana"},Iv={class:"kana-katakana"},Pv={class:"kana-table"},Rv={class:"row-label"},Dv=["onClick"],Mv={class:"kana-hiragana"},Bv={class:"kana-katakana"},Av={class:"kana-table combo-table"},Ev={class:"row-label"},Lv=["onClick"],Fv={class:"kana-hiragana"},Uv={class:"kana-katakana"},Ov={class:"special-chars-grid"},zv=["onClick"],Nv={key:0,class:"char-label"},Vv=Ge({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(n,{emit:t}){const s=n,o=t,a=w("basic"),l=w("hiragana"),r=w(s.defaultTarget),x=w(null),g=[{label:"åŸæ–‡",value:"original"},{label:"è¯‘æ–‡",value:"translated"}],i=[{id:"basic",label:"åŸºæœ¬"},{id:"dakuten",label:"æµŠ/åŠæµŠéŸ³"},{id:"combo",label:"æ‹—éŸ³"},{id:"special",label:"ç‰¹æ®Š"}],c=[{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ã‚¢"},{h:"ã„",k:"ã‚¤"},{h:"ã†",k:"ã‚¦"},{h:"ãˆ",k:"ã‚¨"},{h:"ãŠ",k:"ã‚ª"}]},{label:"ã‹è¡Œ",chars:[{h:"ã‹",k:"ã‚«"},{h:"ã",k:"ã‚­"},{h:"ã",k:"ã‚¯"},{h:"ã‘",k:"ã‚±"},{h:"ã“",k:"ã‚³"}]},{label:"ã•è¡Œ",chars:[{h:"ã•",k:"ã‚µ"},{h:"ã—",k:"ã‚·"},{h:"ã™",k:"ã‚¹"},{h:"ã›",k:"ã‚»"},{h:"ã",k:"ã‚½"}]},{label:"ãŸè¡Œ",chars:[{h:"ãŸ",k:"ã‚¿"},{h:"ã¡",k:"ãƒ"},{h:"ã¤",k:"ãƒ„"},{h:"ã¦",k:"ãƒ†"},{h:"ã¨",k:"ãƒˆ"}]},{label:"ãªè¡Œ",chars:[{h:"ãª",k:"ãƒŠ"},{h:"ã«",k:"ãƒ‹"},{h:"ã¬",k:"ãƒŒ"},{h:"ã­",k:"ãƒ"},{h:"ã®",k:"ãƒ"}]},{label:"ã¯è¡Œ",chars:[{h:"ã¯",k:"ãƒ"},{h:"ã²",k:"ãƒ’"},{h:"ãµ",k:"ãƒ•"},{h:"ã¸",k:"ãƒ˜"},{h:"ã»",k:"ãƒ›"}]},{label:"ã¾è¡Œ",chars:[{h:"ã¾",k:"ãƒ"},{h:"ã¿",k:"ãƒŸ"},{h:"ã‚€",k:"ãƒ "},{h:"ã‚",k:"ãƒ¡"},{h:"ã‚‚",k:"ãƒ¢"}]},{label:"ã‚„è¡Œ",chars:[{h:"ã‚„",k:"ãƒ¤"},null,{h:"ã‚†",k:"ãƒ¦"},null,{h:"ã‚ˆ",k:"ãƒ¨"}]},{label:"ã‚‰è¡Œ",chars:[{h:"ã‚‰",k:"ãƒ©"},{h:"ã‚Š",k:"ãƒª"},{h:"ã‚‹",k:"ãƒ«"},{h:"ã‚Œ",k:"ãƒ¬"},{h:"ã‚",k:"ãƒ­"}]},{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ãƒ¯"},null,null,null,{h:"ã‚’",k:"ãƒ²"}]},{label:"ã‚“",chars:[{h:"ã‚“",k:"ãƒ³"},null,null,null,null]}],C=[{label:"ãŒè¡Œ",chars:[{h:"ãŒ",k:"ã‚¬"},{h:"ã",k:"ã‚®"},{h:"ã",k:"ã‚°"},{h:"ã’",k:"ã‚²"},{h:"ã”",k:"ã‚´"}]},{label:"ã–è¡Œ",chars:[{h:"ã–",k:"ã‚¶"},{h:"ã˜",k:"ã‚¸"},{h:"ãš",k:"ã‚º"},{h:"ãœ",k:"ã‚¼"},{h:"ã",k:"ã‚¾"}]},{label:"ã è¡Œ",chars:[{h:"ã ",k:"ãƒ€"},{h:"ã¢",k:"ãƒ‚"},{h:"ã¥",k:"ãƒ…"},{h:"ã§",k:"ãƒ‡"},{h:"ã©",k:"ãƒ‰"}]},{label:"ã°è¡Œ",chars:[{h:"ã°",k:"ãƒ"},{h:"ã³",k:"ãƒ“"},{h:"ã¶",k:"ãƒ–"},{h:"ã¹",k:"ãƒ™"},{h:"ã¼",k:"ãƒœ"}]},{label:"ã±è¡Œ",chars:[{h:"ã±",k:"ãƒ‘"},{h:"ã´",k:"ãƒ”"},{h:"ã·",k:"ãƒ—"},{h:"ãº",k:"ãƒš"},{h:"ã½",k:"ãƒ"}]}],$=[{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚­ãƒ£"},{h:"ãã‚…",k:"ã‚­ãƒ¥"},{h:"ãã‚‡",k:"ã‚­ãƒ§"}]},{label:"ã—ã‚ƒè¡Œ",chars:[{h:"ã—ã‚ƒ",k:"ã‚·ãƒ£"},{h:"ã—ã‚…",k:"ã‚·ãƒ¥"},{h:"ã—ã‚‡",k:"ã‚·ãƒ§"}]},{label:"ã¡ã‚ƒè¡Œ",chars:[{h:"ã¡ã‚ƒ",k:"ãƒãƒ£"},{h:"ã¡ã‚…",k:"ãƒãƒ¥"},{h:"ã¡ã‚‡",k:"ãƒãƒ§"}]},{label:"ã«ã‚ƒè¡Œ",chars:[{h:"ã«ã‚ƒ",k:"ãƒ‹ãƒ£"},{h:"ã«ã‚…",k:"ãƒ‹ãƒ¥"},{h:"ã«ã‚‡",k:"ãƒ‹ãƒ§"}]},{label:"ã²ã‚ƒè¡Œ",chars:[{h:"ã²ã‚ƒ",k:"ãƒ’ãƒ£"},{h:"ã²ã‚…",k:"ãƒ’ãƒ¥"},{h:"ã²ã‚‡",k:"ãƒ’ãƒ§"}]},{label:"ã¿ã‚ƒè¡Œ",chars:[{h:"ã¿ã‚ƒ",k:"ãƒŸãƒ£"},{h:"ã¿ã‚…",k:"ãƒŸãƒ¥"},{h:"ã¿ã‚‡",k:"ãƒŸãƒ§"}]},{label:"ã‚Šã‚ƒè¡Œ",chars:[{h:"ã‚Šã‚ƒ",k:"ãƒªãƒ£"},{h:"ã‚Šã‚…",k:"ãƒªãƒ¥"},{h:"ã‚Šã‚‡",k:"ãƒªãƒ§"}]},{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚®ãƒ£"},{h:"ãã‚…",k:"ã‚®ãƒ¥"},{h:"ãã‚‡",k:"ã‚®ãƒ§"}]},{label:"ã˜ã‚ƒè¡Œ",chars:[{h:"ã˜ã‚ƒ",k:"ã‚¸ãƒ£"},{h:"ã˜ã‚…",k:"ã‚¸ãƒ¥"},{h:"ã˜ã‚‡",k:"ã‚¸ãƒ§"}]},{label:"ã³ã‚ƒè¡Œ",chars:[{h:"ã³ã‚ƒ",k:"ãƒ“ãƒ£"},{h:"ã³ã‚…",k:"ãƒ“ãƒ¥"},{h:"ã³ã‚‡",k:"ãƒ“ãƒ§"}]},{label:"ã´ã‚ƒè¡Œ",chars:[{h:"ã´ã‚ƒ",k:"ãƒ”ãƒ£"},{h:"ã´ã‚…",k:"ãƒ”ãƒ¥"},{h:"ã´ã‚‡",k:"ãƒ”ãƒ§"}]}],R=[{char:"ã£",label:"ä¿ƒéŸ³"},{char:"ãƒƒ",label:"ä¿ƒéŸ³"},{char:"ãƒ¼",label:"é•¿éŸ³"},{char:"ã€œ",label:"æ³¢æµª"},{char:"ã€‚",label:"å¥å·"},{char:"ã€",label:"é¡¿å·"},{char:"ã€Œ",label:"å¼•å·"},{char:"ã€",label:"å¼•å·"},{char:"ã€",label:"åŒå¼•"},{char:"ã€",label:"åŒå¼•"},{char:"â€¦",label:"çœç•¥"},{char:"ãƒ»",label:"ä¸­ç‚¹"},{char:"ï¼",label:"æ„Ÿå¹"},{char:"ï¼Ÿ",label:"é—®å·"},{char:"â™ª",label:"éŸ³ç¬¦"},{char:"â™¡",label:"å¿ƒå½¢"},{char:"â˜…",label:"æ˜Ÿå½¢"},{char:"â˜†",label:"ç©ºæ˜Ÿ"},{char:"ã",label:"å°ã‚"},{char:"ãƒ",label:"å°ã„"},{char:"ã…",label:"å°ã†"},{char:"ã‡",label:"å°ãˆ"},{char:"ã‰",label:"å°ãŠ"},{char:"ã‚¡",label:"å°ã‚¢"},{char:"ã‚£",label:"å°ã‚¤"},{char:"ã‚¥",label:"å°ã‚¦"},{char:"ã‚§",label:"å°ã‚¨"},{char:"ã‚©",label:"å°ã‚ª"},{char:"ã‚ƒ",label:"å°ã‚„"},{char:"ã‚…",label:"å°ã‚†"},{char:"ã‚‡",label:"å°ã‚ˆ"},{char:"ãƒ£",label:"å°ãƒ¤"},{char:"ãƒ¥",label:"å°ãƒ¦"},{char:"ãƒ§",label:"å°ãƒ¨"}];function k(){o("close")}function D(A){const h=l.value==="hiragana"?A.h:A.k;x.value=A.h,setTimeout(()=>{x.value=null},100),o("insert",h,r.value)}function N(A){x.value=A,setTimeout(()=>{x.value=null},100),o("insert",A,r.value)}function B(){o("delete",r.value)}return(A,h)=>n.visible?(E(),L("div",bv,[e("div",hv,[h[3]||(h[3]=e("span",{class:"kana-keyboard-title"},"50éŸ³é”®ç›˜",-1)),e("div",xv,[(E(),L(ze,null,Ye(i,p=>e("button",{key:p.id,class:Re(["kana-tab",{active:a.value===p.id}]),onClick:T=>a.value=p.id},ee(p.label),11,yv)),64))]),e("button",{class:"kana-keyboard-close",onClick:k},"âœ•")]),e("div",Cv,[e("div",_v,[e("label",null,[oe(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":h[0]||(h[0]=p=>l.value=p)},null,512),[[gn,l.value]]),h[4]||(h[4]=ge(" å¹³å‡å ",-1))]),e("label",null,[oe(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":h[1]||(h[1]=p=>l.value=p)},null,512),[[gn,l.value]]),h[5]||(h[5]=ge(" ç‰‡å‡å ",-1))])]),e("div",kv,[h[6]||(h[6]=e("label",null,"è¾“å…¥åˆ°ï¼š",-1)),_e(We,{modelValue:r.value,"onUpdate:modelValue":h[2]||(h[2]=p=>r.value=p),options:g},null,8,["modelValue"])])]),e("div",{class:Re(["kana-tab-content",{active:a.value==="basic"}])},[e("table",Sv,[h[7]||(h[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(E(),L(ze,null,Ye(c,p=>e("tr",{key:p.label},[e("td",wv,ee(p.label),1),(E(!0),L(ze,null,Ye(p.chars,(T,S)=>(E(),L("td",{key:S},[T?(E(),L("button",{key:0,class:Re(["kana-key",{pressed:x.value===T.h}]),onClick:F=>D(T)},[e("span",Tv,ee(T.h),1),e("span",Iv,ee(T.k),1)],10,$v)):ce("",!0)]))),128))])),64))])])],2),e("div",{class:Re(["kana-tab-content",{active:a.value==="dakuten"}])},[e("table",Pv,[h[8]||(h[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(E(),L(ze,null,Ye(C,p=>e("tr",{key:p.label},[e("td",Rv,ee(p.label),1),(E(!0),L(ze,null,Ye(p.chars,(T,S)=>(E(),L("td",{key:S},[T?(E(),L("button",{key:0,class:Re(["kana-key",{pressed:x.value===T.h}]),onClick:F=>D(T)},[e("span",Mv,ee(T.h),1),e("span",Bv,ee(T.k),1)],10,Dv)):ce("",!0)]))),128))])),64))])])],2),e("div",{class:Re(["kana-tab-content",{active:a.value==="combo"}])},[e("table",Av,[h[9]||(h[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚ƒ"),e("th",null,"ã‚…"),e("th",null,"ã‚‡")])],-1)),e("tbody",null,[(E(),L(ze,null,Ye($,p=>e("tr",{key:p.label},[e("td",Ev,ee(p.label),1),(E(!0),L(ze,null,Ye(p.chars,(T,S)=>(E(),L("td",{key:S},[T?(E(),L("button",{key:0,class:Re(["kana-key",{pressed:x.value===T.h}]),onClick:F=>D(T)},[e("span",Fv,ee(T.h),1),e("span",Uv,ee(T.k),1)],10,Lv)):ce("",!0)]))),128))])),64))])])],2),e("div",{class:Re(["kana-tab-content",{active:a.value==="special"}])},[e("div",Ov,[(E(),L(ze,null,Ye(R,p=>e("button",{key:p.char,class:Re(["kana-key special-key",{pressed:x.value===p.char}]),onClick:T=>N(p.char)},[ge(ee(p.char)+" ",1),p.label?(E(),L("span",Nv,ee(p.label),1)):ce("",!0)],10,zv)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:B},"âŒ« é€€æ ¼")])])):ce("",!0)}}),Wv=Je(Vv,[["__scopeId","data-v-ebfc2125"]]),Kv={class:"edit-panel-content"},qv={class:"text-column original-text-column text-block"},Hv={class:"text-column-header"},jv=["disabled"],Jv={class:"text-column translated-text-column text-block"},Gv={class:"text-column-header"},Yv=["disabled"],Xv={class:"style-settings-section text-block"},Zv={class:"office-toolbar"},Qv={class:"toolbar-row toolbar-row-top"},ef={class:"combo-control font-control"},tf={class:"combo-control size-control"},of={class:"size-input-wrap"},nf=["min","max","step"],sf={class:"toolbar-row toolbar-row-actions"},af={class:"toolbar-icon-group","aria-label":"æ’ç‰ˆæ–¹å‘"},lf=["data-active"],rf=["data-active"],uf={class:"toolbar-color-group"},cf={class:"toolbar-color-picker",title:"æ–‡å­—é¢œè‰²"},df={class:"toolbar-inpaint-group",title:"èƒŒæ™¯ä¿®å¤æ–¹å¼"},gf={class:"toolbar-stroke-cluster"},pf=["data-active"],mf={class:"toolbar-row toolbar-row-bottom"},vf={class:"toolbar-rotation-group",title:"æ—‹è½¬è§’åº¦"},ff={class:"toolbar-position-group",title:"ä½ç½®è°ƒæ•´"},bf={class:"toolbar-position-value"},hf={class:"fontsize-presets-panel"},xf={class:"font-size-presets"},yf=["onClick"],Gt=2,Cf=Ge({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{},isOcrLoading:{type:Boolean},isTranslateLoading:{type:Boolean}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(n,{emit:t}){const s=n,o=t,a=gt(),l={originalText:"",translatedText:"",fontSize:24,fontFamily:ft,textDirection:"vertical",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},r=w(""),x=w(""),g=w(24),i=w(ft),c=w("vertical"),C=w("#231816"),$=w("#FFFFFF"),R=w(!0),k=w("#FFFFFF"),D=w(3),N=w(0),B=w("solid"),A=w(0),h=w(0),p=w(null),T=w(null),S=w(null),F=w(null),O=w(null),te=w(!1),j=w("original"),se=w([{name:"æ€æºé»‘ä½“",path:ft},{name:"åæ–‡æ¥·ä½“",path:"fonts/STKAITI.TTF"},{name:"åæ–‡ç»†é»‘",path:"fonts/STXIHEI.TTF"},{name:"é»‘ä½“",path:"fonts/SIMHEI.TTF"},{name:"å®‹ä½“",path:"fonts/SIMSUN.TTC"}]),U=w([]),Z=J(()=>s.bubble?s.bubble.coords[0]+A.value:0),ae=J(()=>s.bubble?s.bubble.coords[1]+h.value:0),Y=J(()=>{const Te=[{label:"ç³»ç»Ÿå­—ä½“",options:se.value.map(K=>({label:K.name,value:K.path}))}];return U.value.length>0&&Te.push({label:"è‡ªå®šä¹‰å­—ä½“",options:U.value.map(K=>({label:K.name,value:K.path}))}),Te}),v=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤(æ¼«ç”»)",value:"lama_mpe"},{label:"LAMAä¿®å¤(é€šç”¨)",value:"litelama"}];function m(Te){const K=Te||l;r.value=K.originalText,x.value=K.translatedText,g.value=K.fontSize,i.value=K.fontFamily,c.value=K.textDirection,C.value=K.textColor,$.value=K.fillColor,R.value=K.strokeEnabled,k.value=K.strokeColor,D.value=K.strokeWidth,N.value=K.rotationAngle,B.value=K.inpaintMethod,A.value=K.position?.x||0,h.value=K.position?.y||0}Se(()=>s.bubble,Te=>{m(Te)},{deep:!0,immediate:!0});function b(){o("update",{originalText:r.value})}function f(){o("update",{translatedText:x.value})}function u(){navigator.clipboard.writeText(r.value)}function y(){navigator.clipboard.writeText(x.value)}function I(){o("update",{fontSize:g.value})}function M(Te){g.value=Te,o("update",{fontSize:Te})}function V(){g.value=Math.min(rn,g.value+vo),o("update",{fontSize:g.value})}function G(){g.value=Math.max(un,g.value-vo),o("update",{fontSize:g.value})}function d(){o("update",{fontFamily:i.value})}function _(Te){c.value=Te,o("update",{textDirection:Te})}function ie(){S.value?.click()}function z(){o("update",{textColor:C.value})}function X(){F.value?.click()}function pe(){o("update",{fillColor:$.value})}function Ce(){O.value?.click()}function ke(){o("update",{strokeColor:k.value})}function $e(){R.value=!R.value,o("update",{strokeEnabled:R.value})}function Me(){o("update",{strokeWidth:D.value})}function re(){o("update",{inpaintMethod:B.value})}function P(){o("update",{rotationAngle:N.value})}function Q(){N.value=Math.max(-180,N.value-5),o("update",{rotationAngle:N.value})}function he(){N.value=Math.min(180,N.value+5),o("update",{rotationAngle:N.value})}function me(){N.value=0,o("update",{rotationAngle:0})}function xe(){A.value-=Gt,o("update",{position:{x:A.value,y:h.value}})}function W(){A.value+=Gt,o("update",{position:{x:A.value,y:h.value}})}function ne(){h.value-=Gt,o("update",{position:{x:A.value,y:h.value}})}function ve(){h.value+=Gt,o("update",{position:{x:A.value,y:h.value}})}function fe(){A.value=0,h.value=0,o("update",{position:{x:0,y:0}})}function Be(){o("applyBubble",s.bubbleIndex)}function Ne(){a.updateAllBubbles({fontSize:g.value,fontFamily:i.value,textDirection:c.value,textColor:C.value,fillColor:$.value,strokeEnabled:R.value,strokeColor:k.value,strokeWidth:D.value,inpaintMethod:B.value}),console.log("æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡"),o("reRender")}function Ue(){o("resetCurrent",s.bubbleIndex)}function we(){o("ocrRecognize",s.bubbleIndex)}function Le(){o("reTranslate",s.bubbleIndex)}function Ie(){te.value=!te.value}function tt(Te,K){if(K==="original"){const le=p.value;if(le){const be=le.selectionStart||r.value.length,Ke=le.selectionEnd||r.value.length,rt=r.value;r.value=rt.slice(0,be)+Te+rt.slice(Ke),pt(()=>{le.selectionStart=le.selectionEnd=be+Te.length,le.focus()}),o("update",{originalText:r.value})}}else{const le=T.value;if(le){const be=le.selectionStart||x.value.length,Ke=le.selectionEnd||x.value.length,rt=x.value;x.value=rt.slice(0,be)+Te+rt.slice(Ke),pt(()=>{le.selectionStart=le.selectionEnd=be+Te.length,le.focus()}),o("update",{translatedText:x.value})}}}function qe(Te){if(Te==="original"){const K=p.value;if(K&&r.value.length>0){const le=K.selectionStart||r.value.length,be=K.selectionEnd||r.value.length,Ke=r.value;le===be&&le>0?(r.value=Ke.slice(0,le-1)+Ke.slice(be),pt(()=>{K.selectionStart=K.selectionEnd=le-1,K.focus()})):le!==be&&(r.value=Ke.slice(0,le)+Ke.slice(be),pt(()=>{K.selectionStart=K.selectionEnd=le,K.focus()})),o("update",{originalText:r.value})}}else{const K=T.value;if(K&&x.value.length>0){const le=K.selectionStart||x.value.length,be=K.selectionEnd||x.value.length,Ke=x.value;le===be&&le>0?(x.value=Ke.slice(0,le-1)+Ke.slice(be),pt(()=>{K.selectionStart=K.selectionEnd=le-1,K.focus()})):le!==be&&(x.value=Ke.slice(0,le)+Ke.slice(be),pt(()=>{K.selectionStart=K.selectionEnd=le,K.focus()})),o("update",{translatedText:x.value})}}}async function lt(){try{const Te=await Ys();if(Te.fonts){const K=[],le=[];for(const be of Te.fonts){const Ke={name:typeof be=="string"?be:be.display_name||be.file_name||"",path:typeof be=="string"?be:be.path};Ke.path.startsWith("fonts/")?K.push(Ke):le.push(Ke)}K.length>0&&(se.value=K),U.value=le}}catch(Te){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",Te)}}return dt(()=>{lt()}),(Te,K)=>(E(),L("div",Kv,[e("div",qv,[e("div",Hv,[K[14]||(K[14]=e("span",{class:"column-title"},"ğŸ‡¯ğŸ‡µ æ—¥è¯­åŸæ–‡ (OCRç»“æœ)",-1)),e("button",{class:Re(["re-ocr-btn",{"is-loading":n.isOcrLoading}]),disabled:n.isOcrLoading,onClick:we,title:"é‡æ–°OCRæ­¤æ°”æ³¡"},[...K[13]||(K[13]=[e("span",{class:"btn-icon"},"ğŸ”„",-1)])],10,jv)]),oe(e("textarea",{ref_key:"originalTextInput",ref:p,"onUpdate:modelValue":K[0]||(K[0]=le=>r.value=le),class:"text-editor original-editor",placeholder:"OCRè¯†åˆ«çš„æ—¥è¯­åŸæ–‡...",spellcheck:"false",onInput:b},null,544),[[Pe,r.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:u},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"keyboard-toggle-btn",onClick:Ie,title:"æ˜¾ç¤º/éšè—50éŸ³é”®ç›˜"}," âŒ¨ï¸ 50éŸ³ ")]),_e(Wv,{visible:te.value,"default-target":j.value,onClose:K[1]||(K[1]=le=>te.value=!1),onInsert:tt,onDelete:qe},null,8,["visible","default-target"])]),e("div",Jv,[e("div",Gv,[K[16]||(K[16]=e("span",{class:"column-title"},"ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯‘æ–‡",-1)),e("button",{class:Re(["re-translate-btn",{"is-loading":n.isTranslateLoading}]),disabled:n.isTranslateLoading,onClick:Le,title:"é‡æ–°ç¿»è¯‘æ­¤æ°”æ³¡"},[...K[15]||(K[15]=[e("span",{class:"btn-icon"},"ğŸ”„",-1)])],10,Yv)]),oe(e("textarea",{ref_key:"translatedTextInput",ref:T,"onUpdate:modelValue":K[2]||(K[2]=le=>x.value=le),class:"text-editor translated-editor",placeholder:"ç¿»è¯‘åçš„ä¸­æ–‡...",spellcheck:"false",onInput:f},null,544),[[Pe,x.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:y},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"apply-text-btn",onClick:Be},"âœ“ åº”ç”¨æ–‡æœ¬")])]),e("div",Xv,[e("div",Zv,[e("div",Qv,[e("div",ef,[K[17]||(K[17]=e("label",null,"å­—ä½“",-1)),_e(We,{modelValue:i.value,"onUpdate:modelValue":K[3]||(K[3]=le=>i.value=le),groups:Y.value,title:"å­—ä½“",onChange:d},null,8,["modelValue","groups"])]),e("div",tf,[K[18]||(K[18]=e("label",null,"å­—å·",-1)),e("div",of,[oe(e("input",{type:"number","onUpdate:modelValue":K[4]||(K[4]=le=>g.value=le),class:"toolbar-fontsize-input",min:H(un),max:H(rn),step:H(vo),title:"å­—å·",onChange:I},null,40,nf),[[Pe,g.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:V,title:"å¢å¤§å­—å·"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:G,title:"å‡å°å­—å·"}," A- ")])])])]),e("div",sf,[e("div",af,[e("button",{class:"toolbar-btn","data-active":c.value==="vertical",onClick:K[5]||(K[5]=le=>_("vertical")),title:"ç«–å‘æ’ç‰ˆ"},[...K[19]||(K[19]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,lf),e("button",{class:"toolbar-btn","data-active":c.value==="horizontal",onClick:K[6]||(K[6]=le=>_("horizontal")),title:"æ¨ªå‘æ’ç‰ˆ"},[...K[20]||(K[20]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,rf)]),K[26]||(K[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",uf,[e("div",cf,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:ie},[K[21]||(K[21]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:ot({background:C.value})},null,4)]),oe(e("input",{ref_key:"textColorInput",ref:S,type:"color","onUpdate:modelValue":K[7]||(K[7]=le=>C.value=le),class:"hidden-color-input",onInput:z,onChange:z},null,544),[[Pe,C.value]])])]),K[27]||(K[27]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",df,[_e(We,{modelValue:B.value,"onUpdate:modelValue":K[8]||(K[8]=le=>B.value=le),options:v,onChange:re},null,8,["modelValue"]),e("div",{class:Re(["toolbar-color-picker toolbar-solid-color-options",{hidden:B.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:X},[K[22]||(K[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:ot({background:$.value})},null,4)]),oe(e("input",{ref_key:"fillColorInput",ref:F,type:"color","onUpdate:modelValue":K[9]||(K[9]=le=>$.value=le),class:"hidden-color-input",onChange:pe},null,544),[[Pe,$.value]])],2)]),K[28]||(K[28]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",gf,[e("button",{class:"toolbar-btn","data-active":R.value,onClick:$e,title:"æ–‡å­—æè¾¹"},[...K[23]||(K[23]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,pf),e("div",{class:Re(["toolbar-color-picker toolbar-stroke-options",{hidden:!R.value}]),title:"æè¾¹é¢œè‰²"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:Ce},[K[24]||(K[24]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:ot({background:k.value})},null,4)]),oe(e("input",{ref_key:"strokeColorInput",ref:O,type:"color","onUpdate:modelValue":K[10]||(K[10]=le=>k.value=le),class:"hidden-color-input",onChange:ke},null,544),[[Pe,k.value]])],2),e("div",{class:Re(["toolbar-stroke-width toolbar-stroke-options",{hidden:!R.value}]),title:"æè¾¹å®½åº¦"},[oe(e("input",{type:"number","onUpdate:modelValue":K[11]||(K[11]=le=>D.value=le),class:"toolbar-mini-input",min:"0",max:"10",onChange:Me},null,544),[[Pe,D.value,void 0,{number:!0}]]),K[25]||(K[25]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",mf,[e("div",vf,[e("button",{class:"toolbar-btn",onClick:Q,title:"é€†æ—¶é’ˆæ—‹è½¬"},[...K[29]||(K[29]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),oe(e("input",{type:"number","onUpdate:modelValue":K[12]||(K[12]=le=>N.value=le),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:P},null,544),[[Pe,N.value,void 0,{number:!0}]]),K[31]||(K[31]=e("span",{class:"toolbar-unit"},"Â°",-1)),e("button",{class:"toolbar-btn",onClick:he,title:"é¡ºæ—¶é’ˆæ—‹è½¬"},[...K[30]||(K[30]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:me,title:"é‡ç½®æ—‹è½¬"}," 0 ")]),K[37]||(K[37]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",ff,[e("button",{class:"toolbar-btn",onClick:xe,title:"å·¦ç§»"},[...K[32]||(K[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:W,title:"å³ç§»"},[...K[33]||(K[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ne,title:"ä¸Šç§»"},[...K[34]||(K[34]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ve,title:"ä¸‹ç§»"},[...K[35]||(K[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",bf,[e("span",null,ee(Z.value),1),K[36]||(K[36]=ge(",",-1)),e("span",null,ee(ae.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:fe,title:"é‡ç½®ä½ç½®"}," âŒ‚ ")])])]),e("details",hf,[K[38]||(K[38]=e("summary",null,"å­—å·é¢„è®¾",-1)),e("div",xf,[(E(!0),L(ze,null,Ye(H(Rs),le=>(E(),L("button",{key:le,class:Re(["preset-btn",{active:g.value===le}]),onClick:be=>M(le)},ee(le),11,yf))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:Be},"åº”ç”¨"),e("button",{class:"btn-apply-all",onClick:Ne},"åº”ç”¨å…¨éƒ¨"),e("button",{class:"btn-reset",onClick:Ue},"é‡ç½®")])])]))}}),_f=Je(Cf,[["__scopeId","data-v-9d0b72d7"]]),kf={class:"edit-toolbar-wrapper"},Sf={class:"edit-toolbar toolbar-row-1"},wf={class:"image-navigator"},$f=["disabled"],Tf=["disabled"],If={class:"bubble-navigator"},Pf=["disabled"],Rf={class:"bubble-indicator"},Df={id:"currentBubbleNum"},Mf={id:"totalBubbleNum"},Bf=["disabled"],Af={class:"view-controls"},Ef={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},Lf={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},Ff={id:"zoomLevel"},Uf={class:"edit-toolbar toolbar-row-2"},Of={class:"annotation-tools"},zf=["disabled"],Nf=["disabled"],Vf={key:0,class:"brush-size-indicator"},Wf={key:1,class:"brush-mode-hint"},Kf={class:"edit-progress-info"},qf={class:"edit-progress-text"},Hf={class:"edit-progress-count"},jf={class:"edit-progress-bar"},Jf={class:"quick-actions"},Gf=Ge({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{},isRepairLoading:{type:Boolean}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next","open-settings"],setup(n){const t=n,s=w(!1),o=w(void 0);function a(i){o.value=i,s.value=!0}function l(){ye("è®¾ç½®å·²ä¿å­˜","success")}const r=J(()=>t.progressTotal===0?0:Math.round(t.progressCurrent/t.progressTotal*100)),x=J(()=>t.progressTotal>0&&t.progressCurrent>=t.progressTotal),g=J(()=>{const i=t.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${t.mouseX}px`,top:`${t.mouseY}px`,width:`${t.brushSize}px`,height:`${t.brushSize}px`,borderRadius:"50%",border:`2px solid ${i.border}`,backgroundColor:i.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:t.brushMode?"block":"none"}});return(i,c)=>(E(),L("div",kf,[e("div",Sf,[e("div",wf,[e("button",{class:"nav-btn",disabled:!n.canGoPrevious,onClick:c[0]||(c[0]=C=>i.$emit("go-previous-image")),title:"ä¸Šä¸€å¼ å›¾ç‰‡ (PageUp)"}," â—€â—€ ",8,$f),e("span",{class:"image-indicator",onClick:c[1]||(c[1]=C=>i.$emit("toggle-thumbnails")),title:"ç‚¹å‡»å±•å¼€ç¼©ç•¥å›¾"},[c[25]||(c[25]=ge(" å›¾ ",-1)),e("span",null,ee(n.currentImageIndex+1),1),c[26]||(c[26]=ge(" / ",-1)),e("span",null,ee(n.imageCount),1)]),e("button",{class:"nav-btn",disabled:!n.canGoNext,onClick:c[2]||(c[2]=C=>i.$emit("go-next-image")),title:"ä¸‹ä¸€å¼ å›¾ç‰‡ (PageDown)"}," â–¶â–¶ ",8,Tf),e("button",{class:Re(["thumb-toggle-btn",{active:n.showThumbnails}]),onClick:c[3]||(c[3]=C=>i.$emit("toggle-thumbnails")),title:"æ˜¾ç¤º/éšè—ç¼©ç•¥å›¾"}," â˜· ",2)]),c[33]||(c[33]=e("div",{class:"toolbar-divider"},null,-1)),e("div",If,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex<=0,onClick:c[4]||(c[4]=C=>i.$emit("select-previous-bubble")),title:"ä¸Šä¸€ä¸ªæ°”æ³¡ (â†)"}," â—€ ",8,Pf),e("span",Rf,[c[27]||(c[27]=ge(" æ°”æ³¡ ",-1)),e("span",Df,ee(n.selectedBubbleIndex>=0?n.selectedBubbleIndex+1:0),1),c[28]||(c[28]=ge(" / ",-1)),e("span",Mf,ee(n.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex>=n.bubbleCount-1,onClick:c[5]||(c[5]=C=>i.$emit("select-next-bubble")),title:"ä¸‹ä¸€ä¸ªæ°”æ³¡ (â†’)"}," â–¶ ",8,Bf)]),c[34]||(c[34]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Af,[e("button",{class:"layout-toggle-btn",onClick:c[6]||(c[6]=C=>i.$emit("toggle-layout")),title:"åˆ‡æ¢å¸ƒå±€ï¼šå·¦å³/ä¸Šä¸‹"},[n.layoutMode==="horizontal"?(E(),L("svg",Ef,[...c[29]||(c[29]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(E(),L("svg",Lf,[...c[30]||(c[30]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:c[7]||(c[7]=C=>i.$emit("toggle-view-mode")),title:"åˆ‡æ¢è§†å›¾æ¨¡å¼"},[...c[31]||(c[31]=[e("span",{class:"dual-icon"},"â§‰",-1)])]),e("button",{class:Re({active:n.syncEnabled}),onClick:c[8]||(c[8]=C=>i.$emit("toggle-sync")),title:"åŒæ­¥ç¼©æ”¾/æ‹–åŠ¨",style:{"font-size":"12px"}}," ğŸ”— ",2),e("button",{onClick:c[9]||(c[9]=C=>i.$emit("fit-to-screen")),title:"é€‚åº”å±å¹• (åŒå‡»)"},"â›¶"),e("button",{onClick:c[10]||(c[10]=C=>i.$emit("zoom-in")),title:"æ”¾å¤§ (+)"},"+"),e("span",Ff,ee(Math.round(n.scale*100))+"%",1),e("button",{onClick:c[11]||(c[11]=C=>i.$emit("zoom-out")),title:"ç¼©å° (-)"},"âˆ’"),e("button",{onClick:c[12]||(c[12]=C=>i.$emit("reset-zoom")),title:"åŸå§‹å¤§å°"},"1:1"),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"æ‰“å¼€è®¾ç½®",onClick:c[13]||(c[13]=C=>a())},[...c[32]||(c[32]=[e("span",{class:"icon"},"âš™ï¸",-1)])])]),c[35]||(c[35]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:c[14]||(c[14]=C=>i.$emit("exit-edit-mode"))},"é€€å‡ºç¼–è¾‘")]),e("div",Uf,[e("div",Of,[e("button",{class:"annotation-btn detect-btn",onClick:c[15]||(c[15]=C=>i.$emit("auto-detect-bubbles")),title:"è‡ªåŠ¨æ£€æµ‹å½“å‰å›¾ç‰‡çš„æ–‡æœ¬æ¡†"},[...c[36]||(c[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"æ£€æµ‹",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:c[16]||(c[16]=C=>i.$emit("detect-all-images")),title:"æ‰¹é‡æ£€æµ‹æ‰€æœ‰å›¾ç‰‡"},[...c[37]||(c[37]=[ho('<svg viewBox="0 0 16 16" width="14" height="14" data-v-5e01c678><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-5e01c678></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-5e01c678></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-5e01c678></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-5e01c678></path></svg><span data-v-5e01c678>æ‰¹é‡æ£€æµ‹</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:c[17]||(c[17]=C=>i.$emit("translate-with-bubbles")),title:"ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘æ­¤å›¾ç‰‡"},[...c[38]||(c[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"ç¿»è¯‘",-1)])]),c[45]||(c[45]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Re(["annotation-btn",{active:n.isDrawingMode}]),onClick:c[18]||(c[18]=C=>i.$emit("toggle-drawing-mode")),title:"æ·»åŠ æ°”æ³¡æ¡†ï¼ˆæˆ–ä¸­é”®æ‹–æ‹½ç»˜åˆ¶ï¼‰"},[...c[39]||(c[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"æ·»åŠ ",-1)])],2),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:c[19]||(c[19]=C=>i.$emit("delete-selected-bubbles")),title:"åˆ é™¤é€‰ä¸­æ°”æ³¡æ¡† (Delete)"},[...c[40]||(c[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"åˆ é™¤",-1)])],8,zf),e("button",{class:Re(["annotation-btn",{"is-loading":n.isRepairLoading}]),disabled:!n.hasSelection||n.isRepairLoading,onClick:c[20]||(c[20]=C=>i.$emit("repair-selected-bubble")),title:"ä¿®å¤é€‰ä¸­æ°”æ³¡èƒŒæ™¯ (R)"},[(E(),L("svg",{viewBox:"0 0 16 16",width:"14",height:"14",class:Re({"spin-icon":n.isRepairLoading})},[...c[41]||(c[41]=[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},null,-1),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"},null,-1)])],2)),c[42]||(c[42]=e("span",null,"ä¿®å¤",-1))],10,Nf),c[46]||(c[46]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Re(["annotation-btn brush-btn",{active:n.brushMode==="repair"}]),onClick:c[21]||(c[21]=C=>i.$emit("activate-repair-brush")),title:"ä¿®å¤ç¬”åˆ· (æŒ‰ä½R+å·¦é”®æ‹–æ‹½)"},[...c[43]||(c[43]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤ç¬”åˆ·",-1)])],2),e("button",{class:Re(["annotation-btn brush-btn",{active:n.brushMode==="restore"}]),onClick:c[22]||(c[22]=C=>i.$emit("activate-restore-brush")),title:"è¿˜åŸç¬”åˆ· (æŒ‰ä½U+å·¦é”®æ‹–æ‹½)"},[...c[44]||(c[44]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"è¿˜åŸç¬”åˆ·",-1)])],2),n.brushMode?(E(),L("span",Vf," ç¬”åˆ·: "+ee(n.brushSize)+"px ",1)):ce("",!0),c[47]||(c[47]=ho('<div class="help-tooltip-container" data-v-5e01c678><button class="help-tooltip-btn" title="å¿«æ·é”®æ“ä½œå¸®åŠ©" data-v-5e01c678><svg viewBox="0 0 16 16" width="14" height="14" data-v-5e01c678><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-5e01c678></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-5e01c678>?</text></svg><span class="help-btn-text" data-v-5e01c678>å¿«æ·é”®</span></button><div class="help-tooltip-popup" data-v-5e01c678><div class="help-section" data-v-5e01c678><div class="help-title" data-v-5e01c678>ğŸ–±ï¸ é¼ æ ‡æ“ä½œ</div><div class="help-item" data-v-5e01c678><span class="help-key" data-v-5e01c678>å·¦é”®ç‚¹å‡»æ°”æ³¡</span><span class="help-desc" data-v-5e01c678>é€‰æ‹©æ°”æ³¡</span></div><div class="help-item" data-v-5e01c678><span class="help-key" data-v-5e01c678>Shift+å·¦é”®ç‚¹å‡»</span><span class="help-desc" data-v-5e01c678>å¤šé€‰æ°”æ³¡</span></div><div class="help-item" data-v-5e01c678><span class="help-key" data-v-5e01c678>å·¦é”®æ‹–æ‹½å››è§’/è¾¹</span><span class="help-desc" data-v-5e01c678>è°ƒæ•´å¤§å°</span></div><div class="help-item" data-v-5e01c678><span class="help-key" data-v-5e01c678>å·¦é”®æ‹–æ‹½æ¡†å†…éƒ¨</span><span class="help-desc" data-v-5e01c678>ç§»åŠ¨æ°”æ³¡æ¡†</span></div><div class="help-item" data-v-5e01c678><span class="help-key" data-v-5e01c678>ä¸­é”®æ‹–æ‹½</span><span class="help-desc" data-v-5e01c678>ç»˜åˆ¶æ–°æ°”æ³¡æ¡†</span></div></div><div class="help-section" data-v-5e01c678><div class="help-title" data-v-5e01c678>âŒ¨ï¸ å¿«æ·é”®</div><div class="help-item" data-v-5e01c678><span class="help-key" data-v-5e01c678>A / D</span><span class="help-desc" data-v-5e01c678>åˆ‡æ¢ä¸Š/ä¸‹ä¸€å¼ å›¾ç‰‡</span></div><div class="help-item" data-v-5e01c678><span class="help-key" data-v-5e01c678>Ctrl+Enter</span><span class="help-desc" data-v-5e01c678>åº”ç”¨å¹¶è·³è½¬ä¸‹ä¸€å¼ </span></div><div class="help-item" data-v-5e01c678><span class="help-key" data-v-5e01c678>Delete / Backspace</span><span class="help-desc" data-v-5e01c678>åˆ é™¤é€‰ä¸­æ°”æ³¡</span></div><div class="help-item" data-v-5e01c678><span class="help-key" data-v-5e01c678>æŒ‰ä½R+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-5e01c678>ä¿®å¤ç¬”åˆ·</span></div><div class="help-item" data-v-5e01c678><span class="help-key" data-v-5e01c678>æŒ‰ä½U+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-5e01c678>è¿˜åŸç¬”åˆ·</span></div><div class="help-item" data-v-5e01c678><span class="help-key" data-v-5e01c678>ç¬”åˆ·æ¨¡å¼ä¸‹æ»šè½®</span><span class="help-desc" data-v-5e01c678>è°ƒæ•´ç¬”åˆ·å¤§å°</span></div></div></div></div>',1))]),n.brushMode?(E(),L("div",{key:0,class:"brush-cursor",style:ot(g.value)},null,4)):ce("",!0),n.brushMode?(E(),L("div",Wf,ee(n.brushMode==="repair"?"ä¿®å¤ç¬”åˆ· (R)":"è¿˜åŸç¬”åˆ· (U)")+" - æ»šè½®è°ƒæ•´å¤§å° ",1)):ce("",!0),n.isProcessing?(E(),L("div",{key:2,class:Re(["edit-progress-container",{completed:x.value}])},[e("div",Kf,[e("span",qf,ee(n.progressText),1),e("span",Hf,ee(n.progressCurrent)+"/"+ee(n.progressTotal),1)]),e("div",jf,[e("div",{class:Re(["edit-progress-fill",{animating:!x.value}]),style:ot({width:r.value+"%"})},null,6)])],2)):ce("",!0),c[48]||(c[48]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",Jf,[e("button",{class:"primary-btn",onClick:c[23]||(c[23]=C=>i.$emit("apply-and-next")),title:"åº”ç”¨æ›´æ”¹å¹¶è·³è½¬ä¸‹ä¸€å¼  (Ctrl+Enter)"}," åº”ç”¨å¹¶ä¸‹ä¸€å¼  ")])]),_e(Yn,{modelValue:s.value,"onUpdate:modelValue":c[24]||(c[24]=C=>s.value=C),"initial-tab":o.value,onSave:l},null,8,["modelValue","initial-tab"])]))}}),Yf=Je(Gf,[["__scopeId","data-v-5e01c678"]]),Xf={key:0,class:"edit-thumbnails-panel"},Zf={class:"thumbnails-scroll"},Qf=["onClick"],eb=["src","alt"],tb={class:"thumb-index"},ob=Ge({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(n){return(t,s)=>n.visible?(E(),L("div",Xf,[e("div",Zf,[(E(!0),L(ze,null,Ye(n.images,(o,a)=>(E(),L("div",{key:o.id,class:Re(["edit-thumbnail-item",{active:a===n.currentImageIndex}]),onClick:l=>t.$emit("switch-to-image",a)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`å›¾ç‰‡ ${a+1}`},null,8,eb),e("span",tb,ee(a+1),1)],10,Qf))),128))])])):ce("",!0)}}),nb=Je(ob,[["__scopeId","data-v-9d2a43d9"]]),sb=["data-brush-mode"],ab={class:"edit-main-layout"},lb={class:"image-comparison-container"},ib={class:"panel-header"},rb=["src"],ub={class:"panel-header"},cb=["src"],db=Ge({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(n,{emit:t}){const s=n,o=t,a=Ze(),l=gt(),{translateWithCurrentBubbles:r}=Eo(),{reRenderFullImage:x}=sv({onRenderStart:()=>console.log("å¼€å§‹é‡æ–°æ¸²æŸ“..."),onRenderSuccess:q=>console.log("æ¸²æŸ“æˆåŠŸ:",q.substring(0,50)+"..."),onRenderError:q=>console.error("æ¸²æŸ“å¤±è´¥:",q)}),{isDrawingMode:g,isDrawingBox:i,currentDrawingRect:c,isMiddleButtonDown:C,handleBubbleSelect:$,handleBubbleMultiSelect:R,handleClearMultiSelect:k,handleBubbleDragStart:D,handleBubbleDragging:N,handleBubbleDragEnd:B,handleBubbleResizeStart:A,handleBubbleResizing:h,handleBubbleResizeEnd:p,handleBubbleRotateStart:T,handleBubbleRotating:S,handleBubbleRotateEnd:F,toggleDrawingMode:O,handleDrawBubble:te,getDrawingRectStyle:j,handleBubbleUpdate:se,deleteSelectedBubbles:U,repairSelectedBubble:Z,handleOcrRecognize:ae}=nv({onReRender:()=>x(),onDelayedPreview:()=>x()}),Y=w(0),v=w(0),{brushMode:m,brushSize:b,mouseX:f,mouseY:u,isBrushKeyDown:y,toggleBrushMode:I,exitBrushMode:M,startBrushPainting:V,continueBrushPainting:G,finishBrushPainting:d,adjustBrushSize:_}=tv({onBrushComplete:()=>x(),getCurrentRepairSettings:()=>({inpaintMethod:K.value,fillColor:le.value})}),{images:ie,currentImageIndex:z,currentImage:X,imageCount:pe,canGoPrevious:Ce,canGoNext:ke}=yt(a),{bubbles:$e,selectedIndex:Me,selectedIndices:re,selectedBubble:P,bubbleCount:Q,hasBubbles:he,hasSelection:me}=yt(l),xe=J(()=>X.value?.width||0),W=J(()=>X.value?.height||0);function ne(){const q=Be.value?.querySelector("img");q&&q.naturalWidth>0&&q.naturalHeight>0&&a.updateCurrentImageDimensions(q.naturalWidth,q.naturalHeight)}const ve=w(null),fe=w(null),Be=w(null),Ne=w(null),Ue=w(null),we=w(null),Le=w("dual"),Ie=w("horizontal"),tt=w(!1),qe=w(!0),lt=w(!1),Te=w(!1),K=w("solid"),le=w("#FFFFFF"),be=w(!1),Ke=w("å¤„ç†ä¸­..."),rt=w(0),Kt=w(0),Rt=w(!1),Dt=w(!1),Mt=w(!1),st=wn(),Qe=wn(),Bt=J(()=>Qe.scale.value),At=J(()=>Qe.translateX.value),at=J(()=>Qe.translateY.value),Zn=J(()=>st.scale.value),bt=w(null),Qn=J(()=>({transform:`translate(${st.translateX.value}px, ${st.translateY.value}px) scale(${st.scale.value})`})),es=J(()=>({transform:`translate(${Qe.translateX.value}px, ${Qe.translateY.value}px) scale(${Qe.scale.value})`}));function Lo(){Qe.zoomIn(),qe.value&&st.setTransform(Qe.getTransform())}function Fo(){Qe.zoomOut(),qe.value&&st.setTransform(Qe.getTransform())}function Uo(){Qe.resetZoom(),qe.value&&st.setTransform(Qe.getTransform())}const to=w(!1),ts=w(0),oo=w(!1),Et=w({x:0,y:0,size:0});function no(){m.value&&M(),lo()}function so(){l.bubbles.length>0&&l.selectBubble(0)}function Oo(){Ce.value&&(no(),a.goToPrevious())}function ao(){ke.value&&(no(),a.goToNext())}function os(q){q!==z.value&&q>=0&&q<pe.value&&(no(),a.setCurrentImageIndex(q))}function lo(){if(!X.value)return;const q=Array.isArray(X.value.bubbleStates);$e.value.length>0?(a.updateCurrentBubbleStates([...$e.value]),a.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜æ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨")):q&&(a.updateCurrentBubbleStates([]),a.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜ç©ºæ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸»åŠ¨æ¸…ç©ºï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨ï¼‰"))}function Lt(){X.value?.bubbleStates?(l.setBubbles([...X.value.bubbleStates],!0),console.log(`å·²åŠ è½½ ${X.value.bubbleStates.length} ä¸ªæ°”æ³¡çŠ¶æ€`)):l.clearBubblesLocal(),so()}function ns(){l.selectPrevious()}function ss(){l.selectNext()}function as(){tt.value=!tt.value}function ls(){Ie.value=Ie.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(cn,Ie.value)}catch(q){console.warn("ä¿å­˜å¸ƒå±€æ¨¡å¼å¤±è´¥:",q)}setTimeout(()=>{Ct()},300)}function is(){const q=["dual","original","translated"],ue=q.indexOf(Le.value),de=q[(ue+1)%q.length];de&&(Le.value=de)}function rs(){qe.value=!qe.value,console.log("åŒå›¾åŒæ­¥:",qe.value?"å¼€å¯":"å…³é—­"),qe.value&&st.setTransform(Qe.getTransform())}function Ct(){const q=Ne.value||fe.value,ue=Ue.value||Be.value;if(!q||!ue)return;const de=ue.querySelector("img");if(!de||!de.naturalWidth)return;const Ae=q.getBoundingClientRect(),De=Ae.width/de.naturalWidth,Ee=Ae.height/de.naturalHeight,Ve=Math.min(De,Ee)*.95,je=(Ae.width-de.naturalWidth*Ve)/2,ht=(Ae.height-de.naturalHeight*Ve)/2,_t={scale:Ve,translateX:je,translateY:ht};Qe.setTransform(_t),st.setTransform(_t)}function zo(q,ue){if(m.value){const je=q.deltaY>0?-5:5;_(je);return}const de=q.currentTarget.getBoundingClientRect(),Ae=q.clientX-de.left,De=q.clientY-de.top,Ee=q.deltaY>0?.9:1.1,Ve=ue==="original"?st:Qe;Ve.zoomAt(Ae,De,Ee),qe.value&&(ue==="original"?Qe:st).setTransform(Ve.getTransform())}function No(q,ue){if(m.value){const de=ue==="original"?fe.value:Ne.value;de&&V(q,de);return}if(q.button===1){C.value=!0,Ko(q,ue),q.preventDefault();return}if(g.value&&q.button===0){Ko(q,ue),q.preventDefault();return}if(q.button===0){if(q.target.closest(".bubble-highlight-box"))return;q.shiftKey||k(),bt.value=ue,(ue==="original"?st:Qe).startDrag(q.clientX,q.clientY),document.addEventListener("mousemove",Vo),document.addEventListener("mouseup",Wo),q.preventDefault()}}function Vo(q){if(!bt.value)return;const ue=bt.value==="original"?st:Qe;ue.drag(q.clientX,q.clientY),qe.value&&(bt.value==="original"?Qe:st).setTransform(ue.getTransform())}function Wo(){bt.value&&(bt.value==="original"?st:Qe).endDrag(),bt.value=null,document.removeEventListener("mousemove",Vo),document.removeEventListener("mouseup",Wo)}let io="translated";function Ko(q,ue="translated"){io=ue;const de=ue==="original"?Be.value:Ue.value,Ae=ue==="original"?st:Qe;if(!de)return;const De=de.getBoundingClientRect(),Ee=(q.clientX-De.left)/Ae.scale.value,Ve=(q.clientY-De.top)/Ae.scale.value;Y.value=Ee,v.value=Ve,i.value=!0,c.value=[Ee,Ve,Ee,Ve],document.addEventListener("mousemove",ro),document.addEventListener("mouseup",uo)}function ro(q){if(!i.value)return;const ue=io==="original"?Be.value:Ue.value,de=io==="original"?st:Qe;if(!ue)return;const Ae=ue.getBoundingClientRect(),De=(q.clientX-Ae.left)/de.scale.value,Ee=(q.clientY-Ae.top)/de.scale.value;c.value=[Math.min(Y.value,De),Math.min(v.value,Ee),Math.max(Y.value,De),Math.max(v.value,Ee)]}function uo(q){document.removeEventListener("mousemove",ro),document.removeEventListener("mouseup",uo);const ue=C.value;if(!i.value||!c.value){i.value=!1,c.value=null,C.value=!1;return}const[de,Ae,De,Ee]=c.value,Ve=De-de,je=Ee-Ae;Ve>10&&je>10&&(l.addBubble(c.value),l.selectBubble(l.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",c.value)),i.value=!1,c.value=null,C.value=!1,!ue&&g.value&&(g.value=!1)}function qo(q){const de=(q==="original"?Be:Ue).value?.querySelector("img"),Ae=de?.naturalWidth||0,De=de?.naturalHeight||0;console.log(`[EditWorkspace] ${q} å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå°ºå¯¸: ${Ae}x${De}`),q==="original"&&ne();const Ee=Bt.value===1&&At.value===0&&at.value===0,Ve=Ae>3840||De>2160;q==="original"&&(Ee||Ve)&&(Ve&&console.log("[EditWorkspace] æ£€æµ‹åˆ°å¤§å›¾ï¼ˆè¶…è¿‡4Kï¼‰ï¼Œè‡ªåŠ¨é€‚åº”å±å¹•"),pt(()=>{setTimeout(()=>{Ct()},50)}))}function us(){x()}function cs(q){q.inpaintMethod!==void 0&&(K.value=q.inpaintMethod),q.fillColor!==void 0&&(le.value=q.fillColor),Me.value>=0&&se(q)}function ds(q){ye("æ–‡æœ¬å·²åº”ç”¨","success"),x()}function gs(q){const ue=l.initialStates[q];if(!ue){console.warn(`æ— æ³•é‡ç½®æ°”æ³¡ #${q+1}ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€`),ye("æ— æ³•é‡ç½®ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€","warning");return}const de=JSON.parse(JSON.stringify(ue));l.updateBubble(q,de),console.log(`æ°”æ³¡ #${q+1} å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€`),ye("æ°”æ³¡å·²é‡ç½®","success"),x()}async function ps(q){Rt.value=!0;try{await ae(q)}finally{Rt.value=!1}}async function ms(){Mt.value=!0;try{await Z()}finally{Mt.value=!1}}async function vs(q){const ue=$e.value[q];if(!ue?.originalText){console.warn("æ— æ³•é‡æ–°ç¿»è¯‘ï¼šç¼ºå°‘æ°”æ³¡æˆ–åŸæ–‡");return}Dt.value=!0;try{console.log(`å¼€å§‹é‡æ–°ç¿»è¯‘æ°”æ³¡ #${q+1}`);const{translateSingleText:de}=await it(async()=>{const{translateSingleText:je}=await Promise.resolve().then(()=>Qs);return{translateSingleText:je}},void 0),{useSettingsStore:Ae}=await it(async()=>{const{useSettingsStore:je}=await Promise.resolve().then(()=>xo);return{useSettingsStore:je}},void 0),De=Ae().settings,Ee=De.translation.isJsonMode?De.translation.singleJsonPrompt:De.translation.singleNormalPrompt,Ve=await de({original_text:ue.originalText,model_provider:De.translation.provider,api_key:De.translation.apiKey,model_name:De.translation.modelName,custom_base_url:De.translation.customBaseUrl,target_language:De.targetLanguage,prompt_content:Ee,use_json_format:De.translation.isJsonMode,rpm_limit_translation:De.translation.rpmLimit,max_retries:De.translation.maxRetries});Ve.success&&Ve.data?.translated_text?(l.updateBubble(q,{translatedText:Ve.data.translated_text}),console.log(`ç¿»è¯‘æˆåŠŸ: "${Ve.data.translated_text}"`),x()):console.error("ç¿»è¯‘å¤±è´¥:",Ve.error||"æœªçŸ¥é”™è¯¯")}catch(de){console.error("ç¿»è¯‘å‡ºé”™:",de)}finally{Dt.value=!1}}function Ho(q,ue){for(q.bubbleTexts||(q.bubbleTexts=[]),q.originalTexts||(q.originalTexts=[]);q.bubbleTexts.length<ue;)q.bubbleTexts.push("");for(;q.originalTexts.length<ue;)q.originalTexts.push("")}function jo(q,ue,de){const Ae=q.auto_directions||[];return q.bubble_coords.map((De,Ee)=>{const Ve=De[0]??0,je=De[1]??0,ht=De[2]??0,_t=De[3]??0;let kt;return Ae[Ee]?kt=Ae[Ee]==="v"?"vertical":"horizontal":kt=_t-je>ht-Ve?"vertical":"horizontal",{coords:De,originalText:ue.originalTexts?.[Ee]||"",translatedText:ue.bubbleTexts?.[Ee]||"",textboxText:"",fontSize:de.fontSize,fontFamily:de.fontFamily,textDirection:kt,autoTextDirection:kt,textColor:de.textColor,fillColor:de.fillColor,strokeEnabled:de.strokeEnabled,strokeColor:de.strokeColor,strokeWidth:de.strokeWidth,rotationAngle:q.bubble_angles?.[Ee]||0,inpaintMethod:de.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function fs(){const q=X.value;if(!q?.originalDataURL){ye("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºæ£€æµ‹","warning");return}try{ye("æ­£åœ¨è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ¡†...","info");const ue=Fe(),{textStyle:de}=ue.settings,Ae=await zt({imageIndex:z.value,image:q,forceDetect:!0});if(Ae.bubbleCoords.length>0){yo(z.value,Ae),Ho(q,Ae.bubbleCoords.length);const De={bubble_coords:Ae.bubbleCoords,bubble_angles:Ae.bubbleAngles,auto_directions:Ae.autoDirections},Ee=jo(De,q,de);l.setBubbles(Ee),so(),ye(`è‡ªåŠ¨æ£€æµ‹åˆ° ${Ae.bubbleCoords.length} ä¸ªæ–‡æœ¬æ¡†`,"success")}else ye("æœªæ£€æµ‹åˆ°æ–‡æœ¬æ¡†","info")}catch(ue){console.error("è‡ªåŠ¨æ£€æµ‹å¤±è´¥:",ue),ye("è‡ªåŠ¨æ£€æµ‹å¤±è´¥","error")}}async function bs(){if(ie.value.length<=1){ye("è‡³å°‘éœ€è¦ä¸¤å¼ å›¾ç‰‡æ‰èƒ½æ‰§è¡Œæ‰¹é‡æ£€æµ‹","warning");return}if(!confirm("æ­¤æ“ä½œå°†å¯¹æ‰€æœ‰å›¾ç‰‡è¿›è¡Œæ–‡æœ¬æ¡†æ£€æµ‹ï¼Œå¯èƒ½ä¼šè¦†ç›–å·²æœ‰çš„æ£€æµ‹ç»“æœã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ"))return;const q=Fe(),{textStyle:ue}=q.settings,de=z.value,Ae=ie.value.length;be.value=!0,Ke.value="æ‰¹é‡æ£€æµ‹ä¸­",Kt.value=Ae,rt.value=0;try{let De=0;for(let Ee=0;Ee<Ae;Ee++){const Ve=ie.value[Ee];if(Ve?.originalDataURL){rt.value=Ee+1;try{const je=await zt({imageIndex:Ee,image:Ve,forceDetect:!0});if(je.bubbleCoords.length>0){const ht=ie.value[Ee];if(ht){Ho(ht,je.bubbleCoords.length);const _t={bubble_coords:je.bubbleCoords,bubble_angles:je.bubbleAngles,auto_directions:je.autoDirections},kt=jo(_t,ht,ue);yo(Ee,je,{updateBubbleStates:!0,bubbleStates:kt}),De+=je.bubbleCoords.length,Ee===z.value&&Lt()}}}catch(je){console.error(`å›¾ç‰‡ ${Ee+1} æ£€æµ‹å¤±è´¥:`,je)}}}Ke.value="æ£€æµ‹å®Œæˆ",rt.value=Ae,de!==z.value&&a.setCurrentImageIndex(de),Lt(),ye(`æ‰¹é‡æ£€æµ‹å®Œæˆï¼å…±å¤„ç† ${Ae} å¼ å›¾ç‰‡ï¼Œæ£€æµ‹åˆ° ${De} ä¸ªæ–‡æœ¬æ¡†`,"success"),setTimeout(()=>{be.value=!1},2e3)}catch(De){console.error("æ‰¹é‡æ£€æµ‹å¤±è´¥:",De),ye("æ‰¹é‡æ£€æµ‹å¤±è´¥","error"),be.value=!1}}async function hs(){if(!X.value?.originalDataURL){ye("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºç¿»è¯‘","warning");return}if($e.value.length===0){ye("æ²¡æœ‰æ–‡æœ¬æ¡†å¯ç”¨äºç¿»è¯‘ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ·»åŠ æ–‡æœ¬æ¡†","warning");return}ye("æ­£åœ¨ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘...","info");try{await r()&&(ye("ç¿»è¯‘æˆåŠŸï¼","success"),so())}catch(ue){console.error("ç¿»è¯‘å¤±è´¥:",ue),ye(`ç¿»è¯‘å¤±è´¥: ${ue instanceof Error?ue.message:"æœªçŸ¥é”™è¯¯"}`,"error")}}function xs(){I("repair")}function ys(){I("restore")}function Jo(q){G(q)}function Go(){d()}function Cs(q){to.value=!0,ts.value=Ie.value==="horizontal"?q.clientX:q.clientY,document.body.style.cursor=Ie.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",co),document.addEventListener("mouseup",go),q.preventDefault()}function co(q){if(!to.value)return;const ue=fe.value?.parentElement?.parentElement;if(!ue)return;const de=ue.getBoundingClientRect();if(Ie.value==="horizontal"){const Ae=q.clientX-de.left,De=de.width,Ee=Math.max(20,Math.min(80,Ae/De*100)),Ve=ue.querySelector(".original-panel"),je=ue.querySelector(".translated-panel");Ve&&je&&(Ve.style.flex=`0 0 ${Ee}%`,je.style.flex=`0 0 ${100-Ee}%`)}else{const Ae=q.clientY-de.top,De=de.height,Ee=Math.max(20,Math.min(80,Ae/De*100)),Ve=ue.querySelector(".original-panel"),je=ue.querySelector(".translated-panel");Ve&&je&&(Ve.style.flex=`0 0 ${Ee}%`,je.style.flex=`0 0 ${100-Ee}%`)}}function go(){to.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",co),document.removeEventListener("mouseup",go)}function _s(q){oo.value=!0;const ue=we.value;ue&&(Et.value={x:q.clientX,y:q.clientY,size:Ie.value==="horizontal"?ue.offsetWidth:ue.offsetHeight},document.body.style.cursor=Ie.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",po),document.addEventListener("mouseup",mo),q.preventDefault())}function po(q){if(!(!oo.value||!we.value))if(Ie.value==="horizontal"){const ue=Et.value.x-q.clientX;let de=Et.value.size+ue;de=Math.max(300,Math.min(window.innerWidth*.6,de)),we.value.style.flex=`0 0 ${de}px`,we.value.style.minWidth=`${de}px`}else{const ue=Et.value.y-q.clientY;let de=Et.value.size+ue;de=Math.max(200,Math.min(window.innerHeight*.5,de)),we.value.style.flex=`0 0 ${de}px`,we.value.style.height=`${de}px`}}function mo(){oo.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",po),document.removeEventListener("mouseup",mo)}function Yo(q){const ue=q.target,de=q.key.toLowerCase();if(de==="r"||de==="u"||de==="a"||de==="d"){if(ue.tagName==="TEXTAREA")return;(ue.tagName==="INPUT"||ue.tagName==="SELECT"||ue.tagName==="BUTTON")&&ue.blur()}else if(ue.tagName==="INPUT"||ue.tagName==="TEXTAREA"||ue.tagName==="SELECT")return;switch(q.key){case"Escape":Qo();break;case"Delete":case"Backspace":!m.value&&me.value&&(U(),q.preventDefault());break;case"a":case"A":m.value||(Oo(),q.preventDefault());break;case"d":case"D":m.value||(ao(),q.preventDefault());break;case"Enter":q.ctrlKey&&!m.value&&(Zo(),q.preventDefault());break;case"r":case"R":y.value||(I("repair"),q.preventDefault());break;case"u":case"U":y.value||(I("restore"),q.preventDefault());break;case"+":case"=":Lo(),q.preventDefault();break;case"-":Fo(),q.preventDefault();break;case"0":Uo(),q.preventDefault();break}}function Xo(q){(q.key==="r"||q.key==="R"||q.key==="u"||q.key==="U")&&(M(),q.preventDefault())}async function Zo(){lo(),await x(),ke.value?ao():ye("å·²æ˜¯æœ€åä¸€å¼ å›¾ç‰‡","info")}function Qo(){lo(),o("exit")}return Bs((q,ue,de)=>{console.error("[EditWorkspace] æ•è·åˆ°é”™è¯¯:",q,de);const Ae=q instanceof Error?q.message:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•";return ye(Ae,"error"),!1}),dt(()=>{try{const q=localStorage.getItem(cn);(q==="horizontal"||q==="vertical")&&(Ie.value=q)}catch(q){console.warn("åŠ è½½å¸ƒå±€æ¨¡å¼å¤±è´¥:",q)}document.addEventListener("keydown",Yo),document.addEventListener("keyup",Xo),document.addEventListener("mousemove",Jo),document.addEventListener("mouseup",Go),s.isEditModeActive&&(Lt(),pt(()=>{ve.value?.focus()}))}),Wt(()=>{document.removeEventListener("keydown",Yo),document.removeEventListener("keyup",Xo),document.removeEventListener("mousemove",Jo),document.removeEventListener("mouseup",Go),document.removeEventListener("mousemove",ro),document.removeEventListener("mouseup",uo),document.removeEventListener("mousemove",co),document.removeEventListener("mouseup",go),document.removeEventListener("mousemove",po),document.removeEventListener("mouseup",mo)}),Se(()=>s.isEditModeActive,q=>{q&&(Lt(),pt(()=>{ve.value?.focus(),ne(),setTimeout(()=>{Ct()},100)}))}),Se(z,()=>{s.isEditModeActive&&Lt()}),Se(P,q=>{q&&(K.value=q.inpaintMethod||"solid",le.value=q.fillColor||"#FFFFFF")},{immediate:!0}),(q,ue)=>n.isEditModeActive?(E(),L("div",{key:0,class:Re(["edit-workspace",[`layout-${Ie.value}`,{"drawing-mode":H(g)},{"brush-mode-active":!!H(m)}]]),"data-brush-mode":H(m)||void 0,tabindex:"0",ref_key:"workspaceRef",ref:ve},[_e(Yf,{"current-image-index":H(z),"image-count":H(pe),"can-go-previous":H(Ce),"can-go-next":H(ke),"show-thumbnails":tt.value,"has-bubbles":H(he),"selected-bubble-index":H(Me),"bubble-count":H(Q),"layout-mode":Ie.value,"sync-enabled":qe.value,scale:Bt.value,"is-drawing-mode":H(g),"has-selection":H(me),"brush-mode":H(m),"brush-size":H(b),"mouse-x":H(f),"mouse-y":H(u),"is-processing":be.value,"progress-text":Ke.value,"progress-current":rt.value,"progress-total":Kt.value,"is-repair-loading":Mt.value,onGoPreviousImage:Oo,onGoNextImage:ao,onToggleThumbnails:as,onSelectPreviousBubble:ns,onSelectNextBubble:ss,onToggleLayout:ls,onToggleViewMode:is,onToggleSync:rs,onFitToScreen:Ct,onZoomIn:Lo,onZoomOut:Fo,onResetZoom:Uo,onExitEditMode:Qo,onAutoDetectBubbles:fs,onDetectAllImages:bs,onTranslateWithBubbles:hs,onToggleDrawingMode:H(O),onDeleteSelectedBubbles:H(U),onRepairSelectedBubble:ms,onActivateRepairBrush:xs,onActivateRestoreBrush:ys,onApplyAndNext:Zo},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","is-repair-loading","onToggleDrawingMode","onDeleteSelectedBubbles"]),_e(nb,{visible:tt.value,images:H(ie),"current-image-index":H(z),onSwitchToImage:os},null,8,["visible","images","current-image-index"]),e("div",ab,[e("div",lb,[oe(e("div",{class:Re(["image-panel original-panel",{collapsed:Le.value==="translated"||lt.value}])},[e("div",ib,[ue[8]||(ue[8]=e("span",{class:"panel-title"},"ğŸ“– åŸå›¾ (æ—¥æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[0]||(ue[0]=de=>lt.value=!lt.value),title:"æŠ˜å /å±•å¼€"},ee(lt.value?"+":"âˆ’"),1)]),e("div",{ref_key:"originalViewportRef",ref:fe,class:"image-viewport",onWheel:ue[2]||(ue[2]=nt(de=>zo(de,"original"),["prevent"])),onMousedown:ue[3]||(ue[3]=de=>No(de,"original")),onDblclick:Ct},[e("div",{ref_key:"originalWrapperRef",ref:Be,class:"image-canvas-wrapper",style:ot(Qn.value)},[H(X)?.originalDataURL?(E(),L("img",{key:0,src:H(X).originalDataURL,alt:"åŸå›¾",onLoad:ue[1]||(ue[1]=de=>qo("original"))},null,40,rb)):ce("",!0),H(X)?.originalDataURL?(E(),ut(Tn,{key:1,bubbles:H($e),"selected-index":H(Me),"selected-indices":H(re),scale:Zn.value,"is-drawing-mode":H(g),"is-brush-mode":!!H(m),"image-width":xe.value,"image-height":W.value,onSelect:H($),onMultiSelect:H(R),onDragStart:H(D),onDragging:H(N),onDragEnd:H(B),onResizeStart:H(A),onResizing:H(h),onResizeEnd:H(p),onRotateStart:H(T),onRotating:H(S),onRotateEnd:H(F),onDrawBubble:H(te)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):ce("",!0),H(c)?(E(),L("div",{key:2,class:"drawing-rect-edit",style:ot(H(j)())},null,4)):ce("",!0)],4)],544)],2),[[Oe,Le.value!=="translated"]]),Le.value==="dual"?(E(),L("div",{key:0,class:Re(["panel-divider",{"vertical-divider":Ie.value==="vertical"}]),onMousedown:Cs},null,34)):ce("",!0),oe(e("div",{class:Re(["image-panel translated-panel",{collapsed:Le.value==="original"||Te.value}])},[e("div",ub,[ue[9]||(ue[9]=e("span",{class:"panel-title"},"ğŸ“ ç¿»è¯‘å›¾ (ä¸­æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[4]||(ue[4]=de=>Te.value=!Te.value),title:"æŠ˜å /å±•å¼€"},ee(Te.value?"+":"âˆ’"),1)]),e("div",{ref_key:"translatedViewportRef",ref:Ne,class:"image-viewport",onWheel:ue[6]||(ue[6]=nt(de=>zo(de,"translated"),["prevent"])),onMousedown:ue[7]||(ue[7]=de=>No(de,"translated")),onDblclick:Ct},[e("div",{ref_key:"translatedWrapperRef",ref:Ue,class:"image-canvas-wrapper",style:ot(es.value)},[H(X)?.translatedDataURL||H(X)?.originalDataURL?(E(),L("img",{key:0,src:H(X)?.translatedDataURL||H(X)?.originalDataURL,alt:"ç¿»è¯‘å›¾",onLoad:ue[5]||(ue[5]=de=>qo("translated"))},null,40,cb)):ce("",!0),H(X)?.translatedDataURL||H(X)?.originalDataURL?(E(),ut(Tn,{key:1,bubbles:H($e),"selected-index":H(Me),"selected-indices":H(re),scale:Bt.value,"is-drawing-mode":H(g),"is-brush-mode":!!H(m),"image-width":xe.value,"image-height":W.value,onSelect:H($),onMultiSelect:H(R),onDragStart:H(D),onDragging:H(N),onDragEnd:H(B),onResizeStart:H(A),onResizing:H(h),onResizeEnd:H(p),onRotateStart:H(T),onRotating:H(S),onRotateEnd:H(F),onDrawBubble:H(te)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):ce("",!0),H(c)?(E(),L("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:ot(H(j)())},null,4)):ce("",!0)],4)],544)],2),[[Oe,Le.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:we,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:_s}," â‹®â‹®â‹® ",32),_e(_f,{bubble:H(P),"bubble-index":H(Me),"is-ocr-loading":Rt.value,"is-translate-loading":Dt.value,onUpdate:cs,onReRender:us,onOcrRecognize:ps,onReTranslate:vs,onApplyBubble:ds,onResetCurrent:gs},null,8,["bubble","bubble-index","is-ocr-loading","is-translate-loading"])],512)])],10,sb)):ce("",!0)}}),gb=Je(db,[["__scopeId","data-v-5c6291e0"]]),Pt="/api/web-import";async function pb(n){return(await fetch(`${Pt}/check-support?url=${encodeURIComponent(n)}`)).json()}async function mb(){return(await fetch(`${Pt}/gallery-dl-images`)).json()}async function vb(n,t,s,o,a,l="auto",r){const x=await fetch(`${Pt}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n,config:t,engine:l})});if(!x.ok){const C=await x.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));a(C.error||`HTTP ${x.status}`);return}const g=x.body?.getReader();if(!g){a("æ— æ³•è¯»å–å“åº”æµ");return}const i=new TextDecoder;let c="";try{for(;;){const{done:C,value:$}=await g.read();if(C)break;c+=i.decode($,{stream:!0});const R=c.split(`
`);c=R.pop()||"";let k="",D="";for(const N of R)if(N.startsWith("event:"))k=N.slice(6).trim();else if(N.startsWith("data:"))D=N.slice(5).trim();else if(N===""&&k&&D){try{const B=JSON.parse(D);k==="log"?s(B):k==="page"?r&&r(B):k==="result"?o(B):k==="error"&&a(B.error||"æœªçŸ¥é”™è¯¯")}catch(B){console.error("è§£æ SSE æ•°æ®å¤±è´¥:",B)}k="",D=""}}}finally{g.releaseLock()}}async function fb(n,t,s,o="ai-agent"){const a=await fetch(`${Pt}/download`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pages:n,sourceUrl:t,config:s,engine:o})});if(!a.ok){const l=await a.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));throw new Error(l.error||`HTTP ${a.status}`)}return a.json()}async function bb(n){return(await fetch(`${Pt}/test-firecrawl`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:n})})).json()}async function hb(n,t,s,o){return(await fetch(`${Pt}/test-agent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider:n,apiKey:t,customBaseUrl:s,modelName:o})})).json()}const xb={class:"modal-container"},yb={class:"modal-body"},Cb={class:"url-section"},_b=["disabled"],kb=["disabled"],Sb=["disabled"],wb={key:0,class:"loading-spinner"},$b={key:1},Tb={key:0,class:"engine-hint"},Ib={key:0,class:"hint-checking"},Pb={key:1,class:"hint-supported"},Rb={key:2,class:"hint-unsupported"},Db={class:"settings-section"},Mb={class:"settings-toggle"},Bb={key:0,class:"settings-content"},Ab={class:"settings-tabs"},Eb={class:"settings-tab-content"},Lb={class:"settings-group"},Fb={class:"form-row"},Ub={class:"input-group"},Ob=["type","value"],zb=["disabled"],Nb={class:"settings-group"},Vb={class:"form-row"},Wb=["value"],Kb=["value"],qb={class:"form-row"},Hb={class:"input-group"},jb=["type","value"],Jb={key:0,class:"form-row"},Gb=["value"],Yb={class:"form-row"},Xb=["value"],Zb={class:"form-row inline"},Qb={class:"checkbox-label"},eh=["checked"],th={class:"checkbox-label"},oh=["checked"],nh={class:"form-row"},sh=["disabled"],ah={class:"settings-group"},lh={class:"form-row"},ih=["value"],rh={class:"form-row"},uh=["value"],ch={class:"settings-group"},dh={class:"form-grid"},gh={class:"form-row"},ph=["value"],mh={class:"form-row"},vh=["value"],fh={class:"form-row"},bh=["value"],hh={class:"form-row"},xh=["value"],yh={class:"form-row"},Ch={class:"checkbox-label"},_h=["checked"],kh={class:"settings-group"},Sh={class:"form-row inline"},wh={class:"checkbox-label"},$h=["checked"],Th={class:"checkbox-label"},Ih=["checked"],Ph={class:"settings-tab-content"},Rh={class:"settings-group"},Dh={class:"form-row"},Mh={class:"checkbox-label"},Bh=["checked"],Ah={class:"form-row"},Eh={class:"checkbox-label"},Lh=["checked"],Fh={class:"form-row"},Uh={class:"checkbox-label"},Oh=["checked"],zh={key:0,class:"form-grid"},Nh={class:"form-row"},Vh=["value"],Wh={class:"form-row"},Kh=["value"],qh={class:"form-row"},Hh=["value"],jh={class:"form-row"},Jh={class:"checkbox-label"},Gh=["checked"],Yh={key:1,class:"form-row"},Xh=["value"],Zh={class:"settings-tab-content"},Qh={class:"settings-group"},ex={class:"form-row"},tx=["value"],ox={class:"form-row"},nx=["value"],sx={class:"form-row"},ax={class:"checkbox-label"},lx=["checked"],ix={key:1,class:"logs-section"},rx={class:"logs-toggle"},ux={key:0,class:"extracting-hint"},cx={key:0,class:"logs-content"},dx={class:"log-time"},gx={class:"log-message"},px={key:2,class:"error-section"},mx={class:"error-message"},vx={key:3,class:"result-section"},fx={class:"result-header"},bx={class:"result-title"},hx={class:"result-meta"},xx={class:"result-count"},yx={key:0,class:"result-engine"},Cx={class:"select-control"},_x={class:"select-all"},kx=["checked"],Sx={class:"selected-count"},wx={class:"image-grid"},$x=["onClick"],Tx={class:"image-checkbox"},Ix=["checked","onChange"],Px={class:"image-preview"},Rx=["src","alt"],Dx={class:"image-label"},Mx={key:4,class:"progress-section"},Bx={class:"progress-label"},Ax={class:"progress-bar"},Ex={class:"modal-footer"},Lx=["disabled"],Fx=["disabled"],Ux={key:0,class:"loading-spinner"},Ox={key:1},zx=Ge({__name:"WebImportModal",setup(n){const t=Io(),s=Ze(),o=w(""),a=w(!0),l=w("auto"),r=w(!1),x=w(!1),g=w(!1),i=w(!1),c=w("basic"),C=w(!1),$=w(!1),R=w(!1),k=w(!1),D=J(()=>t.modalVisible),N=J(()=>t.status),B=J(()=>t.logs),A=J(()=>t.extractResult),h=J(()=>t.selectedPages),p=J(()=>t.selectedCount),T=J(()=>t.downloadProgress),S=J(()=>t.downloadProgressPercent),F=J(()=>t.error),O=J(()=>t.isProcessing),te=J(()=>t.settings.ui.showAgentLogs),j=J(()=>A.value?.engine||null),se=J(()=>{switch(j.value){case"gallery-dl":return"Gallery-DL";case"ai-agent":return"AI Agent";default:return""}}),U=J(()=>A.value?.pages?p.value===A.value.pages.length:!1);function Z(G){return j.value==="gallery-dl",G}let ae=null;async function Y(G){if(ae&&clearTimeout(ae),!G.trim()){r.value=!1,x.value=!1;return}ae=setTimeout(async()=>{g.value=!0;try{const d=await pb(G);r.value=d.available,x.value=d.supported}catch{r.value=!1,x.value=!1}finally{g.value=!1}},500)}function v(){O.value&&!confirm("æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ")||(t.closeModal(),t.resetState(),o.value="")}async function m(){const G=o.value.trim();if(!G){alert("è¯·è¾“å…¥ç½‘å€");return}try{new URL(G)}catch{alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€");return}t.resetState(),t.setUrl(G),t.setStatus("extracting");try{await vb(G,t.settings,d=>{t.addLog(d)},d=>{t.setExtractResult(d),d.success?t.setStatus("extracted"):t.setError(d.error||"æå–å¤±è´¥")},d=>{t.setError(d)},l.value,d=>{t.addPageIncremental(d)})}catch(d){t.setError(d instanceof Error?d.message:"æå–å¤±è´¥")}}function b(G){t.togglePageSelection(G)}function f(){t.toggleSelectAll()}async function u(){if(!A.value?.pages||p.value===0){alert("è¯·é€‰æ‹©è¦å¯¼å…¥çš„å›¾ç‰‡");return}const G=A.value.pages.filter(_=>h.value.has(_.pageNumber));t.setStatus("downloading"),t.updateDownloadProgress(0,G.length);const d=j.value||"ai-agent";try{if(d==="gallery-dl"){const ie=await mb();if(ie.success&&ie.images.length>0){let z=0;const X=Math.min(ie.images.length,G.length);for(let pe=0;pe<X;pe++){const Ce=ie.images[pe];Ce&&Ce.filename&&Ce.data&&(s.addImage(Ce.filename,Ce.data),z++,t.updateDownloadProgress(z,X))}t.setStatus("completed"),alert(`æˆåŠŸå¯¼å…¥ ${z} å¼ å›¾ç‰‡`),v();return}else throw new Error(ie.error||"è·å–å›¾ç‰‡å¤±è´¥")}const _=await fb(G,A.value.sourceUrl,t.settings,d);if(_.success&&_.images.length>0){t.setDownloadedImages(_.images),t.updateDownloadProgress(_.images.length,G.length);for(const z of _.images)s.addImage(z.filename,z.dataUrl);t.setStatus("completed");const ie=_.failedCount>0?`ï¼Œ${_.failedCount} å¼ å¤±è´¥`:"";alert(`æˆåŠŸå¯¼å…¥ ${_.images.length} å¼ å›¾ç‰‡${ie}`),v()}else t.setError(_.error||"ä¸‹è½½å¤±è´¥")}catch(_){t.setError(_ instanceof Error?_.message:"ä¸‹è½½å¤±è´¥")}}Se(D,G=>{G&&setTimeout(()=>{document.querySelector(".url-input")?.focus()},100)}),Se(o,G=>{Y(G)});const y=J(()=>t.settings.agent.provider==="custom_openai");async function I(){if(!t.settings.firecrawl.apiKey){alert("è¯·è¾“å…¥ Firecrawl API Key");return}C.value=!0;try{const G=await bb(t.settings.firecrawl.apiKey);G.success?alert("âœ… Firecrawl è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${G.error}`)}catch(G){alert(`âŒ è¿æ¥å¤±è´¥: ${G instanceof Error?G.message:"æœªçŸ¥é”™è¯¯"}`)}finally{C.value=!1}}async function M(){if(!t.settings.agent.apiKey){alert("è¯·è¾“å…¥ AI Agent API Key");return}$.value=!0;try{const G=await hb(t.settings.agent.provider,t.settings.agent.apiKey,t.settings.agent.customBaseUrl,t.settings.agent.modelName);G.success?alert("âœ… AI Agent è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${G.error}`)}catch(G){alert(`âŒ è¿æ¥å¤±è´¥: ${G instanceof Error?G.message:"æœªçŸ¥é”™è¯¯"}`)}finally{$.value=!1}}function V(){confirm("ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿ")&&t.resetExtractionPrompt()}return(G,d)=>(E(),ut(Mn,{to:"body"},[D.value?(E(),L("div",{key:0,class:"modal-overlay",onClick:nt(v,["self"])},[e("div",xb,[e("div",{class:"modal-header"},[d[37]||(d[37]=e("h2",{class:"modal-title"},[e("span",{class:"title-icon"},"ğŸŒ"),ge(" ä»ç½‘é¡µå¯¼å…¥æ¼«ç”» ")],-1)),e("button",{class:"close-btn",onClick:v,title:"å…³é—­"},"Ã—")]),e("div",yb,[e("div",Cb,[oe(e("input",{"onUpdate:modelValue":d[0]||(d[0]=_=>o.value=_),type:"url",class:"url-input",placeholder:"è¾“å…¥æ¼«ç”»ç½‘é¡µ URLï¼Œå¦‚ https://example.com/chapter-1",disabled:O.value,onKeyup:Dn(m,["enter"])},null,40,_b),[[Pe,o.value]]),oe(e("select",{"onUpdate:modelValue":d[1]||(d[1]=_=>l.value=_),class:"engine-select",disabled:O.value},[...d[38]||(d[38]=[e("option",{value:"auto"},"è‡ªåŠ¨é€‰æ‹©",-1),e("option",{value:"gallery-dl"},"Gallery-DL",-1),e("option",{value:"ai-agent"},"AI Agent",-1)])],8,kb),[[As,l.value]]),e("button",{class:"extract-btn",disabled:O.value||!o.value.trim(),onClick:m},[N.value==="extracting"?(E(),L("span",wb)):(E(),L("span",$b,"ğŸ”")),ge(" "+ee(N.value==="extracting"?"æå–ä¸­...":"å¼€å§‹æå–"),1)],8,Sb)]),o.value.trim()&&!O.value?(E(),L("div",Tb,[g.value?(E(),L("span",Ib,"æ£€æŸ¥ä¸­...")):x.value?(E(),L("span",Pb,"âœ“ è¯¥ç½‘ç«™æ”¯æŒ Gallery-DL é«˜é€Ÿä¸‹è½½")):r.value?(E(),L("span",Rb,"è¯¥ç½‘ç«™å°†ä½¿ç”¨ AI Agent æ¨¡å¼")):ce("",!0)])):ce("",!0),d[80]||(d[80]=e("div",{class:"notice"}," âš ï¸ è¯·ä»…çˆ¬å–æ‚¨æœ‰æƒè®¿é—®çš„å†…å®¹ï¼Œå¹¶éµå®ˆç›®æ ‡ç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾ã€‚ ",-1)),e("div",Db,[e("div",{class:"settings-header",onClick:d[2]||(d[2]=_=>i.value=!i.value)},[e("span",Mb,ee(i.value?"â–¼":"â–¶"),1),d[39]||(d[39]=e("span",{class:"settings-title"},"âš™ï¸ è®¾ç½®",-1)),d[40]||(d[40]=e("span",{class:"settings-hint"},"ç‚¹å‡»å±•å¼€é…ç½®",-1))]),i.value?(E(),L("div",Bb,[e("div",Ab,[e("button",{class:Re(["settings-tab",{active:c.value==="basic"}]),onClick:d[3]||(d[3]=_=>c.value="basic")}," åŸºæœ¬è®¾ç½® ",2),e("button",{class:Re(["settings-tab",{active:c.value==="preprocess"}]),onClick:d[4]||(d[4]=_=>c.value="preprocess")}," å›¾ç‰‡é¢„å¤„ç† ",2),e("button",{class:Re(["settings-tab",{active:c.value==="advanced"}]),onClick:d[5]||(d[5]=_=>c.value="advanced")}," é«˜çº§è®¾ç½® ",2)]),oe(e("div",Eb,[e("div",Lb,[d[42]||(d[42]=e("h4",{class:"group-title"},"Firecrawl é…ç½®",-1)),e("div",Fb,[d[41]||(d[41]=e("label",{class:"form-label"},"API Key",-1)),e("div",Ub,[e("input",{type:R.value?"text":"password",class:"form-input",value:H(t).settings.firecrawl.apiKey,onInput:d[6]||(d[6]=_=>H(t).setFirecrawlApiKey(_.target.value)),placeholder:"fc-xxxxxxxxxxxxxxxx"},null,40,Ob),e("button",{class:"toggle-btn",onClick:d[7]||(d[7]=_=>R.value=!R.value)},ee(R.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1),e("button",{class:"test-btn",disabled:C.value||!H(t).settings.firecrawl.apiKey,onClick:I},ee(C.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,zb)])])]),e("div",Nb,[d[49]||(d[49]=e("h4",{class:"group-title"},"AI Agent é…ç½®",-1)),e("div",Vb,[d[43]||(d[43]=e("label",{class:"form-label"},"æœåŠ¡å•†",-1)),e("select",{class:"form-select",value:H(t).settings.agent.provider,onChange:d[8]||(d[8]=_=>H(t).setAgentProvider(_.target.value))},[(E(!0),L(ze,null,Ye(H(Ds),_=>(E(),L("option",{key:_.value,value:_.value},ee(_.label),9,Kb))),128))],40,Wb)]),e("div",qb,[d[44]||(d[44]=e("label",{class:"form-label"},"API Key",-1)),e("div",Hb,[e("input",{type:k.value?"text":"password",class:"form-input",value:H(t).settings.agent.apiKey,onInput:d[9]||(d[9]=_=>H(t).setAgentApiKey(_.target.value)),placeholder:"sk-xxxxxxxxxxxxxxxx"},null,40,jb),e("button",{class:"toggle-btn",onClick:d[10]||(d[10]=_=>k.value=!k.value)},ee(k.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1)])]),y.value?(E(),L("div",Jb,[d[45]||(d[45]=e("label",{class:"form-label"},"è‡ªå®šä¹‰ API åœ°å€",-1)),e("input",{type:"url",class:"form-input",value:H(t).settings.agent.customBaseUrl,onInput:d[11]||(d[11]=_=>H(t).setAgentBaseUrl(_.target.value)),placeholder:"https://api.example.com/v1"},null,40,Gb)])):ce("",!0),e("div",Yb,[d[46]||(d[46]=e("label",{class:"form-label"},"æ¨¡å‹åç§°",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.agent.modelName,onInput:d[12]||(d[12]=_=>H(t).setAgentModelName(_.target.value)),placeholder:"gpt-4o-mini"},null,40,Xb)]),e("div",Zb,[e("label",Qb,[e("input",{type:"checkbox",checked:H(t).settings.agent.forceJsonOutput,onChange:d[13]||(d[13]=_=>H(t).setAgentForceJson(_.target.checked))},null,40,eh),d[47]||(d[47]=ge(" å¼ºåˆ¶ JSON æ ¼å¼ ",-1))]),e("label",th,[e("input",{type:"checkbox",checked:H(t).settings.agent.useStream,onChange:d[14]||(d[14]=_=>H(t).setAgentUseStream(_.target.checked))},null,40,oh),d[48]||(d[48]=ge(" æµå¼è°ƒç”¨ ",-1))])]),e("div",nh,[e("button",{class:"test-btn full",disabled:$.value||!H(t).settings.agent.apiKey,onClick:M},ee($.value?"æµ‹è¯•ä¸­...":"æµ‹è¯• Agent è¿æ¥"),9,sh)])]),e("div",ah,[e("h4",{class:"group-title"},[d[50]||(d[50]=ge(" æå–è®¾ç½® ",-1)),e("button",{class:"reset-btn",onClick:V},"é‡ç½®ä¸ºé»˜è®¤")]),e("div",lh,[d[51]||(d[51]=e("label",{class:"form-label"},"æå–æç¤ºè¯",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.extraction.prompt,onInput:d[15]||(d[15]=_=>H(t).setExtractionPrompt(_.target.value)),rows:"6",placeholder:"è¾“å…¥æå–æç¤ºè¯..."},null,40,ih)]),e("div",rh,[d[52]||(d[52]=e("label",{class:"form-label"},"æœ€å¤§è¿­ä»£æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.extraction.maxIterations,onInput:d[16]||(d[16]=_=>H(t).setExtractionMaxIterations(Number(_.target.value))),min:"1",max:"20"},null,40,uh)])]),e("div",ch,[d[58]||(d[58]=e("h4",{class:"group-title"},"ä¸‹è½½è®¾ç½®",-1)),e("div",dh,[e("div",gh,[d[53]||(d[53]=e("label",{class:"form-label"},"å¹¶å‘æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.concurrency,onInput:d[17]||(d[17]=_=>H(t).setDownloadConcurrency(Number(_.target.value))),min:"1",max:"10"},null,40,ph)]),e("div",mh,[d[54]||(d[54]=e("label",{class:"form-label"},"è¶…æ—¶ (ç§’)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.timeout,onInput:d[18]||(d[18]=_=>H(t).setDownloadTimeout(Number(_.target.value))),min:"5",max:"120"},null,40,vh)]),e("div",fh,[d[55]||(d[55]=e("label",{class:"form-label"},"é‡è¯•æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.retries,onInput:d[19]||(d[19]=_=>H(t).setDownloadRetries(Number(_.target.value))),min:"0",max:"5"},null,40,bh)]),e("div",hh,[d[56]||(d[56]=e("label",{class:"form-label"},"ä¸‹è½½é—´éš” (ms)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.delay,onInput:d[20]||(d[20]=_=>H(t).setDownloadDelay(Number(_.target.value))),min:"0",max:"2000",step:"100"},null,40,xh)])]),e("div",yh,[e("label",Ch,[e("input",{type:"checkbox",checked:H(t).settings.download.useReferer,onChange:d[21]||(d[21]=_=>H(t).setDownloadUseReferer(_.target.checked))},null,40,_h),d[57]||(d[57]=ge(" è‡ªåŠ¨æ·»åŠ  Referer ",-1))])])]),e("div",kh,[d[61]||(d[61]=e("h4",{class:"group-title"},"ç•Œé¢è®¾ç½®",-1)),e("div",Sh,[e("label",wh,[e("input",{type:"checkbox",checked:H(t).settings.ui.showAgentLogs,onChange:d[22]||(d[22]=_=>H(t).setShowAgentLogs(_.target.checked))},null,40,$h),d[59]||(d[59]=ge(" æ˜¾ç¤º AI å·¥ä½œæ—¥å¿— ",-1))]),e("label",Th,[e("input",{type:"checkbox",checked:H(t).settings.ui.autoImport,onChange:d[23]||(d[23]=_=>H(t).setAutoImport(_.target.checked))},null,40,Ih),d[60]||(d[60]=ge(" æå–åè‡ªåŠ¨å¯¼å…¥ ",-1))])])])],512),[[Oe,c.value==="basic"]]),oe(e("div",Ph,[e("div",Rh,[e("div",Dh,[e("label",Mh,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.enabled,onChange:d[24]||(d[24]=_=>H(t).setImagePreprocessEnabled(_.target.checked))},null,40,Bh),d[62]||(d[62]=ge(" å¯ç”¨å›¾ç‰‡é¢„å¤„ç† ",-1))])]),H(t).settings.imagePreprocess.enabled?(E(),L(ze,{key:0},[e("div",Ah,[e("label",Eh,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.autoRotate,onChange:d[25]||(d[25]=_=>H(t).setImageAutoRotate(_.target.checked))},null,40,Lh),d[63]||(d[63]=ge(" æ ¹æ® EXIF è‡ªåŠ¨æ—‹è½¬ ",-1))])]),d[71]||(d[71]=e("h5",{class:"subsection-title"},"å‹ç¼©è®¾ç½®",-1)),e("div",Fh,[e("label",Uh,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.compression.enabled,onChange:d[26]||(d[26]=_=>H(t).setImageCompressionEnabled(_.target.checked))},null,40,Oh),d[64]||(d[64]=ge(" å¯ç”¨å‹ç¼© ",-1))])]),H(t).settings.imagePreprocess.compression.enabled?(E(),L("div",zh,[e("div",Nh,[d[65]||(d[65]=e("label",{class:"form-label"},"è´¨é‡ (0-100)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.quality,onInput:d[27]||(d[27]=_=>H(t).setImageCompressionQuality(Number(_.target.value))),min:"1",max:"100"},null,40,Vh)]),e("div",Wh,[d[66]||(d[66]=e("label",{class:"form-label"},"æœ€å¤§å®½åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxWidth,onInput:d[28]||(d[28]=_=>H(t).setImageMaxWidth(Number(_.target.value))),min:"0"},null,40,Kh)]),e("div",qh,[d[67]||(d[67]=e("label",{class:"form-label"},"æœ€å¤§é«˜åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxHeight,onInput:d[29]||(d[29]=_=>H(t).setImageMaxHeight(Number(_.target.value))),min:"0"},null,40,Hh)])])):ce("",!0),d[72]||(d[72]=e("h5",{class:"subsection-title"},"æ ¼å¼è½¬æ¢",-1)),e("div",jh,[e("label",Jh,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.formatConvert.enabled,onChange:d[30]||(d[30]=_=>H(t).setImageFormatConvertEnabled(_.target.checked))},null,40,Gh),d[68]||(d[68]=ge(" å¯ç”¨æ ¼å¼è½¬æ¢ ",-1))])]),H(t).settings.imagePreprocess.formatConvert.enabled?(E(),L("div",Yh,[d[70]||(d[70]=e("label",{class:"form-label"},"ç›®æ ‡æ ¼å¼",-1)),e("select",{class:"form-select",value:H(t).settings.imagePreprocess.formatConvert.targetFormat,onChange:d[31]||(d[31]=_=>H(t).setImageTargetFormat(_.target.value))},[...d[69]||(d[69]=[e("option",{value:"original"},"ä¿æŒåŸæ ¼å¼",-1),e("option",{value:"jpeg"},"JPEG",-1),e("option",{value:"png"},"PNG",-1),e("option",{value:"webp"},"WebP",-1)])],40,Xh)])):ce("",!0)],64)):ce("",!0)])],512),[[Oe,c.value==="preprocess"]]),oe(e("div",Zh,[e("div",Qh,[d[76]||(d[76]=e("h4",{class:"group-title"},"è‡ªå®šä¹‰è¯·æ±‚å¤´",-1)),e("div",ex,[d[73]||(d[73]=e("label",{class:"form-label"},"Cookie",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.advanced.customCookie,onInput:d[32]||(d[32]=_=>H(t).setCustomCookie(_.target.value)),placeholder:"name=value; name2=value2"},null,40,tx)]),e("div",ox,[d[74]||(d[74]=e("label",{class:"form-label"},"Headers (JSON)",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.advanced.customHeaders,onInput:d[33]||(d[33]=_=>H(t).setCustomHeaders(_.target.value)),rows:"3",placeholder:'{"X-Custom-Header": "value"}'},null,40,nx)]),e("div",sx,[e("label",ax,[e("input",{type:"checkbox",checked:H(t).settings.advanced.bypassProxy,onChange:d[34]||(d[34]=_=>H(t).setBypassProxy(_.target.checked))},null,40,lx),d[75]||(d[75]=ge(" ç»•è¿‡ç³»ç»Ÿä»£ç† (è¿æ¥æœ¬åœ°æœåŠ¡æ—¶ä½¿ç”¨) ",-1))])])])],512),[[Oe,c.value==="advanced"]])])):ce("",!0)]),te.value&&B.value.length>0?(E(),L("div",ix,[e("div",{class:"logs-header",onClick:d[35]||(d[35]=_=>a.value=!a.value)},[e("span",rx,ee(a.value?"â–¼":"â–¶"),1),d[77]||(d[77]=e("span",null,"AI å·¥ä½œæ—¥å¿—",-1)),N.value==="extracting"?(E(),L("span",ux,"(æå–ä¸­...)")):ce("",!0)]),a.value?(E(),L("div",cx,[(E(!0),L(ze,null,Ye(B.value,(_,ie)=>(E(),L("div",{key:ie,class:Re(["log-item",`log-${_.type}`])},[e("span",dx,"["+ee(_.timestamp)+"]",1),e("span",gx,ee(_.message),1)],2))),128))])):ce("",!0)])):ce("",!0),F.value?(E(),L("div",px,[d[78]||(d[78]=e("span",{class:"error-icon"},"âŒ",-1)),e("span",mx,ee(F.value),1)])):ce("",!0),A.value?.success?(E(),L("div",vx,[e("div",fx,[e("span",bx," ğŸ“– ã€Š"+ee(A.value.comicTitle)+"ã€‹- "+ee(A.value.chapterTitle),1),e("span",hx,[e("span",xx,"å…± "+ee(A.value.totalPages)+" å¼ ",1),se.value?(E(),L("span",yx,"| å¼•æ“: "+ee(se.value),1)):ce("",!0)])]),e("div",Cx,[e("label",_x,[e("input",{type:"checkbox",checked:U.value,onChange:f},null,40,kx),d[79]||(d[79]=ge(" å…¨é€‰ ",-1))]),e("span",Sx,"å·²é€‰: "+ee(p.value)+" å¼ ",1)]),e("div",wx,[(E(!0),L(ze,null,Ye(A.value.pages,_=>(E(),L("div",{key:_.pageNumber,class:Re(["image-item",{selected:h.value.has(_.pageNumber)}]),onClick:ie=>b(_.pageNumber)},[e("div",Tx,[e("input",{type:"checkbox",checked:h.value.has(_.pageNumber),onClick:d[36]||(d[36]=nt(()=>{},["stop"])),onChange:ie=>b(_.pageNumber)},null,40,Ix)]),e("div",Px,[e("img",{src:Z(_.imageUrl),alt:`ç¬¬${_.pageNumber}é¡µ`,loading:"lazy"},null,8,Rx)]),e("div",Dx,"ç¬¬ "+ee(_.pageNumber)+" é¡µ",1)],10,$x))),128))])])):ce("",!0),N.value==="downloading"?(E(),L("div",Mx,[e("div",Bx," ä¸‹è½½è¿›åº¦: "+ee(T.value.current)+"/"+ee(T.value.total),1),e("div",Ax,[e("div",{class:"progress-fill",style:ot({width:`${S.value}%`})},null,4)])])):ce("",!0)]),e("div",Ex,[e("button",{class:"cancel-btn",onClick:v,disabled:N.value==="downloading"}," å–æ¶ˆ ",8,Lx),e("button",{class:"import-btn",disabled:!A.value?.success||p.value===0||O.value,onClick:u},[N.value==="downloading"?(E(),L("span",Ux)):(E(),L("span",Ox,"ğŸ“¥")),ge(" "+ee(N.value==="downloading"?"ä¸‹è½½ä¸­...":"å¯¼å…¥"),1)],8,Fx)])])])):ce("",!0)]))}}),Nx=Je(zx,[["__scopeId","data-v-78fc5cb0"]]),Vx={class:"disclaimer-container"},Wx={class:"disclaimer-content"},Kx={class:"confirmation-area"},qx=["placeholder"],Hx={key:0,class:"input-error"},jx={class:"disclaimer-footer"},Jx=["disabled"],Yt="æˆ‘å·²é˜…è¯»å¹¶åŒæ„",Gx=Ge({__name:"WebImportDisclaimer",setup(n){const t=Io(),s=w(""),o=J(()=>t.disclaimerVisible),a=J(()=>s.value.trim()===Yt);function l(){a.value&&(t.acceptDisclaimer(),s.value="")}function r(){t.rejectDisclaimer(),s.value=""}return(x,g)=>(E(),ut(Mn,{to:"body"},[o.value?(E(),L("div",{key:0,class:"disclaimer-overlay",onClick:nt(r,["self"])},[e("div",Vx,[g[3]||(g[3]=e("div",{class:"disclaimer-header"},[e("span",{class:"warning-icon"},"âš ï¸"),e("h2",{class:"disclaimer-title"},"é‡è¦å…è´£å£°æ˜")],-1)),e("div",Wx,[g[2]||(g[2]=e("div",{class:"disclaimer-text"},[e("h3",null,"ğŸ“œ ä½¿ç”¨æ¡æ¬¾ä¸æ³•å¾‹å£°æ˜"),e("div",{class:"section"},[e("h4",null,"1. åŠŸèƒ½è¯´æ˜"),e("p",null,[ge(' "ä»ç½‘é¡µå¯¼å…¥"åŠŸèƒ½å…è®¸æ‚¨ä»äº’è”ç½‘ç½‘é¡µä¸­æå–å›¾ç‰‡ã€‚æ­¤åŠŸèƒ½ä»…ä¾›'),e("strong",null,"æŠ€æœ¯ç ”ç©¶ä¸ä¸ªäººå­¦ä¹ "),ge("ä¹‹ç›®çš„æä¾›ã€‚ ")])]),e("div",{class:"section"},[e("h4",null,"2. ç”¨æˆ·è´£ä»»"),e("ul",null,[e("li",null,[ge("æ‚¨åº”å½“ç¡®ä¿æ‹¥æœ‰"),e("strong",null,"åˆæ³•æƒåˆ©"),ge("è®¿é—®å’Œä¸‹è½½ç›®æ ‡å†…å®¹")]),e("li",null,[ge("æ‚¨åº”å½“éµå®ˆç›®æ ‡ç½‘ç«™çš„"),e("strong",null,"æœåŠ¡æ¡æ¬¾"),ge("å’Œ"),e("strong",null,"ä½¿ç”¨åè®®")]),e("li",null,[ge("æ‚¨åº”å½“å°Šé‡å†…å®¹åˆ›ä½œè€…çš„"),e("strong",null,"ç‰ˆæƒ"),ge("å’Œ"),e("strong",null,"çŸ¥è¯†äº§æƒ")]),e("li",null,[ge("æ‚¨"),e("strong",null,"ä¸å¾—"),ge("å°†ä¸‹è½½çš„å†…å®¹ç”¨äºå•†ä¸šç›®çš„æˆ–éæ³•ä¼ æ’­")]),e("li",null,[ge("æ‚¨"),e("strong",null,"ä¸å¾—"),ge("ä½¿ç”¨æœ¬åŠŸèƒ½ç»•è¿‡ä»˜è´¹å†…å®¹çš„è®¿é—®é™åˆ¶")])])]),e("div",{class:"section"},[e("h4",null,"3. ä½¿ç”¨é™åˆ¶"),e("p",null,[ge("æœ¬åŠŸèƒ½"),e("strong",null,"ä¸¥ç¦"),ge("ç”¨äºä»¥ä¸‹ç›®çš„ï¼š")]),e("ul",null,[e("li",null,[ge("ä¸‹è½½ã€å­˜å‚¨æˆ–ä¼ æ’­"),e("strong",null,"ä¾µæƒå†…å®¹")]),e("li",null,[ge("ç»•è¿‡ç½‘ç«™çš„"),e("strong",null,"ä»˜è´¹å¢™"),ge("æˆ–"),e("strong",null,"è®¿é—®æ§åˆ¶")]),e("li",null,[ge("è¿›è¡Œ"),e("strong",null,"å•†ä¸šç”¨é€”"),ge("æˆ–å¤§è§„æ¨¡"),e("strong",null,"æ‰¹é‡çˆ¬å–")]),e("li",null,[ge("ä»»ä½•è¿å"),e("strong",null,"å½“åœ°æ³•å¾‹æ³•è§„"),ge("çš„æ´»åŠ¨")]),e("li",null,[ge("å¯¹ç›®æ ‡ç½‘ç«™é€ æˆ"),e("strong",null,"æœåŠ¡å™¨è´Ÿæ‹…"),ge("æˆ–"),e("strong",null,"æ¶æ„æ”»å‡»")])])]),e("div",{class:"section"},[e("h4",null,"4. å…è´£æ¡æ¬¾"),e("p",null,[ge(" æœ¬è½¯ä»¶ä½œè€…åŠè´¡çŒ®è€…"),e("strong",null,"ä¸å¯¹æ‚¨ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¯¼è‡´çš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥åæœæ‰¿æ‹…è´£ä»»"),ge("ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š ")]),e("ul",null,[e("li",null,"å› ä¾µçŠ¯ç‰ˆæƒè€Œäº§ç”Ÿçš„æ³•å¾‹è´£ä»»"),e("li",null,"å› è¿åæœåŠ¡æ¡æ¬¾è€Œå¯¼è‡´çš„è´¦å·å°ç¦"),e("li",null,"å› æ•°æ®ä¸¢å¤±æˆ–æŸåè€Œé€ æˆçš„æŸå¤±"),e("li",null,"ä»»ä½•å…¶ä»–å› ä½¿ç”¨æœ¬åŠŸèƒ½è€Œäº§ç”Ÿçš„ä¸åˆ©åæœ")])]),e("div",{class:"section warning-section"},[e("h4",null,"5. ç¡®è®¤å£°æ˜"),e("p",null,[ge(" ä½¿ç”¨æœ¬åŠŸèƒ½å³è¡¨ç¤ºæ‚¨"),e("strong",null,"å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„"),ge("ä¸Šè¿°æ‰€æœ‰æ¡æ¬¾ï¼Œå¹¶æ‰¿è¯ºï¼š ")]),e("ul",null,[e("li",null,[ge("ä»…å°†æœ¬åŠŸèƒ½ç”¨äº"),e("strong",null,"åˆæ³•ã€åˆè§„"),ge("çš„ç›®çš„")]),e("li",null,[e("strong",null,"è‡ªè¡Œæ‰¿æ‹…"),ge("ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¸¦æ¥çš„ä¸€åˆ‡é£é™©å’Œè´£ä»»")]),e("li",null,[ge("å¦‚å› ä½¿ç”¨æœ¬åŠŸèƒ½å¯¼è‡´ä»»ä½•äº‰è®®ï¼Œ"),e("strong",null,"ä¸æœ¬è½¯ä»¶ä½œè€…æ— å…³")])])])],-1)),e("div",Kx,[g[1]||(g[1]=e("p",{class:"confirmation-prompt"}," å¦‚æœæ‚¨å·²å®Œæ•´é˜…è¯»å¹¶åŒæ„ä»¥ä¸Šæ¡æ¬¾ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å‡†ç¡®è¾“å…¥ï¼š ",-1)),e("p",{class:"required-text"},[e("code",null,ee(Yt))]),oe(e("input",{"onUpdate:modelValue":g[0]||(g[0]=i=>s.value=i),type:"text",class:"confirmation-input",placeholder:`è¯·è¾“å…¥: ${Yt}`,onKeyup:Dn(l,["enter"])},null,40,qx),[[Pe,s.value]]),s.value&&!a.value?(E(),L("p",Hx," è¾“å…¥ä¸æ­£ç¡®ï¼Œè¯·å®Œæ•´è¾“å…¥ã€Œ"+ee(Yt)+"ã€ ")):ce("",!0)])]),e("div",jx,[e("button",{class:"btn-cancel",onClick:r}," æˆ‘ä¸åŒæ„ï¼Œè¿”å› "),e("button",{class:"btn-confirm",disabled:!a.value,onClick:l}," âœ“ ç¡®è®¤å¹¶ç»§ç»­ ",8,Jx)])])])):ce("",!0)]))}}),Yx=Je(Gx,[["__scopeId","data-v-3750d090"]]),Xx={class:"app-header"},Zx={class:"header-content"},Qx={class:"logo-container"},e1={class:"header-links"},t1={class:"container"},o1={id:"image-display-area"},n1={id:"upload-section",class:"card upload-card"},s1={class:"upload-actions"},a1={key:1,class:"bookshelf-mode-hint"},l1=Ge({__name:"TranslateView",setup(n){const t=Rn(),s=Ze(),o=Fe(),a=$t(),l=gt(),{validateBeforeTranslation:r,initValidation:x}=Nn(),g=Eo(),i=or(),c=w(!1),C=w(void 0),$=w(!1),R=w(!1),k=J(()=>s.currentImage),D=J(()=>s.hasImages),N=J(()=>s.isBatchTranslationInProgress),B=J(()=>s.failedImageCount>0),A=J(()=>D.value&&!R.value),h=J(()=>!!t.query.book&&!!t.query.chapter),p=J(()=>t.query.book),T=J(()=>t.query.chapter),S=J(()=>i.currentBookTitle.value),F=J(()=>i.currentChapterTitle.value),O=J(()=>h.value&&F.value&&S.value?`${F.value} - ${S.value}`:"Saber-Translator");dt(async()=>{s.clearImages(),l.clearBubbles(),await i.initializeApp(),x(),window.addEventListener("keydown",Q)}),Wt(()=>{window.removeEventListener("keydown",Q)}),Se(()=>[t.query.book,t.query.chapter],async([W,ne],[ve,fe])=>{W&&ne?(s.clearImages(),l.clearBubbles(),await U()):ve&&fe&&!W&&!ne&&(s.clearImages(),l.clearBubbles(),await i.initializeBookChapterContext(),console.log("[TranslateView] ä»ä¹¦æ¶æ¨¡å¼åˆ‡æ¢åˆ°å¿«é€Ÿç¿»è¯‘æ¨¡å¼ï¼Œå·²æ¸…ç©ºæ•°æ®"))}),Se(O,W=>{typeof document<"u"&&(document.title=W)},{immediate:!0});const te=w(!1);function j(W){if(!W)return;const ne=o.settings.textStyle;o.updateTextStyle({fontSize:W.fontSize??ne.fontSize,autoFontSize:W.autoFontSize??ne.autoFontSize,fontFamily:W.fontFamily??ne.fontFamily,layoutDirection:W.layoutDirection??ne.layoutDirection,textColor:W.textColor??ne.textColor,fillColor:W.fillColor??ne.fillColor,strokeEnabled:W.strokeEnabled??ne.strokeEnabled,strokeColor:W.strokeColor??ne.strokeColor,strokeWidth:W.strokeWidth??ne.strokeWidth,inpaintMethod:W.inpaintMethod??ne.inpaintMethod,useAutoTextColor:W.useAutoTextColor??ne.useAutoTextColor})}function se(W){s.currentImage&&s.updateCurrentImage({fontSize:W.fontSize,autoFontSize:W.autoFontSize,fontFamily:W.fontFamily,layoutDirection:W.layoutDirection,textColor:W.textColor,fillColor:W.fillColor,strokeEnabled:W.strokeEnabled,strokeColor:W.strokeColor,strokeWidth:W.strokeWidth,inpaintMethod:W.inpaintMethod,useAutoTextColor:W.useAutoTextColor})}Se(()=>s.currentImage,W=>{if(W&&!te.value){te.value=!0;try{j(W),console.log(`[TranslateView] å·²åŒæ­¥å›¾ç‰‡ ${s.currentImageIndex} çš„æ–‡å­—è®¾ç½®åˆ°ä¾§è¾¹æ `)}finally{te.value=!1}}},{immediate:!1}),Se(()=>o.settings.textStyle,W=>{if(s.currentImage&&!te.value){te.value=!0;try{se(W),console.log(`[TranslateView] å·²å°†ä¾§è¾¹æ è®¾ç½®åŒæ­¥åˆ°å›¾ç‰‡ ${s.currentImageIndex}`)}finally{te.value=!1}}},{deep:!0});async function U(){if(!(!p.value||!T.value))try{await i.initializeBookChapterContext()}catch(W){console.error("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥:",W),ye("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥","error")}}function Z(W){console.log(`ä¸Šä¼ å®Œæˆï¼Œå…± ${W} å¼ å›¾ç‰‡`),s.hasImages&&(s.sortImagesByFileName(),i.switchImage(0))}async function ae(W){if(!Object.values(W).some(fe=>fe)){ye("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„è®¾ç½®é¡¹","warning");return}if(s.images.length===0){ye("æ²¡æœ‰å¯åº”ç”¨çš„å›¾ç‰‡","warning");return}if(s.images.length<=1){ye("åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæ— éœ€åº”ç”¨åˆ°å…¨éƒ¨","info");return}const ve=[];for(let fe=0;fe<s.images.length;fe++){const Be=s.images[fe];Be?.bubbleStates&&Be.bubbleStates.length>0&&ve.push(fe)}if(ve.length===0){ye("æ²¡æœ‰å·²ç¿»è¯‘çš„å›¾ç‰‡","warning");return}try{const{textStyle:fe}=o.settings,Be=fe.layoutDirection==="auto",Ne=fe.useAutoTextColor===!0,Ue=fe.autoFontSize===!0,we={fontSize:fe.fontSize,fontFamily:fe.fontFamily,textDirection:Be?"vertical":fe.layoutDirection,textColor:fe.textColor,fillColor:fe.fillColor,strokeEnabled:fe.strokeEnabled,strokeColor:fe.strokeColor,strokeWidth:fe.strokeWidth},Le=Te=>{if(!Te||Te.length!==3)return null;const[K,le,be]=Te;return"#"+[K,le,be].map(Ke=>{const rt=Math.max(0,Math.min(255,Math.round(Ke))).toString(16);return rt.length===1?"0"+rt:rt}).join("")},Ie=Te=>{const K={...Te};if(W.fontSize&&!Ue&&(K.fontSize=we.fontSize),W.fontFamily&&(K.fontFamily=we.fontFamily),W.layoutDirection)if(Be){const le=Te.autoTextDirection;K.textDirection=le==="vertical"||le==="horizontal"?le:"vertical"}else K.textDirection=we.textDirection;return W.textColor&&(Ne&&Te.autoFgColor?K.textColor=Le(Te.autoFgColor)??we.textColor:K.textColor=we.textColor),W.fillColor&&(Ne&&Te.autoBgColor?K.fillColor=Le(Te.autoBgColor)??we.fillColor:K.fillColor=we.fillColor),W.strokeEnabled&&(K.strokeEnabled=we.strokeEnabled),W.strokeColor&&(K.strokeColor=we.strokeColor),W.strokeWidth&&(K.strokeWidth=we.strokeWidth),K},tt=[];for(const Te of ve){const K=s.images[Te];if(!K?.bubbleStates)continue;const be={bubbleStates:K.bubbleStates.map(Ie)};W.fontSize&&(be.autoFontSize=Ue,Ue||(be.fontSize=we.fontSize)),W.fontFamily&&(be.fontFamily=we.fontFamily),W.layoutDirection&&(be.layoutDirection=fe.layoutDirection),(W.textColor||W.fillColor)&&(be.useAutoTextColor=Ne,Ne||(W.textColor&&(be.textColor=we.textColor),W.fillColor&&(be.fillColor=we.fillColor))),W.strokeEnabled&&(be.strokeEnabled=we.strokeEnabled),W.strokeColor&&(be.strokeColor=we.strokeColor),W.strokeWidth&&(be.strokeWidth=we.strokeWidth),s.updateImageByIndex(Te,be),K.translatedDataURL&&tt.push(Te)}l.bubbles.length>0&&l.setBubbles(l.bubbles.map(Ie));const qe=[];if(W.fontSize&&qe.push(Ue?"è‡ªåŠ¨å­—å·":"å­—å·"),W.fontFamily&&qe.push("å­—ä½“"),W.layoutDirection&&qe.push(Be?"è‡ªåŠ¨æ’ç‰ˆæ–¹å‘":"æ’ç‰ˆæ–¹å‘"),W.textColor&&qe.push(Ne?"è‡ªåŠ¨æ–‡å­—é¢œè‰²":"æ–‡å­—é¢œè‰²"),W.fillColor&&qe.push(Ne?"è‡ªåŠ¨å¡«å……é¢œè‰²":"å¡«å……é¢œè‰²"),W.strokeEnabled&&qe.push("æè¾¹å¼€å…³"),W.strokeColor&&qe.push("æè¾¹é¢œè‰²"),W.strokeWidth&&qe.push("æè¾¹å®½åº¦"),tt.length>0){g.progress.value={isInProgress:!0,current:0,total:tt.length,completed:0,failed:0,label:`åº”ç”¨è®¾ç½®ä¸­ï¼š0 / ${tt.length}`,percentage:0};const{executeRender:Te}=await it(async()=>{const{executeRender:le}=await Promise.resolve().then(()=>Ei);return{executeRender:le}},void 0);let K=0;for(const le of tt){const be=s.images[le];if(be?.bubbleStates)try{let Ke="";if(be.cleanImageData?Ke=be.cleanImageData.includes("base64,")?be.cleanImageData.split("base64,")[1]||"":be.cleanImageData:be.originalDataURL&&(Ke=be.originalDataURL.includes("base64,")?be.originalDataURL.split("base64,")[1]||"":be.originalDataURL,console.log(`handleApplyToAll: å›¾ç‰‡ ${le} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!Ke){console.log(`handleApplyToAll: å›¾ç‰‡ ${le} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`),g.progress.value.failed++;continue}const rt=be.bubbleStates.map(at=>at.coords),Kt=be.bubbleStates.map(at=>at.rotationAngle||0),Rt=be.bubbleStates.map(at=>at.autoTextDirection||"vertical"),Dt=be.bubbleStates.map(at=>at.originalText||""),Mt=be.bubbleStates.map(at=>at.translatedText||""),st=be.bubbleStates.map(at=>at.textboxText||""),Qe=be.bubbleStates.map(at=>({textColor:at.textColor||"#000000",bgColor:at.fillColor||"#FFFFFF",autoFgColor:at.autoFgColor||null,autoBgColor:at.autoBgColor||null})),Bt={fontSize:be.fontSize,autoFontSize:W.fontSize&&Ue,fontFamily:be.fontFamily,textDirection:be.layoutDirection,autoTextDirection:fe.layoutDirection==="auto",textColor:be.textColor,fillColor:be.fillColor,strokeEnabled:be.strokeEnabled,strokeColor:be.strokeColor,strokeWidth:be.strokeWidth,inpaintMethod:be.inpaintMethod,useAutoTextColor:be.useAutoTextColor},At=await Te({imageIndex:le,cleanImage:Ke,bubbleCoords:rt,bubbleAngles:Kt,autoDirections:Rt,originalTexts:Dt,translatedTexts:Mt,textboxTexts:st,colors:Qe,savedTextStyles:Bt,currentMode:"standard"});At.finalImage?(s.updateImageByIndex(le,{translatedDataURL:`data:image/png;base64,${At.finalImage}`,bubbleStates:At.bubbleStates||be.bubbleStates,hasUnsavedChanges:!0}),K++,g.progress.value.current=K,g.progress.value.label=`åº”ç”¨è®¾ç½®ä¸­ï¼š${K} / ${tt.length}`,g.progress.value.percentage=Math.round(K/tt.length*100)):g.progress.value.failed++}catch(Ke){console.error(`é‡æ¸²æŸ“å›¾ç‰‡ ${le} å¤±è´¥:`,Ke),g.progress.value.failed++}}g.progress.value.isInProgress=!1}const lt=s.currentImage;if(lt){te.value=!0;try{j(lt),console.log("[TranslateView] åº”ç”¨åˆ°å…¨éƒ¨å®Œæˆï¼Œå·²åŒæ­¥å½“å‰å›¾ç‰‡è®¾ç½®åˆ°ä¾§è¾¹æ ")}finally{te.value=!1}}ye(`å·²å°† ${qe.join("ã€")} åº”ç”¨åˆ° ${ve.length} å¼ å›¾ç‰‡`,"success"),console.log(`[TranslateView] åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å®Œæˆï¼Œæ›´æ–°äº† ${ve.length} å¼ å›¾ç‰‡ï¼Œé‡æ¸²æŸ“äº† ${tt.length} å¼ `)}catch(fe){console.error("åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å¤±è´¥:",fe),ye("åº”ç”¨è®¾ç½®å¤±è´¥","error")}}async function Y(){k.value&&r("normal")&&await g.translateCurrentImage()}async function v(){D.value&&r("normal")&&await g.translateAllImages()}async function m(){D.value&&r("hq")&&await g.executeHqTranslation()}async function b(){D.value&&r("proofread")&&await g.executeProofreading()}async function f(){k.value&&await g.removeTextOnly()}async function u(){D.value&&await g.removeAllTexts()}async function y(W,ne){D.value&&r("normal")&&await g.translateImageRange({startPage:W,endPage:ne})}async function I(W,ne){D.value&&r("hq")&&await g.executeHqTranslation({startPage:W,endPage:ne})}async function M(W,ne){D.value&&r("proofread")&&await g.executeProofreading({startPage:W,endPage:ne})}async function V(W,ne){D.value&&await g.removeTextRange({startPage:W,endPage:ne})}function G(){if(!k.value)return;const W=k.value.fileName||`å›¾ç‰‡ ${s.currentImageIndex+1}`;confirm(`ç¡®å®šè¦åˆ é™¤å½“å‰å›¾ç‰‡ (${W}) å—ï¼Ÿ`)&&(s.deleteCurrentImage(),ye("å›¾ç‰‡å·²åˆ é™¤","success"))}function d(){D.value&&confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„è¿›åº¦ã€‚")&&(s.clearImages(),ye("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤","success"))}async function _(){try{const W=await Bn(),ne=await wo();if(W.success&&ne.success)ye("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ","success");else{const ve=[];W.success||ve.push("è°ƒè¯•æ–‡ä»¶æ¸…ç†å¤±è´¥"),ne.success||ve.push("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å¤±è´¥"),ye(ve.join("ï¼Œ"),"warning")}}catch{ye("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥","error")}}function ie(){i.goToPrevious()}function z(){i.goToNext()}function X(){R.value=!R.value}async function pe(){if(!B.value){ye("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘","info");return}r("normal")&&await g.retryFailedImages()}async function Ce(){if(!D.value){ye("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹","warning");return}if(!(!p.value||!T.value))try{await a.saveChapterSession(p.value,T.value)?ye("ç« èŠ‚è¿›åº¦å·²ä¿å­˜","success"):ye("ä¿å­˜å¤±è´¥","error")}catch(W){console.error("ä¿å­˜ä¼šè¯å¤±è´¥:",W),ye("ä¿å­˜å¤±è´¥: "+(W instanceof Error?W.message:"æœªçŸ¥é”™è¯¯"),"error")}}function ke(W){C.value=W,c.value=!0}function $e(){ke("plugins")}function Me(){ye("è®¾ç½®å·²ä¿å­˜","success")}function re(){$.value=!0}function P(){ye("ğŸŒ™ è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼","info")}function Q(W){const ne=W.target;if(!(ne instanceof HTMLInputElement||ne instanceof HTMLTextAreaElement||ne.getAttribute("contenteditable")==="true"||ne.id==="bubbleTextEditor")&&!R.value&&W.altKey)switch(W.key){case"ArrowLeft":W.preventDefault(),ie();break;case"ArrowRight":W.preventDefault(),z();break;case"ArrowUp":if(W.preventDefault(),!o.settings.textStyle.autoFontSize){const fe=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:fe+1})}break;case"ArrowDown":if(W.preventDefault(),!o.settings.textStyle.autoFontSize){const fe=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,fe-1)})}break}}async function he(W){const ne=k.value;if(!ne||!ne.translatedDataURL){console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${W} (ä»…å½±å“ä¸‹æ¬¡ç¿»è¯‘)`);return}const ve=ne.bubbleStates;if(!ve||!Array.isArray(ve)||ve.length===0){console.log("å½“å‰å›¾ç‰‡æ²¡æœ‰ bubbleStatesï¼Œè·³è¿‡é‡æ¸²æŸ“");return}if(console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${W}ï¼Œå°†é‡æ–°æ¸²æŸ“...`),W){console.log("è‡ªåŠ¨å­—å·å·²å¼€å¯ï¼Œé‡æ–°è®¡ç®—å­—å·å¹¶æ¸²æŸ“...");try{const{apiClient:fe}=await it(async()=>{const{apiClient:Ie}=await import("./client.Bht704G-.js");return{apiClient:Ie}},__vite__mapDeps([1,2]));let Be="";if(ne.cleanImageData){const Ie=ne.cleanImageData;Be=Ie.includes("base64,")?Ie.split("base64,")[1]||"":Ie}else ne.originalDataURL&&(Be=ne.originalDataURL.includes("base64,")?ne.originalDataURL.split("base64,")[1]||"":ne.originalDataURL);if(!Be){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Ne=ve.map(Ie=>({translatedText:Ie.translatedText||"",coords:Ie.coords,fontSize:Ie.fontSize||o.settings.textStyle.fontSize,fontFamily:Ie.fontFamily||o.settings.textStyle.fontFamily,textDirection:Ot(Ie),textColor:Ie.textColor||o.settings.textStyle.textColor,rotationAngle:Ie.rotationAngle||0,position:Ie.position||{x:0,y:0},strokeEnabled:Ie.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:Ie.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:Ie.strokeWidth??o.settings.textStyle.strokeWidth})),Ue=Ne.map(Ie=>Ie.translatedText),we=Ne.map(Ie=>Ie.coords),Le=await fe.post("/api/re_render_image",{clean_image:Be,bubble_texts:Ue,bubble_coords:we,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:Ne,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(Le.rendered_image){if(Le.bubble_states&&Array.isArray(Le.bubble_states)){const Ie=ve.map((tt,qe)=>({...tt,fontSize:Le.bubble_states[qe]?.fontSize??tt.fontSize}));s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Le.rendered_image}`,bubbleStates:Ie,hasUnsavedChanges:!0}),l.setBubbles(Ie)}else s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Le.rendered_image}`,hasUnsavedChanges:!0});console.log("è‡ªåŠ¨å­—å·æ¸²æŸ“æˆåŠŸ")}else Le.error&&(console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å¤±è´¥:",Le.error),ye("é‡æ–°æ¸²æŸ“å¤±è´¥: "+Le.error,"error"))}catch(fe){console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å‡ºé”™:",fe)}}else{const fe=o.settings.textStyle.fontSize;console.log(`è‡ªåŠ¨å­—å·å·²å…³é—­ï¼Œä½¿ç”¨å›ºå®šå­—å· ${fe} æ¸²æŸ“...`);const Be=ve.map(Ne=>({...Ne,fontSize:fe}));s.updateCurrentImage({bubbleStates:Be}),l.setBubbles(Be),await me("fontSize",fe)}}async function me(W,ne){const ve=k.value;if(!ve||!ve.translatedDataURL||!ve.bubbleStates||ve.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(W))return;console.log(`å…¨å±€è®¾ç½®å˜æ›´ (${W}=${ne})ï¼Œå‡†å¤‡é‡æ¸²æŸ“...`);const Ne={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[W];if(Ne&&ve.bubbleStates)if(W==="layoutDirection")if(ne==="auto"){console.log("æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º 'auto'ï¼Œä» autoTextDirection æ¢å¤æ¯ä¸ªæ°”æ³¡çš„æ’ç‰ˆæ–¹å‘");const Ue=ve.bubbleStates.map(we=>({...we,textDirection:we.autoTextDirection==="vertical"||we.autoTextDirection==="horizontal"?we.autoTextDirection:"vertical"}));s.updateCurrentImage({bubbleStates:Ue}),l.setBubbles(Ue)}else{console.log(`æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º '${ne}'ï¼Œåº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡`);const Ue=ve.bubbleStates.map(we=>({...we,textDirection:ne}));s.updateCurrentImage({bubbleStates:Ue}),l.setBubbles(Ue)}else{const Ue=ve.bubbleStates.map(we=>({...we,[Ne]:ne}));s.updateCurrentImage({bubbleStates:Ue}),l.setBubbles(Ue)}try{const we=s.currentImage?.bubbleStates||ve.bubbleStates||[];if(we.length===0||!we[0]?.coords){console.log("æ²¡æœ‰æœ‰æ•ˆçš„æ°”æ³¡åæ ‡ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Le=o.settings.textStyle.layoutDirection,Ie=we.map(le=>({translatedText:le.translatedText||"",coords:le.coords,fontSize:le.fontSize||o.settings.textStyle.fontSize,fontFamily:le.fontFamily||o.settings.textStyle.fontFamily,textDirection:Ot(le),textColor:le.textColor||o.settings.textStyle.textColor,rotationAngle:le.rotationAngle||0,position:le.position||{x:0,y:0},strokeEnabled:le.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:le.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:le.strokeWidth??o.settings.textStyle.strokeWidth})),tt=Ie.map(le=>le.translatedText),qe=Ie.map(le=>le.coords);let lt="";if(ve.cleanImageData){const le=ve.cleanImageData;lt=le.includes("base64,")?le.split("base64,")[1]||"":le}else ve.originalDataURL&&(lt=ve.originalDataURL.includes("base64,")?ve.originalDataURL.split("base64,")[1]||"":ve.originalDataURL,console.log("handleTextStyleChanged: ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰"));if(!lt){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const{apiClient:Te}=await it(async()=>{const{apiClient:le}=await import("./client.Bht704G-.js");return{apiClient:le}},__vite__mapDeps([1,2])),K=await Te.post("/api/re_render_image",{clean_image:lt,bubble_texts:tt,bubble_coords:qe,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:Le==="auto"?"vertical":Le,textColor:o.settings.textStyle.textColor,bubble_states:Ie,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});K.rendered_image?(s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${K.rendered_image}`,hasUnsavedChanges:!0}),console.log("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“æˆåŠŸ")):K.error&&console.error("é‡æ–°æ¸²æŸ“å¤±è´¥:",K.error)}catch(Ue){console.error("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“å¤±è´¥:",Ue)}}function xe(W){i.switchImage(W)}return(W,ne)=>{const ve=Es("router-link");return E(),L("div",{class:Re(["translate-page",{"edit-mode-active":R.value}])},[e("header",Xx,[e("div",Zx,[e("div",Qx,[_e(ve,{to:"/",title:"è¿”å›ä¹¦æ¶"},{default:xt(()=>[...ne[3]||(ne[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",e1,[_e(ve,{to:"/",class:"back-to-shelf",title:"è¿”å›ä¹¦æ¶"},{default:xt(()=>[...ne[4]||(ne[4]=[ge("ğŸ“š",-1)])]),_:1}),h.value?(E(),L("button",{key:0,class:"save-header-btn",title:"ä¿å­˜è¿›åº¦",onClick:Ce}," ğŸ’¾ ")):ce("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"æ‰“å¼€è®¾ç½®",onClick:ne[0]||(ne[0]=fe=>ke())},[...ne[5]||(ne[5]=[e("span",{class:"icon"},"âš™ï¸",-1),e("span",null,"è®¾ç½®",-1)])]),ne[8]||(ne[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"ä½¿ç”¨æ•™ç¨‹",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:re},[...ne[6]||(ne[6]=[e("span",null,"â¤ï¸ è¯·ä½œè€…å–å¥¶èŒ¶",-1)])]),ne[9]||(ne[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"åŠŸèƒ½å¼€å‘ä¸­",onClick:P},[...ne[7]||(ne[7]=[e("span",{class:"theme-icon"},"â˜€ï¸",-1)])])])])]),e("div",t1,[_e(Kl,{onTranslateCurrent:Y,onTranslateAll:v,onTranslateRange:y,onHqTranslate:m,onHqTranslateRange:I,onProofread:b,onProofreadRange:M,onRemoveText:f,onRemoveAllText:u,onRemoveTextRange:V,onRetryFailed:pe,onDeleteCurrent:G,onClearAll:d,onCleanTemp:_,onOpenPlugins:$e,onOpenSettings:ke,onPrevious:ie,onNext:z,onApplyToAll:ae,onTextStyleChanged:me,onAutoFontSizeChanged:he}),e("main",o1,[e("section",n1,[e("div",s1,[_e(Ra,{ref:"imageUploadRef",onUploadComplete:Z},null,512)]),H(a).loadingProgress.total>0?(E(),ut(Po,{key:0,visible:!0,percentage:H(a).loadingProgress.current/H(a).loadingProgress.total*100,label:H(a).loadingProgress.message},null,8,["percentage","label"])):ce("",!0),_e(Mr,{progress:H(g).progress.value},null,8,["progress"]),N.value&&h.value?(E(),L("div",a1,[...ne[10]||(ne[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," ï¼ˆä¹¦æ¶æ¨¡å¼ä¸‹é€€å‡ºå‰è¯·ç‚¹å‡»é¡¶éƒ¨ä¿å­˜æŒ‰é’®ï¼‰ ",-1)])])):ce("",!0)]),_e(pi,{ref:"imageResultRef","is-edit-mode":R.value,onToggleEditMode:X,onRetryFailed:pe},null,8,["is-edit-mode"])]),oe(_e(iu,{"is-visible":A.value,onSelect:xe},null,8,["is-visible"]),[[Oe,A.value]])]),k.value&&R.value?(E(),ut(gb,{key:0,"is-edit-mode-active":R.value,onExit:X},null,8,["is-edit-mode-active"])):ce("",!0),_e(hi,{onOpenSettings:ke}),_e(Yn,{modelValue:c.value,"onUpdate:modelValue":ne[1]||(ne[1]=fe=>c.value=fe),"initial-tab":C.value,onSave:Me},null,8,["modelValue","initial-tab"]),$.value?(E(),ut(Ar,{key:1,onClose:ne[2]||(ne[2]=fe=>$.value=!1)})):ce("",!0),_e(Yx),_e(Nx)],2)}}}),f1=Je(l1,[["__scopeId","data-v-065359f7"]]);export{f1 as default};
